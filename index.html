<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>GRYFFONDOR</title>
  <meta name="author" content="TalkWithKeyboard">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="GRYFFONDOR">

  
    <meta property="og:image" content>
  

  
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

</head>
</html>
 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">GRYFFONDOR</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>GRYFFONDOR<span class="blink-fast">âˆ</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		ã€Œ@JIKEã€ Data engineer/Code player

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/09/10/a18/" >Spark Memory Management</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-09-10  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>æœ¬æ–‡ä¸»è¦æ˜¯å¯¹Sparkçš„å†…å­˜ç®¡ç†æ¨¡å—è¿›è¡Œäº†ä»£ç èµ°è¯»ï¼Œä»ä¸šåŠ¡é€»è¾‘ä¸ŠSparkå°†å†…å­˜åˆ’åˆ†ä¸ºæ‰§è¡ŒåŒºï¼ˆExecutionåŒºï¼Œå†…å­˜ä¸»è¦ç”¨æ¥è¿›è¡Œshuffleï¼Œjoinï¼Œsortï¼Œaggregateçš„è®¡ç®—ï¼‰ã€å­˜å‚¨åŒºï¼ˆStorageåŒºï¼Œå†…å­˜ä¸»è¦ç”¨æ¥è¿›è¡Œç¼“å­˜å’Œdata transferï¼‰ã€‚ä¸ºäº†ä¼˜åŒ–JVMå†…å­˜ç³»ç»Ÿçš„ä¸€äº›é—®é¢˜ï¼Œåœ¨å †å†…å­˜å’Œå †å¤–å†…å­˜çš„åŸºç¡€ä¸ŠæŠ½è±¡äº†Tungstenå†…å­˜ç³»ç»Ÿã€‚æ–‡ä¸­å¯¹æ¶‰åŠåˆ°çš„å†…çš„å…³é”®æ–¹æ³•è¿›è¡Œäº†åˆ†æã€‚</p>
<h2 id="ä»£ç æ¸…å•"><a href="#ä»£ç æ¸…å•" class="headerlink" title="ä»£ç æ¸…å•"></a>ä»£ç æ¸…å•</h2><ul>
<li>org.apache.spark.memory.MemoryManager</li>
<li>org.apache.spark.memory.UnifiedMemoryManager</li>
<li>org.apache.spark.memory.MemoryPool</li>
<li>org.apache.spark.memory.ExecutionMemoryPool</li>
<li>org.apache.spark.memory.StorageMemoryPool</li>
<li>org.apache.spark.memory.MemoryConsumer</li>
<li>org.apache.spark.memory.TaskMemoryManager</li>
<li>org.apache.spark.unsafe.memory.MemoryLocation</li>
<li>org.apache.spark.unsafe.memory.MemoryBlock</li>
<li>org.apache.spark.unsafe.memory.MemoryAllocator</li>
<li>org.apache.spark.unsafe.memory.HeapMemoryAllocator</li>
<li>org.apache.spark.unsafe.memory.UnsafeMemoryAllocator</li>
<li>org.apache.spark.storage.memory.MemoryStore</li>
</ul>
<h2 id="æ€»è§ˆ"><a href="#æ€»è§ˆ" class="headerlink" title="æ€»è§ˆ"></a>æ€»è§ˆ</h2><p><img src="/images/a18-1.jpg" alt="a18-1"><br>å…¨å±€åªæœ‰å”¯ä¸€ä¸€ä¸ªMemoryManagerï¼Œé‡Œé¢ç»´æŠ¤äº†4ä¸ªPoolã€‚ä»ä¸šåŠ¡ä¸Šåˆ†ä¸ºExecutionå’ŒStorageï¼Œä»å­˜å‚¨ä½ç½®åˆ†ä¸ºOnHeapå’ŒOffHeapã€‚æ¯ä¸ªtaskéœ€è¦ä½¿ç”¨å¤šä¸ªæ•°æ®ç»“æ„ï¼Œæ¯ä¸ªæ•°æ®ç»“æ„éƒ½æ˜¯ä¸€ä¸ª<code>MemoryConsumer</code>çš„å®ç°ï¼Œæ¯ä¸ªtaskçš„è¿™äº›consumeréƒ½é€šè¿‡<code>TaskMemoryManager</code>è¿›è¡Œç®¡ç†ï¼Œå¤šä¸ª<code>TaskMemoryManager</code>å…±åŒç»´æŠ¤ä¸€ä¸ª<code>Tungsten</code>çš„é¡µç»“æ„ã€‚</p>
<h2 id="Tungsten"><a href="#Tungsten" class="headerlink" title="Tungsten"></a>Tungsten</h2><p>ä¸ºäº†è§£å†³JVMå¯¹è±¡å­˜å‚¨æ—¶çš„overheadé—®é¢˜ï¼Œä»¥åŠGCé€ æˆçš„æ€§èƒ½æŸè€—ï¼Œè€Œæå‡ºäº†ä¸€ä¸ªæ–°çš„å†…å­˜æ¨¡å‹ã€‚æä¾›ä¸€å¥—åƒC/C++ä¸€æ ·å¯ä»¥ç›´æ¥æ“ä½œå†…å­˜çš„æ¥å£ï¼ˆå®é™…æ“ä½œçš„æ˜¯å †å¤–å†…å­˜ï¼‰ï¼Œå†ä¸ºäº†é€šç”¨æ€§æä¾›äº†æ›´é«˜å±‚çš„æ¥å£å°†å †å†…å­˜å’Œå †å¤–å†…å­˜è¿›è¡Œäº†ç»Ÿä¸€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryLocation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  Object obj;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> offset;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MemoryLocation</span><span class="params">(@Nullable Object obj, <span class="keyword">long</span> offset)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.obj = obj;</span><br><span class="line">    <span class="keyword">this</span>.offset = offset;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MemoryLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObjAndOffset</span><span class="params">(Object newObj, <span class="keyword">long</span> newOffset)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.obj = newObj;</span><br><span class="line">    <span class="keyword">this</span>.offset = newOffset;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">getBaseObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">getBaseOffset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> offset;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryBlock</span> <span class="keyword">extends</span> <span class="title">MemoryLocation</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> length;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">int</span> pageNumber = NO_PAGE_NUMBER;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tungstenæä¾›äº†ä¸€å¥—ç±»ä¼¼æ“ä½œç³»ç»Ÿé¡µå†…å­˜ç®¡ç†ä¸€æ ·çš„ç»“æ„ï¼Œæ¯é¡µä¼šå­˜å‚¨ä¸€ä¸ª<code>MemoryBlock</code>ç»“æ„ã€‚<br><code>length</code>æ˜¯æ•´ä¸ªBlockå®é™…å ç”¨çš„å†…å­˜å¤§å°ï¼Œ<code>pageNumber</code>æ˜¯åœ¨é¡µæ•°ç»„ä¸­çš„indexä½ç½®ã€‚<code>MemoryLocation</code>ç»Ÿä¸€äº†å †å†…å¤–å†…å­˜çš„å¯»å€ï¼Œå¦‚æœæ˜¯off-heapï¼Œåˆ™<code>obj</code>ä¸ºnullï¼Œ<code>offset</code>ä¸ºç»å¯¹å†…å­˜åœ°å€ï¼›å¦‚æœæ˜¯on-heapï¼Œåˆ™<code>obj</code>ä¸ºå¯¹è±¡çš„åŸºåœ°å€ï¼Œ<code>offset</code>ä¸ºåç§»é‡ã€‚æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹å½“ä¸­å°±éœ€è¦åœ¨ç‰©ç†åœ°å€ä¸<code>pageNumber</code>,<code>offsetInPage</code>ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼š</p>
<ul>
<li>on-heap: <code>address = page.obj + page.offset + inPageOffset</code></li>
<li>off-heap: <code>address = page.offset + inPageOffset</code></li>
</ul>
<p>ä½†æ˜¯åœ¨è¿™å¥—ç»“æ„ä¸­ç‰©ç†åœ°å€ä¸ä¼šç›´æ¥çš„å­˜å‚¨ï¼Œ<code>pageNumer</code> + <code>offsetInPage</code>çš„ç»„åˆå°±èƒ½å”¯ä¸€çš„å®šä½ä¸€ä¸ªå€¼çš„ä½ç½®ï¼Œæ‰€ä»¥æä¾›äº†ä¸€ä¸ªç¼–ç æ–¹æ³•ç”¨64ä½çš„longå€¼å­˜å‚¨è¿™ä¸ªåæ ‡ï¼Œå‰13ä½æ˜¯pageNumberï¼Œå51ä½æ˜¯inPageOffsetã€‚åœ¨<code>TaskMemoryManager</code>å½“ä¸­æä¾›äº†å¤šä¸ªè½¬æ¢çš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>long encodePageNumberAndOffset(MemoryBlock page, long offsetInPage)</code>ï¼šç»™å®šé¡µå’Œé¡µå†…åç§»é‡è®¡ç®—encodeå€¼</li>
<li><code>long encodePageNumberAndOffset(int pageNumer, long offsetInPage)</code>ï¼šç»™å®šé¡µå·å’Œé¡µå†…åç§»é‡è®¡ç®—encodeå€¼</li>
<li><code>int decodePageNumber(long pagePlusOffsetAddress)</code>ï¼šç»™å®šencodeå€¼ï¼Œè§£ç pageNumber</li>
<li><code>long decodeOffset(long pagePlusOffsetAddress)</code>ï¼šç»™å®šencodeå€¼ï¼Œè§£ç offset</li>
<li><code>Object getPage(long pagePlusOffsetAddress)</code>ï¼šç»™å®šencodeå€¼ï¼Œè·å–é¡µ</li>
<li><code>long getOffsetInPage(long pagePlusOffsetAddress)</code>ï¼šç»™å®šencodeå€¼ï¼Œè·å–é¡µå†…åç§»</li>
</ul>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><h3 id="MemoryManager"><a href="#MemoryManager" class="headerlink" title="MemoryManager"></a>MemoryManager</h3><p>è¯¥ç±»æ˜¯å†…å­˜ç®¡ç†çš„ç»Ÿç­¹ç±»ï¼Œå®šä¹‰äº†æ‰€æœ‰çš„å†…å­˜ç®¡ç†åŠ¨ä½œã€‚å› ä¸ºæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥è¿™äº›åŠ¨ä½œæœ‰çš„ä¼šä¸‹æ”¾ç»™å®ç°ç±»å®ç°ï¼Œæœ‰äº›åŠ¨ä½œä¼šå§”æ‰˜<code>MemoryPool</code>ç±»å®ç°ã€‚ä¸‹é¢æ˜¯æ¥å£çš„åˆ†ç±»ï¼š</p>
<ul>
<li><p>è·å–å†…å­˜å¤§å°ï¼š</p>
<ul>
<li><code>abstract maxOnHeapStorageMemory</code>ï¼šè·å–StorageåŒºæœ€å¤§èƒ½ä½¿ç”¨çš„å †å†…å­˜å¤§å°ï¼ˆåŠ¨æ€å˜åŒ–çš„ï¼‰</li>
<li><code>abstract maxOffHeapStorageMemory</code>ï¼šè·å–StorageåŒºæœ€å¤§èƒ½ä½¿ç”¨çš„å †å¤–å†…å­˜å¤§å°ï¼ˆåŠ¨æ€å˜åŒ–çš„ï¼‰</li>
<li><code>storageMemoryUsed</code>: StorageåŒºå·²ä½¿ç”¨çš„å†…å­˜å¤§å°</li>
<li><code>onHeapStorageMemoryUsed</code>ï¼šStorageåŒºå·²ä½¿ç”¨çš„å †å†…å­˜å¤§å°</li>
<li><code>offHeapStorageMemoryUsed</code>ï¼šStorageåŒºå·²ä½¿ç”¨çš„å †å¤–å†…å­˜å¤§å°</li>
<li><code>executionMemoryUsed</code>: ExecutionåŒºå·²ä½¿ç”¨çš„å†…å­˜å¤§å°</li>
<li><code>onHeapExecutionMemoryUsed</code>ï¼šExecutionåŒºå·²ä½¿ç”¨çš„å †å†…å­˜å¤§å°</li>
<li><code>offHeapExecutionMemoryUsed</code>ï¼šExecutionåŒºå·²ä½¿ç”¨çš„å †å¤–å†…å­˜å¤§å°</li>
<li><code>getExecutionMemoryUsageForTask</code>ï¼šè·å–ä¸€ä¸ªtaskåœ¨ExecutionåŒºå ç”¨çš„å†…å­˜å¤§å°</li>
</ul>
</li>
<li><p>è·å–æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼š</p>
<ul>
<li><code>abstract acquireStorageMemory(blockId: BlockId, numBytes: Long, memoryMode: MemoryMode)</code>ï¼šä¸ºä¸€ä¸ªBlockè·å–<code>numBytes</code>çš„StorageåŒºå†…å­˜ç©ºé—´ï¼Œå¦‚æœè·å–ä¸åˆ°è¶³å¤Ÿçš„ç©ºé—´å¯èƒ½ä¼šåˆ é™¤ä¸€ä¸ªå­˜åœ¨çš„Blockã€‚</li>
<li><code>abstract acquireExecutionMemory(numBytes: Long, taskAttemptId: Long, memoryMode: MemoryMode)</code>ï¼šä¸ºä¸€ä¸ªtaskè·å–<code>numBytes</code>çš„ExecutionåŒºå†…å­˜ç©ºé—´ï¼Œå½“ä¸èƒ½è·å–åˆ°è¶³å¤Ÿæ‰§è¡Œçš„å†…å­˜ç©ºé—´æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°è·å–åˆ°è¶³å¤Ÿå¤šçš„å†…å­˜ã€‚</li>
</ul>
</li>
<li><p>é‡Šæ”¾å†…å­˜ç©ºé—´ï¼š</p>
<ul>
<li><code>releaseAllExecutionMemoryForTask(taskAttemptId: Long)</code>ï¼šé‡Šæ”¾ä¸€ä¸ªtaskå ç”¨çš„æ‰€æœ‰ExecutionåŒºå†…å­˜ç©ºé—´</li>
<li><code>releaseStorageMemory(numBytes: Long, memoryMode: MemoryMode)</code>ï¼šé‡Šæ”¾<code>numBytes</code>çš„StorageåŒºå†…å­˜ç©ºé—´</li>
<li><code>releaseAllStorageMemory()</code>ï¼šé‡Šæ”¾æ‰€æœ‰çš„StorageåŒºå†…å­˜ç©ºé—´</li>
<li><code>releaseUnrollMemory(numBytes: Long, memoryMode: MemoryMode)</code>ï¼šé‡Šæ”¾<code>numBytes</code>çš„ç”¨äºunroll blockçš„å†…å­˜ç©ºé—´</li>
</ul>
</li>
<li><p><code>Tungsten</code>ç›¸å…³</p>
</li>
</ul>
<h3 id="UnifiedMemoryManager"><a href="#UnifiedMemoryManager" class="headerlink" title="UnifiedMemoryManager"></a>UnifiedMemoryManager</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[spark] <span class="class"><span class="keyword">class</span> <span class="title">UnifiedMemoryManager</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    conf: <span class="type">SparkConf</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    val maxHeapMemory: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    onHeapStorageRegionSize: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    numCores: <span class="type">Int</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>æ„é€ å‡½æ•°ä¸­çš„ï¼š</p>
<ul>
<li><code>maxHeapMemory</code>ï¼šæ˜¯å †å†…å­˜çš„æ€»å¤§å°</li>
<li><code>onHeapStorageRegionSize</code>ï¼šæ˜¯å †å†…å­˜ä¸­StorageåŒºçš„èµ·å§‹å¤§å°</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">maxOnHeapStorageMemory</span></span>: <span class="type">Long</span> = synchronized &#123;</span><br><span class="line">  maxHeapMemory - onHeapExecutionMemoryPool.memoryUsed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">maxOffHeapStorageMemory</span></span>: <span class="type">Long</span> = synchronized &#123;</span><br><span class="line">  maxOffHeapMemory - offHeapExecutionMemoryPool.memoryUsed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯ç®€å•çš„è®¡ç®—ï¼Œä¸è¿‡<code>maxHeapMemory</code>æ˜¯åˆ›å»º<code>UnifiedMemoryManager</code>æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œè€Œ<code>maxOffHeapMemory</code>æ˜¯ä»<code>spark.memory.offHeap.size</code>å‚æ•°ä¸­è¯»å…¥ã€‚</p>
<p>::acquireExecutionMemory::<br><code>acquireExecutionMemory</code>ä¸­ä¸»è¦çš„ä»»åŠ¡å°±æ˜¯è¦ç»™å‡º<code>MemoryPool.acquireMemory()</code>ä¸­çš„ä¸¤ä¸ªå›è°ƒï¼Œä¸€ä¸ªæ˜¯è·å–æ›´å¤šçš„ExecutionåŒºå†…å­˜çš„å›è°ƒï¼Œä¸€ä¸ªæ˜¯è·å–ExecutionåŒºæœ€å¤šèƒ½è·å–åˆ°çš„å†…å­˜å¤§å°ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">maybeGrowExecutionPool</span></span>(extraMemoryNeeded: <span class="type">Long</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">if</span> (extraMemoryNeeded &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// There is not enough free memory in the execution pool, so try to reclaim memory from</span></span><br><span class="line">    <span class="comment">// storage. We can reclaim any free memory from the storage pool. If the storage pool</span></span><br><span class="line">    <span class="comment">// has grown to become larger than `storageRegionSize`, we can evict blocks and reclaim</span></span><br><span class="line">    <span class="comment">// the memory that storage has borrowed from execution.</span></span><br><span class="line">    <span class="keyword">val</span> memoryReclaimableFromStorage = math.max(</span><br><span class="line">      storagePool.memoryFree,</span><br><span class="line">      storagePool.poolSize - storageRegionSize)</span><br><span class="line">    <span class="keyword">if</span> (memoryReclaimableFromStorage &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Only reclaim as much space as is necessary and available:</span></span><br><span class="line">      <span class="keyword">val</span> spaceToReclaim = storagePool.freeSpaceToShrinkPool(</span><br><span class="line">        math.min(extraMemoryNeeded, memoryReclaimableFromStorage))</span><br><span class="line">      storagePool.decrementPoolSize(spaceToReclaim)</span><br><span class="line">      executionPool.incrementPoolSize(spaceToReclaim)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ‘†è·å–æ›´å¤šçš„ExecutionåŒºå†…å­˜çš„å›è°ƒï¼Œè¿™é‡Œæœ€é‡è¦çš„æ˜¯è®¡ç®—å¯ä»¥å½’è¿˜å†…å­˜å¤§å°çš„é€»è¾‘ï¼Œåœ¨<code>memoryFree</code>ï¼ˆç©ºé—²çš„å†…å­˜å¤§å°ï¼‰å’Œ<code>poolSize-storageRegionSize</code>ï¼ˆå‘ExecutionsåŒºå€Ÿçš„å†…å­˜å¤§å°ï¼‰ä¸­å–ä¸€ä¸ªæ›´å¤§çš„å€¼ã€‚ç„¶åçœŸæ­£å½’è¿˜çš„å†…å­˜å¤§å°æ˜¯åœ¨<code>memoryReclaimableFromStorage</code>ï¼ˆå¯ä»¥å½’è¿˜çš„å†…å­˜å¤§å°ï¼‰å’Œ<code>extraMemoryNeeded</code>ï¼ˆExecutionsåŒºéœ€è¦æ‰©å¤§çš„å†…å­˜å¤§å°ï¼‰ä¹‹é—´å–ä¸€ä¸ªæ›´å°çš„å€¼ã€‚</p>
<p>è®¡ç®—å®Œæˆä»¥åéœ€è¦çœŸæ­£çš„è¿›è¡Œå†…å­˜æ“ä½œé‡Šæ”¾éœ€è¦çš„å†…å­˜ï¼Œè¯¥æ–¹æ³•åœ¨<code>StorageMemoryPool</code>ä¸­ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">freeSpaceToShrinkPool</span></span>(spaceToFree: <span class="type">Long</span>): <span class="type">Long</span> = lock.synchronized &#123;</span><br><span class="line">  <span class="keyword">val</span> spaceFreedByReleasingUnusedMemory = math.min(spaceToFree, memoryFree)</span><br><span class="line">  <span class="keyword">val</span> remainingSpaceToFree = spaceToFree - spaceFreedByReleasingUnusedMemory</span><br><span class="line">  <span class="keyword">if</span> (remainingSpaceToFree &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// If reclaiming free memory did not adequately shrink the pool, begin evicting blocks:</span></span><br><span class="line">    <span class="keyword">val</span> spaceFreedByEviction =</span><br><span class="line">      memoryStore.evictBlocksToFreeSpace(<span class="type">None</span>, remainingSpaceToFree, memoryMode)</span><br><span class="line">    <span class="comment">// When a block is released, BlockManager.dropFromMemory() calls releaseMemory(), so we do</span></span><br><span class="line">    <span class="comment">// not need to decrement _memoryUsed here. However, we do need to decrement the pool size.</span></span><br><span class="line">    spaceFreedByReleasingUnusedMemory + spaceFreedByEviction</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    spaceFreedByReleasingUnusedMemory</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>

<p>å…ˆè®¡ç®—ç©ºé—²ç©ºé—´çš„å¤§å°ï¼Œå¦‚æœç©ºé—²ç©ºé—´å¤§äºç­‰äºéœ€è¦é‡Šæ”¾çš„ç©ºé—´å¤§å°ï¼Œåˆ™ä¸éœ€è¦è¿›è¡Œå†…å­˜å¯¹è±¡æ“ä½œã€‚å¦åˆ™çš„è¯ï¼Œéœ€è¦åˆ é™¤ä¸€äº›å†…å­˜Blockã€‚åˆ é™¤çš„æ–¹æ³•åœ¨<code>MemoryStore</code>ä¸­ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[spark] <span class="function"><span class="keyword">def</span> <span class="title">evictBlocksToFreeSpace</span></span>(</span><br><span class="line">    blockId: <span class="type">Option</span>[<span class="type">BlockId</span>],</span><br><span class="line">    space: <span class="type">Long</span>,</span><br><span class="line">    memoryMode: <span class="type">MemoryMode</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">  assert(space &gt; <span class="number">0</span>)</span><br><span class="line">  memoryManager.synchronized &#123;</span><br><span class="line">    <span class="keyword">var</span> freedMemory = <span class="number">0</span>L</span><br><span class="line">    <span class="keyword">val</span> rddToAdd = blockId.flatMap(getRddId)</span><br><span class="line">    <span class="keyword">val</span> selectedBlocks = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">BlockId</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">blockIsEvictable</span></span>(blockId: <span class="type">BlockId</span>, entry: <span class="type">MemoryEntry</span>[_]): <span class="type">Boolean</span> = &#123;</span><br><span class="line">      entry.memoryMode == memoryMode &amp;&amp; (rddToAdd.isEmpty || rddToAdd != getRddId(blockId))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// This is synchronized to ensure that the set of entries is not changed</span></span><br><span class="line">    <span class="comment">// (because of getValue or getBytes) while traversing the iterator, as that</span></span><br><span class="line">    <span class="comment">// can lead to exceptions.</span></span><br><span class="line">    entries.synchronized &#123;</span><br><span class="line">      <span class="keyword">val</span> iterator = entries.entrySet().iterator()</span><br><span class="line">      <span class="keyword">while</span> (freedMemory &lt; space &amp;&amp; iterator.hasNext) &#123;</span><br><span class="line">        <span class="keyword">val</span> pair = iterator.next()</span><br><span class="line">        <span class="keyword">val</span> blockId = pair.getKey</span><br><span class="line">        <span class="keyword">val</span> entry = pair.getValue</span><br><span class="line">        <span class="keyword">if</span> (blockIsEvictable(blockId, entry)) &#123;</span><br><span class="line">          <span class="comment">// We don't want to evict blocks which are currently being read, so we need to obtain</span></span><br><span class="line">          <span class="comment">// an exclusive write lock on blocks which are candidates for eviction. We perform a</span></span><br><span class="line">          <span class="comment">// non-blocking "tryLock" here in order to ignore blocks which are locked for reading:</span></span><br><span class="line">          <span class="keyword">if</span> (blockInfoManager.lockForWriting(blockId, blocking = <span class="literal">false</span>).isDefined) &#123;</span><br><span class="line">            selectedBlocks += blockId</span><br><span class="line">            freedMemory += pair.getValue.size</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dropBlock</span></span>[<span class="type">T</span>](blockId: <span class="type">BlockId</span>, entry: <span class="type">MemoryEntry</span>[<span class="type">T</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> data = entry <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">DeserializedMemoryEntry</span>(values, _, _) =&gt; <span class="type">Left</span>(values)</span><br><span class="line">        <span class="keyword">case</span> <span class="type">SerializedMemoryEntry</span>(buffer, _, _) =&gt; <span class="type">Right</span>(buffer)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">val</span> newEffectiveStorageLevel =</span><br><span class="line">        blockEvictionHandler.dropFromMemory(blockId, () =&gt; data)(entry.classTag)</span><br><span class="line">      <span class="keyword">if</span> (newEffectiveStorageLevel.isValid) &#123;</span><br><span class="line">        <span class="comment">// The block is still present in at least one store, so release the lock</span></span><br><span class="line">        <span class="comment">// but don't delete the block info</span></span><br><span class="line">        blockInfoManager.unlock(blockId)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// The block isn't present in any store, so delete the block info so that the</span></span><br><span class="line">        <span class="comment">// block can be stored again</span></span><br><span class="line">        blockInfoManager.removeBlock(blockId)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (freedMemory &gt;= space) &#123;</span><br><span class="line">      <span class="keyword">var</span> lastSuccessfulBlock = <span class="number">-1</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        logInfo(<span class="string">s"<span class="subst">$&#123;selectedBlocks.size&#125;</span> blocks selected for dropping "</span> +</span><br><span class="line">          <span class="string">s"(<span class="subst">$&#123;Utils.bytesToString(freedMemory)&#125;</span> bytes)"</span>)</span><br><span class="line">        (<span class="number">0</span> until selectedBlocks.size).foreach &#123; idx =&gt;</span><br><span class="line">          <span class="keyword">val</span> blockId = selectedBlocks(idx)</span><br><span class="line">          <span class="keyword">val</span> entry = entries.synchronized &#123;</span><br><span class="line">            entries.get(blockId)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// This should never be null as only one task should be dropping</span></span><br><span class="line">          <span class="comment">// blocks and removing entries. However the check is still here for</span></span><br><span class="line">          <span class="comment">// future safety.</span></span><br><span class="line">          <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">            dropBlock(blockId, entry)</span><br><span class="line">            afterDropAction(blockId)</span><br><span class="line">          &#125;</span><br><span class="line">          lastSuccessfulBlock = idx</span><br><span class="line">        &#125;</span><br><span class="line">        logInfo(<span class="string">s"After dropping <span class="subst">$&#123;selectedBlocks.size&#125;</span> blocks, "</span> +</span><br><span class="line">          <span class="string">s"free memory is <span class="subst">$&#123;Utils.bytesToString(maxMemory - blocksMemoryUsed)&#125;</span>"</span>)</span><br><span class="line">        freedMemory</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// like BlockManager.doPut, we use a finally rather than a catch to avoid having to deal</span></span><br><span class="line">        <span class="comment">// with InterruptedException</span></span><br><span class="line">        <span class="keyword">if</span> (lastSuccessfulBlock != selectedBlocks.size - <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// the blocks we didn't process successfully are still locked, so we have to unlock them</span></span><br><span class="line">          (lastSuccessfulBlock + <span class="number">1</span> until selectedBlocks.size).foreach &#123; idx =&gt;</span><br><span class="line">            <span class="keyword">val</span> blockId = selectedBlocks(idx)</span><br><span class="line">            blockInfoManager.unlock(blockId)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      blockId.foreach &#123; id =&gt;</span><br><span class="line">        logInfo(<span class="string">s"Will not store <span class="subst">$id</span>"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      selectedBlocks.foreach &#123; id =&gt;</span><br><span class="line">        blockInfoManager.unlock(id)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="number">0</span>L</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥ç±»å½“ä¸­æœ‰ä¸€ä¸ªå­˜å‚¨æ‰€æœ‰Blockçš„Mapï¼Œå³ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> entries = <span class="keyword">new</span> <span class="type">LinkedHashMap</span>[<span class="type">BlockId</span>, <span class="type">MemoryEntry</span>[_]](<span class="number">32</span>, <span class="number">0.75</span>f, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p><code>LinkedHashMap</code>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ¯æ¬¡æ“ä½œä¹‹å‰ä¹Ÿæ˜¯éœ€è¦åŠ é”ã€‚å¦‚æœæ²¡æœ‰è·å–åˆ°éœ€è¦é‡Šæ”¾çš„å†…å­˜ç©ºé—´å¤§å°åˆ™éå†Blockï¼Œåˆ¤æ–­éå†çš„Blockä¸éœ€è¦å­˜å‚¨çš„Blockæ˜¯å¦æ˜¯åŒä¸€ä¸ªå­˜å‚¨åŒºåŸŸï¼ˆè¿˜åˆ¤æ–­äº†éå†çš„Blockä¸éœ€è¦å­˜å‚¨çš„Blockæ˜¯å¦æ˜¯åŒä¸€ä¸ªï¼‰ï¼Œå¦‚æœé€šè¿‡äº†åˆ¤æ–­åˆ™éœ€è¦å…ˆå°†è¯¥Blocké”ä½ï¼ŒåŠ å…¥å€™é€‰åå•ã€‚</p>
<p>æ‰¾å¤Ÿæ‰€æœ‰çš„å€™é€‰è€…ä»¥åè¿˜æ²¡æœ‰è¾¾åˆ°éœ€è¦é‡Šæ”¾çš„å†…å­˜ç©ºé—´å¤§å°åˆ™å°†æ‰€æœ‰é”ä½çš„Blockè§£é”ï¼Œè¿”å›0ï¼Œè¡¨ç¤ºè¿™ä¸ªæ“ä½œå¤±è´¥ã€‚å¦‚æœè¾¾åˆ°äº†ï¼Œåˆ™å¼€å§‹é‡Šæ”¾å†…å­˜çš„è¿‡ç¨‹ã€‚å°†æ¯ä¸€ä¸ªBlockæ‰§è¡Œ<code>dropBlock</code>ï¼Œ<code>afterDropAction</code>çš„æ“ä½œã€‚åœ¨<code>dropBlock</code>ä¸­ä¼šåˆ é™¤è¯¥Blockæœ¬èº«çš„æ•°æ®ï¼ˆé™¤éBlockè¿˜åœ¨è¢«æ“ä½œï¼‰ï¼Œæ£€æŸ¥Blockæ˜¯å¦è¿˜åœ¨è¢«å…¶ä»–çš„storageå­˜å‚¨ï¼Œå¦‚æœæ˜¯çš„è¯å°±å…ˆä¸åˆ é™¤å…¶metadataï¼Œå¦åˆ™çš„è¯ç»§ç»­åˆ é™¤metadataã€‚<code>afterDropAction</code>æ˜¯ä¸ªhookï¼Œå¯ä»¥ç”±è°ƒç”¨æ–¹æŒ‡å®šåˆ é™¤ä¹‹åçš„åŠ¨ä½œã€‚å¦‚æœåœ¨åˆ é™¤è¿‡ç¨‹å½“ä¸­å¤±è´¥çš„è¯ï¼Œéœ€è¦å°†æ²¡æœ‰åˆ é™¤çš„Blockè§£é”ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">computeMaxExecutionPoolSize</span></span>(): <span class="type">Long</span> = &#123;</span><br><span class="line">  maxMemory - math.min(storagePool.memoryUsed, storageRegionSize)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ‘†è·å–ExecutionåŒºæœ€å¤šèƒ½è·å–åˆ°çš„å†…å­˜å¤§å°ï¼Œæ˜¯é€šè¿‡æœ€å¤§çš„å†…å­˜å¤§å°å‡å»StorageåŒºæœ€å¤§èƒ½å ç”¨çš„å†…å­˜å¤§å°ã€‚StorageåŒºèƒ½å ç”¨çš„ä¸Šé™æ˜¯<code>storageRegionSize</code>ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹çœŸæ­£è¿›è¡Œå†…å­˜åˆ†é…çš„å‡½æ•°<code>acquireMemory</code>ï¼Œè¯¥æ–¹æ³•åœ¨<code>ExecutionMemoryPool</code>ä¸­ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[memory] <span class="function"><span class="keyword">def</span> <span class="title">acquireMemory</span></span>(</span><br><span class="line">    numBytes: <span class="type">Long</span>,</span><br><span class="line">    taskAttemptId: <span class="type">Long</span>,</span><br><span class="line">    maybeGrowPool: <span class="type">Long</span> =&gt; <span class="type">Unit</span> = (additionalSpaceNeeded: <span class="type">Long</span>) =&gt; (),</span><br><span class="line">    computeMaxPoolSize: () =&gt; <span class="type">Long</span> = () =&gt; poolSize): <span class="type">Long</span> = lock.synchronized &#123;</span><br><span class="line">  assert(numBytes &gt; <span class="number">0</span>, <span class="string">s"invalid number of bytes requested: <span class="subst">$numBytes</span>"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> clean up this clunky method signature</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add this task to the taskMemory map just so we can keep an accurate count of the number</span></span><br><span class="line">  <span class="comment">// of active tasks, to let other tasks ramp down their memory in calls to `acquireMemory`</span></span><br><span class="line">  <span class="keyword">if</span> (!memoryForTask.contains(taskAttemptId)) &#123;</span><br><span class="line">    memoryForTask(taskAttemptId) = <span class="number">0</span>L</span><br><span class="line">    <span class="comment">// This will later cause waiting tasks to wake up and check numTasks again</span></span><br><span class="line">    lock.notifyAll()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep looping until we're either sure that we don't want to grant this request (because this</span></span><br><span class="line">  <span class="comment">// task would have more than 1 / numActiveTasks of the memory) or we have enough free</span></span><br><span class="line">  <span class="comment">// memory to give it (we always let each task get at least 1 / (2 * numActiveTasks)).</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> simplify this to limit each task to its own slot</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> numActiveTasks = memoryForTask.keys.size</span><br><span class="line">    <span class="keyword">val</span> curMem = memoryForTask(taskAttemptId)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// In every iteration of this loop, we should first try to reclaim any borrowed execution</span></span><br><span class="line">    <span class="comment">// space from storage. This is necessary because of the potential race condition where new</span></span><br><span class="line">    <span class="comment">// storage blocks may steal the free execution memory that this task was waiting for.</span></span><br><span class="line">    maybeGrowPool(numBytes - memoryFree)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Maximum size the pool would have after potentially growing the pool.</span></span><br><span class="line">    <span class="comment">// This is used to compute the upper bound of how much memory each task can occupy. This</span></span><br><span class="line">    <span class="comment">// must take into account potential free memory as well as the amount this pool currently</span></span><br><span class="line">    <span class="comment">// occupies. Otherwise, we may run into SPARK-12155 where, in unified memory management,</span></span><br><span class="line">    <span class="comment">// we did not take into account space that could have been freed by evicting cached blocks.</span></span><br><span class="line">    <span class="keyword">val</span> maxPoolSize = computeMaxPoolSize()</span><br><span class="line">    <span class="keyword">val</span> maxMemoryPerTask = maxPoolSize / numActiveTasks</span><br><span class="line">    <span class="keyword">val</span> minMemoryPerTask = poolSize / (<span class="number">2</span> * numActiveTasks)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// How much we can grant this task; keep its share within 0 &lt;= X &lt;= 1 / numActiveTasks</span></span><br><span class="line">    <span class="keyword">val</span> maxToGrant = math.min(numBytes, math.max(<span class="number">0</span>, maxMemoryPerTask - curMem))</span><br><span class="line">    <span class="comment">// Only give it as much memory as is free, which might be none if it reached 1 / numTasks</span></span><br><span class="line">    <span class="keyword">val</span> toGrant = math.min(maxToGrant, memoryFree)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We want to let each task get at least 1 / (2 * numActiveTasks) before blocking;</span></span><br><span class="line">    <span class="comment">// if we can't give it this much now, wait for other tasks to free up memory</span></span><br><span class="line">    <span class="comment">// (this happens if older tasks allocated lots of memory before N grew)</span></span><br><span class="line">    <span class="keyword">if</span> (toGrant &lt; numBytes &amp;&amp; curMem + toGrant &lt; minMemoryPerTask) &#123;</span><br><span class="line">      logInfo(<span class="string">s"TID <span class="subst">$taskAttemptId</span> waiting for at least 1/2N of <span class="subst">$poolName</span> pool to be free"</span>)</span><br><span class="line">      lock.wait()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      memoryForTask(taskAttemptId) += toGrant</span><br><span class="line">      <span class="keyword">return</span> toGrant</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">0</span>L  <span class="comment">// Never reached</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå…³æ³¨ä¸€ä¸‹é”çš„å¯¹è±¡ï¼Œåœ¨è°ƒç”¨æ–¹<code>MemoryManager</code>åˆå§‹åŒ–çš„æ—¶å€™æœ‰å£°æ˜é”çš„å¯¹è±¡ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"this"</span>)</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">val</span> onHeapStorageMemoryPool = <span class="keyword">new</span> <span class="type">StorageMemoryPool</span>(<span class="keyword">this</span>, <span class="type">MemoryMode</span>.<span class="type">ON_HEAP</span>)</span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"this"</span>)</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">val</span> offHeapStorageMemoryPool = <span class="keyword">new</span> <span class="type">StorageMemoryPool</span>(<span class="keyword">this</span>, <span class="type">MemoryMode</span>.<span class="type">OFF_HEAP</span>)</span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"this"</span>)</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">val</span> onHeapExecutionMemoryPool = <span class="keyword">new</span> <span class="type">ExecutionMemoryPool</span>(<span class="keyword">this</span>, <span class="type">MemoryMode</span>.<span class="type">ON_HEAP</span>)</span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"this"</span>)</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">val</span> offHeapExecutionMemoryPool = <span class="keyword">new</span> <span class="type">ExecutionMemoryPool</span>(<span class="keyword">this</span>, <span class="type">MemoryMode</span>.<span class="type">OFF_HEAP</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[memory] <span class="class"><span class="keyword">class</span> <span class="title">ExecutionMemoryPool</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    lock: <span class="type">Object</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    memoryMode: <span class="type">MemoryMode</span></span></span></span><br><span class="line"><span class="class"><span class="params">  </span>)</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªä»£ç ç‰‡æ®µå¯ä»¥çœ‹å‡ºï¼Œå¤šä¸ªPoolçš„é”å¯¹è±¡éƒ½æ˜¯<code>MemoryManger</code>ï¼Œæ‰€ä»¥å¤šä¸ªPoolä¹‹é—´æ˜¯äº’æ–¥çš„ï¼Œä¸è®ºæ˜¯<code>StorageMemoryPool</code>è¿˜æ˜¯<code>ExecutionMemoryPool</code>ã€‚</p>
<p>ç„¶åæ•´ä¸ªå‡½æ•°çš„å·¥ä½œæ–¹å¼ï¼š</p>
<ul>
<li>å¦‚æœæ˜¯ä¸€ä¸ªæ–°çš„taskï¼Œå…ˆå¸®å®ƒåŠ å…¥åˆ°<code>memoryForTask</code>ä¸­ï¼Œå†…å­˜è®¾ä¸º0ï¼Œç„¶åå”¤é†’æ‰€æœ‰ç­‰å¾…é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹å¼€å§‹ç­‰é”ã€‚<code>memoryForTask</code>æ˜¯ä¸€ä¸ªä¿å­˜<code>taskId -&gt; memory</code>çš„mapã€‚</li>
<li>è¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ä¸­ï¼Œå…ˆæŸ¥çœ‹æ˜¯å¦éœ€è¦è·å–æ›´å¤šçš„å†…å­˜ï¼Œå¦‚æœéœ€è¦çš„è¯åˆ™è°ƒç”¨<code>maybeGrowPool</code>å›è°ƒã€‚è®¡ç®—ä¸€ä¸ªtaskç†è®ºèƒ½åˆ†é…åˆ°çš„æœ€å¤§å†…å­˜å’Œæœ€å°å†…å­˜ï¼Œå³<code>1/2N * maxPoolSize &lt;= cache &lt;= 1/N * maxPoolSize</code>ã€‚æ¥ç€è®¡ç®—å®é™…æœ€å¤§èƒ½åˆ†é…åˆ°çš„å†…å­˜ä»¥åŠæœ€ç»ˆå®é™…åˆ†é…çš„å†…å­˜ã€‚</li>
<li>å¦‚æœå®é™…åˆ†é…åˆ°çš„å†…å­˜å°äºéœ€è¦çš„å†…å­˜æˆ–è€…è¿™ä¸ªä»»åŠ¡åˆ†é…åˆ°çš„æ€»å†…å­˜éƒ½æ²¡æœ‰è¾¾åˆ°ç†è®ºæœ€å°å†…å­˜çš„è¯ï¼Œåˆ™å°†é”è¿˜æ‰ä»¥åç»§ç»­ç­‰é”ã€‚å¦‚æœæ‹¿åˆ°äº†éœ€è¦çš„å†…å­˜ä»¥åå°±æ›´æ–°<code>memoryForTask</code>å¹¶è¿›è¡Œè¿”å›ã€‚</li>
</ul>
<p>::acquireStorageMemory::</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">acquireStorageMemory</span></span>(</span><br><span class="line">    blockId: <span class="type">BlockId</span>,</span><br><span class="line">    numBytes: <span class="type">Long</span>,</span><br><span class="line">    memoryMode: <span class="type">MemoryMode</span>): <span class="type">Boolean</span> = synchronized &#123;</span><br><span class="line">  assertInvariants()</span><br><span class="line">  assert(numBytes &gt;= <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">val</span> (executionPool, storagePool, maxMemory) = memoryMode <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">MemoryMode</span>.<span class="type">ON_HEAP</span> =&gt; (</span><br><span class="line">      onHeapExecutionMemoryPool,</span><br><span class="line">      onHeapStorageMemoryPool,</span><br><span class="line">      maxOnHeapStorageMemory)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">MemoryMode</span>.<span class="type">OFF_HEAP</span> =&gt; (</span><br><span class="line">      offHeapExecutionMemoryPool,</span><br><span class="line">      offHeapStorageMemoryPool,</span><br><span class="line">      maxOffHeapStorageMemory)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (numBytes &gt; maxMemory) &#123;</span><br><span class="line">    <span class="comment">// Fail fast if the block simply won't fit</span></span><br><span class="line">    logInfo(<span class="string">s"Will not store <span class="subst">$blockId</span> as the required space (<span class="subst">$numBytes</span> bytes) exceeds our "</span> +</span><br><span class="line">      <span class="string">s"memory limit (<span class="subst">$maxMemory</span> bytes)"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (numBytes &gt; storagePool.memoryFree) &#123;</span><br><span class="line">    <span class="comment">// There is not enough free memory in the storage pool, so try to borrow free memory from</span></span><br><span class="line">    <span class="comment">// the execution pool.</span></span><br><span class="line">    <span class="keyword">val</span> memoryBorrowedFromExecution = <span class="type">Math</span>.min(executionPool.memoryFree,</span><br><span class="line">      numBytes - storagePool.memoryFree)</span><br><span class="line">    executionPool.decrementPoolSize(memoryBorrowedFromExecution)</span><br><span class="line">    storagePool.incrementPoolSize(memoryBorrowedFromExecution)</span><br><span class="line">  &#125;</span><br><span class="line">  storagePool.acquireMemory(blockId, numBytes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœéœ€è¦ç”³è¯·çš„å†…å­˜å¤§äºæœ€å¤§å†…å­˜åˆ™è¿”å›falseï¼Œç”³è¯·çš„å†…å­˜å¤§äºStorageåŒºçš„å‰©ä½™å†…å­˜ï¼Œåˆ™éœ€è¦ä»ExecutionåŒºå€Ÿå†…å­˜ã€‚StorageåŒºä¸èƒ½å°†æ­£åœ¨è¿è¡Œçš„taskè¸¢å‡ºExecutionåŒºï¼Œæ‰€ä»¥åªèƒ½ä»ä¸­è·å–ç©ºé—²çš„ç©ºé—´å¤§å°ã€‚æ•°å€¼è®¡ç®—å®Œæˆä»¥åï¼Œå¼€å§‹çœŸæ­£çš„åˆ†é…ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">acquireMemory</span></span>(</span><br><span class="line">    blockId: <span class="type">BlockId</span>,</span><br><span class="line">    numBytesToAcquire: <span class="type">Long</span>,</span><br><span class="line">    numBytesToFree: <span class="type">Long</span>): <span class="type">Boolean</span> = lock.synchronized &#123;</span><br><span class="line">  assert(numBytesToAcquire &gt;= <span class="number">0</span>)</span><br><span class="line">  assert(numBytesToFree &gt;= <span class="number">0</span>)</span><br><span class="line">  assert(memoryUsed &lt;= poolSize)</span><br><span class="line">  <span class="keyword">if</span> (numBytesToFree &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    memoryStore.evictBlocksToFreeSpace(<span class="type">Some</span>(blockId), numBytesToFree, memoryMode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> If the memory store evicts blocks, then those evictions will synchronously call</span></span><br><span class="line">  <span class="comment">// back into this StorageMemoryPool in order to free memory. Therefore, these variables</span></span><br><span class="line">  <span class="comment">// should have been updated.</span></span><br><span class="line">  <span class="keyword">val</span> enoughMemory = numBytesToAcquire &lt;= memoryFree</span><br><span class="line">  <span class="keyword">if</span> (enoughMemory) &#123;</span><br><span class="line">    _memoryUsed += numBytesToAcquire</span><br><span class="line">  &#125;</span><br><span class="line">  enoughMemory</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆä»Storageä¸­åˆ é™¤ä¸€äº›Blocké‡Šæ”¾ä¸€äº›å†…å­˜ï¼Œå¦‚æœæœ‰è¶³å¤Ÿçš„å†…å­˜ç”³è¯·å°±æ›´æ–°å·²ä½¿ç”¨çš„å†…å­˜è®¡æ•°å™¨ï¼Œå¦åˆ™ç›´æ¥è¿”å›falseã€‚</p>
<h3 id="MemoryPool"><a href="#MemoryPool" class="headerlink" title="MemoryPool"></a>MemoryPool</h3><p>è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ•´ä¸ªç±»éƒ½åœ¨ç»´æŠ¤ä¸€ä¸ªå˜é‡<code>_poolSize</code>ï¼Œè¡¨ç¤ºå†…å­˜ä½¿ç”¨é‡ã€‚æä¾›äº†ç»´æŠ¤è¿™ä¸ªé‡çš„ä¸€äº›æ–¹æ³•ï¼Œå¦‚ï¼š</p>
<ul>
<li><code>poolSize: Long</code>ï¼šè·å–<code>_poolSize</code></li>
<li><code>memoryFree: Long</code>ï¼šè·å–ç©ºé—²çš„å†…å­˜ç©ºé—´å¤§å°</li>
<li><code>incrementPoolSize(delta: Long)</code>ï¼šæé«˜<code>_poolSize</code></li>
<li><code>decrementPoolSize(delta: Long)</code>ï¼šé™ä½<code>_poolSize</code></li>
</ul>
<p>ä»¥åŠä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼š</p>
<ul>
<li><code>memoryUsed: Long</code></li>
</ul>
<h3 id="ExecutionMemoryPool"><a href="#ExecutionMemoryPool" class="headerlink" title="ExecutionMemoryPool"></a>ExecutionMemoryPool</h3><p>è¯¥ç±»ä¸­ç»´æŠ¤äº†ä¸€ä¸ª<code>taskId -&gt; memory</code>çš„Mapï¼š<code>memoryForTask</code>æ¥ç®¡ç†å†…å­˜ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">memoryUsed</span></span>: <span class="type">Long</span> = lock.synchronized &#123;</span><br><span class="line">  memoryForTask.values.sum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œç›´æ¥å°†<code>memoryForTask</code>ä¸­çš„valuesç´¯åŠ ã€‚</p>
<p><code>acquireMemory</code>å·²ç»åœ¨ä¸Šæ–‡ä¸­åˆ†æè¿‡äº†ã€‚<code>releaseMemory</code>åœ¨<code>MemoryManager.releaseExecutionMemory</code>ä¸­è¢«è°ƒç”¨ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">releaseMemory</span></span>(numBytes: <span class="type">Long</span>, taskAttemptId: <span class="type">Long</span>): <span class="type">Unit</span> = lock.synchronized &#123;</span><br><span class="line">  <span class="keyword">val</span> curMem = memoryForTask.getOrElse(taskAttemptId, <span class="number">0</span>L)</span><br><span class="line">  <span class="keyword">val</span> memoryToFree = <span class="keyword">if</span> (curMem &lt; numBytes) &#123;</span><br><span class="line">    logWarning(</span><br><span class="line">      <span class="string">s"Internal error: release called on <span class="subst">$numBytes</span> bytes but task only has <span class="subst">$curMem</span> bytes "</span> +</span><br><span class="line">        <span class="string">s"of memory from the <span class="subst">$poolName</span> pool"</span>)</span><br><span class="line">    curMem</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    numBytes</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (memoryForTask.contains(taskAttemptId)) &#123;</span><br><span class="line">    memoryForTask(taskAttemptId) -= memoryToFree</span><br><span class="line">    <span class="keyword">if</span> (memoryForTask(taskAttemptId) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      memoryForTask.remove(taskAttemptId)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  lock.notifyAll() <span class="comment">// Notify waiters in acquireMemory() that memory has been freed</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ­£å¼é‡Šæ”¾ä¹‹å‰ä¼šå…ˆæ¯”è¾ƒä¸€ä¸‹ç°åœ¨è¯¥taskæ‰€å ç”¨çš„å†…å­˜å’Œéœ€è¦é‡Šæ”¾çš„å†…å­˜çš„å¤§å°ï¼Œå¦‚æœtaskæ‰€å å†…å­˜å°äºéœ€è¦é‡Šæ”¾çš„å†…å­˜ä¹Ÿåªä¼šé‡Šæ”¾taskæ‰€å å†…å­˜ï¼Œä¸ä¼šå†é‡Šæ”¾å…¶ä»–çš„taskã€‚å› ä¸ºæœ‰æ–°çš„å†…å­˜ç©ºé—´å‡ºç°ï¼Œæ‰€ä»¥å¯ä»¥å”¤é†’ç­‰å¾…é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹ï¼Œå¼€å§‹ç»™æ–°ä»»åŠ¡äº‰å–å†…å­˜ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">releaseAllMemoryForTask</span></span>(taskAttemptId: <span class="type">Long</span>): <span class="type">Long</span> = lock.synchronized &#123;</span><br><span class="line">  <span class="keyword">val</span> numBytesToFree = getMemoryUsageForTask(taskAttemptId)</span><br><span class="line">  releaseMemory(numBytesToFree, taskAttemptId)</span><br><span class="line">  numBytesToFree</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•ä¼šé‡Šæ”¾ä¸€ä¸ªtaskæ‰€æœ‰çš„å†…å­˜ï¼Œç›´æ¥è·å–taskæ‰€å ç”¨çš„å†…å­˜ä»¥åè°ƒç”¨ä¸Šé¢çš„<code>releaseMemory</code>æ–¹æ³•ã€‚</p>
<h3 id="StorageMemoryPool"><a href="#StorageMemoryPool" class="headerlink" title="StorageMemoryPool"></a>StorageMemoryPool</h3><p>è¯¥ç±»è´Ÿè´£StorageåŒºçš„å†…å­˜ç®¡ç†ï¼Œåœ¨ç±»ä¸­ç»´æŠ¤äº†ä¸€ä¸ª<code>_memoryUsed</code>å‚æ•°ï¼Œæ¥è¡¨ç¤ºä½¿ç”¨äº†å¤šå°‘å†…å­˜ã€‚å¹¶ä¸”ä¼šå…³è”ä¸€ä¸ª<code>MemoryStore</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¼šå®ŒæˆçœŸæ­£çš„å†…å­˜ç®¡ç†æ“ä½œã€‚</p>
<p>é‡è¦çš„<code>acquireMemory</code>å’Œ<code>freeSpaceToShrinkPool</code>å‡½æ•°å‡åœ¨ä¸Šæ–‡ä¸­è¿›è¡Œäº†ä»‹ç»ã€‚</p>
<h3 id="TaskMemoryManager"><a href="#TaskMemoryManager" class="headerlink" title="TaskMemoryManager"></a>TaskMemoryManager</h3><p>è¯¥ç±»è´Ÿè´£ç®¡ç†ä¸€ä¸ªtaskçš„å†…å­˜ï¼Œè¯¥ç±»ä¸­ä¸ä¼šç›´æ¥æ“ä½œå†…å­˜ï¼Œä¼šé€šè¿‡<code>MemoryManager</code>æ¥è¿›è¡Œç®¡ç†ã€‚ä¸è¿‡å› ä¸ºåº•å±‚ä½¿ç”¨äº†<code>Tungsten</code>å†…å­˜æ¨¡å‹ï¼Œè¯¥ç±»ä¸­è¿˜ä¼šç»´æŠ¤å†…å­˜æ¨¡å‹ä½¿ç”¨çš„é¡µæœºåˆ¶ç›¸å…³çš„å˜é‡ã€‚æ‰€æœ‰çš„<code>TaskMemoryManager</code>ä¼šå…±ç”¨ä¸€ä¸ª<code>MemoryManager</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">acquireExecutionMemory</span><span class="params">(<span class="keyword">long</span> required, MemoryConsumer consumer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span>(required &gt;= <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">assert</span>(consumer != <span class="keyword">null</span>);</span><br><span class="line">  MemoryMode mode = consumer.getMode();</span><br><span class="line">  <span class="comment">// If we are allocating Tungsten pages off-heap and receive a request to allocate on-heap</span></span><br><span class="line">  <span class="comment">// memory here, then it may not make sense to spill since that would only end up freeing</span></span><br><span class="line">  <span class="comment">// off-heap memory. This is subject to change, though, so it may be risky to make this</span></span><br><span class="line">  <span class="comment">// optimization now in case we forget to undo it late when making changes.</span></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">long</span> got = memoryManager.acquireExecutionMemory(required, taskAttemptId, mode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to release memory from other consumers first, then we can reduce the frequency of</span></span><br><span class="line">    <span class="comment">// spilling, avoid to have too many spilled files.</span></span><br><span class="line">    <span class="keyword">if</span> (got &lt; required) &#123;</span><br><span class="line">      <span class="comment">// Call spill() on other consumers to release memory</span></span><br><span class="line">      <span class="comment">// Sort the consumers according their memory usage. So we avoid spilling the same consumer</span></span><br><span class="line">      <span class="comment">// which is just spilled in last few times and re-spilling on it will produce many small</span></span><br><span class="line">      <span class="comment">// spill files.</span></span><br><span class="line">      TreeMap&lt;Long, List&lt;MemoryConsumer&gt;&gt; sortedConsumers = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">      <span class="keyword">for</span> (MemoryConsumer c: consumers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c != consumer &amp;&amp; c.getUsed() &gt; <span class="number">0</span> &amp;&amp; c.getMode() == mode) &#123;</span><br><span class="line">          <span class="keyword">long</span> key = c.getUsed();</span><br><span class="line">          List&lt;MemoryConsumer&gt; list =</span><br><span class="line">              sortedConsumers.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">          list.add(c);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (!sortedConsumers.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// Get the consumer using the least memory more than the remaining required memory.</span></span><br><span class="line">        Map.Entry&lt;Long, List&lt;MemoryConsumer&gt;&gt; currentEntry =</span><br><span class="line">          sortedConsumers.ceilingEntry(required - got);</span><br><span class="line">        <span class="comment">// No consumer has used memory more than the remaining required memory.</span></span><br><span class="line">        <span class="comment">// Get the consumer of largest used memory.</span></span><br><span class="line">        <span class="keyword">if</span> (currentEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">          currentEntry = sortedConsumers.lastEntry();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;MemoryConsumer&gt; cList = currentEntry.getValue();</span><br><span class="line">        MemoryConsumer c = cList.get(cList.size() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">long</span> released = c.spill(required - got, consumer);</span><br><span class="line">          <span class="keyword">if</span> (released &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Task &#123;&#125; released &#123;&#125; from &#123;&#125; for &#123;&#125;"</span>, taskAttemptId,</span><br><span class="line">              Utils.bytesToString(released), c, consumer);</span><br><span class="line">            got += memoryManager.acquireExecutionMemory(required - got, taskAttemptId, mode);</span><br><span class="line">            <span class="keyword">if</span> (got &gt;= required) &#123;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cList.remove(cList.size() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (cList.isEmpty()) &#123;</span><br><span class="line">              sortedConsumers.remove(currentEntry.getKey());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClosedByInterruptException e) &#123;</span><br><span class="line">          <span class="comment">// This called by user to kill a task (e.g: speculative task).</span></span><br><span class="line">          logger.error(<span class="string">"error while calling spill() on "</span> + c, e);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          logger.error(<span class="string">"error while calling spill() on "</span> + c, e);</span><br><span class="line">          <span class="comment">// checkstyle.off: RegexpSinglelineJava</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> SparkOutOfMemoryError(<span class="string">"error while calling spill() on "</span> + c + <span class="string">" : "</span></span><br><span class="line">            + e.getMessage());</span><br><span class="line">          <span class="comment">// checkstyle.on: RegexpSinglelineJava</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call spill() on itself</span></span><br><span class="line">    <span class="keyword">if</span> (got &lt; required) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> released = consumer.spill(required - got, consumer);</span><br><span class="line">        <span class="keyword">if</span> (released &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          logger.debug(<span class="string">"Task &#123;&#125; released &#123;&#125; from itself (&#123;&#125;)"</span>, taskAttemptId,</span><br><span class="line">            Utils.bytesToString(released), consumer);</span><br><span class="line">          got += memoryManager.acquireExecutionMemory(required - got, taskAttemptId, mode);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ClosedByInterruptException e) &#123;</span><br><span class="line">        <span class="comment">// This called by user to kill a task (e.g: speculative task).</span></span><br><span class="line">        logger.error(<span class="string">"error while calling spill() on "</span> + consumer, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.error(<span class="string">"error while calling spill() on "</span> + consumer, e);</span><br><span class="line">        <span class="comment">// checkstyle.off: RegexpSinglelineJava</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SparkOutOfMemoryError(<span class="string">"error while calling spill() on "</span> + consumer + <span class="string">" : "</span></span><br><span class="line">          + e.getMessage());</span><br><span class="line">        <span class="comment">// checkstyle.on: RegexpSinglelineJava</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    consumers.add(consumer);</span><br><span class="line">    logger.debug(<span class="string">"Task &#123;&#125; acquired &#123;&#125; for &#123;&#125;"</span>, taskAttemptId, Utils.bytesToString(got), consumer);</span><br><span class="line">    <span class="keyword">return</span> got;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•æ˜¯ä¸ºä¸€ä¸ªtaskæ–°çš„consumeråˆ†é…å†…å­˜ï¼Œä¸€è¿›æ¥ä¼šå…ˆå°è¯•ä½¿ç”¨ExecutorPoolç”³è¯·<code>required</code>å¤§å°çš„å†…å­˜ï¼Œå¦‚æœèƒ½ç›´æ¥è·å–åˆ°å°±ç»“æŸã€‚å¦åˆ™çš„è¯éœ€è¦ä»consumerä¸­æŒ‘é€‰åˆé€‚çš„consumerè¿›è¡Œspillæ“ä½œï¼ˆä¹Ÿå°±æ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®å†²å†™åˆ°ç¡¬ç›˜ä¸Šï¼‰æ¥é‡Šæ”¾è¶³å¤Ÿå¤šçš„å†…å­˜ã€‚</p>
<p>æŒ‘é€‰çš„è¿‡ç¨‹ä¹Ÿå¾ˆå¸¸è§„ï¼Œä¼šé€‰å‡ºå¤§äºéœ€è¦çš„å†…å­˜çš„consumerä¸­æœ€å°çš„ä¸€ä¸ªï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»å¤§åˆ°å°ä¾æ¬¡spillï¼Œç›´åˆ°é‡Šæ”¾çš„å†…å­˜è¾¾åˆ°éœ€æ±‚ã€‚ä¸è¿‡ç­›é€‰å¤§äºéœ€è¦çš„å†…å­˜ä¸­æœ€å°çš„ä¸€ä¸ªç”¨äº†ä¸€ä¸ªå¾ˆç®€æ´å¿«é€Ÿçš„æ–¹å¼ï¼Œåˆ›å»ºäº†ä¸€ä¸ª<code>memory -&gt; List&lt;MemoryConsumer&gt;</code>çš„TreeMapï¼Œç›´æ¥ä½¿ç”¨<code>TreeMap.ceilingEntry</code>æ–¹æ³•ã€‚æ¯æ¬¡é‡Šæ”¾å®Œæˆä»¥åéƒ½å†é‡æ–°ç”³è¯·æ›´å¤šçš„å†…å­˜ï¼Œç›´åˆ°ç”³è¯·åˆ°äº†è¶³å¤Ÿå¤šçš„å†…å­˜ã€‚</p>
<p>å¦‚æœåœ¨ä¸Šé¢çš„æ“ä½œæ‰§è¡Œå®Œæˆä»¥åï¼ˆä¹Ÿå°±æ˜¯èƒ½é‡Šæ”¾çš„éƒ½é‡Šæ”¾æ‰äº†ï¼‰è¿˜æ˜¯ä¸å¤Ÿï¼Œé‚£ä¹ˆå°±å°†è¿™ä¸ªè¦åŠ å…¥çš„æ–°çš„consumerçš„éƒ¨åˆ†æ•°æ®å†²å†™åˆ°ç¡¬ç›˜ä¸Šï¼Œä½¿ä»–èƒ½è¢«æ”¾å…¥MemoryPoolä¸­ã€‚</p>
<h4 id="Allocate-page"><a href="#Allocate-page" class="headerlink" title="Allocate page"></a>Allocate page</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MemoryBlock <span class="title">allocatePage</span><span class="params">(<span class="keyword">long</span> size, MemoryConsumer consumer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span>(consumer != <span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">assert</span>(consumer.getMode() == tungstenMemoryMode);</span><br><span class="line">  <span class="keyword">if</span> (size &gt; MAXIMUM_PAGE_SIZE_BYTES) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> TooLargePageException(size);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> acquired = acquireExecutionMemory(size, consumer);</span><br><span class="line">  <span class="keyword">if</span> (acquired &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> pageNumber;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    pageNumber = allocatedPages.nextClearBit(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pageNumber &gt;= PAGE_TABLE_SIZE) &#123;</span><br><span class="line">      releaseExecutionMemory(acquired, consumer);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">        <span class="string">"Have already allocated a maximum of "</span> + PAGE_TABLE_SIZE + <span class="string">" pages"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    allocatedPages.set(pageNumber);</span><br><span class="line">  &#125;</span><br><span class="line">  MemoryBlock page = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    page = memoryManager.tungstenMemoryAllocator().allocate(acquired);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">    logger.warn(<span class="string">"Failed to allocate a page (&#123;&#125; bytes), try again."</span>, acquired);</span><br><span class="line">    <span class="comment">// there is no enough memory actually, it means the actual free memory is smaller than</span></span><br><span class="line">    <span class="comment">// MemoryManager thought, we should keep the acquired memory.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      acquiredButNotUsed += acquired;</span><br><span class="line">      allocatedPages.clear(pageNumber);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// this could trigger spilling to free some pages.</span></span><br><span class="line">    <span class="keyword">return</span> allocatePage(size, consumer);</span><br><span class="line">  &#125;</span><br><span class="line">  page.pageNumber = pageNumber;</span><br><span class="line">  pageTable[pageNumber] = page;</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">"Allocate page number &#123;&#125; (&#123;&#125; bytes)"</span>, pageNumber, acquired);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¡µç®¡ç†ä¸»è¦ç”±ä¸€ä¸ª <code>BitSet</code>ï¼ˆæ ‡ç¤ºé¡µä½æƒ…å†µï¼‰å’Œ<code>MemoryBlock[]</code>ï¼ˆï¼‰å®ç°ï¼Œtrueè¡¨ç¤ºé¡µä½è¢«å ã€‚è¯¥æ–¹æ³•ä¼šå…ˆè°ƒç”¨<code>acquireExecutionMemory</code>ç”³è¯·å®é™…çš„ç‰©ç†å†…å­˜ï¼Œç„¶åé€šè¿‡<code>BitSet.nextClearBitï¼ˆï¼‰</code>å‡½æ•°è·å–ç¬¬ä¸€ä¸ªç©ºä½ç½®ï¼Œå¹¶è¿›è¡Œå ä½ã€‚å®Œæˆä»¥åå°±ä¼šé€šè¿‡<code>tungstenMemoryAllocator</code>æ¥çœŸæ­£è¿›è¡Œå†…å­˜ç”³è¯·ï¼Œä¸‹é¢ä¼šåˆ†æä¸€ä¸‹on-heapå’Œoff-heapä¸¤ç§ä¸åŒçš„å†…å­˜ç”³è¯·ï¼š</p>
<p>::Unsafe memory allocate::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MemoryBlock <span class="title">allocate</span><span class="params">(<span class="keyword">long</span> size)</span> <span class="keyword">throws</span> OutOfMemoryError </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> address = Platform.allocateMemory(size);</span><br><span class="line">  MemoryBlock memory = <span class="keyword">new</span> MemoryBlock(<span class="keyword">null</span>, address, size);</span><br><span class="line">  <span class="keyword">if</span> (MemoryAllocator.MEMORY_DEBUG_FILL_ENABLED) &#123;</span><br><span class="line">    memory.fill(MemoryAllocator.MEMORY_DEBUG_FILL_CLEAN_VALUE);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> memory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Off-heapçš„æ‰€æœ‰å†…å­˜æ“ä½œéƒ½æ˜¯é€šè¿‡Unsafeå·¥å…·ç±»æ¥å®Œæˆï¼Œè¿™ä¸ªæ–¹æ³•éå¸¸çš„ç®€å•ã€‚ä¼šå…ˆé€šè¿‡<code>Unsafe.allocateMemory</code>ç”³è¯·å†…å­˜ï¼Œç„¶ååˆå§‹åŒ–ä¸€ä¸ªé¡µç»“æ„ï¼Œoff-heapä¸ä¼šæ˜ å°„å¯¹è±¡ï¼Œæ‰€ä»¥objä¼ å…¥nullå³å¯ã€‚</p>
<p>::Heap memory allocate::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MemoryBlock <span class="title">allocate</span><span class="params">(<span class="keyword">long</span> size)</span> <span class="keyword">throws</span> OutOfMemoryError </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> numWords = (<span class="keyword">int</span>) ((size + <span class="number">7</span>) / <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">long</span> alignedSize = numWords * <span class="number">8L</span>;</span><br><span class="line">  <span class="keyword">assert</span> (alignedSize &gt;= size);</span><br><span class="line">  <span class="keyword">if</span> (shouldPool(alignedSize)) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> LinkedList&lt;WeakReference&lt;<span class="keyword">long</span>[]&gt;&gt; pool = bufferPoolsBySize.get(alignedSize);</span><br><span class="line">      <span class="keyword">if</span> (pool != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (!pool.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">final</span> WeakReference&lt;<span class="keyword">long</span>[]&gt; arrayReference = pool.pop();</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">long</span>[] array = arrayReference.get();</span><br><span class="line">          <span class="keyword">if</span> (array != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">assert</span> (array.length * <span class="number">8L</span> &gt;= size);</span><br><span class="line">            MemoryBlock memory = <span class="keyword">new</span> MemoryBlock(array, Platform.LONG_ARRAY_OFFSET, size);</span><br><span class="line">            <span class="keyword">if</span> (MemoryAllocator.MEMORY_DEBUG_FILL_ENABLED) &#123;</span><br><span class="line">              memory.fill(MemoryAllocator.MEMORY_DEBUG_FILL_CLEAN_VALUE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> memory;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bufferPoolsBySize.remove(alignedSize);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">long</span>[] array = <span class="keyword">new</span> <span class="keyword">long</span>[numWords];</span><br><span class="line">  MemoryBlock memory = <span class="keyword">new</span> MemoryBlock(array, Platform.LONG_ARRAY_OFFSET, size);</span><br><span class="line">  <span class="keyword">if</span> (MemoryAllocator.MEMORY_DEBUG_FILL_ENABLED) &#123;</span><br><span class="line">    memory.fill(MemoryAllocator.MEMORY_DEBUG_FILL_CLEAN_VALUE);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> memory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¤šå¤§å†…å­˜æœ‰ä¸€ä¸ªä¼˜åŒ–æœºåˆ¶ï¼Œç±»ä¸­æœ‰ä¸€ä¸ªMapä¼šä¿å­˜å¤§å†…å­˜å—çš„å¼•ç”¨ï¼Œå‡å°‘GCå’Œç”³è¯·å†…å­˜çš„æ—¶é—´ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"this"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, LinkedList&lt;WeakReference&lt;<span class="keyword">long</span>[]&gt;&gt;&gt; bufferPoolsBySize = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>è§¦å‘è¿™ä¸ªæœºåˆ¶çš„å†…å­˜å¤§å°æ˜¯<code>1024 * 1024</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½çœ‹åˆ°åœ¨allocateæ–¹æ³•ä¸­ä¼šå…ˆåˆ¤æ–­æ˜¯å¦è§¦å‘è¯¥æœºåˆ¶ï¼Œå¦‚æœè§¦å‘åˆ™ä»æœªè¢«å›æ”¶çš„å¤§å†…å­˜å—ä¸­å–å‡ºç›¸åº”çš„å—è¿›è¡Œå­˜å‚¨ï¼Œå¦åˆ™ä¼šé‡æ–°ç”³è¯·å†…å­˜ã€‚</p>
<h4 id="Free-page"><a href="#Free-page" class="headerlink" title="Free page"></a>Free page</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">freePage</span><span class="params">(MemoryBlock page, MemoryConsumer consumer)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> (page.pageNumber != MemoryBlock.NO_PAGE_NUMBER) :</span><br><span class="line">    <span class="string">"Called freePage() on memory that wasn't allocated with allocatePage()"</span>;</span><br><span class="line">  <span class="keyword">assert</span> (page.pageNumber != MemoryBlock.FREED_IN_ALLOCATOR_PAGE_NUMBER) :</span><br><span class="line">    <span class="string">"Called freePage() on a memory block that has already been freed"</span>;</span><br><span class="line">  <span class="keyword">assert</span> (page.pageNumber != MemoryBlock.FREED_IN_TMM_PAGE_NUMBER) :</span><br><span class="line">          <span class="string">"Called freePage() on a memory block that has already been freed"</span>;</span><br><span class="line">  <span class="keyword">assert</span>(allocatedPages.get(page.pageNumber));</span><br><span class="line">  pageTable[page.pageNumber] = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    allocatedPages.clear(page.pageNumber);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">    logger.trace(<span class="string">"Freed page number &#123;&#125; (&#123;&#125; bytes)"</span>, page.pageNumber, page.size());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">long</span> pageSize = page.size();</span><br><span class="line">  <span class="comment">// Clear the page number before passing the block to the MemoryAllocator's free().</span></span><br><span class="line">  <span class="comment">// Doing this allows the MemoryAllocator to detect when a TaskMemoryManager-managed</span></span><br><span class="line">  <span class="comment">// page has been inappropriately directly freed without calling TMM.freePage().</span></span><br><span class="line">  page.pageNumber = MemoryBlock.FREED_IN_TMM_PAGE_NUMBER;</span><br><span class="line">  memoryManager.tungstenMemoryAllocator().free(page);</span><br><span class="line">  releaseExecutionMemory(pageSize, consumer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”äºç”³è¯·é¡µä¹Ÿä¼šæœ‰é‡Šæ”¾é¡µçš„æ“ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å¯¹é¡µç›¸å…³çš„æ•°æ®ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œåšä¸€äº›æ¸…ç©ºæ“ä½œã€‚æœ€åä¼šè°ƒç”¨<code>tungstenMemoryAllocator.free</code>è¿›è¡ŒçœŸæ­£çš„é‡Šæ”¾ï¼Œå¹¶ä¸”è°ƒç”¨åº•å±‚çš„ExecutoråŒºçš„poolè¿›è¡Œé‡Šæ”¾ã€‚ä¸‹é¢ä¹Ÿä¼šåˆ†æä¸€ä¸‹on-heapå’Œoff-heapçš„ä¸åŒé‡Šæ”¾æ“ä½œã€‚</p>
<p>::Unsafe memory free::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">(MemoryBlock memory)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> (memory.obj == <span class="keyword">null</span>) :</span><br><span class="line">    <span class="string">"baseObject not null; are you trying to use the off-heap allocator to free on-heap memory?"</span>;</span><br><span class="line">  <span class="keyword">assert</span> (memory.pageNumber != MemoryBlock.FREED_IN_ALLOCATOR_PAGE_NUMBER) :</span><br><span class="line">    <span class="string">"page has already been freed"</span>;</span><br><span class="line">  <span class="keyword">assert</span> ((memory.pageNumber == MemoryBlock.NO_PAGE_NUMBER)</span><br><span class="line">          || (memory.pageNumber == MemoryBlock.FREED_IN_TMM_PAGE_NUMBER)) :</span><br><span class="line">    <span class="string">"TMM-allocated pages must be freed via TMM.freePage(), not directly in allocator free()"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (MemoryAllocator.MEMORY_DEBUG_FILL_ENABLED) &#123;</span><br><span class="line">    memory.fill(MemoryAllocator.MEMORY_DEBUG_FILL_FREED_VALUE);</span><br><span class="line">  &#125;</span><br><span class="line">  Platform.freeMemory(memory.offset);</span><br><span class="line">  <span class="comment">// As an additional layer of defense against use-after-free bugs, we mutate the</span></span><br><span class="line">  <span class="comment">// MemoryBlock to reset its pointer.</span></span><br><span class="line">  memory.offset = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Mark the page as freed (so we can detect double-frees).</span></span><br><span class="line">  memory.pageNumber = MemoryBlock.FREED_IN_ALLOCATOR_PAGE_NUMBER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªè¿‡ç¨‹ä¹Ÿå¾ˆç®€å•ï¼Œè°ƒç”¨<code>Unsafe.freeMemory</code>è¿›è¡Œå†…å­˜é‡Šæ”¾ï¼Œå°†é¡µå¯¹è±¡è®¾ç½®ä¸ºä¸€ä¸ªæ¸…ç©ºåçš„çŠ¶æ€ã€‚</p>
<p>::Heap memory free::</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">(MemoryBlock memory)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> (memory.obj != <span class="keyword">null</span>) :</span><br><span class="line">    <span class="string">"baseObject was null; are you trying to use the on-heap allocator to free off-heap memory?"</span>;</span><br><span class="line">  <span class="keyword">assert</span> (memory.pageNumber != MemoryBlock.FREED_IN_ALLOCATOR_PAGE_NUMBER) :</span><br><span class="line">    <span class="string">"page has already been freed"</span>;</span><br><span class="line">  <span class="keyword">assert</span> ((memory.pageNumber == MemoryBlock.NO_PAGE_NUMBER)</span><br><span class="line">          || (memory.pageNumber == MemoryBlock.FREED_IN_TMM_PAGE_NUMBER)) :</span><br><span class="line">    <span class="string">"TMM-allocated pages must first be freed via TMM.freePage(), not directly in allocator "</span> +</span><br><span class="line">      <span class="string">"free()"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> size = memory.size();</span><br><span class="line">  <span class="keyword">if</span> (MemoryAllocator.MEMORY_DEBUG_FILL_ENABLED) &#123;</span><br><span class="line">    memory.fill(MemoryAllocator.MEMORY_DEBUG_FILL_FREED_VALUE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Mark the page as freed (so we can detect double-frees).</span></span><br><span class="line">  memory.pageNumber = MemoryBlock.FREED_IN_ALLOCATOR_PAGE_NUMBER;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// As an additional layer of defense against use-after-free bugs, we mutate the</span></span><br><span class="line">  <span class="comment">// MemoryBlock to null out its reference to the long[] array.</span></span><br><span class="line">  <span class="keyword">long</span>[] array = (<span class="keyword">long</span>[]) memory.obj;</span><br><span class="line">  memory.setObjAndOffset(<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> alignedSize = ((size + <span class="number">7</span>) / <span class="number">8</span>) * <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">if</span> (shouldPool(alignedSize)) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      LinkedList&lt;WeakReference&lt;<span class="keyword">long</span>[]&gt;&gt; pool = bufferPoolsBySize.get(alignedSize);</span><br><span class="line">      <span class="keyword">if</span> (pool == <span class="keyword">null</span>) &#123;</span><br><span class="line">        pool = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        bufferPoolsBySize.put(alignedSize, pool);</span><br><span class="line">      &#125;</span><br><span class="line">      pool.add(<span class="keyword">new</span> WeakReference&lt;&gt;(array));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Do nothing</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†å†…å­˜åŒºåŸŸç½®ä¸ºç©ºï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå¤§å†…å­˜å—çš„è¯å°±ä¿ç•™å¼±å¼•ç”¨ï¼Œä»¥ä¾›ä¸‹æ¬¡éœ€è¦çš„æ—¶å€™ç›´æ¥è¿›è¡Œä½¿ç”¨ã€‚ä¸ºäº†åŠ å¤§å‘½ä¸­æ¦‚ç‡å¯ä»¥çœ‹åˆ°åœ¨è®¡ç®—å ç”¨å†…å­˜çš„æ—¶å€™éƒ½ä¼šæ‰¾åˆ°æ¯”å½“å‰å†…å­˜å¤§çš„æœ€è¿‘çš„ä¸€ä¸ª8çš„å€æ•°ï¼Œä¿è¯äº†ä»å¼±å¼•ç”¨åŒºåŸŸä¸­æ‰¾åˆ°çš„ä¸€å®šæ˜¯è¶³å¤Ÿèƒ½è£…çš„ä¸‹æ•°æ®ä¸­æœ€å°çš„ä¸€å—ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.cnblogs.com/johnny666888/p/11197519.html" target="_blank" rel="noopener">spark æºç åˆ†æä¹‹åäº” â€” Sparkå†…å­˜ç®¡ç†å‰–æ - JohnnyBai - åšå®¢å›­</a><br><a href="https://github.com/hustnn/TungstenSecret" target="_blank" rel="noopener">GitHub - hustnn/TungstenSecret: Explore the project Tungsten</a><br><a href="https://www.uml-diagrams.org/examples/java-6-thread-state-machine-diagram-example.html" target="_blank" rel="noopener">Java 6 thread states and life cycle UML protocol state machine diagram example.</a></p>

	
	</div>
  <a type="button" href="/2020/09/10/a18/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/03/22/a17/" >Mongodb CDCé“¾è·¯ä¸­çš„æœ‰åºæ€§</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-03-22  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡å½“ä¸­æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œç”¨æˆ·æ¯æ”¶åˆ°ä¸€ç¬”è½¬è´¦ä»¥åï¼Œå°±ä¼šé€šè¿‡æ¨é€æœåŠ¡ç»™ç”¨æˆ·å‘é€ä¸€ä¸ªé€šçŸ¥ï¼Œè€Œè¿™äº›é€šçŸ¥ä¹‹é—´éœ€è¦ä¿è¯å…ˆåé¡ºåºï¼ˆå³å¸å•çš„äº§ç”Ÿæ—¶åºï¼‰ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•æ•°æ®ç»“æ„<code>Bill</code>ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"_id"</span>: ObjectId</span><br><span class="line">	<span class="string">"fromUserId"</span>: String,</span><br><span class="line">	<span class="attr">"toUserId"</span>: String,</span><br><span class="line">	<span class="attr">"amount"</span>: Double,</span><br><span class="line">	<span class="attr">"createdAt"</span>: Long</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fromUserId</code>æ˜¯è½¬è´¦ç”¨æˆ·çš„idï¼Œ<code>toUserId</code>æ˜¯æ”¶æ¬¾ç”¨æˆ·çš„idï¼Œ<code>amount</code>æ˜¯è½¬è´¦é‡‘é¢ï¼Œ<code>createdAt</code>æ˜¯è®°å½•åˆ›å»ºçš„æ—¥æœŸã€‚</p>
<p>ç³»ç»Ÿä¸­ä½¿ç”¨å®‰è£…äº†<code>debezium connector for mongodb</code>æ’ä»¶çš„<code>kafka connect</code>æ¥å°†mongodb oplogæ”¶é›†åˆ°kafkaä¸­ï¼Œä¸‹æ¸¸ä½¿ç”¨<code>flink streaming task</code>æ¥è¿›è¡Œæ¶ˆè´¹å¹¶è§¦å‘æ¨é€æœåŠ¡ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­æ•°æ®ä¼šæµè¿‡å¤šä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¦‚ä½•ä¿è¯åœ¨æµç»è¿™äº›ç³»ç»Ÿä»¥åè¿˜èƒ½ä¿è¯è®°å½•çš„äº§ç”Ÿé¡ºåºå°±æ˜¯ä»Šå¤©è¦è®¨è®ºçš„é—®é¢˜ã€‚</p>
<h2 id="Kafka-connect-amp-amp-Kafka"><a href="#Kafka-connect-amp-amp-Kafka" class="headerlink" title="Kafka connect &amp;&amp; Kafka"></a>Kafka connect &amp;&amp; Kafka</h2><p>æ‰€æœ‰çš„<code>Bill oplog</code>éƒ½ä¼šè¢«å‘é€åˆ°åŒä¸€ä¸ª<code>Kafka topic</code>ä¸­ï¼Œæ‰€ä»¥åªéœ€è¦ä¿è¯åœ¨å‘å¾€Kafkaçš„è¿‡ç¨‹å½“ä¸­ä½¿ç”¨<code>toUserId</code>ä½œä¸º Partition Keyå³å¯ã€‚ä½†æ˜¯ç”±äºä½¿ç”¨äº†å¼€æºç»„ä»¶æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆäº†æ”¶é›†oplogçš„ä»»åŠ¡ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯<code>debezium connector for mongodb</code>èƒ½å¦‚æˆ‘ä»¬çš„æ„¿ã€‚</p>
<p>é¦–å…ˆéœ€è¦çŸ¥é“çš„æ˜¯<code>Kafka connect</code>é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„åˆ†åŒºç­–ç•¥æ˜¯<code>org.apache.kafka.clients.producer.DefaultPartitioner</code>ï¼Œå…¶ä¸­<code>partition</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Compute the partition for the given record.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> topic The topic name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key The key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keyBytes serialized key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value The value to partition on or null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> valueBytes serialized value to partition on or null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cluster The current cluster metadata</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">    List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line">    <span class="keyword">int</span> numPartitions = partitions.size();</span><br><span class="line">    <span class="keyword">if</span> (keyBytes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextValue = nextValue(topic);</span><br><span class="line">        List&lt;PartitionInfo&gt; availablePartitions = cluster.availablePartitionsForTopic(topic);</span><br><span class="line">        <span class="keyword">if</span> (availablePartitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> part = Utils.toPositive(nextValue) % availablePartitions.size();</span><br><span class="line">            <span class="keyword">return</span> availablePartitions.get(part).partition();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// no partitions are available, give a non-available partition</span></span><br><span class="line">            <span class="keyword">return</span> Utils.toPositive(nextValue) % numPartitions;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// hash the keyBytes to choose a partition</span></span><br><span class="line">        <span class="keyword">return</span> Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">nextValue</span><span class="params">(String topic)</span> </span>&#123;</span><br><span class="line">    AtomicInteger counter = topicCounterMap.get(topic);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == counter) &#123;</span><br><span class="line">        counter = <span class="keyword">new</span> AtomicInteger(ThreadLocalRandom.current().nextInt());</span><br><span class="line">        AtomicInteger currentCounter = topicCounterMap.putIfAbsent(topic, counter);</span><br><span class="line">        <span class="keyword">if</span> (currentCounter != <span class="keyword">null</span>) &#123;</span><br><span class="line">            counter = currentCounter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> counter.getAndIncrement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœkeyæ˜¯ç©ºçš„ï¼Œåˆ™ä»¥è½®è®­çš„æ–¹å¼æ¥åˆ†é…<code>partition</code>ï¼Œå¦åˆ™åˆ™ä½¿ç”¨ä¸€ç§<code>murmur2</code>çš„HASHç®—æ³•æ¥åˆ†é…<code>partition</code>ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†message keyè®¾ç½®ä¸º<code>toUserId</code>å³å¯è¾¾æˆæˆ‘ä»¬çš„ç›®çš„ã€‚ä½†æ˜¯ <a href="https://debezium.io/documentation/reference/1.0/connectors/mongodb.html#mongodb-change-events-key" target="_blank" rel="noopener">Debezium Connector for MongoDB :: Change eventâ€™s key</a> ä¸­å†™é“ï¼Œmessage keyåªèƒ½æ˜¯<code>_id</code>ï¼Œè€Œ<code>toUserId</code>ä¸å…·æœ‰å”¯ä¸€æ€§ï¼Œæ‰€ä»¥ä¸èƒ½ä½œä¸º<code>_id</code>ï¼›å¦‚æœåŠ ä¸Šæ—¶é—´æˆ³æˆ–è€…å…¶ä»–çš„å­—æ®µä¿è¯äº†å”¯ä¸€æ€§ï¼Œåˆå¤±å»äº†è¦å°†ç›¸åŒ<code>toUserId</code>æ”¾åœ¨ä¸€ä¸ªåˆ†åŒºçš„è¯­ä¹‰ï¼Œæ‰€ä»¥è¿™æ¡è·¯åŸºæœ¬æ˜¯èµ°ä¸é€šçš„ã€‚</p>
<blockquote>
<p>The MongoDB connector does not make any explicit determination of the topic partitions for events. Instead, it allows Kafka to determine the partition based upon the key. You can change Kafkaâ€™s partitioning logic by defining in the Kafka Connect worker configuration the name of the Partitioner implementation.<br>Be aware that Kafka only maintains total order for events written to a single topic partition. Partitioning the events by key does mean that all events with the same key will always go to the same partition, ensuring that all events for a specific document are always totally ordered.</p>
</blockquote>
<p>ç»§ç»­å¯»æ‰¾å…¶ä»–çš„å˜é€šæ–¹æ³•ï¼Œ<a href="https://debezium.io/documentation/reference/1.0/connectors/mongodb.html#partitions" target="_blank" rel="noopener">Debezium Connector for MongoDB :: Partitions</a> æ–‡æ¡£ä¸­å†™åˆ°å¯ä»¥é€šè¿‡è®¾ç½® Kafka connect worker çš„<code>Partitioner</code>è®¾ç½®æ¥æŒ‡å®šåˆ†åŒºç­–ç•¥ã€‚ä¹Ÿå°±æ˜¯ <a href="http://kafka.apache.org/documentation.html#producerconfigs" target="_blank" rel="noopener">Apache Kafka</a> æ–‡æ¡£ä¸­æåˆ°çš„<code>partitioner.class</code>ï¼š</p>
<blockquote>
<p>partitioner.class: Partitioner class that implements the org.apache.kafka.clients.producer.Partitioner interface.<br>Type: classDefault: org.apache.kafka.clients.producer.internals.DefaultPartitioner</p>
</blockquote>
<p>å³éœ€è¦è‡ªå·±é€šè¿‡ç»§æ‰¿<code>Partitioner</code>æ¥å£æ¥å®ç°è‡ªå·±çš„åˆ†åŒºç­–ç•¥ï¼Œè¦å®ç°<code>partitionæ–¹æ³•</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°äº†ä¹‹åå°†åŒ…å«è¯¥ç±»çš„JARåŒ…æ”¾å…¥Kafka connectèƒ½æ‰«æçš„è·¯å¾„ä¸‹ï¼Œå†åœ¨<code>connect-standalone.properties</code>æˆ–è€…<code>connect-distributed.properties</code>é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œå…¨å±€çš„è®¾å®šã€‚å¯ä»¥å‚è§ä¸‹é¢ä¸¤ä¸ªé“¾æ¥ğŸ‘‡ï¼š</p>
<ul>
<li><a href="https://stackoverflow.com/questions/55188508/custom-partition-assignment-in-kafka-jdbc-connector" target="_blank" rel="noopener">java - Custom partition assignment in Kafka JDBC connector - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/questions/44810221/setting-partition-strategy-in-a-kafka-connector" target="_blank" rel="noopener">java - Setting Partition Strategy in a Kafka Connector - Stack Overflow</a></li>
</ul>
<p>é‚£ä¹ˆè¯•æƒ³ä¸€ä¸‹æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ä¸æ˜¯å°±å¯ä»¥å®ç°ä¸ºï¼Œå°†<code>toUserId</code>å’Œæ—¶é—´æˆ³æ‹¼æ¥ä¸ºå”¯ä¸€æ€§çš„<code>_id</code>ï¼Œåœ¨partitionå‡½æ•°ä¸­å°†<code>toUserId</code>æå–å‡ºæ¥å¹¶ä»¥æ­¤ä½œä¸ºpartition keyè¿›è¡Œåˆ†åŒºä»¥å®ç°åœ¨kafkaä¸­ä¿è¯é¡ºåºçš„ç›®çš„ã€‚ä½†æ˜¯è¿™æ ·çš„å®ç°æ–¹æ¡ˆä¹Ÿå­˜åœ¨é—®é¢˜ï¼Œæ¯”å¦‚è¿™ä¸ªKafka connect ä»…æ¥ä¸ºè¿™ä¸ªä»»åŠ¡æœåŠ¡ï¼Œå› ä¸ºè¿™ç§åˆ†åŒºç­–ç•¥å¹¶ä¸å…·æœ‰é€šç”¨æ€§ï¼Œå¦‚æœæœ‰å¤šä¸ªç±»ä¼¼çš„éœ€æ±‚åˆ™è¦éƒ¨ç½²å¤šä»½Kafka connectã€‚åŒæ—¶ä¹Ÿå­˜åœ¨ä¸€äº›å¥½å¤„ï¼Œä¾‹å¦‚æ‹¼æ¥çš„<code>_id</code>æ˜¯å¯ä»¥ç›´æ¥ä½œä¸ºMongodbçš„shard keyæ¥å¯¹è¯¥åœºæ™¯çš„ä¸Šæ¸¸è¿›è¡Œæ¨ªå‘æ‰©å±•çš„ã€‚å¯æƒœçš„æ˜¯debeziumçš„å®ç°å¹¶ä¸èƒ½ä¿è¯shard clusterä¼ å…¥kafkaæ—¶ä¿è¯äº‹ä»¶çš„å‘ç”Ÿé¡ºåºï¼Œè™½ç„¶èƒ½å°†æ‹¼æ¥çš„<code>_id</code>ä½œä¸ºshard keyï¼Œä½†æ˜¯ç”±äºè¿™ç§æ¶æ„å¹¶æ²¡æœ‰èƒ½åŠ›ä¿è¯é¡ºåºæ€§ï¼Œæ‰€ä»¥è¿™ç§æ‰©å±•ä¹Ÿæ˜¯æ— æ•ˆçš„ï¼Œå‚è§ğŸ‘‡ï¼š<br><a href="https://debezium.io/documentation/reference/1.0/connectors/mongodb.html#mongodb-sharded-cluster" target="_blank" rel="noopener">Debezium Connector for MongoDB :: MongoDB sharded cluster</a></p>
<p>ç»¼ä¸Šåœ¨è¯¥æ¶æ„ä¸­å¦‚æœæƒ³åœ¨Kafkaå±‚ä¿è¯äº‹ä»¶çš„æœ‰åºæ€§æ˜¯éå¸¸å›°éš¾ï¼Œå¹¶ä¸”å¾ˆä¸ç»æµå®æƒ ã€‚</p>
<h2 id="Flink-streaming"><a href="#Flink-streaming" class="headerlink" title="Flink streaming"></a>Flink streaming</h2><p>é€šè¿‡ä¸Šæ–‡çš„åˆ†æï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ¥å—ä¸€ä¸ªäº‹å®ï¼Œ<code>Flink</code>æ¶ˆè´¹åˆ°çš„æ˜¯ä¹±åºæ•°æ®ã€‚ä½†æ˜¯å› ä¸ºå…¶ç‰¹æ€§ï¼Œèƒ½è¾ƒä¸ºæ–¹ä¾¿çš„å¯¹ä¹±åºæ•°æ®è¿›è¡Œå¤„ç†ã€‚<br>åœ¨debeziumæ”¶é›†åˆ°çš„oplogä¸­ï¼ŒåŒ…å«ä¸¤ä¸ªæ—¶é—´æˆ³ï¼Œä¸€ä¸ªæ˜¯åœ¨Value payloadä¸­çš„<code>ts_ms</code>ï¼Œè¡¨ç¤ºçš„æ˜¯debeziumæ”¶é›†è¯¥oplogæ—¶çš„ç³»ç»Ÿæ—¶é—´ï¼›å¦å¤–ä¸€ä¸ªæ˜¯åœ¨Value payloadä¸­çš„<code>source.ts_ms</code>ï¼Œè¡¨ç¤ºçš„æ˜¯mongodbäº§ç”Ÿoplogçš„æ—¶é—´ã€‚è€Œæˆ‘ä»¬çš„å®ä½“ç±»ä¸­ä¹Ÿå†™å…¥äº†Create billçš„æ—¶é—´<code>createdAt</code>ï¼Œç”±äºåªå…³å¿ƒ<code>Insert</code>äº‹ä»¶ï¼Œæ‰€ä»¥åœ¨Value payloadçš„<code>after.createdAt</code>ä¸­èƒ½è·å–Billåˆ›å»ºçš„çœŸå®æ—¶é—´ã€‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸€èˆ¬ä»¥ç¬¬äºŒä¸ªæ—¶é—´æˆ–è€…ç¬¬ä¸‰ä¸ªæ—¶é—´ä¸ºå‡†ï¼Œåœ¨æ²¡æœ‰é‡‡ç”¨shard clusterçš„mongodbä¸­ï¼Œæˆ‘è®¤ä¸ºç¬¬äºŒä¸ªæ—¶é—´çš„å…ˆåæ¬¡åºåº”è¯¥ä¸ç¬¬ä¸‰ä¸ªæ—¶é—´çš„å…ˆåæ¬¡åºç›¸åŒï¼›é‡‡ç”¨äº†shard clusterçš„mongodbä¸­ï¼Œåº”è¯¥ä»¥ç¬¬ä¸‰ä¸ªæ—¶é—´ä¸ºå‡†ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">"payload": &#123;</span><br><span class="line">      "after": ...,</span><br><span class="line">      "patch": null,</span><br><span class="line">      "source": &#123;</span><br><span class="line">        "version": "1.0.3.Final",</span><br><span class="line">        "connector": "mongodb",</span><br><span class="line">        "name": "cdc_test",</span><br><span class="line">        "ts_ms": 1558965508000,</span><br><span class="line">        "snapshot": true,</span><br><span class="line">        "db": "inventory",</span><br><span class="line">        "rs": "rs0",</span><br><span class="line">        "collection": "bill",</span><br><span class="line">        "ord": 31,</span><br><span class="line">        "h": 1546547425148721999</span><br><span class="line">      &#125;,</span><br><span class="line">      "op": "r",</span><br><span class="line">      "ts_ms": 1558965515240</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨Flinkçš„æ—¶é—´æ¦‚å¿µä¸­ä¹Ÿæœ‰ä¸‰ç§æ—¶é—´ï¼š</p>
<ul>
<li>äº‹ä»¶æ—¶é—´ï¼šç‹¬ç«‹äº‹ä»¶åœ¨äº§ç”Ÿå®ƒçš„è®¾å¤‡ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œé€šå¸¸åœ¨è¿›å…¥Flinkä¹‹å‰å°±å·²ç»åµŒå…¥åˆ°äº‹ä»¶ä¸­ã€‚</li>
<li>æ¥å…¥æ—¶é—´ï¼šæ•°æ®è¿›å…¥Flinkçš„æ—¶é—´ï¼Œå–å†³äºSource Operatoræ‰€åœ¨ä¸»æœºçš„ç³»ç»Ÿæ—¶é’Ÿã€‚</li>
<li>å¤„ç†æ—¶é—´ï¼šæ•°æ®åœ¨æ“ä½œç®—å­è®¡ç®—è¿‡ç¨‹ä¸­è·å–åˆ°çš„æ‰€åœ¨ä¸»æœºæ—¶é—´ã€‚</li>
</ul>
<p>æ˜¾ç„¶åœ¨è¯¥åœºæ™¯ä¸‹åº”è¯¥é€‰æ‹©<code>Bill</code>çš„åˆ›å»ºæ—¶é—´ä½œä¸ºFlinkçš„äº‹ä»¶æ—¶é—´ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">env.addSource(<span class="type">Utils</span>.providesAvroKafkaConsumer(kafkaConfig))</span><br><span class="line">    .map(recordTuple =&gt; <span class="type">AvroMongoOplog</span>.newInstance(recordTuple._1.asInstanceOf[<span class="type">Record</span>], recordTuple._2.asInstanceOf[<span class="type">Record</span>]))</span><br><span class="line">    .filter(mongoOplog =&gt; mongoOplog.getOpType.eq(<span class="type">MongoOpType</span>.<span class="type">Insert</span>))</span><br><span class="line">    .assignAscendingTimestamps(mongoOplog =&gt; mongoOplog.getDocument.getLong(<span class="string">"createdAt"</span>))</span><br><span class="line">	  .keyBy(mongoOplog =&gt; mongoOplog.getDocument.get(<span class="string">"toUserId"</span>))</span><br><span class="line">    .window(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">    .process(...)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>è¿æ¥Kafkaï¼Œä½¿ç”¨å®ç°çš„<code>KeyedAvroDeserializationSchema</code>è¿›è¡Œååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.confluent.kafka.schemaregistry.client.CachedSchemaRegistryClient</span><br><span class="line"><span class="keyword">import</span> org.apache.avro.generic.GenericRecord</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.typeinfo.TypeInformation</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.formats.avro.registry.confluent.ConfluentRegistryAvroDeserializationSchema</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.KafkaDeserializationSchema</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord</span><br><span class="line"></span><br><span class="line"><span class="meta">@SerialVersionUID</span>(<span class="number">1584533572114L</span>)</span><br><span class="line">class KeyedAvroDeserializationSchema extends KafkaDeserializationSchema[(GenericRecord, GenericRecord)] &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> keyDeserializer: ConfluentRegistryAvroDeserializationSchema[GenericRecord] = _</span><br><span class="line">    <span class="keyword">var</span> valueDeserializer: ConfluentRegistryAvroDeserializationSchema[GenericRecord] = _</span><br><span class="line"></span><br><span class="line">    <span class="function">def <span class="title">this</span><span class="params">(topic: String, schemaRegistry: String)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>()</span><br><span class="line">        val keySubject = topic + <span class="string">"-key"</span></span><br><span class="line">        val valueSubject = topic + <span class="string">"-value"</span></span><br><span class="line">        val schemaRegistryClient = <span class="keyword">new</span> CachedSchemaRegistryClient(schemaRegistry, <span class="number">1000</span>)</span><br><span class="line">        val keySchema = schemaRegistryClient.getByID(schemaRegistryClient.getLatestSchemaMetadata(keySubject).getId)</span><br><span class="line">        val valueSchema = schemaRegistryClient.getByID(schemaRegistryClient.getLatestSchemaMetadata(valueSubject).getId)</span><br><span class="line">        keyDeserializer = ConfluentRegistryAvroDeserializationSchema.forGeneric(keySchema, schemaRegistry)</span><br><span class="line">        valueDeserializer = ConfluentRegistryAvroDeserializationSchema.forGeneric(valueSchema, schemaRegistry)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">override def <span class="title">isEndOfStream</span><span class="params">(t: (GenericRecord, GenericRecord)</span>): Boolean </span>= <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">    <span class="function">override def <span class="title">deserialize</span><span class="params">(consumerRecord: ConsumerRecord[Array[Byte], Array[Byte]])</span>: <span class="params">(GenericRecord, GenericRecord)</span></span></span><br><span class="line"><span class="function">    </span>= (keyDeserializer.deserialize(consumerRecord.key()), valueDeserializer.deserialize(consumerRecord.value()))</span><br><span class="line"></span><br><span class="line">    override def getProducedType: TypeInformation[(GenericRecord, GenericRecord)] = createTypeInformation[(GenericRecord, GenericRecord)]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ä¸€ä¸ªå·¥å…·ç±»å°†<code>(Record,Record)</code>è½¬åŒ–ä¸ºæ›´å¥½å¤„ç†çš„<code>MongoOplogEntry</code>ç±»å‹</p>
</li>
<li><p>è¿‡æ»¤å‡ºæ‰€æœ‰çš„<code>Insert</code>äº‹ä»¶</p>
</li>
<li><p>å°†<code>Bill</code>çš„åˆ›å»ºæ—¶é—´ä½œä¸ºFlinkçš„äº‹ä»¶æ—¶é—´</p>
</li>
<li><p>æŒ‰ç…§<code>toUserId</code>è¿›è¡Œåˆ†åŒº</p>
</li>
<li><p>è®¾ç½®10ç§’çš„æ—¶é—´çª—å£</p>
</li>
<li><p>åœ¨çª—å£å¤„ç†å‡½æ•°ä¸­å¯¹æ‰€æœ‰<code>MongoOplogEntry</code>å¯¹è±¡æŒ‰ç…§<code>createdAt</code>å†æ’åºåä¾æ¬¡è§¦å‘æ¨é€æœåŠ¡</p>
</li>
</ul>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ä»¥ä¸Šä»‹ç»äº†åœ¨Mongodb CDCè¿‡ç¨‹ä¸­ä¿è¯æ•°æ®æœ‰åºæ€§çš„ä¸¤ç§æ€è·¯ï¼Œä¸€ç§æ˜¯åœ¨Kafkaä¸­å°±ä¿è¯<code>toUserId</code>ç›¸åŒçš„æ•°æ®å‡æœ‰åºï¼Œè¿™æ ·åœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­ä¸éœ€è¦åšçª—å£è®¡ç®—ï¼Œåªè¦åœ¨éœ€è¦partitionçš„åœ°æ–¹ç»§ç»­ä½¿ç”¨<code>toUserId</code>è¿›è¡Œpartitionï¼Œå°±èƒ½ä¿è¯æ•°æ®æœ‰åºæ€§ã€‚è¿™ç§æ–¹æ¡ˆåœ¨Kafka connectä¾§éœ€è¦åšå¾ˆå¤šçš„å·¥ä½œï¼Œä½†æ˜¯èƒ½ä¸ºæµå¼ä»»åŠ¡å¸¦æ¥æ›´å¥½çš„æ¶ˆè´¹æ€§èƒ½ï¼Œä½†æ˜¯ç”±äºdebeziumçš„å±€é™æ€§ï¼Œåœ¨shard clusterçš„Mongodbä¸­ä¸èƒ½å‘æŒ¥ä½œç”¨ã€‚ç¬¬äºŒç§æ˜¯è®©Flinkæ¶ˆè´¹ä¹±åºæ•°æ®ï¼Œä½¿ç”¨å…¶æœ¬èº«çš„äº‹ä»¶æ—¶é—´çª—å£è®¡ç®—æ¥é‡æ–°çº æ­£æ•°æ®ã€‚è¿™ç§æ–¹æ¡ˆä¼šè®©Flinkçš„æ•ˆç‡å¤§æ‰“æŠ˜æ‰£ï¼Œå¹¶ä¸”éœ€è¦ä¿è¯çª—å£ç¼“å­˜æ•°æ®ä¸èƒ½è¶…è¿‡é™åˆ¶ï¼Œä½†æ˜¯æ¯”è¾ƒé€šç”¨ï¼Œä½¿ç”¨çš„æ—¶å€™ä¹Ÿéœ€è¦æ³¨æ„è¿Ÿåˆ°çš„æ•°æ®è¯¥å¦‚ä½•å¤„ç†ã€‚å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„åœºæ™¯æ¥æŒ‘é€‰æ–¹æ¡ˆï¼Œæˆ–è€…å¦‚æœæœ‰æ›´å¥½çš„æ–¹æ¡ˆæ¬¢è¿ä¸€èµ·äº¤æµã€‚</p>

	
	</div>
  <a type="button" href="/2020/03/22/a17/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/01/20/a16/" >URLEncoder in JAVA</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-01-20  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>å‘ç°<code>Webclient</code>çš„<code>URLEncoder</code>çš„è¡¨ç°éå¸¸ä¸ç¨³å®šï¼Œæ‰€ä»¥æ‰¾äº†ä¸€ä¸‹æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªissue <a href="https://github.com/spring-projects/spring-boot/issues/8888" target="_blank" rel="noopener">TestRestTemplate does the url encoding twice if I pass the URI as a string Â· Issue #8888 Â· spring-projects/spring-boot Â· GitHub</a> ï¼Œä¸€ä¸ªè€å“¥å‘ç°å½“<code>exchange</code> é‡Œä¼ å…¥ <code>URI</code> ç±»çš„æ—¶å€™ï¼Œ<code>exchange</code>ä¸ä¼šæœ‰ä»»ä½•encodeè¡Œä¸ºï¼Œä½†æ˜¯åœ¨ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ä¼šè¢«encodeã€‚</p>
<p>ä¸‹é¢æœ‰<code>bclozel</code>çš„å›ç­”ğŸ‘‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Hi  [@georgmittendorfer](https://github.com/georgmittendorfer) ,</span><br><span class="line">I think this is the expected behavior in Spring Framework (see  [SPR-16202](https://jira.spring.io/browse/SPR-16202)  and  [SPR-14828](https://jira.spring.io/browse/SPR-14828)  for some background on this).</span><br><span class="line">As a general rule, providing a URI String to RestTemplate means that this String should be expanded (using optional method parameters) and then encoded. If you want to take full control over the encoding, you should then use the method variant taking a URI as a parameter.</span><br><span class="line">The Spring Framework team recently added  [some more documentation on the subject of URI encoding](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/web.html#web-uri-encoding) . Does that help?</span><br></pre></td></tr></table></figure>

<p>çœ‹æ¥Springè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ­£å¸¸çš„è¡Œä¸ºï¼Œå³<strong>ä¼ å…¥å­—ç¬¦ä¸²çš„æ—¶å€™æˆ‘å°±è¦å¯¹ä½ è¿›è¡Œencodeï¼Œä½ ä¼ URIå¯¹è±¡çš„æ—¶å€™æˆ‘ä¸ç®¡</strong>ã€‚ç»§ç»­ç‚¹è¿›å»çœ‹çœ‹å®˜æ–¹æ–‡æ¡£ <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/web.html#web-uri-encoding" target="_blank" rel="noopener">Web on Servlet Stack</a>ï¼š<br>1.5.3 ä¸­è¢«è¡¥ä¸Šäº†è¯¦ç»†çš„ä½¿ç”¨ç»†èŠ‚ï¼Œé¦–å…ˆå®ƒå°†<code>URI</code>çš„ç»„æˆåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªå«åš<code>URI template</code>ï¼Œä¸€ä¸ªå«åš<code>URI variables</code>ã€‚ç„¶åæä¾›äº†4ç§encodeçš„æ¨¡å¼ï¼š</p>
<ul>
<li><code>TEMPLATE_AND_VALUES</code>ï¼šä¼šå…ˆå¯¹templateè¿›è¡Œencodeï¼Œç„¶ååœ¨æ‰©å±•çš„æ—¶å€™å†å¯¹variablesè¿›è¡Œencodeã€‚</li>
<li><code>VALUES_ONLY</code>ï¼šä¸ä¼šå¯¹templateè¿›è¡Œencodeï¼Œåœ¨æ‰©å±•ä¹‹å‰å¯¹variablesè¿›è¡Œencodeã€‚</li>
<li><code>URI_COMPONENTS</code>ï¼šå’Œç¬¬äºŒç§ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯åœ¨æ‰©å±•ä¹‹åå¯¹valuesè¿›è¡Œencodeã€‚</li>
<li><code>NONE</code>ï¼šä¸åšä»»ä½•çš„encodeã€‚</li>
</ul>
<p>å†æ¥çœ‹çœ‹æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ï¼Œåœ¨æˆ‘ä»¬çš„ä¸€ä¸ªåº“ä¸­ï¼Œç”¨é”™è¯¯çš„å§¿åŠ¿ä½¿ç”¨çš„<code>URI</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> webClient</span><br><span class="line">    .get()</span><br><span class="line">    .uri(<span class="string">"/doItemHighCommissionPromotionLinkByAll?"</span> + Utils.pojo2UrlQuery(request))</span><br><span class="line">    .exchange();</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥ä¼ å…¥äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¼šå‘ç°è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBodySpec <span class="title">uri</span><span class="params">(String uriTemplate, Object... uriVariables)</span> </span>&#123;</span><br><span class="line">	attribute(URI_TEMPLATE_ATTRIBUTE, uriTemplate);</span><br><span class="line">	<span class="keyword">return</span> uri(uriBuilderFactory.expand(uriTemplate, uriVariables));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸæ¥æˆ‘ä»¬ä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å ä½ç¬¦çš„<code>uriTemplate</code>ï¼Œè€Œç°åœ¨ä¾èµ–çš„<code>WebClient</code>ç‰ˆæœ¬ä¸­é»˜è®¤çš„encodeæ¨¡å¼æ˜¯<code>EncodingMode.URI_COMPONENTS</code>ï¼Œä¹Ÿå°±æ˜¯æ ¹æœ¬ä¸ä¼šç®¡templateéƒ¨åˆ†ã€‚æ‰€ä»¥æˆ‘ä»¬å‘ç°ä¸ºä»€ä¹ˆä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™æ²¡æœ‰è¢«è‡ªåŠ¨encodeã€‚</p>
<p>é‚£ä¹ˆæ˜¯ä¸æ˜¯æŠŠencodeæ¨¡å¼æ”¹ä¸º<code>EncodingMode. TEMPLATE_AND_VALUES</code>ï¼Œè®©å®ƒä¼šencode templateå°±æ²¡é—®é¢˜äº†å‘¢ï¼Ÿä¹Ÿä¸æ˜¯ï¼Œæ¯”å¦‚<code>http://api.vephp.com/hcapi?detail=1&amp;vekey=V00003484Y95498091&amp;para=https://uland.taobao.com/coupon/edetail?activityId=8932eb9980234090851d448195fe363c&amp;itemId=578614572836</code><br>è¿™ä¸ªurlï¼Œparaä¼ å…¥çš„åˆæ˜¯ä¸€ä¸ªurlï¼Œè·Ÿäº†ä¸€ä¸‹è§£æä»£ç ï¼Œä¼šå‘ç°templateåœ¨è§£æçš„æ—¶å€™ä¼šæŠŠquery mapè§£æˆï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"detail"</span>: <span class="number">1</span>,</span><br><span class="line">	<span class="attr">"vekey"</span>: <span class="string">"V00003484Y95498091"</span>,</span><br><span class="line">	<span class="attr">"para"</span>: <span class="string">"https://uland.taobao.com/coupon/edetail?activityId=8932eb9980234090851d448195fe363c"</span>,</span><br><span class="line">	<span class="attr">"itemId"</span>: <span class="string">"578614572836"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå®ƒè§£æquery paramsçš„æ­£åˆ™é•¿è¿™æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"([^&amp;=]+)(=?)([^&amp;]+)?"</span></span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åæœæ˜¯<code>para</code>ä¼šè¢«encodeï¼ˆè€Œä¸”è¿˜æ˜¯é”™è¯¯çš„encodeï¼Œè¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹templateçš„encodeï¼Œä¸æ˜¯æ­£ç´§çš„urlEncodeï¼‰ï¼Œä½†æ˜¯<code>itemId</code>éƒ¨åˆ†ä¸ä¼šã€‚æ‰€ä»¥æœ€ç»ˆä¹Ÿåªæ˜¯å¾—åˆ°äº†ä¸€ä¸ªé”™è¯¯çš„encodeç»“æœã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li><p>ä¼ å…¥çš„è¿˜æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸è¿‡åœ¨æ„é€ çš„æ—¶å€™è‡ªå·±å»åšurlEncodeï¼Œç„¶ååœ¨WebClientçš„è®¾ç½®é‡Œå°†encodeæ¨¡å¼è®¾ä¸ºåä¸‰ç§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> WebClient</span><br><span class="line">    .builder()</span><br><span class="line">    .exchangeStrategies(strategies)</span><br><span class="line">    .baseUrl(endpoint)</span><br><span class="line">    .uriBuilderFactory(providesUriBuilderFactory(endpoint));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DefaultUriBuilderFactory <span class="title">providesUriBuilderFactory</span><span class="params">(String endpoint)</span> </span>&#123;</span><br><span class="line">    DefaultUriBuilderFactory factory = <span class="keyword">new</span> DefaultUriBuilderFactory(endpoint);</span><br><span class="line">    factory.setEncodingMode(EncodingMode.NONE);</span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¼ å…¥ä¸€ä¸ª<code>URI</code>å¯¹è±¡ï¼Œæ„é€ çš„æ—¶å€™è‡ªå·±å»åšurlEncodeï¼Œä¸ç”¨å…³å¿ƒWebClienté‡Œçš„è®¾ç½®ã€‚</p>
</li>
<li><p>æ­£ç¡®çš„ä½¿ç”¨<code>url template</code>å’Œ<code>url variables</code>è¿›è¡Œæ„é€ ï¼Œé‚£å°±ä¸ç”¨è‡ªå·±å»åšurlEncodeã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">URI uri = UriComponentsBuilder.fromPath(<span class="string">"/hotel list/&#123;city&#125;"</span>)</span><br><span class="line">        .queryParam(<span class="string">"q"</span>, <span class="string">"&#123;q&#125;"</span>)</span><br><span class="line">        .build(<span class="string">"New York"</span>, <span class="string">"foo+bar"</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>æœ€åä½ å¯èƒ½ä¼šå‘ç°è‡ªå·±åœ¨è¿›è¡ŒurlEncodeçš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šæœ‰é—®é¢˜ã€‚å¯ä»¥é˜…è¯»ä¸‹ <a href="https://stackoverflow.com/questions/14321873/java-url-encoding-urlencoder-vs-uri" target="_blank" rel="noopener">Java URL encoding: URLEncoder vs. URI - Stack Overflow</a> å’Œ  <a href="https://stackoverflow.com/questions/607176/java-equivalent-to-javascripts-encodeuricomponent-that-produces-identical-outpu" target="_blank" rel="noopener">Java equivalent to JavaScriptâ€™s encodeURIComponent that produces identical output? - Stack Overflow</a><br>ç®€å•ç‚¹è¯´å°±æ˜¯ <code>URLEncoder.encode()</code> æ–¹æ³•ä¸æ˜¯ä½ çœŸæ­£æƒ³ç”¨åˆ°çš„æ–¹æ³•ï¼Œä½ å¯ä»¥è¿™æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeURIComponent</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    String result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = URLEncoder.encode(s, <span class="string">"UTF-8"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\+"</span>, <span class="string">"%20"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%21"</span>, <span class="string">"!"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%27"</span>, <span class="string">"'"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%28"</span>, <span class="string">"("</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%29"</span>, <span class="string">")"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%7E"</span>, <span class="string">"~"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        result = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆå¥½å‚»å•Š</p>

	
	</div>
  <a type="button" href="/2020/01/20/a16/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/11/08/a15/" >KVåˆ†å¸ƒå¼äº‹åŠ¡</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-11-08  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="Percolator"><a href="#Percolator" class="headerlink" title="Percolator"></a>Percolator</h2><p><code>Percolator</code>ä¸»è¦ä½¿ç”¨åœ¨Bigtableç³»ç»Ÿä¸­æä¾›åˆ†å¸ƒå¼äº‹åŠ¡èƒ½åŠ›ï¼Œå…¶æœ¬èº«çš„å®ç°æ˜¯åˆ©ç”¨Bigtableçš„å•è¡Œäº‹åŠ¡èƒ½åŠ›ä»¥åŠåœ¨è¡Œå†…è®¾ç½®lockåˆ—æ¥è¿›è¡Œæ‚²è§‚äº‹åŠ¡ã€‚æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;key, version&gt;: &lt;data&gt;, &lt;lock&gt;, &lt;write&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Transaction-Write"><a href="#Transaction-Write" class="headerlink" title="Transaction Write"></a>Transaction Write</h3><ul>
<li>å¼€å¯äº‹åŠ¡ï¼šå‘é›†ä¸­çš„<code>Timestamp server oracle(TSO)</code>èŠ‚ç‚¹ç”³è¯·ä¸€ä¸ªäº‹åŠ¡å¼€å§‹æ—¶é—´æˆ³<code>t(s)</code>ï¼Œå¹¶ä¸”ä»¥æ­¤æ—¶é—´æˆ³åšä¸ºäº‹åŠ¡id</li>
<li>2PCç¬¬ä¸€é˜¶æ®µï¼š<code>Percolator</code>åœ¨ä¸€äº›Write setå½“ä¸­é€‰æ‹©ä¸€è¡Œåšä¸ºPrimaryï¼Œå…¶ä»–çš„è¡Œåšä¸ºSecondariesã€‚å…ˆå¯¹Primaryåš<code>prewrite</code>æ“ä½œï¼Œå¦‚æœæˆåŠŸåˆ™å¯¹å…¶ä»–çš„Secondariesåš<code>prewrite</code>æ“ä½œã€‚<ul>
<li>Prewriteï¼šè¿™ä¸ªæ“ä½œå½“ä¸­æœ‰å¤šä¸ªåŸå­æ“ä½œï¼Œè¢«å°è£…åœ¨ä¸€ä¸ªäº‹åŠ¡å½“ä¸­ï¼Œç”±Bigtableçš„å•è¡Œäº‹åŠ¡æ€§æ¥ä¿è¯ã€‚<ul>
<li>é¦–å…ˆæ£€æŸ¥<code>write</code>æ˜¯å¦æœ‰æ—¶é—´æˆ³å¤§äº<code>t(s)</code>çš„ç‰ˆæœ¬ï¼Œå¦‚æœæœ‰åˆ™è¯´æ˜è¿™è¡Œæ•°æ®å·²ç»è¢«æ–°çš„äº‹åŠ¡æäº¤è¿‡äº†ï¼Œç›´æ¥è¿”å›äº‹åŠ¡å†²çª</li>
<li>ç„¶åæ£€æŸ¥<code>lock</code>æ˜¯å¦æœ‰ä»»æ„ç‰ˆæœ¬çš„æ•°æ®å­˜åœ¨ï¼Œå¦‚æœæœ‰åˆ™è¯´æ˜è¿™è¡Œèµ„æºè¿˜è¢«åˆ«çš„äº‹åŠ¡æŒæœ‰ï¼Œè¿”å›äº‹åŠ¡å†²çª</li>
<li>å¦‚æœå‰é¢çš„æ“ä½œéƒ½æˆåŠŸäº†ï¼Œé‚£ä¹ˆåœ¨<code>data</code>å†™å…¥ç‰ˆæœ¬ä¸º<code>t(s)</code>çš„valueæ•°æ®</li>
<li>å¹¶ä¸”åœ¨<code>lock</code>ä¸­å†™å…¥ç‰ˆæœ¬ä¸º<code>t(s)</code>å€¼ä¸ºprimaryä½ç½®çš„æ•°æ®<br>åœ¨<code>prewrite</code>çš„ç¬¬äºŒéƒ¨æ£€æŸ¥å½“ä¸­ï¼Œå‘ç”Ÿå†²çªæ˜¯æœ‰ä¸‰ç§æƒ…å†µï¼š</li>
</ul>
</li>
</ul>
<ul>
<li>è·å¾—é”çš„ç‰ˆæœ¬å°äº<code>t(s)</code>ï¼Œè¯¥èµ„æºæ­£åœ¨è¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰</li>
<li>è·å¾—é”çš„ç‰ˆæœ¬å°äº<code>t(s)</code>ï¼Œæœ‰ä¸€ä¸ªè€äº‹åŠ¡å› ä¸ºæŸç§åŸå› æ²¡æœ‰æˆåŠŸçš„è¿˜æ‰é”</li>
<li>è·å¾—é”çš„ç‰ˆæœ¬å¤§äº<code>t(s)</code>ï¼Œè¯¥èµ„æºæ­£åœ¨è¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰<br>ä¸Šè¿°æƒ…å†µå½“ä¸­çš„1ï¼Œ3éƒ½æ˜¯å…¸å‹çš„å†™-å†™å†²çªï¼Œclientå°±è¿›è¡Œæ­£å¸¸çš„backoffé‡è¯•å³å¯ã€‚è€Œç¬¬2ç§æƒ…å†µæ˜¯å®¢æˆ·ç«¯åœ¨2PCçš„ç¬¬äºŒé˜¶æ®µå‘ç”Ÿäº†å¼‚å¸¸å¯¼è‡´ï¼Œè¿™æ—¶éœ€è¦rollbackä¹‹å‰çš„äº‹åŠ¡æ¥é‡Šæ”¾æ‰è¿™ä¸ªå¼‚å¸¸çš„é”ã€‚å¹¶ä¸”è¿™é‡Œæ˜¯å¾ˆéš¾åŒºåˆ†1ï¼Œ2çš„ï¼Œæ¯•ç«Ÿé”çš„ç‰ˆæœ¬éƒ½å°äº<code>t(s)</code>ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªé™„ä»¶æ¡ä»¶é”çš„ttlæ—¶é—´ï¼Œå¦‚æœé”å¤„äºttlæ—¶é—´å†…åˆ™è¯´æ˜æ˜¯ç¬¬1ç§æƒ…å†µï¼Œåœ¨ttlæ—¶é—´å¤–åˆ™æ˜¯ç¬¬2ç§æƒ…å†µã€‚</li>
</ul>
</li>
</ul>
<ul>
<li>2PCç¬¬äºŒé˜¶æ®µï¼šå‘é›†ä¸­çš„<code>TSO</code>èŠ‚ç‚¹ç”³è¯·ä¸€ä¸ªäº‹åŠ¡æäº¤æ—¶é—´æˆ³<code>t(c)</code>ï¼Œä¹‹åæ£€æŸ¥Primaryçš„<code>lock</code>æ˜¯å¦è¿˜å­˜åœ¨<code>t(s)</code>ç‰ˆæœ¬çš„æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¯´æ˜è¯¥äº‹åŠ¡é”å·²ç»è¶…è¿‡ttlæ—¶é•¿ï¼Œè¢«å…¶ä»–çš„äº‹åŠ¡ä¸­æ–­äº†ã€‚å¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™å‘<code>write</code>å†™å…¥ç‰ˆæœ¬ä¸º<code>t(c)</code>å€¼ä¸º<code>t(s)</code>çš„æ•°æ®å¹¶ä¸”æ¸…æ‰é”ï¼Œè¿™æ—¶æ•´ä¸ªäº‹åŠ¡å·²ç»æˆåŠŸã€‚æœ€åå¼‚æ­¥çš„å®ŒæˆSecondarieså†™<code>write</code>å¹¶ä¸”é‡Šæ”¾é”çš„æ“ä½œã€‚è¿™ä¸ªé˜¶æ®µå½“ä¸­æ£€æŸ¥ã€å†™å…¥ã€æ¸…é”çš„è¿‡ç¨‹è¢«åŒ…è£…åœ¨ä¸€ä¸ªäº‹åŠ¡å½“ä¸­ã€‚</li>
</ul>
<h3 id="Transaction-Read"><a href="#Transaction-Read" class="headerlink" title="Transaction Read"></a>Transaction Read</h3><p>è¯»äº‹åŠ¡å°±è¦ç®€å•å¾ˆå¤šï¼Œ<code>Percolator</code>å‘é›†ä¸­çš„<code>TSO</code>èŠ‚ç‚¹ç”³è¯·ä¸€ä¸ªäº‹åŠ¡å¼€å§‹çš„æ—¶é—´æˆ³<code>t(s)</code>ï¼Œç„¶åæ£€æŸ¥æ‰€æœ‰çš„Read setä¸­çš„é”ï¼Œå¦‚æœå­˜åœ¨æ—¶é—´æˆ³å°äº<code>t(s)</code>çš„é”ï¼š</p>
<ul>
<li>é”è¿˜å¤„äºTTLæ—¶é—´å†…ï¼Œè¯´æ˜è¯¥èµ„æºæ­£åœ¨è¢«å¦å¤–ä¸€ä¸ªäº‹åŠ¡æŒæœ‰ï¼ŒClientè¿›è¡Œbackoffæ“ä½œ</li>
<li>é”å·²ç»è¶…æ—¶ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡é”ä¸­è®°å½•çš„primaryä½ç½®æ‰¾åˆ°primaryè¡Œçš„<code>write</code>åˆ—ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨é”ç‰ˆæœ¬çš„æ•°æ®ã€‚å¦‚æœå­˜åœ¨åˆ™è¯´æ˜è¯¥äº‹åŠ¡å·²ç»æˆåŠŸï¼Œåªæ˜¯æ²¡æœ‰æ­£å¸¸çš„è¿˜é”ï¼Œè¿™æ—¶å°†é”å¯¹åº”çš„äº‹åŠ¡è¿›è¡Œæäº¤ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¯´æ˜è¯¥äº‹åŠ¡2PCç¬¬äºŒé˜¶æ®µå‡ºç°é—®é¢˜ï¼Œå°†è¯¥äº‹åŠ¡è¿›è¡Œrollback</li>
</ul>
<p>ä¸‹é¢æ˜¯è®ºæ–‡æºç ğŸ‘‡ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Write</span>&#123;</span> Row row; Column: col; <span class="built_in">string</span> value;&#125;;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Write&gt; writes_;</span><br><span class="line">    <span class="keyword">int</span> start_ts_;</span><br><span class="line"></span><br><span class="line">    Transaction():start_ts_(orcle.GetTimestamp()) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Set</span><span class="params">(Write w)</span> </span>&#123;writes_.push_back(w);&#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">Get</span><span class="params">(Row row, Column c, <span class="built_in">string</span>* value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            bigtable::Txn = bigtable::StartRowTransaction(row);</span><br><span class="line">            <span class="comment">// Check for locks that signal concurrent writes.</span></span><br><span class="line">            <span class="keyword">if</span> (T.Read(row, c+<span class="string">"locks"</span>, [<span class="number">0</span>, start_ts_])) &#123;</span><br><span class="line">                <span class="comment">// There is a pending lock; try to clean it and wait</span></span><br><span class="line">                BackoffAndMaybeCleanupLock(row, c);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the latest write below our start_timestamp.</span></span><br><span class="line">        latest_write = T.Read(row, c+<span class="string">"write"</span>, [<span class="number">0</span>, start_ts_]);</span><br><span class="line">        <span class="keyword">if</span>(!latest_write.found()) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// no data</span></span><br><span class="line">        <span class="keyword">int</span> data_ts = latest_write.start_timestamp();</span><br><span class="line">        *value = T.Read(row, c+<span class="string">"data"</span>, [data_ts, data_ts]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// prewrite tries to lock cell w, returning false in case of conflict.</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">Prewrite</span><span class="params">(Write w, Write primary)</span> </span>&#123;</span><br><span class="line">        Column c = w.col;</span><br><span class="line">        bigtable::Txn T = bigtable::StartRowTransaction(w.row);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// abort on writes after our start stimestamp ...</span></span><br><span class="line">        <span class="keyword">if</span> (T.Read(w.row, c+<span class="string">"write"</span>, [start_ts_, max])) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// ... or locks at any timestamp.</span></span><br><span class="line">        <span class="keyword">if</span> (T.Read(w.row, c+<span class="string">"lock"</span>, [<span class="number">0</span>, max])) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        T.Write(w.row, c+<span class="string">"data"</span>, start_ts_, w.value);</span><br><span class="line">        T.Write(w.row, c+<span class="string">"lock"</span>, start_ts_, </span><br><span class="line">            &#123;primary.row, primary.col&#125;);  <span class="comment">// The primary's location.</span></span><br><span class="line">        <span class="keyword">return</span> T.Commit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">Commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Write primary = write_[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">vector</span>&lt;Write&gt; secondaries(write_.begin() + <span class="number">1</span>, write_.end());</span><br><span class="line">        <span class="keyword">if</span> (!Prewrite(primary, primary)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (Write w : secondaries)</span><br><span class="line">            <span class="keyword">if</span> (!Prewrite(w, primary)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> commit_ts = orcle.GetTimestamp();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Commit primary first.</span></span><br><span class="line">        Write p = primary;</span><br><span class="line">        bigtable::Txn T = bigtable::StartRowTransaction(p.row);</span><br><span class="line">        <span class="keyword">if</span> (!T.Read(p.row, p.col+<span class="string">"lock"</span>, [start_ts_, start_ts_]))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// aborted while working</span></span><br><span class="line">        T.Write(p.row, p.col+<span class="string">"write"</span>, commit_ts,</span><br><span class="line">            start_ts_); <span class="comment">// Pointer to data written at start_ts_</span></span><br><span class="line">        T.Erase(p.row, p.col+<span class="string">"lock"</span>, commit_ts);</span><br><span class="line">        <span class="keyword">if</span>(!T.Commit()) <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// commit point</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Second phase: write our write records for secondary cells.</span></span><br><span class="line">        <span class="keyword">for</span> (Write w:secondaries) &#123;</span><br><span class="line">            bigtable::write(w.row, w.col+<span class="string">"write"</span>, commit_ts, start_ts_);</span><br><span class="line">            bigtable::Erase(w.row, w.col+<span class="string">"lock"</span>, commit_ts);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;; <span class="comment">// class Transaction</span></span><br></pre></td></tr></table></figure>

<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><ol>
<li>åˆå§‹åŒ–Bobå’ŒJoeçš„è´¦æˆ·ï¼ŒBobæœ‰10å…ƒï¼ŒJoeæœ‰2å…ƒ<br><img src="/images/a15-1.png" alt="a15-1"></li>
<li>æœ‰ä¸€ä¸ªäº‹åŠ¡å‡ºç°ï¼Œè¿™ä¸ªäº‹åŠ¡è¦å°†Bobçš„7å…ƒç»™Joeï¼Œè¿™æ—¶è·å¾—äº†ä¸€ä¸ªæ–°çš„æ—¶é—´æˆ³7ï¼Œé€‰æ‹©Bobåšä¸ºprimaryï¼Œé”ä½è¯¥è¡Œå†™å…¥Bobå‡æ‰7å…ƒä»¥åçš„æ•°æ®<br><img src="/images/a15-2.png" alt="a15-2"></li>
<li>å°†Joeé€‰ä¸ºSecondaryï¼Œå¹¶æŒ‡å‘Primaryçš„Bobï¼Œé”ä½è¯¥è¡Œå†™å…¥JoeåŠ 7å…ƒä»¥åçš„æ•°æ®<br><img src="/images/a15-3.png" alt="a15-3"></li>
<li>è¿™æ—¶å€™2PCç¬¬ä¸€é˜¶æ®µå®Œæˆï¼Œå¼€å§‹ç¬¬äºŒé˜¶æ®µï¼Œç”³è¯·ä¸€ä¸ªæäº¤æ—¶é—´æˆ³8ï¼Œå°†æ—¶é—´æˆ³7å†™å…¥Bobçš„<code>write</code>çš„8ç‰ˆæœ¬ä¸­<br><img src="/images/a15-4.png" alt="a15-4"></li>
<li>å°†æ—¶é—´æˆ³7å†™å…¥Joeçš„<code>write</code>çš„8ç‰ˆæœ¬ä¸­<br><img src="/images/a15-5.png" alt="a15-5"></li>
</ol>
<h2 id="Percolator-in-TiDB"><a href="#Percolator-in-TiDB" class="headerlink" title="Percolator in TiDB"></a>Percolator in TiDB</h2><p>æœ‰äº†ä¸Šé¢å¯¹<code>Percolator</code>çš„è§£é‡Šï¼Œæˆ‘ä»¬ç°åœ¨å¾ˆå®¹æ˜“ç†è§£åœ¨TiDBä¸­æ˜¯å¦‚æœä½¿ç”¨<code>Percolator</code>æ¥å®ç°äº‹åŠ¡é€»è¾‘ã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹å…¶ä¹è§‚äº‹åŠ¡çš„å®ç°ï¼š<br><img src="/images/a15-6.jpg" alt="a15-6"><br>æˆ‘ä»¬ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ<code>Percolator</code>æ˜¯è¢«ä½¿ç”¨åœ¨TiDBå’Œå…¶ä¸‹é¢çš„TiKVè¿›è¡Œäº‹åŠ¡é€šä¿¡çš„åè®®ã€‚æœ€å¼€å§‹çš„æ—¶å€™æˆ‘å¾ˆå¥‡æ€ªï¼Œ<code>Percolator</code>çš„å®ç°ä¸æ˜¯ä¸€ä¸ªæ‚²è§‚äº‹åŠ¡æ¨¡å‹å—ï¼Ÿä½†æ˜¯ä¸ºä»€ä¹ˆTiDBé‡Œç§°å…¶ä¸ºä¹è§‚äº‹åŠ¡ï¼Œæ˜¯å› ä¸ºæš´éœ²ç»™Clientçš„ä¸æ˜¯åº•å±‚çš„KVè€Œæ˜¯DBè¿™ä¸€å±‚ï¼Œè€ŒåŠ é”çš„è¿‡ç¨‹è¢«æ”¾åœ¨äº†Commité˜¶æ®µï¼Œæ‰€ä»¥å¯¹äºClientæ¥è¯´ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªä¹è§‚äº‹åŠ¡æ¨¡å‹ã€‚å½“äº‹åŠ¡å¼€å§‹ä»¥åï¼Œé¦–å…ˆæ‰§è¡ŒDMLæ“ä½œï¼Œå¾—åˆ°Write setï¼Œç„¶åå°†Write setæ”¾åˆ°<code>Percolator</code>ä¸­æ‰§è¡Œ2PCï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µä¸Šé”ã€‚</p>
<p>ä¸‹é¢å†çœ‹çœ‹ä»–ä»¬åœ¨è¿™åŸºç¡€ä¸Šä¿®æ”¹çš„æ‚²è§‚äº‹åŠ¡æ¨¡å‹ï¼Œå¾ˆå·§å¦™ï¼š<br><img src="/images/a15-7.jpg" alt="a15-7"><br>å°†ä¸Šé”çš„è¿‡ç¨‹æå‰åˆ°å¼€å§‹æ‰§è¡Œ<code>Percolator</code>äº‹åŠ¡ä¹‹å‰ï¼Œå…ˆå¯¹æ‰€æœ‰çš„Write setä¸Šä¸€ä¸ªå’Œ<code>Percolator</code>åŒæ ·çš„é”ï¼Œä¸è¿‡é”é‡Œé¢æ²¡æœ‰è®°å½•Primaryçš„ä½ç½®ï¼Œè€Œæ˜¯ç©ºçš„ï¼Œä»…åšå ä½ç¬¦ä½¿ç”¨ã€‚ç­‰å¼€å§‹æ‰§è¡Œ<code>Percolator</code>äº‹åŠ¡ä»¥åï¼Œé”ä¼šè¢«å†™å…¥æ­£ç¡®çš„å€¼ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œåœ¨æ•°æ®çœŸæ­£å¼€å§‹å‘ç”Ÿå˜æ›´ä¹‹å‰å°±é”ä½äº†æ‰€æœ‰èµ„æºã€‚ä¸ä¼šå‘ç”Ÿå›æ»šè¡Œä¸ºï¼Œåœ¨èµ„æºç«äº‰å¯†é›†çš„åœºæ™¯ä¸‹æ•ˆç‡å¤§å¤§ä¼˜äºä¹è§‚äº‹åŠ¡ã€‚å†™è¯·æ±‚çœ‹åˆ°è¿™ä¸ªç©ºé”ç›´æ¥ç­‰é”ï¼Œè¯»è¯·æ±‚å¯ä»¥ç›´æ¥ä»TiKVä¸­è¯»å–æ•°æ®å³å¯ã€‚</p>
<h2 id="Omid"><a href="#Omid" class="headerlink" title="Omid"></a>Omid</h2><p><code>Omid</code>ä¸»è¦ä½¿ç”¨åœ¨Phoenixç³»ç»Ÿä¸­æä¾›åˆ†å¸ƒå¼äº‹åŠ¡èƒ½åŠ›ï¼Œå…¶æœ¬èº«çš„å®ç°æ˜¯åˆ©ç”¨Hbaseçš„å•è¡Œäº‹åŠ¡èƒ½åŠ›ä»¥åŠåœ¨è¡Œå†…è®¾ç½®version, commitåˆ—æ¥è¿›è¡Œä¹è§‚äº‹åŠ¡ï¼Œæ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Data table   &lt;key, version&gt;: &lt;value&gt; &lt;commit&gt;</span><br><span class="line">Commit table      &lt;version&gt;: &lt;commit&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Transaction-Write-1"><a href="#Transaction-Write-1" class="headerlink" title="Transaction Write"></a>Transaction Write</h3><ul>
<li>å¼€å¯äº‹åŠ¡ï¼šå‘é›†ä¸­çš„<code>Timestamp server oracle(TSO)</code>èŠ‚ç‚¹ç”³è¯·ä¸€ä¸ªäº‹åŠ¡å¼€å§‹æ—¶é—´æˆ³<code>t(s)</code>ï¼Œå¹¶ä¸”ä»¥æ­¤æ—¶é—´æˆ³åšä¸ºäº‹åŠ¡id</li>
<li>2PCç¬¬ä¸€é˜¶æ®µï¼šClientå°†Write setä¸­çš„æ¯è¡Œçš„ä¿®æ”¹æ•°æ®å†™å…¥Data tableç‰ˆæœ¬ä¸º<code>t(s)</code>ï¼Œå¯¹åº”çš„keyçš„<code>value</code>å½“ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™æ—¶å€™çš„<code>commit</code>å‡ä¸ºnull</li>
<li>2PCç¬¬äºŒé˜¶æ®µï¼šClientå¸¦ä¸ŠWrite setå’Œ<code>t(s)</code>å‘<code>TSO</code>æäº¤commitè¯·æ±‚ï¼Œ<code>TSO</code>ä¼šè¿›è¡Œå†²çªæ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥æˆåŠŸåˆ™è¿”å›<code>t(c)</code>ç»™Clientï¼Œå¦åˆ™çš„è¯æ•´ä¸ªäº‹åŠ¡è¢«ä¸­æ–­ã€‚Clientæ‹¿åˆ°<code>t(c)</code>ä»¥åå‘Commit Tableå‘èµ·<code>CAS(t(s), commit, null, t(c))</code>æ“ä½œï¼Œå¦‚æœè¿”å›<code>ABORT</code>åˆ™å°†äº‹åŠ¡ç»ˆæ­¢ï¼Œå¹¶ä¸”å¼‚æ­¥çš„æ¸…é™¤Data tableä¸­ä¹‹å‰å†™å…¥çš„æ•°æ®ã€‚å¦‚æœæˆåŠŸï¼Œåˆ™è¿›è¡ŒPost-commitæµç¨‹ï¼Œå°†å†™å…¥Commit tableä¸­çš„<code>t(c)</code>å¼‚æ­¥å¤åˆ¶åˆ°Data tableçš„ç‰ˆæœ¬ä¸º<code>t(s)</code>çš„<code>commit</code>å½“ä¸­ã€‚å®Œæˆæ‰€æœ‰çš„å¼‚æ­¥å¤åˆ¶ä»¥åè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå°†Commit tableå½“ä¸­çš„æ•°æ®æ¸…é™¤æ‰ï¼Œå®Œæˆæ•´ä¸ªäº‹åŠ¡ã€‚<ul>
<li>TSOå¦‚ä½•è¿›è¡Œå†²çªæ£€æŸ¥ï¼šåŸç†éå¸¸çš„ç®€å•ï¼Œå°±æ˜¯æ£€æŸ¥Write setå½“ä¸­çš„æ¯ä¸€è¡Œæ˜¯å¦æœ‰<code>lastCommit &gt; t(s)</code>çš„æ•°æ®ï¼ŒlastCommitæ˜¯è¿™ä¸€è¡Œæœ€æ–°çš„ä¸€ä¸ª<code>t(c)</code>ã€‚å¦‚æœæœ‰åˆ™è¯´æ˜åœ¨è¯¥äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹å½“ä¸­å·²ç»æœ‰å…¶ä»–çš„äº‹åŠ¡å®Œæˆï¼Œå‡ºç°äº†å†™-å†™å†²çªï¼Œåˆ™ä¸­æ–­è¯¥äº‹åŠ¡ã€‚ä½†æ˜¯è¦æ‰§è¡Œè¿™ä¸ªæ“ä½œéœ€è¦åœ¨TSOå½“ä¸­ä¿å­˜æ‰€æœ‰è¡Œçš„lastCommitæ•°æ®æ‰è¡Œï¼Œè¿™ä¸ªå­˜å‚¨å¼€é”€å¤ªå¤§äº†ï¼Œæ‰€ä»¥éœ€è¦æƒ³åŠæ³•ä¼˜åŒ–ã€‚ä¼˜åŒ–çš„æ‰‹æ®µä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç»´æŠ¤ä¸€ä¸ªLRUé˜Ÿåˆ—å³å¯ï¼Œåªä¿å­˜ä¸€å®šæ•°é‡çš„è¡Œçš„lastCommitå³å¯ã€‚é‚£ä¹ˆä¸åœ¨é˜Ÿåˆ—å½“ä¸­çš„è¡Œçš„lastCommitä¸€å®šå°äºç­‰äºé˜Ÿåˆ—ä¸­æœ€å°çš„ä¸€ä¸ªlastCommitæ—¶é—´ï¼Œè¿™æ ·å¯ä»¥æ£€æŸ¥<code>lastCommit&lt;=Smallest(lastCommit)&lt;=t(s)</code>çš„ååºå…³ç³»ï¼Œä»¥æ£€æŸ¥å†²çªæƒ…å†µã€‚ä½†æ˜¯ç”±äºé˜Ÿåˆ—ä¸­æ²¡æœ‰ä¿å­˜æ‰€æœ‰çš„æ•°æ®ï¼Œè¿˜æ˜¯ä¼šæœ‰æ¼ç½‘ä¹‹é±¼ï¼Œæ¯”å¦‚è¯´ç°åœ¨é˜Ÿåˆ—é‡Œçš„<code>Smallest(lastCommit) &gt; t(s)</code>ï¼Œå¹¶ä¸”è¦æ£€æŸ¥çš„è¡Œæ²¡æœ‰åœ¨é˜Ÿåˆ—å½“ä¸­ï¼Œé‚£ä¹ˆååºå…³ç³»å°±æ— ä»å¯çŸ¥ï¼Œè¿™æ—¶å€™å°±ç›´æ¥å°†äº‹åŠ¡ä¸­æ–­å³å¯ï¼Œä¹Ÿä¸ä¼šå½±å“æ­£ç¡®æ€§ã€‚</li>
<li>CASå‡½æ•°ï¼šè¿™æ˜¯ä¸€ä¸ªåœ¨å®ç°ä¹è§‚é”å½“ä¸­ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„å‡½æ•°ï¼Œ<code>CAS(a,b,c,d)</code>æ˜¯æŒ‡æ¯”è¾ƒaè¡Œbåˆ—ï¼Œå¦‚æœå®ƒç°åœ¨çš„å€¼ç­‰äºcï¼Œåˆ™å°†å…¶ä¿®æ”¹ä¸ºdã€‚å¹¶ä¸”è¿™ä¸ªå‡½æ•°éœ€è¦ä¿è¯åŸå­æ€§ã€‚åœ¨HBaseå½“ä¸­å¯ä»¥ä½¿ç”¨è¡Œçº§äº‹åŠ¡æ¥å®ç°CASå‡½æ•°ï¼Œå¹¶ä¿è¯å…¶åŸå­æ€§ã€‚</li>
</ul>
</li>
</ul>
<h3 id="Transaction-Read-1"><a href="#Transaction-Read-1" class="headerlink" title="Transaction Read"></a>Transaction Read</h3><ul>
<li>å‘é›†ä¸­çš„<code>Timestamp server oracle(TSO)</code>èŠ‚ç‚¹ç”³è¯·ä¸€ä¸ªäº‹åŠ¡å¼€å§‹æ—¶é—´æˆ³<code>t(s)</code>ï¼Œå¹¶ä¸”ä»¥æ­¤æ—¶é—´æˆ³åšä¸ºäº‹åŠ¡id</li>
<li>æ‰«ææ‰€æœ‰çš„Read setï¼Œæ¯ä¸€è¡Œä»å¤§ç‰ˆæœ¬åˆ°å°ç‰ˆæœ¬æ‰«æï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªæäº¤ç‰ˆæœ¬å°äº<code>t(s)</code>çš„valueå’Œå¯¹åº”çš„ç‰ˆæœ¬<code>t(s2)</code>ã€‚å¦‚æœå‘ç°å…¶<code>commit==null</code>ï¼Œè¿™æ—¶å€™æœ‰ä¸¤ç§æƒ…å†µï¼š<ul>
<li>è¿™ä¸€æ¬¡äº‹åŠ¡å·²ç»æˆåŠŸï¼Œåªæ˜¯æ­£åœ¨è¿›è¡ŒPost-commitæµç¨‹ï¼Œä»Commit tableå½“ä¸­å°†<code>t(c)</code>å¤åˆ¶è¿‡æ¥</li>
<li>è¿™ä¸€æ¬¡äº‹åŠ¡æ²¡æœ‰æˆåŠŸ<br>ä¸ºäº†åŒºåˆ†è¿™ä¸¤ç§æƒ…å†µï¼Œ<code>Omid</code>ä¼šå»Commit tableå½“ä¸­æ£€æŸ¥ç‰ˆæœ¬<code>t(s2)</code>å¯¹åº”çš„<code>commit</code>æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼åˆ™è¯´æ˜æ˜¯æƒ…å†µ1ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¯´æ˜æ˜¯æƒ…å†µ2ã€‚æƒ…å†µ1çš„è¯å¾ˆå¥½åŠï¼Œç»§ç»­å‘ä¸‹éå†æ›´å°çš„ç‰ˆæœ¬ã€‚æƒ…å†µ2çš„è¯å°±æ¯”è¾ƒéº»çƒ¦ï¼š</li>
<li>Clientè°ƒç”¨<code>CAS(t(s2), commit, null, ABORT)</code>æ¥å°†å…¶å¯¹åº”çš„äº‹åŠ¡è®¾ç½®ä¸ºABORTï¼Œè¿™æ ·åœ¨å…¶é‡è¯•çš„Commitç¯èŠ‚ä¼šå‘ç°ABORTæ ‡å¿—è€Œä½¿å…¶äº‹åŠ¡è¿›è¡Œä¸­æ–­æ“ä½œ</li>
<li>å¦‚æœè®¾ç½®æˆåŠŸï¼Œè¿˜éœ€è¦æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æ˜¯å› ä¸ºè¯»äº‹åŠ¡å¤ªæ…¢è€Œå¯¼è‡´çš„é”™è¯¯ä¸­æ–­ï¼Œå»Data tableè¯»<code>t(s2)</code>ç‰ˆæœ¬çš„commitï¼Œå¦‚æœå‘ç°å­˜åœ¨å€¼<code>t(c2)</code>ï¼Œå¹¶ä¸”<code>t(c2)&lt;t(s)</code>ï¼Œåˆ™è¿”å›å…¶valueå’Œç‰ˆæœ¬ã€‚å¦åˆ™ç»§ç»­å‘ä¸‹éå†æ›´å°çš„ç‰ˆæœ¬ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸‹é¢æ˜¯è®ºæ–‡æºç ğŸ‘‡ï¼š<br><img src="/images/a15-8.png" alt="a15-8"></p>
<p><img src="/images/a15-9.png" alt="a15-9"></p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>é€šè¿‡ä¸Šæ–‡çš„åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<code>Percolator</code>çš„ä¼˜ç‚¹æ˜¯åˆ†å¸ƒå¼çš„Commit tableï¼ŒTSOé€»è¾‘ç®€å•ï¼Œç¼ºç‚¹æ˜¯é”æ£€æŸ¥æ—¶éœ€è¦æ‰«ææ‰€æœ‰Write setçš„é”æƒ…å†µï¼Œå¹¶ä¸”éœ€è¦é¢å¤–çš„å­˜å‚¨å¼€é”€æ¥è®°å½•é”ã€‚<code>Omid</code>çš„ä¼˜ç‚¹æ˜¯æ‰§è¡Œæ•ˆç‡ä¸Šä¼˜äº<code>Percolator</code>ï¼Œä½†æ˜¯åˆå¤šäº†ä¸€ä¸ªä¸­å¿ƒç³»ç»ŸCommit tableã€‚å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„ä½¿ç”¨åœºæ™¯æ¥è¿›è¡Œé€‰æ‹©ã€‚</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ul>
<li><a href="https://www.usenix.org/system/files/conference/fast17/fast17-shacham.pdf" target="_blank" rel="noopener">Omid, Reloaded: Scalable and Highly-Available Transaction Processing</a></li>
<li><a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36726.pdf" target="_blank" rel="noopener">Large-scale Incremental Processing Using Distributed Transactions and Notifications</a></li>
<li><a href="http://kaiyuan.me/2019/01/19/2pc/" target="_blank" rel="noopener">åŸºäº KV çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/79034576?utm_source=wechat_session&utm_medium=social&utm_oi=956566129104080896&from=singlemessage&isappinstalled=0&wechatShare=1&s_r=0" target="_blank" rel="noopener">TiDB æ–°ç‰¹æ€§æ¼«è°ˆï¼šæ‚²è§‚äº‹åŠ¡</a></li>
</ul>

	
	</div>
  <a type="button" href="/2019/11/08/a15/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/10/18/a14/" >é”</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-10-18  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>åœ¨å¾ˆå¤šçš„å¤šçº¿ç¨‹ç¼–ç¨‹åœºæ™¯ä¸‹éƒ½ä¼šé‡åˆ°å¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªèµ„æºè¿›è¡Œæ“ä½œè®¿é—®çš„æƒ…å†µï¼Œè¿™ç§åœºæ™¯ä¸€æ—¦å‘ç”Ÿå°±ä¼šç‰µæ‰¯åˆ°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä¸ºäº†ä¿è¯ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬ä¸å¾—ä¸èŠ±å¾ˆå¤§çš„åŠ›æ°”å»è§£å†³è¿™äº›çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚åœ¨Javaä¸­è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„åŠæ³•è¢«åˆ†ä¸ºäº†ä¸‰ç§ï¼Œå…¶ä¸€æ˜¯äº’æ–¥åŒæ­¥ï¼Œå…¶äºŒæ˜¯éé˜»å¡åŒæ­¥ï¼Œå…¶ä¸‰æ˜¯æ— åŒæ­¥æ–¹æ¡ˆã€‚å‰ä¸¤ç§çš„å®ç°å½¢å¼éƒ½æ˜¯é”ï¼Œç¬¬ä¸‰ç§æ˜¯é€šè¿‡è®¾è®¡æ¨¡å¼çš„è½¬å˜æ¥å°†ä»£ç è½¬å˜ä¸ºä¸å…±äº«å˜é‡çš„å½¢å¼ï¼Œè¿™ä¸åœ¨è¿™ç¯‡åšå®¢çš„è®¨è®ºèŒƒå›´ä¸­ã€‚</p>
<h2 id="çº¿ç¨‹ä¸å®‰å…¨"><a href="#çº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="çº¿ç¨‹ä¸å®‰å…¨"></a>çº¿ç¨‹ä¸å®‰å…¨</h2><p>é¦–å…ˆæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹çº¿ç¨‹å®‰å…¨é—®é¢˜äº§ç”Ÿçš„åº•å±‚åŸå› åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿå…ˆçœ‹ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.talkwithkeyboard.code;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadIncrease</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> race = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        race = race + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> THREAD_COUNT = <span class="number">20</span>;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[THREAD_COUNT];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREAD_COUNT; i++) &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                System.out.format(<span class="string">"This is %d thread.\n"</span>, Thread.currentThread().getId());</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                    increase();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(race);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè§£é‡Šä¸€ä¸ªç»†èŠ‚ï¼Œå› ä¸ºæˆ‘çš„ä»£ç æ˜¯åœ¨Ideaé‡Œè·‘çš„ï¼Œæ‰€ä»¥ä¸ä»…æ˜¯æœ‰<code>Main thread</code>ï¼Œè¿˜æœ‰ä¸€ä¸ª<code>Monitor Ctrl-Break</code>çš„å®ˆæŠ¤çº¿ç¨‹ã€‚æ‰€ä»¥ä»£ç ä¸­æ˜¯<code>Thread.activeCount() &gt; 2</code>ã€‚å¦‚æœç›´æ¥ä½¿ç”¨<code>java</code>æ‰§è¡Œçš„è¯ï¼Œè¿™é‡Œæ˜¯1å³å¯ã€‚ç„¶åä¸Šé¢çš„ä»£ç åšäº†ä¸€ä¸ªå¾ˆç®€å•çš„äº‹æƒ…ï¼Œå¼€äº†20ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åšä¸€ä»¶äº‹æƒ…ï¼Œå¯¹<code>race</code>è¿™ä¸ªå˜é‡ç´¯åŠ 10000æ¬¡ï¼Œæœ€åè¾“å‡ºã€‚æœ€åçš„ç»“æœæ˜¾ç„¶ä¸æ˜¯200000ï¼Œä¼šå°å¾ˆå¤šå¹¶ä¸”æ¯æ¬¡éƒ½ä¸ä¸€æ ·ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>æ˜¯å› ä¸º<code>race = race + 1</code>è¿™ä¸€è¡Œä»£ç å…¶å®åšäº†ä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li><ol>
<li>å–å‡º<code>race</code>ç°æœ‰çš„å€¼</li>
</ol>
</li>
<li><ol start="2">
<li>ç»™<code>race</code>ç°æœ‰çš„å€¼åŠ ä¸Š1</li>
</ol>
</li>
<li><ol start="3">
<li>å°†æ›´æ–°åçš„å€¼å†é™„ç»™<code>race</code></li>
</ol>
</li>
</ul>
<p>æˆ‘ä»¬ç†æƒ³çš„çŠ¶æ€æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹é¡ºåºçš„åšå®Œè¿™ä¸‰ä»¶äº‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">thread1.1  // race=0</span><br><span class="line">thread1.2  // race=0</span><br><span class="line">thread1.3  // race=1</span><br><span class="line">thread2.1  // race=1</span><br><span class="line">thread2.2  // race=1</span><br><span class="line">thread2.3  // race=2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ä½†å®é™…æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">thread1.1  // race=0</span><br><span class="line">thread2.1  // race=0</span><br><span class="line">thread2.2  // race=0</span><br><span class="line">thread1.2  // race=0</span><br><span class="line">thread1.3  // race=1</span><br><span class="line">thread2.3  // race=1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>ç”šè‡³æ›´åŠ çš„æ··ä¹±ï¼Œè¿™å°±é€ æˆä»£ç è¿è¡Œç»“æœé”™è¯¯çš„ç°è±¡ï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†çº¿ç¨‹ä¸å®‰å…¨è¡Œä¸ºã€‚é‚£ä¹ˆä¸ºäº†è§„é¿è¿™æ ·çš„è¡Œä¸ºï¼Œå°±éœ€è¦å¼•å‡ºé”çš„æ¦‚å¿µï¼Œæ‚²è§‚é”å°±æ˜¯äº’æ–¥åŒæ­¥çš„å®ç°ï¼Œä¹è§‚é”æ˜¯éé˜»å¡åŒæ­¥çš„å®ç°ã€‚</p>
<h2 id="äº’æ–¥åŒæ­¥-æ‚²è§‚é”"><a href="#äº’æ–¥åŒæ­¥-æ‚²è§‚é”" class="headerlink" title="äº’æ–¥åŒæ­¥ æ‚²è§‚é”"></a>äº’æ–¥åŒæ­¥ æ‚²è§‚é”</h2><p>é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹ã€Šæ·±å…¥ç†è§£JVMã€‹ä¸­å¯¹äº’æ–¥åŒæ­¥çš„å®šä¹‰ï¼Œâ€äº’æ–¥åŒæ­¥æ˜¯å¸¸è§çš„ä¸€ç§å¹¶å‘æ­£ç¡®æ€§ä¿éšœæ‰‹æ®µã€‚åŒæ­¥æ˜¯æŒ‡åœ¨å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œä¿è¯å…±äº«æ•°æ®åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªè¢«ä¸€ä¸ªï¼ˆæˆ–è€…ä¸€äº›ï¼Œä½¿ç”¨ä¿¡å·é‡çš„æ—¶å€™ï¼‰çº¿ç¨‹ä½¿ç”¨ã€‚è€Œäº’æ–¥æ˜¯å®ç°åŒæ­¥çš„ä¸€ç§æ‰‹æ®µï¼Œä¸´ç•ŒåŒºã€äº’æ–¥é‡å’Œä¿¡å·é‡éƒ½æ˜¯ä¸»è¦çš„äº’æ–¥å®ç°æ–¹å¼ã€‚å› æ­¤ï¼Œåœ¨è¿™4ä¸ªå­—é‡Œé¢ï¼Œäº’æ–¥æ˜¯å› ï¼ŒåŒæ­¥æ˜¯æœï¼›äº’æ–¥æ˜¯æ–¹æ³•ï¼ŒåŒæ­¥æ˜¯ç›®çš„ã€‚â€œ</p>
<h3 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h3><p>è€Œå¦‚ä½•ä¿è¯å…±äº«æ•°æ®åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªè¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Ÿé‚£ä¹ˆå°±éœ€è¦åœ¨è¿™ä¸ªæ•°æ®è¢«ä½¿ç”¨ä¹‹å‰å°±ä¸ºæœŸåŠ ä¸Šé”ï¼Œåªæœ‰è·å¾—é”çš„çº¿ç¨‹èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œæ“ä½œï¼Œè€Œè¿™æ ·çš„é”å°±è¢«ç§°ä¸ºæ‚²è§‚é”ã€‚åœ¨Javaä¸­ï¼Œæœ€åŸºæœ¬çš„å®ç°å°±æ˜¯<code>synchronized</code>å…³é”®å­—ã€‚å…¶å®ç°çš„åŸç†æ˜¯åœ¨ç¼–è¯‘åä¼šåœ¨åŒæ­¥å—çš„å‰ååˆ†åˆ«å½¢æˆ<code>monitorenter</code>å’Œ<code>monitorexit</code>è¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤éƒ½éœ€è¦ä¸€ä¸ªreferenceç±»å‹çš„å‚æ•°æ¥æŒ‡æ˜è¦é”å®šå’Œè§£é”çš„å¯¹è±¡ã€‚å¦‚æœæŒ‡æ˜çš„æ˜¯å¯¹è±¡å‚æ•°ï¼Œé‚£å°±æ˜¯è¿™ä¸ªå¯¹è±¡çš„referenceï¼›å¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šï¼Œé‚£å°±æ ¹æ®<code>synchronized</code>çš„æ˜¯å®ä¾‹è¿˜æ˜¯ç±»æ–¹æ³•ï¼Œå»å–å¯¹åº”çš„å¯¹è±¡å®ä¾‹æˆ–Classå¯¹è±¡æ¥ä½œä¸ºé”å¯¹è±¡ã€‚å…ˆçœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå¯¹æ¯”ä¸€ä¸‹æ·»åŠ <code>synchronized</code>å…³é”®å­—å‰åçš„å­—èŠ‚ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.talkwithkeyboard.code;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoSynchronized</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> race = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        race = race + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> NoSynchronized().increase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡javapå·¥å…·æ¥è·å–å­—èŠ‚ç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> javap -verbose -p io.talkwithkeyboard.code.NoSynchronized</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åªå…³æ³¨<code>increase</code>æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void increase();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args_size=1</span><br><span class="line">         0: getstatic     #2                  // Field race:I</span><br><span class="line">         3: iconst_1</span><br><span class="line">         4: iadd</span><br><span class="line">         5: putstatic     #2                  // Field race:I</span><br><span class="line">         8: return</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆåœ¨æ·»åŠ <code>synchronized</code>å…³é”®å­—åï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.talkwithkeyboard.code;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WithSynchronized</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> race = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            race = race + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> WithSynchronized().increase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯åªå…³æ³¨<code>increase</code>æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public void increase();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=3, args_size=1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: dup</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: monitorenter</span><br><span class="line">         4: getstatic     #2                  // Field race:I</span><br><span class="line">         7: iconst_1</span><br><span class="line">         8: iadd</span><br><span class="line">         9: putstatic     #2                  // Field race:I</span><br><span class="line">        12: aload_1</span><br><span class="line">        13: monitorexit</span><br><span class="line">        14: goto          22</span><br><span class="line">        17: astore_2</span><br><span class="line">        18: aload_1</span><br><span class="line">        19: monitorexit</span><br><span class="line">        20: aload_2</span><br><span class="line">        21: athrow</span><br><span class="line">        22: return</span><br></pre></td></tr></table></figure>

<p>å­—èŠ‚ç æè¿°çš„è¿‡ç¨‹æ˜¯ï¼š</p>
<ul>
<li><ol start="0">
<li>å°†ç±»å¯¹è±¡å…¥æ ˆ</li>
</ol>
</li>
<li><ol>
<li>å¤åˆ¶æ ˆé¡¶å…ƒç´ ï¼ˆå³ç±»å¯¹è±¡çš„å¼•ç”¨ï¼‰</li>
</ol>
</li>
<li><ol start="2">
<li>å°†æ ˆé¡¶å…ƒç´ ï¼ˆç±»å¯¹è±¡ï¼‰å­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨Slot 1ä¸­</li>
</ol>
</li>
<li><ol start="3">
<li>ä»¥æ ˆé¡¶å…ƒç´ åšä¸ºé”å¼€å§‹åŒæ­¥</li>
</ol>
</li>
<li><ol start="4">
<li>å–è·å–ç±»çš„é™æ€å­—æ®µï¼ˆraceï¼‰ï¼Œå°†å…¶å€¼å‹å…¥æ ˆé¡¶</li>
</ol>
</li>
<li><ol start="7">
<li>intå‹å¸¸é‡1è¿›æ ˆ</li>
</ol>
</li>
<li><ol start="8">
<li>å¯¹æ“ä½œæ•°æ ˆä¸Šçš„ä¸¤ä¸ªæ•°å€¼è¿›è¡ŒåŠ æ³•ï¼Œç»“æœå‹å…¥æ ˆé¡¶</li>
</ol>
</li>
<li><ol start="9">
<li>ç”¨æ ˆé¡¶å…ƒç´ ç»™ç±»çš„é™æ€å­—æ®µï¼ˆraceï¼‰èµ‹å€¼</li>
</ol>
</li>
<li><ol start="12">
<li>å°†å±€éƒ¨å˜é‡è¡¨Slot 1ä¸­çš„ç±»å¯¹è±¡å…¥æ ˆ</li>
</ol>
</li>
<li><ol start="13">
<li>é€€å‡ºåŒæ­¥</li>
</ol>
</li>
<li><ol start="14">
<li>æ–¹æ³•æ­£å¸¸ç»“æŸï¼Œè·³è½¬åˆ°22è¿”å›</li>
</ol>
</li>
<li><ol start="17">
<li>ä»è¿™æ­¥å¼€å§‹æ˜¯å¼‚å¸¸è·¯å¾„ï¼Œæš‚ä¸èµ˜è¿°</li>
</ol>
</li>
</ul>
<p>åœ¨å±•ç¤ºäº†æ•´ä¸ª<code>synchronized</code>å…³é”®å­—çš„ä»£ç æµç¨‹ä»¥åï¼Œæˆ‘ä»¬å†æ·±ç©¶ä¸€ä¸‹<code>monitorenter</code>æŒ‡ä»¤å’Œ<code>monitorexit</code>æŒ‡ä»¤åœ¨æœºå™¨ç æˆé¢åˆ°åº•åšäº†ä»€ä¹ˆã€‚ä¸ºäº†é˜…è¯»æ–¹ä¾¿ï¼Œæˆ‘ä»¬å…ˆä¸å±•ç¤ºæœºå™¨ç çš„å†…å®¹ï¼Œè€Œæ˜¯ä»è™šæ‹Ÿæœºè§„èŒƒå‡ºå‘ï¼Œåœ¨æ‰§è¡Œ<code>monitorenter</code>æŒ‡ä»¤çš„æ—¶ï¼Œé¦–å…ˆè¦å°è¯•è·å–å¯¹è±¡çš„é”ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼Œæˆ–è€…å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†é‚£ä¸ªå¯¹è±¡çš„é”ï¼ŒæŠŠé”çš„è®¡æ•°å™¨åŠ 1ã€‚ç›¸åº”çš„ï¼Œåœ¨æ‰§è¡Œ<code>monitorexit</code>æŒ‡ä»¤çš„æ—¶å€™ï¼ŒæŠŠé”çš„è®¡æ•°å™¨å‡1ï¼Œå½“è®¡æ•°å™¨ä¸º0çš„æ—¶å€™ï¼Œé”å°±è¢«é‡Šæ”¾æ‰ã€‚</p>
<h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p>ä»¥ä¸Šå°±æ˜¯é”çš„æ•´ä¸ªä½å±‚å®ç°è¿‡ç¨‹ï¼Œåœ¨Javaä¸­å…¶å®è¿˜æœ‰æ›´ä¸Šå±‚çš„é”å°è£…èƒ½å®ç°æ›´å¤šç‰¹æ€§çš„é”ï¼Œé‚£å°±æ˜¯<code>ReentrantLock</code>ç±»ï¼Œå®ƒå’Œ<code>synchronized</code>å…³é”®å­—ä¸€æ ·éƒ½æ˜¯æ‚²è§‚é”çš„å®ç°ã€‚ä½†æ˜¯ç›¸æ¯”<code>synchronized</code>ï¼Œå¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p>
<ul>
<li>ç­‰å¾…å¯ä¸­æ–­ï¼šå½“æŒæœ‰é”çš„çº¿ç¨‹é•¿æœŸä¸é‡Šæ”¾é”çš„æ—¶å€™ï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ï¼Œå¯ä¸­æ–­ç‰¹æ€§å¯¹å¤„ç†æ‰§è¡Œæ—¶é—´éå¸¸é•¿çš„åŒæ­¥å—å¾ˆæœ‰å¸®åŠ©ã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lock() å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    interrupted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// lockInterruptibly() å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Node node = addWaiter(Node.EXCLUSIVE);</span><br><span class="line">        <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°åœ¨<code>lock()</code>å’Œ<code>lockInterruptibly()</code>æºç çš„å®ç°ä¸­ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åœ¨ä¸€ç›´ç­‰å¾…é”çš„è¿‡ç¨‹ä¸­ï¼Œ<code>lock()</code>ä¼šåæ‰ä¸­æ–­ï¼Œè¿‘è®°å½•ä¸­æ–­çŠ¶æ€ï¼Œè€Œ<code>lockInterruptibly()</code>ä¼šæŠ›å¼‚å¸¸åˆ°ä¸Šå±‚ï¼Œäº¤ç»™ä¸Šé¢çš„ä¸šåŠ¡é€»è¾‘è¿›è¡Œå¤„ç†ã€‚</p>
<ul>
<li>å…¬å¹³é”ï¼šå¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”ï¼Œè€Œéå…¬å¹³é”æ˜¯ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹çš„ã€‚<code>synchronized</code>å°±æ˜¯éå…¬å¹³é”ï¼Œå¯ä»¥é€šè¿‡ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>æ¥åˆ›å»ºå…¬å¹³é”ã€‚</p>
<ul>
<li>å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼šä¸»è¦æ˜¯å¤„ç†ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œç”±äºç¯‡å¹…è¿™é‡Œæš‚ä¸èµ˜è¿°ã€‚</li>
</ul>
<h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h3><p><code>volatile</code>å¯ä»¥è¯´æ˜¯Javaä¸­æœ€è½»é‡åŒ–çº§çš„åŒæ­¥æœºåˆ¶ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹Ÿæ˜¯å¯ä»¥å½“ä½œå¯¹è±¡çš„é”æ¥è¿›è¡Œä½¿ç”¨çš„ï¼Œä½†æ˜¯åœ¨åŠŸèƒ½ä¸Šè¿˜æ˜¯ä¸èƒ½å®Œå…¨æ›¿ä»£è¢«<code>synchronized</code>ä½œç”¨çš„å¯¹è±¡ã€‚å½“ä¸€ä¸ªå˜é‡å®šä¹‰ä¸º<code>volatile</code>ä¹‹åï¼Œå®ƒå°†å…·å¤‡ä¸¤ç§ç‰¹æ€§ï¼Œç¬¬ä¸€æ˜¯å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œæ–°å€¼å¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¾—çŸ¥çš„ï¼Œè¿™å°±æ˜¯å¯è§æ€§ã€‚ç¬¬äºŒä¸ªè¯­ä¹‰æ˜¯ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚</p>
<p>é¦–å…ˆä»‹ç»ä¸€ä¸‹å¯è§æ€§æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿæ™®é€šå˜é‡åœ¨è¢«ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ä¹‹åï¼Œä¼šå‘ä¸»å†…å­˜è¿›è¡Œå›å†™ï¼Œåªæœ‰ç­‰åˆ°ä¸»å†…å­˜å›å†™å®Œæˆä»¥åï¼Œå…¶ä»–çš„çº¿ç¨‹æ‰èƒ½è¯»åˆ°æ–°çš„å€¼ã€‚ è€Œè¢«<code>volatile</code>ä¿®é¥°çš„å˜é‡åœ¨èµ‹å€¼åä¼šäº§ç”Ÿä¸€ä¸ª<code>lock addl $0x0,(%esp)</code>å‘å¯„å­˜å™¨ä¸­åŠ 0çš„ç©ºæ“ä½œï¼Œè¿™ä¸ªæ“ä½œèƒ½ä½¿ç”¨æœ¬CPUçš„Cacheå†™å…¥å†…æ ¸ï¼Œå¹¶ä½¿åˆ«çš„CPUæˆ–è€…åˆ«çš„å†…æ ¸æ— æ•ˆåŒ–Cacheã€‚ç›¸å½“äºå°†å·¥ä½œå†…å­˜ä¸­çš„å˜é‡æ‹¿åˆ°äº†ä¸»å†…å­˜å½“ä¸­ï¼Œæ­£æ˜¯å› ä¸ºæ­¤è®©<code>volatile</code>ä¿®é¥°çš„å˜é‡é©¬ä¸Šå¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.talkwithkeyboard.code;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileControl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">boolean</span> shutdownRequested = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        shutdownRequested = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> loopCount = <span class="number">100000000</span>;</span><br><span class="line">        System.out.println(Thread.currentThread().getId() + <span class="string">":"</span> + loopCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopCount; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shutdownRequested) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getId() + <span class="string">":"</span> + <span class="string">"shutdown!"</span>);</span><br><span class="line">        shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> THREAD_COUNT = <span class="number">10</span>;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[THREAD_COUNT];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREAD_COUNT; i ++) &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> Thread(() -&gt; <span class="keyword">new</span> VolatileControl().doWork());</span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚åœ¨è¿™ä¸ªä¾‹å­å½“ä¸­ï¼Œè®©æ¯ä¸ªçº¿ç¨‹éƒ½å¾ªç¯100000000æ¬¡ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æœ€åå¯ä»¥çœ‹åˆ°<code>shutdown!</code>åªè¢«æ‰“å°äº†ä¸€æ¬¡ã€‚ä½†æ˜¯ä¸€æ—¦å»æ‰<code>volatile</code>ä¿®é¥°ä»¥åï¼Œå°±ä¼šçœ‹åˆ°å¾ˆå¤šä¸ª<code>shutdown!</code>è¢«æ‰“å°å‡ºæ¥ï¼Œè¿™å°±æ˜¯å› ä¸ºå¾ˆå¤šçº¿ç¨‹åœ¨<code>shutdownRequested</code>è¢«ä¿®æ”¹ä»¥åï¼Œéƒ½è¯»åˆ°äº†è€ç‰ˆæœ¬çš„å€¼ï¼Œå‡ºç°äº†çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µã€‚è€Œ<code>volatile</code>ä»è¡¨ç°æ¥çœ‹åŸºæœ¬ä¸Šè¾¾åˆ°äº†ä¸º<code>shutdownRequested</code>åŠ é”çš„æ•ˆæœã€‚ä½†æ˜¯åˆšæ‰ä¹Ÿæåˆ°äº†æˆ‘ä»¬æ˜¯åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯åªçœ‹åˆ°ä¸€æ¬¡<code>shutdown!</code>ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¯ä»¥å…ˆçœ‹ä¸€ä¸ªæ›´åŠ å®¹æ˜“å¤ç°çš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.talkwithkeyboard.code;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileIncrease</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> race = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        race = race + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> THREAD_COUNT = <span class="number">20</span>;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[THREAD_COUNT];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREAD_COUNT; i++) &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                    increase();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(race);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯ä¸Šé¢å‡ºç°è¿‡çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ç»™<code>race</code>ç´¯åŠ å€¼çš„ä»£ç ï¼Œåªä¸è¿‡ç°åœ¨ä¼šç”¨<code>volatile</code>è¿›è¡Œä¿®é¥°ã€‚<code>volatile</code>çš„ç‰¹æ€§åˆæ˜¯å€¼è¢«ä¿®æ”¹åç«‹å³èƒ½è¢«å…¶ä»–çº¿ç¨‹çœ‹è§ï¼Œé‚£ä¹ˆè¿™ä¸ªä¾‹å­å°±åº”è¯¥è¾“å‡ºæ­£ç¡®çš„ç»“æœ200000ï¼Œä½†æ˜¯è¿è¡Œåä¼šå‘ç°è¿˜æ˜¯å‡ºç°äº†ä¸Šé¢æåˆ°çš„çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ã€‚é‚£ä¹ˆè¿™æ˜¯ä¸æ˜¯å’Œ<code>volatile</code>çš„æè¿°ä¸ç¬¦å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯è¾“å‡ºå­—èŠ‚ç æ¥çœ‹çœ‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static void increase();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=0, args_size=0</span><br><span class="line">         0: getstatic     #2                  // Field race:I</span><br><span class="line">         3: iconst_1</span><br><span class="line">         4: iadd</span><br><span class="line">         5: putstatic     #2                  // Field race:I</span><br><span class="line">         8: return</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°é—®é¢˜æ˜¯å‡ºåœ¨<code>race = race + 1</code>ä¸Šé¢ï¼Œåˆ°å­—èŠ‚ç å±‚é¢ä¸Šè¿™ä¸ªæ“ä½œå·²ç»è¢«æ‹†åˆ†æˆäº†4æ¡æŒ‡ä»¤ï¼Œå¹¶ä¸”ä¸å…·å¤‡äº‹åŠ¡æ€§äº†ã€‚<code>volatile</code>èƒ½ä¿è¯çš„æ˜¯<code>getstatic</code>èƒ½å–åˆ°æœ€æ–°çš„å€¼ï¼Œä½†æ˜¯åœ¨<code>iadd</code>æ“ä½œçš„æ—¶å€™å…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»æŠŠè¿™ä¸ªå€¼åŠ å¤§äº†ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­å½“ä¸­åŒç†ï¼Œåœ¨å°†<code>shutdownRequested</code>èµ‹å€¼ä¸ºtrueçš„æ—¶å€™ï¼Œå¯èƒ½å…¶ä»–çº¿ç¨‹å·²ç»èµ‹å€¼æˆåŠŸï¼Œä½†æ˜¯å½“å‰çº¿ç¨‹ä¸å¯è§ã€‚æ‰€ä»¥<code>volatile</code>çš„ä½œç”¨æ˜¯éå¸¸è½»å¾®çš„ï¼Œåªèƒ½å¤Ÿä¿è¯åœ¨å–å€¼çš„æ—¶å€™èƒ½å–åˆ°æœ€æ–°å€¼ï¼Œå½“ä¸€ä¸ªæ“ä½œçš„äº‹åŠ¡æ€§æ— æ³•ä¿è¯çš„æ—¶å€™ï¼Œ<code>volatile</code>ä¹Ÿä¸èƒ½æä¾›é”çš„æ€§è´¨ã€‚è‡³äºé˜²æ­¢æŒ‡ä»¤é‡æ‹å’Œé¢˜ç›®ç›¸å…³æ€§ä¸å¼ºï¼Œè¿™é‡Œå…ˆä¸åšèµ˜è¿°ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨ã€Šæ·±å…¥ç†è§£JVMè™šæ‹Ÿæœºã€‹ä¸­ï¼Œæœ‰å¯¹<code>synchronized</code>å’Œ<code>ReentrantLock</code>è¿›è¡Œæ€§èƒ½å¯¹æ¯”ï¼Œé€šè¿‡å¯¹<code>synchronized</code>çš„ä¼˜åŒ–ï¼Œæ€§èƒ½åŸºæœ¬ä¸ŠæŒå¹³ã€‚å¹¶ä¸”æä¾›å› ä¸ºå›¢é˜Ÿä¼šæ›´åå‘äºä¼˜åŒ–åŸç”Ÿçš„<code>synchronized</code>å…³é”®å­—ï¼Œæ‰€ä»¥å½“ä¸¤ä¸ªéƒ½èƒ½ä½¿ç”¨çš„æ—¶å€™å¯ä»¥ä¼˜å…ˆä½¿ç”¨<code>synchronized</code>å…³é”®å­—ï¼Œéœ€è¦æ›´é«˜é˜¶çš„åŠŸèƒ½æ—¶ï¼Œå†é€‰æ‹©<code>ReentrantLock</code>ã€‚ä½†æ˜¯å› ä¸ºé˜»å¡çš„å®ç°æ–¹å¼ï¼Œè¿™ä¸¤ç§å®ç°éƒ½ä¼šé˜»å¡åé¢å…¶ä»–çš„çº¿ç¨‹è¿›å…¥ï¼Œè€ŒJavaçš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è¦é˜»å¡æˆ–å”¤é†’ï¼Œéƒ½æ˜¯éœ€è¦æ“ä½œç³»ç»Ÿä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°æ ¸å¿ƒæ€æ¥è¿›è¡Œå¸®å¿™çš„ï¼Œæ‰€ä»¥éœ€è¦éå¸¸è°¨æ…çš„æ—¶å€™ï¼Œåœ¨ä¸€å®šæƒ…å†µä¸‹æ˜¯å¯ä»¥ä½¿ç”¨<code>volatile</code>å…³é”®å­—æ¥è¿›è¡Œæ›¿ä»£çš„ï¼Œä»¥æé«˜æ€§èƒ½ã€‚</p>
<h2 id="éé˜»å¡åŒæ­¥-ä¹è§‚é”"><a href="#éé˜»å¡åŒæ­¥-ä¹è§‚é”" class="headerlink" title="éé˜»å¡åŒæ­¥ ä¹è§‚é”"></a>éé˜»å¡åŒæ­¥ ä¹è§‚é”</h2><p>ç”±äºæ‚²è§‚é”çš„å®ç°ä¸­æ¶‰åŠåˆ°åŠ é”ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€åˆ‡æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çº¿ç¨‹éœ€è¦è¢«å”¤é†’ç­‰å¤æ‚çš„æ“ä½œï¼Œåœ¨æ‰§è¡Œæ•ˆç‡ä¸Šå¤§æ‰“æŠ˜æ‰£ã€‚éšç€ç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œåˆå¤šäº†ä¸€ç§é”å®ç°æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯ä¹è§‚é”ï¼Œå…¶ä¸»è¦çš„æ€æƒ³æ˜¯ï¼šå…ˆè¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰ç«äº‰åˆ™æ“ä½œæˆåŠŸï¼Œå¦‚æœæœ‰ç«äº‰ï¼Œé‚£å°±å†é‡‡å–å…¶ä»–çš„è¡¥å¿æªæ–½ã€‚è¿™ç§å®ç°æ–¹å¼ä¸‹ï¼Œä¸éœ€è¦å°†çº¿ç¨‹æŒ‚èµ·ï¼Œå› æ­¤ä¹Ÿç§°ä¸ºéé˜»å¡åŒæ­¥ã€‚</p>
<h3 id="Compare-and-Swap"><a href="#Compare-and-Swap" class="headerlink" title="Compare-and-Swap"></a>Compare-and-Swap</h3><p>ä¹è§‚é”çš„ä¸€ä¸ªå®ç°å…³é”®æ˜¯éœ€è¦è®©â€œç°åœ¨çš„å€¼ç­‰äºæ—§é¢„æœŸå€¼æ—¶ï¼Œå°†æ–°é¢„æœŸå€¼å†™å…¥â€è¿™ä¸ªæ“ä½œåŸå­åŒ–ï¼Œè€Œè¿™ä¹Ÿä¾èµ–äºç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œå‡ºç°äº†<code>CAS(Compare-and-Swap)</code>æŒ‡ä»¤æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚CASæŒ‡ä»¤éœ€è¦ä¸‰ä¸ªæ“ä½œæ•°ï¼Œåˆ†åˆ«æ˜¯å†…å­˜ä½ç½®Vã€æ—§çš„é¢„æœŸå€¼Aã€æ–°çš„é¢„æœŸå€¼Bã€‚CASæŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œå½“ä¸”ä»…å½“Vç¬¦åˆæ—§çš„é¢„æœŸå€¼Açš„æ—¶å€™ï¼Œå¤„ç†å™¨ç”¨æ–°å€¼Bæ›´æ–°Vçš„å€¼ï¼Œå¦åˆ™å®ƒå°±ä¸æ‰§è¡Œæ›´æ–°ï¼Œä½†æ˜¯æ— è®ºæ˜¯å¦æ›´æ–°äº†Vçš„å€¼ï¼Œéƒ½ä¼šè¿”å›Vçš„æ—§å€¼ï¼Œå¹¶ä¸”ä¸Šè¿°çš„è¿‡ç¨‹æ˜¯åŸå­æ€§çš„ã€‚åœ¨JDK1.5ä¹‹åï¼Œ<code>sun.misc.Unsafe</code>ç±»çš„<code>compareAndSwapInt()</code>å’Œ<code>compareAndSwapLong()</code>ç­‰å‡ ä¸ªæ“ä½œéƒ½ä¾é CASæŒ‡ä»¤æ‰§è¡Œï¼Œè™šæ‹Ÿæœºå†…éƒ¨å¯¹è¿™äº›æ–¹æ³•åšäº†ç‰¹æ®Šå¤„ç†ï¼Œå³æ—¶ç¼–è¯‘å‡ºæ¥çš„ç»“æœå°±æ˜¯ä¸€æ¡å¹³å°ç›¸å…³çš„å¤„ç†å™¨CASæŒ‡ä»¤ã€‚åœ¨æ›´ä¸Šå±‚ä¸­çš„æ¥å£ä¸­ï¼Œ<code>AtomicInteger.incerementAndGet()</code>ç­‰ä½¿ç”¨äº†<code>Unsafe</code>çš„ä½å±‚æ¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.talkwithkeyboard.code;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadAtomicIncrease</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AtomicInteger race = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        race.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> THREAD_COUNT = <span class="number">20</span>;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[THREAD_COUNT];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREAD_COUNT; i++) &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                    insert();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(race.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ä¹è§‚é”æ¥å¯¹ä¸Šé¢å¤šçº¿ç¨‹ç´¯åŠ çš„ç¨‹åºè¿›è¡Œä¼˜åŒ–ï¼Œè¿è¡Œç¨‹åºå¯ä»¥çœ‹åˆ°æ­£ç¡®çš„ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">incrementAndGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>incrementAndGet</code>æ–¹æ³•å°±æ˜¯å¯¹<code>Unsafe</code>ç±»çš„<code>getAndAddInt</code>æ–¹æ³•è¿›è¡Œäº†å°è£…ï¼Œè€Œ<code>getAndAddInt</code>åœ¨ä½å±‚ä½¿ç”¨äº†å’ŒCASç±»ä¼¼çš„æŒ‡ä»¤<code>Fetch-and-Increment</code>ï¼Œå°†è·å–å€¼å’Œç´¯åŠ ä¸¤ä¸ªæ“ä½œè¿›è¡ŒåŸå­åŒ–å°è£…ã€‚è€Œåœ¨æ—©æœŸçš„JDKå®ç°ä¸­ï¼Œæ˜¯ä½¿ç”¨CASæŒ‡ä»¤è¿›è¡Œå®Œæˆï¼Œä¸æ–­å°è¯•å°†æ¯”ç°åœ¨å€¼å¤§1çš„å€¼å†™å…¥ã€‚è¿™ä¸ªä¼˜åŒ–ä¹Ÿæ˜¯ç¡¬ä»¶æŒ‡ä»¤é›†çš„è¿›ä¸€æ­¥ä¸°å¯Œå¸¦æ¥çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> current = get();</span><br><span class="line">        <span class="keyword">int</span> next = current + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(current, next))</span><br><span class="line">            <span class="keyword">return</span> current;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="é”ä¼˜åŒ–"><a href="#é”ä¼˜åŒ–" class="headerlink" title="é”ä¼˜åŒ–"></a>é”ä¼˜åŒ–</h2><h3 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h3><p>å› ä¸ºäº’æ–¥åŒæ­¥å¯¹æ€§èƒ½çš„æ¶ˆè€—éå¸¸å¤§ï¼Œå¹¶ä¸”JVMå›¢é˜Ÿå‘ç°å¤§é‡çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´è¿œå°äºå¯¹CPUçš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢æ—¶é—´ã€‚æ‰€ä»¥å°±æƒ³å‡ºæ¥ä¸€ä¸ªåŠæ³•ä¸è½»æ˜“çš„å¯¹çº¿ç¨‹è¿›è¡Œé˜»å¡ï¼Œè€Œä½¿ç”¨å¿™å¾ªç¯ï¼ˆè‡ªæ—‹ï¼‰æ¥æ›¿ä»£ã€‚ä¸è¿‡è‡ªæ—‹ä¹Ÿä¸æ˜¯å®Œå…¨ä¼˜äºé˜»å¡çš„ï¼Œè™½ç„¶çœä¸‹äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œä¸è¿‡å¿™å¾ªç¯ä¼šå ç”¨å¤„ç†å™¨æ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœé”å®šçŠ¶æ€æ—¶é—´è¾ƒçŸ­ä½¿ç”¨è‡ªæ—‹æ˜¯åˆ’ç®—çš„ï¼Œé”å®šçŠ¶æ€æ—¶é—´è¾ƒé•¿å°±ä¼šæµªè´¹å¤„ç†å™¨èµ„æºï¼Œå¸¦æ¥æ€§èƒ½çš„æ¶ˆè€—ã€‚å› æ­¤ç°åœ¨çš„å®ç°ä¸­ï¼Œä¼šè§„å®šä¸€ä¸ªè‡ªæ—‹çš„ä¸Šé™ï¼Œå½“è¾¾åˆ°ä¸Šé™ä»¥åå°±è½¬ä¸ºé‡é”çš„æ–¹å¼æŒ‚èµ·çº¿ç¨‹ã€‚ç°åœ¨é«˜ç‰ˆæœ¬çš„JDKä¸­è‡ªæ—‹æ˜¯é»˜è®¤å¼€å¯çš„ï¼ŒJavaç”¨æˆ·å¯ä»¥é€šè¿‡<code>-XX:PreBlockSpin</code>æ¥ä¿®æ”¹è‡ªæ—‹çš„æ¬¡æ•°ã€‚</p>
<p>å¹¶ä¸”ä¸ºäº†è¿›ä¸€æ­¥çš„æé«˜è‡ªæ—‹é”çš„æ€§èƒ½ï¼Œåœ¨JDK1.6æå‡ºäº†è‡ªé€‚åº”çš„è‡ªæ—‹é”ï¼Œæ¯æ¬¡è‡ªæ—‹çš„æ—¶é—´ä¸å›ºå®šï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´ä»¥åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€å†³å®šã€‚å¦‚æœåœ¨ä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œé€šè¿‡è‡ªæ—‹çš„æ–¹å¼ç»å¸¸æˆåŠŸè·å¾—è¿‡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„è¿›ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆè¿™æ¬¡è‡ªæ—‹æœ‰è¾ƒå¤§å¯èƒ½è·å¾—é”ï¼Œå°±å¯ä»¥ç­‰å¾…è¾ƒå¤šçš„è‡ªæ—‹æ¬¡æ•°ã€‚å¦‚æœåœ¨ä¸€ä¸ªé”å¯¹è±¡ä¸Šä»æ¥æ²¡æœ‰æˆåŠŸé€šè¿‡è‡ªæ—‹è·å¾—é”ï¼Œé‚£ä¹ˆå°±ç›´æ¥çœå»è‡ªæ—‹æ­¥éª¤ï¼Œç›´æ¥è¿›å…¥é‡é”ã€‚</p>
<h3 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h3><p>é”æ¶ˆé™¤æ˜¯æŒ‡å¼€å‘äººå‘˜è™½ç„¶è¦æ±‚ä¸€æ®µä»£ç å—éœ€è¦ä¸Šé”ï¼ŒåŒæ­¥æ‰§è¡Œã€‚ä½†æ˜¯è¢«JVMæ£€æµ‹åˆ°å­˜åœ¨ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”ï¼Œå°±ä¼šè‡ªåŠ¨å°†å…¶æ¶ˆé™¤æ‰ã€‚è¿™ä¸ªæ£€æµ‹ä¸»è¦ä¾èµ–é€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒï¼Œå¦‚æœåˆ¤æ–­åœ¨ä¸€æ®µä»£ç ä¸­ï¼Œå †ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½ä¸ä¼šé€ƒé€¸å‡ºå»è¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£å°±å¯ä»¥æŠŠå®ƒå½“ä½œæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºä»–ä»¬æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå°±ä¸ç”¨åŠ é”ã€‚</p>
<h3 id="é”ç²—åŒ–"><a href="#é”ç²—åŒ–" class="headerlink" title="é”ç²—åŒ–"></a>é”ç²—åŒ–</h3><p>å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éƒ½å¸Œæœ›åŠ é”çš„ä½œç”¨èŒƒå›´é™åˆ¶çš„å°½å¯èƒ½çš„å°ï¼Œè¿™æ ·å¯ä»¥ç¼©çŸ­é”çŠ¶æ€çš„æŒç»­æ—¶é—´ï¼Œè®©ç­‰å¾…çš„çº¿ç¨‹å°½å¿«çš„è·å¾—é”ã€‚ä½†æ˜¯å¶å°”ä¼šå‡ºç°ä¸€ç³»åˆ—è¿ç»­çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œå‡ºç°åœ¨å¾ªç¯ä½“ä¸­çš„ï¼Œè¿™æ ·é¢‘ç¹çš„è¿›è¡Œäº’æ–¥åŒæ­¥ä¼šæå¤§çš„é™ä½æ‰§è¡Œæ•ˆç‡ï¼Œè¿™æ—¶å€™è™šæ‹Ÿæœºæ¢æµ‹åˆ°æœ‰è¿™æ ·ä¸€ä¸²é›¶ç¢çš„æ“ä½œéƒ½å¯¹ä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°±ä¼šæŠŠåŠ é”çš„èŒƒå›´ç²—åŒ–åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨ï¼Œè¿™æ ·åŠ é”ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚å°±è¿˜æ˜¯ç”¨ä¸Šé¢çš„ä¾‹å­ä¸¾ä¾‹ï¼Œæ¯æ¬¡<code>increase</code>æ“ä½œéƒ½æœ‰åŠ é”è§£é”çš„æ­¥éª¤ï¼Œè¿™æ—¶å°±ä¼šæŠŠé”ç²—åŒ–åˆ°forå¾ªç¯çš„å¤–éƒ¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.talkwithkeyboard.code;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadIncreaseSync</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> race = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        race = race + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> THREAD_COUNT = <span class="number">20</span>;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[THREAD_COUNT];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREAD_COUNT; i++) &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                    increase();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            threads[i].start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (Thread.activeCount() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(race);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h3><p>è½»é‡çº§é”çš„ä¼˜åŒ–æ–¹å‘æ˜¯ä½¿ç”¨CASä»£æ›¿äº’æ–¥é‡çš„å¼€é”€ï¼Œå¹¶ä¸”ä¾æ®ç»éªŒâ€œå¯¹äºç»å¤§å¤šæ•°çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½æ˜¯ä¸å­˜åœ¨ç«äº‰çš„â€ï¼Œå‡è®¾æ²¡æœ‰ç«äº‰é‚£ä¹ˆCASæ“ä½œå°±é¿å…äº†äº’æ–¥é‡çš„å¼€é”€ï¼Œä½†æ˜¯å¦‚æœå­˜åœ¨ç«äº‰ï¼Œè½»é‡é”æœ€ç»ˆä¼šè†¨èƒ€ä¸ºé‡é‡é”ï¼Œä¸ä»…æœ‰äº’æ–¥é‡çš„å¼€é”€ï¼Œè¿˜å¤šäº†CASæ“ä½œã€‚åœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡å¤´ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯éå›ºå®šæ•°æ®ç»“æ„çš„ï¼Œç”¨æ¥å‚¨å­˜å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œå€¼ï¼ŒGCåˆ†å¸¦å¹´é¾„ç­‰æ•°æ®ï¼Œå®˜æ–¹ç§°ä¸ºâ€Mark wordâ€ï¼›å¦ä¸€éƒ¨åˆ†ç”¨äºå‚¨å­˜æŒ‡å‘æ–¹æ³•åŒºå¯¹è±¡ç±»å‹æ•°æ®çš„æŒ‡é’ˆï¼Œè¿™ä¸€éƒ¨åˆ†å…ˆä¸å…³æ³¨ã€‚è€Œâ€œMark wordâ€å°±æ˜¯é”å®ç°çš„å…³é”®ï¼Œæˆ‘ä»¬ä»¥32ä½çš„HotSpotä¸¾ä¾‹ï¼Œ32bitçš„â€Mark wordâ€ä¸­é™¤äº†2bitç”¨äºå­˜å‚¨é”æ ‡å¿—ä½å¤–ï¼Œå…¶ä»–çš„30bitæ‰€ä¿å­˜çš„å†…å®¹éƒ½æ ¹æ®é”çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼š</p>
<ul>
<li>å½“å¤„äºæœªé”å®šï¼ˆæ ‡å¿—ä½ä¸º01ï¼‰æ—¶ï¼Œ29bitå­˜å‚¨äº†å¯¹è±¡å“ˆå¸Œå€¼ã€å¯¹è±¡åˆ†ä»£å¹´é¾„ç­‰</li>
<li>éœ€è¦åŠ é”æ—¶ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å¤„äºæœªé”å®šçŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨å½“å‰é”å¯¹è±¡â€Mark wordâ€çš„æ‹·è´</li>
<li>ä½¿ç”¨CASæ“ä½œå°†å…¶ä½™30bitæ›´æ–°ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆ<ul>
<li>è¿™äº›åŠ¨ä½œæˆåŠŸäº†ï¼Œæ”¹å˜æ ‡å¿—ä½ï¼ˆ00æ˜¯è½»é‡çº§é”ï¼‰ï¼Œè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”</li>
<li>å¦‚æœå¤±è´¥äº†ï¼Œè™šæ‹Ÿæœºä¼šæ£€æŸ¥å¯¹è±¡çš„Mark wordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»è·å¾—é”ï¼Œåˆ™ç›´æ¥è¿›å…¥åŒæ­¥å—æ‰§è¡Œã€‚å¦åˆ™è¿™ä¸ªé”å¯¹è±¡å·²ç»è¢«å…¶ä»–çš„çº¿ç¨‹æŠ¢å äº†ã€‚è¿™æ—¶å€™è½»é‡é”è†¨èƒ€ä¸ºé‡é‡é”ï¼Œæ ‡å¿—ä½æ”¹ä¸º10ï¼ŒMark wordæŒ‡å‘é‡é‡é”ï¼Œåé¢çš„çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li>
</ul>
</li>
<li>å½“æ‰§è¡Œå®ŒåŒæ­¥å—ï¼Œä½¿ç”¨CASæ“ä½œå°†å¯¹è±¡å½“å‰çš„Mark wordä¸ä¹‹å‰å­˜å‚¨çš„è€Mark wordæ‹·è´è¿›è¡Œäº¤æ¢ï¼Œå®Œæˆè§£é”ã€‚</li>
</ul>
<h3 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h3><p>åå‘é”çš„ä¼˜åŒ–æ–¹å‘æ˜¯åœ¨ä¸å­˜åœ¨ç«äº‰æ—¶ç›´æ¥å»æ‰åŒæ­¥åŸè¯­ï¼Œå½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å–çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºä¼šå°†æ ‡å¿—ä½æ”¹ä¸º01ï¼Œå³åå‘æ¨¡å¼ï¼ŒåŒæ—¶ä½¿ç”¨CASæ“ä½œæŠŠè·å–åˆ°çš„é”çš„çº¿ç¨‹IDè®°å½•åœ¨Mark wordä¹‹ä¸­ï¼Œå¦‚æœæ“ä½œæˆåŠŸï¼Œè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ã€‚ä¹‹åå½“æŒæœ‰åå‘é”çš„çº¿ç¨‹è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºä¸éœ€è¦åšä»»ä½•æ“ä½œï¼Œè€Œåœ¨è½»é‡é”ä¸­ï¼Œè¿˜æ˜¯éœ€è¦å°è¯•æ£€æŸ¥é”å®šçŠ¶æ€ï¼Œä»¥åŠå¯¹è±¡çš„Mark wordæ˜¯å¦æŒ‡å‘è‡ªå·±ã€‚å½“æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”çš„æ—¶å€™ï¼Œåå‘é”å°±è†¨èƒ€ä¸ºè½»é‡é”ã€‚åå‘é”å¯ä»¥æé«˜å¸¦æœ‰åŒæ­¥ä½†æ— ç«äº‰çš„ç¨‹åºæ€§èƒ½ï¼Œä½†æ˜¯å¦‚æœç¨‹åºä¸­å¤§å¤šæ•°çš„é”æ€»æ˜¯è¢«å¤šä¸ªä¸åŒçš„çº¿ç¨‹è®¿é—®ï¼Œé‚£åå‘æ¨¡å¼å°±æ˜¯å¤šä½™çš„ã€‚å¯ä»¥é€šè¿‡<code>-XX:-UseBiasedLocking</code>æ¥è¿›è¡Œç¦æ­¢ã€‚</p>
<p><img src="/images/a-14-1.jpg" alt="a-14-1"></p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>å‚è€ƒèµ„æ–™ï¼šã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹</p>

	
	</div>
  <a type="button" href="/2019/10/18/a14/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/09/28/a6/" >Elasticsearchä¼˜åŒ–æ€è·¯</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-09-28  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<blockquote>
<p>äº9æœˆ25æ—¥ï¼Œå‚åŠ äº‘æ –å¤§ä¼šelasticsearchä¸“åœºåå¯¹é˜¿é‡Œäº‘çš„ä¼˜åŒ–æ€è·¯è¿›è¡Œæ•´ç†æ€»ç»“ã€‚è¡Œæ–‡åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªéƒ¨åˆ†æ˜¯å¯¹åŸç”Ÿelasticsearchçš„è§£å†³æ–¹æ¡ˆè¿›è¡Œå¤§è‡´ä»‹ç»ï¼Œå†å¯¹é˜¿é‡Œäº‘çš„ä¼˜åŒ–è¿›è¡Œæ•´ç†ã€‚</p>
</blockquote>
<h2 id="åŸç”Ÿæ¶æ„"><a href="#åŸç”Ÿæ¶æ„" class="headerlink" title="åŸç”Ÿæ¶æ„"></a>åŸç”Ÿæ¶æ„</h2><p>åœ¨elasticsearchå½“ä¸­<code>index</code>æ˜¯å¤§å®¶æœ€ç†Ÿæ‚‰çš„ç»„ç»‡ç»“æ„ï¼Œå®ƒå°±åƒä¼ ç»Ÿnosqlæ•°æ®åº“ä¸­çš„collectionï¼Œç»„ç»‡ç€ä¸€æ‰¹æœ‰ç›¸åŒæ•°æ®ç»“æ„çš„æ•°æ®ã€‚å½“ä¸€ä¸ª<code>index</code>ä¸­çš„æ•°æ®é‡è¶Šæ¥è¶Šå¤§ï¼Œå°±ä¼šå¾ˆè‡ªç„¶çš„å°†<code>index</code>è¿›è¡Œåˆ†ç‰‡ï¼Œåˆ†åˆ°å¤šä¸ªshardå½“ä¸­ã€‚è¿™æ ·é€šè¿‡æ°´å¹³æ‰©å±•å°±èƒ½è§£å†³æ•°æ®è†¨èƒ€çš„é—®é¢˜ï¼Œç„¶ååŒæ—¶ä¹Ÿå¼•å…¥äº†å‰¯æœ¬æ¥æé«˜æ•´ä¸ªé›†ç¾¤çš„å¯ç”¨æ€§ã€‚æ‰€ä»¥æœ‰ä¸¤ä¸ª<code>index</code>ï¼Œæ¯ä¸ª<code>index</code>æœ‰3ä¸ªshardï¼Œæ¯ä¸ªshardæœ‰2ä¸ªreplicaçš„é›†ç¾¤å°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ğŸ‘‡ï¼š<br><img src="/images/a6-1.png" alt="a6-1"><br>index Aæœ‰3ä¸ªshardï¼š<code>A1</code>ã€<code>A2</code>ã€<code>A3</code>ï¼Œ<code>A1â€™</code>æ˜¯<code>A1</code>çš„å‰¯æœ¬ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>åœ¨è¿™æ ·çš„æ¶æ„ä¸­ï¼Œå¦‚æœæƒ³å‘index Aä¸­å†™å…¥æ–‡æ¡£ï¼Œä¼šå…ˆé€šè¿‡è·¯ç”±ç®—æ³•åˆ†é…åˆ°ä¸€ä¸ªprimaryæ‰€åœ¨çš„èŠ‚ç‚¹ï¼ˆæ¯”å¦‚<code>A1</code>ï¼‰è¿›è¡Œå†™å…¥ï¼Œå®Œæˆä»¥åä¼šåˆ°è¯¥primaryçš„å‰¯æœ¬<code>A1â€™</code>ä¸­è¿›è¡Œå†™å…¥ï¼Œå®Œæˆä»¥åå†è¿”å›æˆåŠŸã€‚å¯ä»¥çœ‹å‡ºè¿™æ ·çš„æµç¨‹ä¸­æœ‰å‡ ä¸ªç“¶é¢ˆæ‰€åœ¨ï¼š</p>
<ul>
<li>å¦‚æœå‰¯æœ¬çš„æ•°é‡ä¸€æ—¦è¾ƒå¤šï¼Œå†™è¯·æ±‚çš„å»¶æ—¶å°±ä¼šæˆå€å¢é•¿</li>
<li>å‰¯æœ¬ä¼šä¿å­˜ä¸€ä»½å®Œæ•´çš„æ•°æ®ï¼Œæ‰€ä»¥é›†ç¾¤çš„å­˜å‚¨æˆæœ¬ä¹Ÿåœ¨æˆå€åœ°å¢é•¿</li>
<li>å¦‚æœå‰¯æœ¬æ•°é‡è¶…è¿‡äº†åˆ†ç‰‡æ•°é‡ï¼Œä¼šå‡ºç°æœ‰èŠ‚ç‚¹åªæ˜¯ç”¨æ¥åšå‰¯æœ¬çš„æƒ…å†µï¼Œåªèƒ½è¢«è¯»ï¼Œæµªè´¹äº†èµ„æº</li>
<li>å½“ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œä¼šä»æ–°åœ¨å‰¯æœ¬å½“ä¸­é€‰ä¸¾ä¸»èŠ‚ç‚¹ï¼Œå¹¶æ–°å¯åŠ¨ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»æ–°çš„ä¸»èŠ‚ç‚¹å½“ä¸­å…¨é‡æ‹·è´æ•°æ®ã€‚å…¨é‡æ‹·è´çš„å»¶æ—¶è¾ƒé•¿ï¼Œåœ¨è¿™ä¸€æ®µæ—¶é—´å†…æ–°å‰¯æœ¬èŠ‚ç‚¹æ˜¯ä¸å¯ç”¨çš„ï¼Œæ‰€æœ‰çš„æµé‡ä¼šæ‰“åˆ°ä¸»èŠ‚ç‚¹å’Œå…¶ä»–å‰¯æœ¬èŠ‚ç‚¹ä¸Šï¼Œå¯èƒ½å‡ºç°æ€§èƒ½é—®é¢˜</li>
</ul>
<h2 id="ä¼˜åŒ–æ¶æ„"><a href="#ä¼˜åŒ–æ¶æ„" class="headerlink" title="ä¼˜åŒ–æ¶æ„"></a>ä¼˜åŒ–æ¶æ„</h2><p>å…ˆæ¥çœ‹é˜¿é‡Œäº‘çš„æ¶æ„å›¾ğŸ‘‡ï¼š<br><img src="/images/a6-2.png" alt="a6-2"><br>ä½¿ç”¨äº†è®¡ç®—ä¸å­˜å‚¨åˆ†ç¦»çš„æ¶æ„ï¼Œé€šè¿‡åº•å±‚çš„äº‘å‚¨å­˜æ¥æä¾›å…±äº«å­˜å‚¨ã€‚è¿™æ ·ä¸»å‰¯ä¹‹é—´çš„æ•°æ®åªç”¨å­˜åœ¨ä¸€ä¸ªåœ°æ–¹å³å¯ï¼Œè€ŒèŠ‚ç‚¹ä¸Šåªæä¾›è®¡ç®—èƒ½åŠ›ï¼Œç”±äº‘å­˜å‚¨æ¥æä¾›æ•°æ®çš„å¤šå‰¯æœ¬æœºåˆ¶ä»¥ä¿è¯æ•°æ®çš„å¯é æ€§ã€‚å¦‚æœè¦å®Œæ•´çš„ç†è§£ä¸Šé¢è¿™å¼ å›¾ï¼Œæˆ‘ä»¬éœ€è¦å†ä»‹ç»ä¸€äº›æ¦‚å¿µï¼š</p>
<p>åœ¨elasticsearchä¸­ï¼Œä¸€ä¸ªshardæ˜¯ç”±å¤šä¸ªsegmentç»„æˆçš„ï¼Œå¹¶å¯¹åº”ä¸€ä¸ªtranslogæ–‡ä»¶ã€‚é‚£ä¹ˆå½“å†™å…¥ä¸€ä¸ªæ–‡æ¡£æ—¶ï¼Œä¼šå…ˆåœ¨translongä¸­è¿›è¡Œç›¸åº”çš„è®°å½•ï¼Œå¹¶å°†å…¶å†™å…¥åˆ°primaryèŠ‚ç‚¹çš„bufferå½“ä¸­ã€‚ç„¶ååœ¨primaryèŠ‚ç‚¹ä¸Šæ˜¯æœ‰ä¸€ä¸ªæ¯ç§’æ‰§è¡Œä¸€æ¬¡çš„<code>refresh</code>æ“ä½œï¼Œè¯¥æ“ä½œä¼šæŠŠbufferå½“ä¸­çš„æ‰€æœ‰documentå†™å…¥åˆ°å†…å­˜ä¸­çš„ä¸€ä¸ªæ–°çš„segmentå½“ä¸­ï¼Œè¿™æ—¶å€™æ–‡æ¡£å˜æˆäº†å¯è¢«æ£€ç´¢çš„çŠ¶æ€ï¼Œæ‰€ä»¥ä¸€ä¸ªsegmentå®é™…å°±æ˜¯ä¸€ä¸ªå€’æ’ç´¢å¼•ã€‚æœ€åä¼šæœ‰ä¸€ä¸ª<code>flush</code>æ“ä½œï¼Œè¯¥æ“ä½œä¹Ÿä¼šæŠŠbufferä¸­çš„æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„segmentä¸­ï¼Œå¹¶è¿›ä¸€æ­¥å°†å†…å­˜ä¸­çš„æ‰€æœ‰segmentå†²æ´—åˆ°ç¡¬ç›˜ä¸Šï¼Œå¹¶æ¸…ç©ºè¯¥shardä¸Šçš„translogã€‚</p>
<p>åœ¨å¯¹æ•´ä¸ªç´¢å¼•è¿‡ç¨‹è§£é‡Šäº†ä¸€éä»¥åå°±å¯ä»¥æ¸…æ™°çš„ç†è§£ä¸Šå›¾ï¼ŒNFSè¡¨ç¤ºé˜¿é‡Œäº‘æä¾›çš„åˆ†å¸ƒå¼äº‘å­˜å‚¨ã€‚å½“ä¸€ä¸ªindexè¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼ŒprimaryèŠ‚ç‚¹ä¼šå…ˆåœ¨translogä¸­æ·»åŠ ä¸€æ¡è®°å½•ï¼Œå¹¶å°†è¯¥æ–‡æ¡£å†™å…¥bufferå½“ä¸­ã€‚æ¯éš”ä¸€æ®µæ—¶é—´ï¼ŒprimaryèŠ‚ç‚¹ä¼šè¿›è¡Œrefreshæ“ä½œå°†bufferä¸­çš„æ‰€æœ‰æ•°æ®å†™å…¥åˆ°nfsçš„refresh segmentä¸­è¿›è¡Œä¿å­˜ã€‚ç„¶åä¼šç”± <code>nrt segment synchronizer</code>è¿›ç¨‹å®šæœŸçš„å¤åˆ¶refresh segmentä¸­çš„æ•°æ®åˆ°ä¸´æ—¶ç›®å½•å½“ä¸­ã€‚æœ€åä¼šç”±<code>flush</code>æ“ä½œï¼Œå°†refresh segmentä¸­çš„æ•°æ®å†™å…¥åˆ°commit segmentä¸­ï¼Œå¹¶åˆ é™¤refresh segmentï¼Œä¸´æ—¶ç›®å½•ï¼Œä»¥åŠtranslogã€‚è€Œè¯»è¯·æ±‚å¦‚æœä»primaryèŠ‚ç‚¹è¯»ä¼šè¯»åˆ°refresh segment + commit segmentçš„å†…å®¹ï¼Œå¦‚æœä»replicaä¸­è¯»ä¼šè¯»åˆ°ä¸´æ—¶ç›®å½• + commit segmentçš„å†…å®¹ã€‚</p>
<p>è¿™ç§æ¶æ„è§£å†³äº†åŸç”Ÿæ¶æ„çš„ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>é™ä½äº†å†™è¯·æ±‚çš„å»¶æ—¶ï¼Œå› ä¸ºç°åœ¨çš„refresh segmentåˆ°ä¸´æ—¶ç›®å½•çš„å¤åˆ¶æ²¡æœ‰é€šè¿‡ç½‘ç»œä¼ è¾“ï¼Œç›´æ¥æ˜¯åŒä¸€æ–‡ä»¶ç³»ç»Ÿä¸­çš„å¤åˆ¶ï¼Œæ‰€ä»¥å¤§å¤§é™ä½äº†ä¸»å¤‡å»¶æ—¶ã€‚ï¼ˆæ®é˜¿é‡Œæ‰€è¯´ä»åˆ†é’Ÿçº§é™ä½åˆ°äº†æ¯«ç§’çº§ï¼Œä½†æ˜¯åŸç”Ÿæ¶æ„ä¹Ÿæ²¡æœ‰åˆ†é’Ÿçº§è¿™ä¹ˆå¤¸å¼ å§â€¦ï¼‰</li>
<li>commit segmentåªä¼šä¿å­˜ä¸€ä»½ï¼Œæ‰€ä»¥ä¸ä¼šå› ä¸ºå‰¯æœ¬æ•°é‡è¿‡å¤šè€Œå¯¼è‡´é›†ç¾¤çš„å­˜å‚¨æˆæœ¬ä¸Šå‡</li>
<li>å› ä¸ºè®¡ç®—ä¸å­˜å‚¨åˆ†ç¦»ï¼Œå½“å‡ºç°ä¸»èŠ‚ç‚¹æ•…éšœéœ€è¦ä¸»å‰¯åˆ‡æ¢æ—¶ï¼Œä¸éœ€è¦é•¿æ—¶é—´çš„æ‹·è´å…¨é‡æ•°æ®ï¼Œä¸€ä¸ªæ–°çš„å‰¯èŠ‚ç‚¹å¯åŠ¨ä»¥åï¼Œåªè¦æŒ‡å‘åŸæ¥çš„ä¸´æ—¶ç›®å½•å³å¯</li>
</ul>
<p>ä½†æ˜¯ä¹Ÿå¼•å…¥äº†ä¸€äº›æ–°çš„é—®é¢˜ï¼š</p>
<ul>
<li>ç”±äºç°åœ¨æ˜¯å…±äº«å†…å­˜ï¼Œæ‰€ä»¥refreshæ“ä½œå¤šäº†ä¼ è¾“æˆæœ¬ï¼Œå¹¶ä¸”åœ¨NFSçš„é€Ÿåº¦ä¹Ÿä½äºåŸæœ¬æœºå†…å­˜ä¸­çš„é€Ÿåº¦ï¼Œæ‰€ä»¥è¿™é‡Œçš„æˆæœ¬æœ‰æé«˜ã€‚ä¸è¿‡åº”è¯¥æ˜¯å°äºä¸»ä»å¤åˆ¶çš„æ€§èƒ½æå‡ã€‚</li>
<li>å¼•å…¥äº†ä¸€äº›ä¼ ç»Ÿå…±äº«å†…å­˜å‹åˆ†å¸ƒå¼çš„é—®é¢˜ï¼Œæ¯”å¦‚è„‘è£‚ï¼ŒåŒå†™ç­‰ã€‚ä¸è¿‡åœ¨PPTä¸­ä¹Ÿçœ‹åˆ°é˜¿é‡Œä¹Ÿå®ç°äº†IO fencingæ¥é¿å…ä¸»ä»åˆ‡æ¢æ—¶å¸¦æ¥çš„åŒå†™é—®é¢˜ã€‚</li>
</ul>
<p>ä¸‹é¢å†ç®€å•ä»‹ç»ä¸€ä¸‹æ¼”è®²ä¸­è®²åˆ°çš„ä¸»ä»å¤åˆ¶çš„ä¼˜åŒ–ï¼Œä¸‹é¢æ˜¯ç»™å‡ºçš„ç¤ºæ„å›¾ğŸ‘‡ï¼š<br><img src="/images/a6-3.png" alt="a6-3"><br>é˜¿é‡Œè¯´æ˜¯ä½¿ç”¨äº†luence-replicatoræ¡†æ¶è¿›è¡Œå®ç°ï¼Œæˆ‘ç°åœ¨è¿˜æ²¡ä»”ç»†é˜…è¯»ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹çœ‹<a href="http://shaierera.blogspot.com/2013/05/the-replicator.html" target="_blank" rel="noopener">Code Reduction: The Replicator</a><br>æ‰€ä»¥æˆ‘ä¸‹é¢çš„è§£é‡Šä¸»è¦åŸºäºä»–ä»¬çš„æ¼”è®²ä»¥åŠä¸€äº›çŒœæµ‹ï¼š<br>åœ¨ä¸»ä»å¤åˆ¶è¿‡ç¨‹å½“ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¼šå®šæ—¶çš„å¯¹metaè¿›è¡Œå¿«ç…§ï¼Œæ¯”å¦‚ç”Ÿæˆäº†å›¾ä¸­çš„snapshot4ï¼Œç„¶åå¯¹å®ƒå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå†å‘é€ç»™ä»èŠ‚ç‚¹ã€‚ä»èŠ‚ç‚¹ä¼šå’Œè‡ªå·±çš„å¿«ç…§è¿›è¡Œæ¯”å¯¹ï¼Œæ‰¾åˆ°è½åäº†å¤šå°‘ä¸ªç‰ˆæœ¬ã€‚å°†ç¼ºå°‘çš„segmentå¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•å½“ä¸­ï¼Œå¤åˆ¶å®Œæˆä»¥åå°±å¯ä»¥é€šçŸ¥primaryèŠ‚ç‚¹å¤åˆ¶ç»“æŸï¼Œä»è€Œå‡å°‘åŒæ­¥å‰ä»èŠ‚ç‚¹å¿«ç…§ç‰ˆæœ¬çš„å¼•ç”¨è®¡æ•°ï¼Œåˆ é™¤å¼•ç”¨è®¡æ•°ä¸º0çš„æ–‡ä»¶ã€‚</p>
<p>å…¶ä¸­è¿˜æåˆ°äº†ä¸€äº›é’ˆå¯¹segment mergeçš„ä¼˜åŒ–ï¼Œé‚£ä¹ˆè¿˜æ˜¯å…ˆä»‹ç»ä¸€äº›ä»€ä¹ˆæ˜¯segment mergeï¼š<br>å› ä¸ºæ¯ç§’éƒ½ä¼šè¿›è¡Œ<code>refresh</code>æ“ä½œï¼Œç”Ÿæˆä¸€ä¸ªå°çš„segmentæ–‡ä»¶ï¼Œè¿™äº›å°çš„æ–‡ä»¶å¯¹å†…å­˜çš„åˆ©ç”¨ç‡æ˜¯éå¸¸ä½çš„ï¼Œè€Œä¸”æ¯æ¬¡queryè¯·æ±‚æ¥çš„æ—¶å€™éƒ½ä¼šè½®è®­è¿™äº›å°çš„segmentæ–‡ä»¶ï¼Œæ‰€ä»¥æ–‡ä»¶æ•°é‡è¶Šå¤šæ€§èƒ½è¶Šå·®ã€‚elasticsearchä¼šåœ¨åå°è¿›è¡Œå¼‚æ­¥çš„åˆå¹¶æ“ä½œï¼Œä»å°çš„segmentåˆå¹¶æˆå¤§çš„segmentï¼Œå¹¶ä¸”åœ¨åˆå¹¶é˜¶æ®µå¤„ç†æ–‡ä»¶çš„åˆ é™¤å’Œæ›´æ–°ã€‚</p>
<p>é‚£ä¹ˆä¼˜åŒ–çš„éƒ¨åˆ†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯åœ¨åˆå¹¶æˆå¤§çš„segmentä»¥åä¼šç«‹å³è¿›è¡Œ<code>flush</code>æ“ä½œï¼Œæ¥ä¿è¯å¤§çš„segmentä¸ä¼šå‡ºç°åœ¨ä¸»ä»å¤åˆ¶å½“ä¸­ã€‚ä»è€Œè¿›ä¸€æ­¥çš„å¯¹ä¸»ä»å¤åˆ¶è¿›è¡Œæé€Ÿã€‚</p>
<h2 id="ä¼˜åŒ–ç´¢å¼•é€Ÿåº¦"><a href="#ä¼˜åŒ–ç´¢å¼•é€Ÿåº¦" class="headerlink" title="ä¼˜åŒ–ç´¢å¼•é€Ÿåº¦"></a>ä¼˜åŒ–ç´¢å¼•é€Ÿåº¦</h2><h3 id="ç¦»çº¿"><a href="#ç¦»çº¿" class="headerlink" title="ç¦»çº¿"></a>ç¦»çº¿</h3><p>ç¦»çº¿å…¨é‡å†™å…¥ä¸€ç›´æ˜¯ä¸€ä¸ªç—›ç‚¹é—®é¢˜ï¼Œä¼ ç»Ÿè§£å†³åŠæ³•æ˜¯ç»´æŠ¤ä¸¤ä¸ªelasticsearché›†ç¾¤ï¼Œæ­£å¸¸ä½¿ç”¨Aé›†ç¾¤ï¼Œç„¶åæ”¶é›†Aé›†ç¾¤çš„translogï¼Œå¹¶å°†å…¨é‡å¿«ç…§å†™å…¥Bé›†ç¾¤ï¼Œå®Œæˆä»¥åå›æ”¾translogï¼Œä¿è¯ä¸¤è¾¹æ•°æ®ä¸€è‡´ã€‚å®Œæˆåä»Aé›†ç¾¤åˆ‡åˆ°Bé›†ç¾¤ï¼Œè¿™æ ·çš„ç»´æŠ¤æˆæœ¬æ˜¯éå¸¸é«˜çš„ï¼Œå¹¶ä¸”å…¨é‡å¿«ç…§å†™å…¥çš„æ—¶é—´åˆéå¸¸çš„é•¿ã€‚</p>
<p>é˜¿é‡Œäº‘é’ˆå¯¹è¿™ä¸ªç‚¹è¿›è¡Œçš„ä¼˜åŒ–æ˜¯å–æ¶ˆäº†translogï¼Œä½¿ç”¨blink checkpointå¤©ç”Ÿçš„at least onceçš„è¯­ä¹‰æ¥ä¿è¯æ•…éšœæ¢å¤ï¼Œç›¸å½“äºå‡å°‘äº†ä¸€åŠçš„å†™å·¥ä½œé‡ã€‚ä½†æ˜¯è¿™æ ·ç›¸å½“äºåœ¨elasticsearchå¤–é¢å¥—ä¸Šäº†ä¸€ä¸ªblinkï¼Œå¹¶ä¸”éœ€è¦å’Œå¤–éƒ¨çš„blinkè¿›è¡Œé€šä¿¡ï¼Œç³»ç»Ÿå¤æ‚åº¦åˆä¸Šå‡äº†ä¸€ä¸ªç­‰çº§ï¼ˆä¸è¿‡åæ­£ä¹Ÿæ˜¯äº‘æœåŠ¡ï¼Œåˆä¸è¦æˆ‘ä»¬è‡ªå·±åšDBAï¼‰ã€‚ç¬¬äºŒä¸ªæ˜¯åœ¨segmentåˆå¹¶ä¸Šå¢åŠ äº†ä¸€ä¸ªlimitï¼Œåªæœ‰åˆå¹¶åè¾¾åˆ°ä¸€å®šçš„å¤§å°æ‰ä¼š<code>flush</code>åˆ°ç£ç›˜å½“ä¸­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç£ç›˜é‡Œçš„å°segmentå†è¢«è¯»å…¥åˆ°å†…å­˜ä¸­è¿›è¡Œåå¤çš„åˆå¹¶ï¼Œå‡å°IOæ¬¡æ•°ã€‚</p>
<p>å‰ä¸¤ä¸ªæˆ‘è§‰å¾—éƒ½æ˜¯è¾ƒå°çš„ä¼˜åŒ–ï¼Œç¬¬ä¸‰ä¸ªä¼˜åŒ–æ¯”è¾ƒå¤§ï¼Œå¦‚ä¸‹å›¾ğŸ‘‡ï¼š<br><img src="/images/a6-4.png" alt="a6-4"><br>ä¼˜åŒ–çš„æ ¸å¿ƒç‚¹æ˜¯åˆ©ç”¨æ›´é«˜çš„å¹¶å‘æå‰è®¡ç®—å¥½ç´¢å¼•ï¼Œç›´æ¥è®©çº¿ä¸Šçš„elasticsearché›†ç¾¤æ¥loadç´¢å¼•ã€‚å…·ä½“æ€ä¹ˆåšçš„å‘¢ï¼Œå°±æ˜¯åˆ©ç”¨blinkçš„æµè®¡ç®—èƒ½åŠ›æ¥å–ä»£client nodeçš„è®¡ç®—æ•°æ®åˆ†ç‰‡èƒ½åŠ›ï¼Œç„¶åæ¨¡æ‹Ÿprocessï¼Œbuildï¼Œmergeä¸‰ä¸ªæ“ä½œå¹¶å°†å…¶åˆ†å¸ƒå¼åŒ–ï¼Œè®©è¿™ä¸‰ä¸ªæ“ä½œéƒ½å¯ä»¥è¿›è¡Œæ°´å¹³æ‰©å±•ï¼Œè®©ç´¢å¼•èƒ½åŠ›å¯ä»¥éšç€è®¡ç®—èµ„æºçš„æå‡è€Œæå‡ã€‚åŸæ¥å¦‚æœæƒ³æé«˜ç´¢å¼•çš„è®¡ç®—èƒ½åŠ›ï¼Œæ˜¯éœ€è¦å¯¹elasticsearché›†ç¾¤çš„èµ„æºè¿›è¡Œæ‹“å±•ï¼Œä½†æ˜¯ç°åœ¨å°†ç´¢å¼•è®¡ç®—çš„æ­¥éª¤åˆ†ç¦»äº†å‡ºæ¥ï¼Œè½¬å˜æˆäº†ä¸€ä¸ªç»å…¸åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶èƒ½è§£å†³çš„é—®é¢˜ã€‚æœ€åæ”¾åˆ°OSSå½“ä¸­ï¼Œè®©çº¿ä¸Šçš„æ¨¡å‹è¿›è¡Œloadã€‚ç±»ä¼¼çš„ä¼˜åŒ–ä¹‹å‰ä¹Ÿæœ‰äººå·²ç»å°è¯•è¿‡ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹<a href="https://elasticsearch.cn/slides/217#page=5" target="_blank" rel="noopener">åŸºäºHadoopå¿«é€Ÿæ„å»ºç¦»çº¿elasticsearchç´¢å¼•</a></p>
<h3 id="åœ¨çº¿"><a href="#åœ¨çº¿" class="headerlink" title="åœ¨çº¿"></a>åœ¨çº¿</h3><p>åœ¨çº¿å¢é‡å¯¼å…¥çš„ä¼˜åŒ–ä¹Ÿæ˜¯å°†client nodeè·¯ç”±è®¡ç®—çš„èƒ½åŠ›æ”¾åˆ°äº†blinkä¸Šï¼Œå› ä¸ºä»–ä»¬å‘ç°åœ¨å¤§æ•°æ®å¢é‡å¯¼å…¥çš„æ—¶å€™ï¼Œç“¶é¢ˆå‡ºç°åœ¨äº†CPUä¸Šï¼Œæ‰€ä»¥å°†è®¡ç®—éƒ¨åˆ†å¤–ç§»ï¼Œå¹¶ä¸”blinkå¯ä»¥æ›´å¥½çš„è¿›è¡Œé’ˆå¯¹è®¡ç®—çš„å¼¹æ€§å‡ç¼©ã€‚</p>
<p>å‚è€ƒææ–™ï¼š<br><a href="https://zhuanlan.zhihu.com/p/33375126" target="_blank" rel="noopener">ä»Elasticsearchæ¥çœ‹åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„è®¾è®¡ - çŸ¥ä¹</a><br><a href="https://blog.csdn.net/laoyang360/article/details/84727820" target="_blank" rel="noopener">Elasticsearchå†™å…¥åŸç†æ·±å…¥è¯¦è§£ - é“­æ¯…å¤©ä¸‹ï¼ˆå…¬ä¼—å·åŒåï¼‰ - CSDNåšå®¢</a><br><a href="https://blog.csdn.net/lsgqjh/article/details/83022206" target="_blank" rel="noopener">Elasticsearch ä¹‹ commit point | Segment | refresh | flush ç´¢å¼•åˆ†ç‰‡å†…éƒ¨åŸç† - èˆ’å“¥çš„blog - CSDNåšå®¢</a></p>

	
	</div>
  <a type="button" href="/2019/09/28/a6/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/05/11/a5/" >RATE LIMIT FOR MONGOSPARK WRITER</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-05-11  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>æœ€è¿‘è¿ç§»æ•°æ®åº“çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œç›¸ä¿¡ä¹Ÿæ˜¯å¾ˆå¤š MongoDB ä½¿ç”¨è€…éƒ½ä¼šé‡åˆ°çš„é—®é¢˜ã€‚æˆ‘åœ¨ä½¿ç”¨ MongoSpark æ‰¹é‡çš„å†™å…¥æ•°æ®çš„æ—¶å€™ä¼šé€ æˆä¸¥é‡çš„æ•°æ®åº“æŠ–åŠ¨ã€‚ä¸»è¦çš„åŸå› æ˜¯ç°åœ¨å¤§å¤š MongoDB çš„é…ç½®éƒ½æ˜¯ replica set æ¨¡å¼ï¼Œè¿™æ ·å†™æ“ä½œåªä¼šåˆ° Master èŠ‚ç‚¹ä¸Šï¼Œå†™æ“ä½œå°±ä¼šæˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆï¼Œå¤§é‡çš„å†™æ“ä½œä¼šä½¿ Master èŠ‚ç‚¹çš„è¯»æ“ä½œå˜æ…¢ï¼Œå¹¶ä¸”ä¼šè®© secondary èŠ‚ç‚¹åŒæ­¥é€Ÿåº¦å˜æ…¢ï¼Œä»è€Œå‡ºç°ä» secondary èŠ‚ç‚¹ä¸Šè¯»åˆ°è€æ•°æ®çš„é—®é¢˜ã€‚</p>
<p>è€Œé€šè¿‡å¯¹ MongoDB è¿›è¡Œ shard æ˜¯ä¸€ä¸ªä»£ä»·éå¸¸æ˜‚è´µä¸”åªèƒ½çº¿æ€§æé«˜å†™ååçš„æ–¹æ³•ï¼Œéå¸¸çš„ä¸ç»æµå®æƒ ã€‚æ‰€ä»¥æˆ‘ä»¬ä¹Ÿåªèƒ½ç‰ºç‰²é€Ÿç‡æ¥ä¿è¯çº¿ä¸ŠæœåŠ¡çš„ç¨³å®šã€‚æ‰€ä»¥è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨ MongoSpark ä¸­æ·»åŠ ä¸Šå†™é™é€ŸåŠŸèƒ½ã€‚</p>
<h2 id="Guava-RateLimiter"><a href="#Guava-RateLimiter" class="headerlink" title="Guava.RateLimiter"></a>Guava.RateLimiter</h2><p>é€‰æ‹©çš„é™é€Ÿå™¨æ˜¯ Guava æä¾›çš„ä»¤ç‰Œæ¡¶ã€‚ç®—æ³•çš„åŸç†å¾ˆç®€å•ï¼Œä¼šå®šæ—¶çš„å‘æ¡¶ä¸­æ”¾ç½®ä»¤ç‰Œï¼ŒæœåŠ¡åªæœ‰è·å¾—ä»¤ç‰Œä»¥åæ‰èƒ½è¿›è¡Œåç»­çš„æ“ä½œï¼Œæ¯”å¦‚å¸Œæœ›å¯¹ä¸€ä¸ªæœåŠ¡è¿›è¡Œæ¯ç§’10æ¬¡çš„é™é€Ÿï¼Œé‚£ä¹ˆæ¯ç§’ä¸­å°±ä¼šå‘æ¡¶ä¸­æ”¾ç½®10ä¸ªä»¤ç‰Œã€‚è€Œè·å–çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é˜»å¡ç­‰å¾…ä»¤ç‰Œæˆ–è€…å–ä¸åˆ°ä»¤ç‰Œç›´æ¥è¿”å›å¤±è´¥ã€‚</p>
<p>é‚£ä¹ˆä¸‹é¢å°±ç®€å•çš„ä»‹ç»ä¸€ä¸‹APIï¼Œä¸»è¦æ˜¯åˆ†ä¸¤ä¸ªåŠ¨ä½œï¼Œåˆ›å»ºæ¡¶å’Œè·å–ä»¤ç‰Œï¼š</p>
<p><strong>åˆ›å»ºä»¤ç‰Œæ¡¶</strong> </p>
<ul>
<li><code>RateLimiter create(double permitsPerSecond)</code>: æ ¹æ®ä¸€ä¸ªç¨³å®šçš„é€Ÿç‡åˆ›å»ºä»¤ç‰Œæ¡¶ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’æ’å…¥ permitsPerSecond ä¸ªä»¤ç‰Œã€‚</li>
<li><code>RateLimiter create(double permitsPerSecond, long warmupPeriod, TimeUnit unit)</code>: é€šè¿‡ä¸€ä¸ªé¢„çƒ­æ—¶é—´æ®µè¾¾åˆ°ç¨³å®šçš„é€Ÿç‡åˆ›å»ºä»¤ç‰Œæ¡¶ï¼Œåœ¨ warmupPeriod è¿™æ®µæ—¶é—´å†…æ¯ç§’ä»¤ç‰Œæ•°é‡å¹³ç¨³çš„çˆ¬å‡è‡³ permitsPerSecondï¼Œè€Œåä¿æŒç¨³å®šã€‚è¿™é‡Œçš„é€Ÿç‡ä¹Ÿæ˜¯å€¼æ¯ç§’æ’å…¥ permitsPerSecond ä¸ªä»¤ç‰Œã€‚</li>
</ul>
<p><strong>è·å–ä»¤ç‰Œ</strong></p>
<ul>
<li><code>void acquire()</code>: è·å–ä¸€ä¸ªä»¤ç‰Œï¼Œä¼šä¸€ç›´é˜»å¡ç­‰å¾…ç›´åˆ°æ‹¿åˆ°ã€‚</li>
<li><code>void acquire(int permits)</code>: è·å– permits ä¸ªä»¤ç‰Œï¼Œä¼šä¸€ç›´é˜»å¡ç­‰åˆ°ç›´åˆ°å…¨éƒ¨æ‹¿åˆ°ã€‚</li>
<li><code>boolean tryAcquire()</code>: è·å–ä¸€ä¸ªä»¤ç‰Œï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥ç›´æ¥è¿”å› falseã€‚</li>
<li><code>boolean tryAcquire(long timeout, TimeUnit unit)</code>: è·å–ä¸€ä¸ªä»¤ç‰Œï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œæ²¡æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œæ—¶ç­‰åˆ° timeout æ—¶é—´ï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆ™è¿”å› falseã€‚</li>
<li><code>boolean tryAcquire(int permits)</code>: è·å– permits ä¸ªä»¤ç‰Œï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥ç›´æ¥è¿”å› falseã€‚</li>
<li><code>boolean tryAcquire(int permits, long timeout, TimeUnit unit)</code>: è·å– permits ä¸ªä»¤ç‰Œï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œæ²¡æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œæ—¶ç­‰åˆ° timeout æ—¶é—´ï¼Œå¦‚æœè¿˜æ²¡æœ‰åˆ™è¿”å› falseã€‚</li>
</ul>
<p>é€šè¿‡ä¸Šé¢çš„APIå¯ä»¥å¾ˆçµæ´»çš„å¯¹ RateLimiter è¿›è¡Œä½¿ç”¨ï¼Œä½†æ˜¯åœ¨é˜…è¯»æºç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¹Ÿå‘ç°äº† Guava çš„å®ç°ä¸­æœ‰ä¸€ä¸ªä¸å°½å¦‚äººæ„çš„åœ°æ–¹ã€‚é‚£å°±æ˜¯é™åˆ¶èƒ½åŠ›åªèƒ½åœ¨æ¯ç§’å¤šå°‘ä¸ªä»¤ç‰Œæ¡¶ï¼Œä½†æ˜¯æˆ‘æƒ³å®ç°å°†å°‘ä¸€ç§’çš„å‰©ä½™ä»¤ç‰Œç•™ç»™ä¸‹ä¸€ç§’ç»§ç»­ç”¨ï¼Œä¹Ÿå°±æ˜¯å‡ ç§’ç”šè‡³æ›´é«˜æ—¶é—´å•ä½çš„é™æµæ˜¯ä¸è¡Œçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Bursty</span> <span class="keyword">extends</span> <span class="title">RateLimiter</span> </span>&#123;</span><br><span class="line">    Bursty(RateLimiter.SleepingTicker ticker) &#123;</span><br><span class="line">        <span class="keyword">super</span>(ticker, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doSetRate</span><span class="params">(<span class="keyword">double</span> permitsPerSecond, <span class="keyword">double</span> stableIntervalMicros)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> oldMaxPermits = <span class="keyword">this</span>.maxPermits;</span><br><span class="line">        <span class="keyword">this</span>.maxPermits = permitsPerSecond;</span><br><span class="line">        <span class="keyword">this</span>.storedPermits = oldMaxPermits == <span class="number">0.0</span>D ? <span class="number">0.0</span>D : <span class="keyword">this</span>.storedPermits * <span class="keyword">this</span>.maxPermits / oldMaxPermits;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">storedPermitsToWaitTime</span><span class="params">(<span class="keyword">double</span> storedPermits, <span class="keyword">double</span> permitsToTake)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>Bursty</code> å°±æ˜¯å§‹ç»ˆä¿æŒå¹³ç¨³é€Ÿç‡çš„ä»¤ç‰Œæ¡¶ç±»ï¼Œå…¶ä¸­ <code>maxPermits</code> æ˜¯æ¡¶ä¸­æœ€å¤šæœ‰å¤šå°‘çš„ä»¤ç‰Œï¼Œ<code>storedPermits</code> æ˜¯ç°åœ¨æ¡¶ä¸­çš„ä»¤ç‰Œä¸ªæ•°ã€‚å¯ä»¥çœ‹åˆ°<code>maxPermits</code> å§‹ç»ˆç­‰äº <code>permitsPerSecond</code>ï¼Œæ˜¯ä¸èƒ½ä¹˜ä¸Šæ—¶é—´ç³»æ•°çš„ï¼Œå¹¶ä¸”åœ¨é‡æ–°è®¾ç½® <code>maxPermits</code> åä¼šæŒ‰ç…§æ¯”ä¾‹ç¼©æ”¾ä¹‹å‰çš„æ¡¶ä¸­ä»¤ç‰Œæ•°é‡ã€‚</p>
<h2 id="MongoSpark-save"><a href="#MongoSpark-save" class="headerlink" title="MongoSpark.save"></a>MongoSpark.save</h2><p><code>save()</code> æ–¹æ³•æ˜¯æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„ä¸»è¦æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ MongoSpark ä¸­åˆå­˜åœ¨å¤šç§çš„ save æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«ä¸ºè¿™äº› save æ–¹æ³•åŠ ä¸Šé™æµåŠŸèƒ½ï¼Œæˆ–è€…ä½ å·²ç»å¾ˆæ˜ç¡®å°†ä½¿ç”¨çš„å‡½æ•°ã€‚</p>
<p>åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ—¢ç„¶è¦é™æµï¼Œé‚£æˆ‘ä»¬è‚¯å®šéœ€è¦ä¸€ä¸ªå‚æ•°æ¥æ§åˆ¶æµé€Ÿï¼Œè€Œåœ¨ MongoSpark ä¸­æ˜¯æœ‰ä¸€ä¸ªé…ç½®ç±»ä¾›æˆ‘ä»¬è®¾ç½®å‚æ•°çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹ <code>WriteConfig</code> è¿™ä¸ªç±»ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Write Configuration for writes to MongoDB</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param databaseName       the database name</span></span><br><span class="line"><span class="comment"> * @param collectionName     the collection name</span></span><br><span class="line"><span class="comment"> * @param connectionString   the optional connection string used in the creation of this configuration.</span></span><br><span class="line"><span class="comment"> * @param replaceDocument    replaces the whole document, when saving a Dataset that contains an `_id` field.</span></span><br><span class="line"><span class="comment"> *                           If false only updates / sets the fields declared in the Dataset.</span></span><br><span class="line"><span class="comment"> * @param maxBatchSize       the maxBatchSize when performing a bulk update/insert. Defaults to 512.</span></span><br><span class="line"><span class="comment"> * @param localThreshold     the local threshold in milliseconds used when choosing among multiple MongoDB servers to send a request.</span></span><br><span class="line"><span class="comment"> *                           Only servers whose ping time is less than or equal to the server with the fastest ping time plus the local</span></span><br><span class="line"><span class="comment"> *                           threshold will be chosen.</span></span><br><span class="line"><span class="comment"> * @param writeConcernConfig the write concern configuration</span></span><br><span class="line"><span class="comment"> * @param shardKey           an optional shardKey in extended json form: `"&#123;key: 1, key2: 1&#125;"`. Used when upserting DataSets in sharded clusters.</span></span><br><span class="line"><span class="comment"> * @param forceInsert        if true forces the writes to be inserts, even if a Dataset contains an `_id` field. Default `false`.</span></span><br><span class="line"><span class="comment"> * @param ordered            configures the bulk operation ordered property. Defaults to true.</span></span><br><span class="line"><span class="comment"> * @param secondLatch        the maxBatchSize when performing a bulk update/insert per second per partition.</span></span><br><span class="line"><span class="comment"> * @since 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteConfig</span>(<span class="params"></span></span></span><br><span class="line"><span class="class"><span class="params">    databaseName:       <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    collectionName:     <span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    connectionString:   <span class="type">Option</span>[<span class="type">String</span>]     = <span class="type">None</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    replaceDocument:    <span class="type">Boolean</span>            = <span class="type">WriteConfig</span>.<span class="type">DefaultReplaceDocument</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    maxBatchSize:       <span class="type">Int</span>                = <span class="type">WriteConfig</span>.<span class="type">DefaultMaxBatchSize</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    localThreshold:     <span class="type">Int</span>                = <span class="type">MongoSharedConfig</span>.<span class="type">DefaultLocalThreshold</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    writeConcernConfig: <span class="type">WriteConcernConfig</span> = <span class="type">WriteConcernConfig</span>.<span class="type">Default</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    shardKey:           <span class="type">Option</span>[<span class="type">String</span>]     = <span class="type">None</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    forceInsert:        <span class="type">Boolean</span>            = <span class="type">WriteConfig</span>.<span class="type">DefaultForceInsert</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    ordered:            <span class="type">Boolean</span>            = <span class="type">WriteConfig</span>.<span class="type">DefautOrdered</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">    secondLatch:        <span class="type">Option</span>[<span class="type">Int</span>]        = <span class="type">None</span></span></span></span><br><span class="line"><span class="class"><span class="params"></span>) <span class="keyword">extends</span> <span class="title">MongoCollectionConfig</span> <span class="keyword">with</span> <span class="title">MongoClassConfig</span> </span>&#123;</span><br><span class="line">  require(maxBatchSize &gt;= <span class="number">1</span>, <span class="string">s"maxBatchSize (<span class="subst">$maxBatchSize</span>) must be greater or equal to 1"</span>)</span><br><span class="line">  require(localThreshold &gt;= <span class="number">0</span>, <span class="string">s"localThreshold (<span class="subst">$localThreshold</span>) must be greater or equal to 0"</span>)</span><br><span class="line">  require(<span class="type">Try</span>(connectionString.map(uri =&gt; <span class="keyword">new</span> <span class="type">ConnectionString</span>(uri))).isSuccess, <span class="string">s"Invalid uri: '<span class="subst">$&#123;connectionString.get&#125;</span>'"</span>)</span><br><span class="line">  require(<span class="type">Try</span>(shardKey.map(json =&gt; <span class="type">BsonDocument</span>.parse(json))).isSuccess, <span class="string">s"Invalid shardKey: '<span class="subst">$&#123;shardKey.get&#125;</span>'"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">type</span> <span class="title">Self</span> </span>= <span class="type">WriteConfig</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">withOption</span></span>(key: <span class="type">String</span>, value: <span class="type">String</span>): <span class="type">WriteConfig</span> = <span class="type">WriteConfig</span>(<span class="keyword">this</span>.asOptions + (key -&gt; value))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">withOptions</span></span>(options: collection.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]): <span class="type">WriteConfig</span> = <span class="type">WriteConfig</span>(options, <span class="type">Some</span>(<span class="keyword">this</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">asOptions</span></span>: collection.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>] = &#123;</span><br><span class="line">    <span class="keyword">val</span> options = mutable.<span class="type">Map</span>(<span class="string">"database"</span> -&gt; databaseName, <span class="string">"collection"</span> -&gt; collectionName,</span><br><span class="line">      <span class="type">WriteConfig</span>.replaceDocumentProperty -&gt; replaceDocument.toString,</span><br><span class="line">      <span class="type">WriteConfig</span>.localThresholdProperty -&gt; localThreshold.toString,</span><br><span class="line">      <span class="type">WriteConfig</span>.forceInsertProperty -&gt; forceInsert.toString) ++ writeConcernConfig.asOptions</span><br><span class="line">    connectionString.map(uri =&gt; options += (<span class="type">WriteConfig</span>.mongoURIProperty -&gt; uri))</span><br><span class="line">    shardKey.map(json =&gt; options += (<span class="type">WriteConfig</span>.shardKeyProperty -&gt; json))</span><br><span class="line">    secondLatch.map(number =&gt; options += (<span class="type">WriteConfig</span>.secondLatchProperty -&gt; number.toString))</span><br><span class="line">    options.toMap</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">withOptions</span></span>(options: util.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]): <span class="type">WriteConfig</span> = withOptions(options.asScala)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">asJavaOptions</span></span>: util.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>] = asOptions.asJava</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The `WriteConcern` that this config represents</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @return the WriteConcern</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">writeConcern</span></span>: <span class="type">WriteConcern</span> = writeConcernConfig.writeConcern</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¿®æ”¹ä»¥åçš„ <code>WriteConfig</code> ç±»ä»£ç ï¼Œæˆ‘ä»¬æ·»åŠ ä¸Šäº†ä¸€ä¸ª <code>secondLatch</code> çš„å‚æ•°ä½œä¸ºæµé€Ÿæ§åˆ¶å‚æ•°ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™å¯ä»¥ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> writeConfig = <span class="keyword">new</span> <span class="type">WriteConfig</span>(conf.mongoDatabase, conf.mongoCollection)</span><br><span class="line">  .withOption(<span class="type">WriteConfig</span>.replaceDocumentProperty, conf.replaceDocument.toString)</span><br><span class="line">  .withOption(<span class="type">WriteConfig</span>.mongoURIProperty, conf.mongoUri)</span><br><span class="line">  .withOption(<span class="type">WriteConfig</span>.secondLatchProperty, conf.secondLatch.toString)</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <code>withOption()</code> çš„æ–¹æ³•è®¾å®š <code>secondLatch</code> å‚æ•°ï¼Œç„¶åæˆ‘ä»¬è·Ÿè¸ªä¸€ä¸‹ä¸Šé¢çš„ <code>withOption()</code> æ–¹æ³•çš„å®ç°ï¼Œæ˜¯é€šè¿‡ä¸€ä¸ª <code>WriteConfig(options: util.Map[String, String])</code> çš„æ„é€ å‡½æ•°è¿›è¡Œäº†æ„é€ ã€‚æ‰€ä»¥ä¹Ÿéœ€è¦ä¿®æ”¹è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(options: collection.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>], <span class="keyword">default</span>: <span class="type">Option</span>[<span class="type">WriteConfig</span>]): <span class="type">WriteConfig</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> cleanedOptions = stripPrefix(options)</span><br><span class="line">  <span class="keyword">val</span> cachedConnectionString = connectionString(cleanedOptions)</span><br><span class="line">  <span class="keyword">val</span> defaultDatabase = <span class="keyword">default</span>.map(conf =&gt; conf.databaseName).orElse(<span class="type">Option</span>(cachedConnectionString.getDatabase))</span><br><span class="line">  <span class="keyword">val</span> defaultCollection = <span class="keyword">default</span>.map(conf =&gt; conf.collectionName).orElse(<span class="type">Option</span>(cachedConnectionString.getCollection))</span><br><span class="line"></span><br><span class="line">  <span class="type">WriteConfig</span>(</span><br><span class="line">    databaseName = databaseName(databaseNameProperty, cleanedOptions, defaultDatabase),</span><br><span class="line">    collectionName = collectionName(collectionNameProperty, cleanedOptions, defaultCollection),</span><br><span class="line">    connectionString = cleanedOptions.get(mongoURIProperty).orElse(<span class="keyword">default</span>.flatMap(conf =&gt; conf.connectionString)),</span><br><span class="line">    replaceDocument = getBoolean(cleanedOptions.get(replaceDocumentProperty), <span class="keyword">default</span>.map(conf =&gt; conf.replaceDocument),</span><br><span class="line">      defaultValue = <span class="type">DefaultReplaceDocument</span>),</span><br><span class="line">    maxBatchSize = getInt(cleanedOptions.get(maxBatchSizeProperty), <span class="keyword">default</span>.map(conf =&gt; conf.maxBatchSize),</span><br><span class="line">      <span class="type">DefaultMaxBatchSize</span>),</span><br><span class="line">    localThreshold = getInt(cleanedOptions.get(localThresholdProperty), <span class="keyword">default</span>.map(conf =&gt; conf.localThreshold),</span><br><span class="line">      <span class="type">MongoSharedConfig</span>.<span class="type">DefaultLocalThreshold</span>),</span><br><span class="line">    writeConcernConfig = <span class="type">WriteConcernConfig</span>(cleanedOptions, <span class="keyword">default</span>.map(writeConf =&gt; writeConf.writeConcernConfig)),</span><br><span class="line">    shardKey = cleanedOptions.get(shardKeyProperty).orElse(<span class="keyword">default</span>.flatMap(conf =&gt; conf.shardKey).orElse(<span class="type">None</span>)),</span><br><span class="line">    forceInsert = getBoolean(cleanedOptions.get(forceInsertProperty), <span class="keyword">default</span>.map(conf =&gt; conf.forceInsert),</span><br><span class="line">      defaultValue = <span class="type">DefaultForceInsert</span>),</span><br><span class="line">    ordered = getBoolean(cleanedOptions.get(orderedProperty), <span class="keyword">default</span>.map(conf =&gt; conf.ordered), <span class="type">DefautOrdered</span>),</span><br><span class="line">	  <span class="comment">// æµé€Ÿæ§åˆ¶å‚æ•°</span></span><br><span class="line">    secondLatch = cleanedOptions</span><br><span class="line">      .get(secondLatchProperty).orElse(<span class="keyword">default</span>.flatMap(conf =&gt; <span class="type">Try</span>(conf.secondLatch.toString).toOption).orElse(<span class="type">None</span>))</span><br><span class="line">      .flatMap(s =&gt; <span class="type">Try</span>(s.toInt).toOption)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ„é€ å‡½æ•°è°ƒç”¨çš„æ˜¯ä¸€ä¸ªè¦ä¼ é€’æ‰€æœ‰å‚æ•°çš„æ„é€ å‡½æ•°è¿›è¡Œæ„é€ çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å®ç°è¿™æ ·ä¸€ä¸ªä¼ é€’æ‰€æœ‰å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œç„¶ååŠ ä¸Šï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">secondLatch = cleanedOptions</span><br><span class="line">      .get(secondLatchProperty).orElse(<span class="keyword">default</span>.flatMap(conf =&gt; <span class="type">Try</span>(conf.secondLatch.toString).toOption).orElse(<span class="type">None</span>))</span><br><span class="line">      .flatMap(s =&gt; <span class="type">Try</span>(s.toInt).toOption)</span><br></pre></td></tr></table></figure>

<p>ç”±äº <code>options</code> çš„ value éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¿™è¾¹éœ€è¦è½¬ä¸€ä¸‹ <code>Int</code>ï¼Œä¼ é€’æ‰€æœ‰å‚æ•°çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Creates a WriteConfig</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @param databaseName      the database name</span></span><br><span class="line"><span class="comment">  * @param collectionName    the collection name</span></span><br><span class="line"><span class="comment">  * @param connectionString  the optional connection string used in the creation of this configuration</span></span><br><span class="line"><span class="comment">  * @param replaceDocument   replaces the whole document, when saving a Dataset that contains an `_id` field.</span></span><br><span class="line"><span class="comment">  *                          If false only updates / sets the fields declared in the Dataset.</span></span><br><span class="line"><span class="comment">  * @param maxBatchSize      the maxBatchSize when performing a bulk update/insert. Defaults to 512.</span></span><br><span class="line"><span class="comment">  * @param localThreshold    the local threshold in milliseconds used when choosing among multiple MongoDB servers to send a request.</span></span><br><span class="line"><span class="comment">  *                          Only servers whose ping time is less than or equal to the server with the fastest ping time plus the local</span></span><br><span class="line"><span class="comment">  *                          threshold will be chosen.</span></span><br><span class="line"><span class="comment">  * @param writeConcern      the WriteConcern to use</span></span><br><span class="line"><span class="comment">  * @param shardKey          an optional shardKey in extended form: `"&#123;key: 1, key2: 1&#125;"`. Used when upserting DataSets in sharded clusters.</span></span><br><span class="line"><span class="comment">  * @param forceInsert       if true forces the writes to be inserts, even if a Dataset contains an `_id` field. Default `false`.</span></span><br><span class="line"><span class="comment">  * @param ordered           configures if the bulk operation is ordered property.</span></span><br><span class="line"><span class="comment">  * @param secondLatch       the maxBatchSize when performing a bulk update/insert per second per partition.</span></span><br><span class="line"><span class="comment">  * @return the write config</span></span><br><span class="line"><span class="comment">  * @since jike-1.0.0</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(databaseName: <span class="type">String</span>, collectionName: <span class="type">String</span>, connectionString: <span class="type">Option</span>[<span class="type">String</span>], replaceDocument: <span class="type">Boolean</span>, maxBatchSize: <span class="type">Int</span>,</span><br><span class="line">          localThreshold: <span class="type">Int</span>, writeConcern: <span class="type">WriteConcern</span>, shardKey: <span class="type">Option</span>[<span class="type">String</span>], forceInsert: <span class="type">Boolean</span>, ordered: <span class="type">Boolean</span>, secondLatch: <span class="type">Option</span>[<span class="type">Int</span>]): <span class="type">WriteConfig</span> = &#123;</span><br><span class="line">  apply(databaseName, collectionName, connectionString, replaceDocument, maxBatchSize, localThreshold, <span class="type">WriteConcernConfig</span>(writeConcern),</span><br><span class="line">    shardKey, forceInsert, ordered, secondLatch)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>case class</code> æä¾›çš„é»˜è®¤æ„é€ å‡½æ•°è¿›è¡Œæ„é€ ï¼Œè‡³æ­¤æˆ‘ä»¬å°±èƒ½æ„‰å¿«çš„å¯¹åŒ…å« <code>secondLatch</code> å­—æ®µçš„ <code>WriteConfig</code> è¿›è¡Œæ„é€ äº†ã€‚</p>
<h3 id="Save-Method"><a href="#Save-Method" class="headerlink" title="Save Method"></a>Save Method</h3><p>ç„¶åæˆ‘ä»¬å°±éœ€è¦åˆ†åˆ«å¯¹å¤šä¸ª <code>save()</code> æ·»åŠ é™é€Ÿå™¨ï¼ŒåŸç†éƒ½å¤§åŒå°å¼‚ï¼Œå°±æ˜¯åœ¨ <code>foreachPartition</code> çš„å‡½æ•°ä¸­æ„å»ºä»¤ç‰Œæ¡¶ï¼Œç„¶ååœ¨ <code>foreach</code> çš„å†™Mongodb å‡½æ•°ä¹‹å‰è¿›è¡Œé˜»å¡çš„ä»¤ç‰Œè·å–ï¼Œè¿™é‡Œå°±å±•ç¤ºå¸¸ç”¨çš„ Datasets å’Œ RDD ç±»å‹ save æ–¹æ³•çš„ä¿®æ”¹ï¼š</p>
<p><strong>save[D] (dataset: Dataset[D]): Unit</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Save data to MongoDB</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * '''Note:''' If the dataFrame contains an `_id` field the data will upserted and replace any existing documents in the collection.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param dataset the dataset to save to MongoDB</span></span><br><span class="line"><span class="comment"> * @param writeConfig the writeConfig</span></span><br><span class="line"><span class="comment"> * @tparam D</span></span><br><span class="line"><span class="comment"> * @since 1.1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span></span>[<span class="type">D</span>](dataset: <span class="type">Dataset</span>[<span class="type">D</span>], writeConfig: <span class="type">WriteConfig</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> mongoConnector = <span class="type">MongoConnector</span>(writeConfig.asOptions)</span><br><span class="line">  <span class="keyword">val</span> dataSet = dataset.toDF()</span><br><span class="line">  <span class="keyword">val</span> mapper = rowToDocumentMapper(dataSet.schema)</span><br><span class="line">  <span class="keyword">val</span> documentRdd: <span class="type">RDD</span>[<span class="type">BsonDocument</span>] = dataSet.rdd.map(row =&gt; mapper(row))</span><br><span class="line">  <span class="keyword">val</span> fieldNames = dataset.schema.fieldNames.toList</span><br><span class="line">  <span class="keyword">val</span> queryKeyList = <span class="type">BsonDocument</span>.parse(writeConfig.shardKey.getOrElse(<span class="string">"&#123;_id: 1&#125;"</span>)).keySet().asScala.toList</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (writeConfig.forceInsert || !queryKeyList.forall(fieldNames.contains(_))) &#123;</span><br><span class="line">    <span class="type">MongoSpark</span>.save(documentRdd, writeConfig)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    documentRdd.foreachPartition(iter =&gt; <span class="keyword">if</span> (iter.nonEmpty) &#123;</span><br><span class="line">		<span class="comment">// **INIT RateLimiter</span></span><br><span class="line">      <span class="keyword">var</span> rateLimiter: <span class="type">Option</span>[<span class="type">RateLimiter</span>] = <span class="type">None</span></span><br><span class="line">      <span class="keyword">if</span> (writeConfig.secondLatch.isDefined) &#123;</span><br><span class="line">        <span class="comment">// If secondLatch &lt; maxBatchSize, it will destroy rate limit rule.</span></span><br><span class="line">        <span class="keyword">val</span> permitSize = <span class="keyword">if</span> (writeConfig.secondLatch.get &gt;= writeConfig.maxBatchSize) (writeConfig.secondLatch.get / writeConfig.maxBatchSize).floor <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        rateLimiter = <span class="type">Option</span>.apply(<span class="type">RateLimiter</span>.create(permitSize))</span><br><span class="line">      &#125;</span><br><span class="line">      mongoConnector.withCollectionDo(writeConfig, &#123; collection: <span class="type">MongoCollection</span>[<span class="type">BsonDocument</span>] =&gt;</span><br><span class="line">        iter.grouped(writeConfig.maxBatchSize).foreach(batch =&gt; &#123;</span><br><span class="line">			<span class="comment">// **Acquire</span></span><br><span class="line">          <span class="keyword">if</span> (rateLimiter.isDefined) &#123;</span><br><span class="line">            rateLimiter.get.acquire(<span class="number">1</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">val</span> requests = batch.map(doc =&gt;</span><br><span class="line">            <span class="keyword">if</span> (queryKeyList.forall(doc.containsKey(_))) &#123;</span><br><span class="line">              <span class="keyword">val</span> queryDocument = <span class="keyword">new</span> <span class="type">BsonDocument</span>()</span><br><span class="line">              queryKeyList.foreach(key =&gt; queryDocument.append(key, doc.get(key)))</span><br><span class="line">              <span class="keyword">if</span> (writeConfig.replaceDocument) &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="type">ReplaceOneModel</span>[<span class="type">BsonDocument</span>](queryDocument, doc, <span class="keyword">new</span> <span class="type">ReplaceOptions</span>().upsert(<span class="literal">true</span>))</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                queryDocument.keySet().asScala.foreach(doc.remove(_))</span><br><span class="line">                <span class="keyword">new</span> <span class="type">UpdateOneModel</span>[<span class="type">BsonDocument</span>](queryDocument, <span class="keyword">new</span> <span class="type">BsonDocument</span>(<span class="string">"$set"</span>, doc), <span class="keyword">new</span> <span class="type">UpdateOptions</span>().upsert(<span class="literal">true</span>))</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">new</span> <span class="type">InsertOneModel</span>[<span class="type">BsonDocument</span>](doc)</span><br><span class="line">            &#125;)</span><br><span class="line">          collection.bulkWrite(requests.toList.asJava, <span class="keyword">new</span> <span class="type">BulkWriteOptions</span>().ordered(writeConfig.ordered))</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>save[D: ClassTag] (rdd: RDD[D]): Unit</strong></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Save data to MongoDB</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param rdd the RDD data to save to MongoDB</span></span><br><span class="line"><span class="comment"> * @param writeConfig the writeConfig</span></span><br><span class="line"><span class="comment"> * @tparam D the type of the data in the RDD</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span></span>[<span class="type">D</span>: <span class="type">ClassTag</span>](rdd: <span class="type">RDD</span>[<span class="type">D</span>], writeConfig: <span class="type">WriteConfig</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> mongoConnector = <span class="type">MongoConnector</span>(writeConfig.asOptions)</span><br><span class="line">  rdd.foreachPartition(iter =&gt; <span class="keyword">if</span> (iter.nonEmpty) &#123;</span><br><span class="line">    <span class="comment">// **INIT RateLimiter</span></span><br><span class="line">    <span class="keyword">var</span> rateLimiter: <span class="type">Option</span>[<span class="type">RateLimiter</span>] = <span class="type">None</span></span><br><span class="line">    <span class="keyword">if</span> (writeConfig.secondLatch.isDefined) &#123;</span><br><span class="line">      <span class="comment">// If secondLatch &lt; maxBatchSize, it will destroy rate limit rule.</span></span><br><span class="line">      <span class="keyword">val</span> permitSize = <span class="keyword">if</span> (writeConfig.secondLatch.get &gt;= writeConfig.maxBatchSize) (writeConfig.secondLatch.get / writeConfig.maxBatchSize).floor <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">      rateLimiter = <span class="type">Option</span>.apply(<span class="type">RateLimiter</span>.create(permitSize))</span><br><span class="line">    &#125;</span><br><span class="line">    mongoConnector.withCollectionDo(writeConfig, &#123; collection: <span class="type">MongoCollection</span>[<span class="type">D</span>] =&gt;</span><br><span class="line">      iter.grouped(writeConfig.maxBatchSize).foreach(batch =&gt; &#123;</span><br><span class="line">		  <span class="comment">// **Acquire</span></span><br><span class="line">        <span class="keyword">if</span> (rateLimiter.isDefined) &#123;</span><br><span class="line">          rateLimiter.get.acquire(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        collection.insertMany(</span><br><span class="line">          batch.toList.asJava,</span><br><span class="line">          <span class="keyword">new</span> <span class="type">InsertManyOptions</span>().ordered(writeConfig.ordered)</span><br><span class="line">        )</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ä¸è¦åœ¨ Driver ä¸Šå»åˆå§‹åŒ– <code>RateLimiter</code>ï¼Œè¿˜è¦æ³¨æ„ä¸ WriteConfig ä¸­å·²å­˜åœ¨çš„ <code>maxBatchSize</code> å‚æ•°çš„å…³ç³»ã€‚</p>
<p>åˆ°è¿™é‡Œå°±èƒ½æ„‰å¿«çš„è¿›è¡Œé™é€Ÿäº†ã€‚</p>

	
	</div>
  <a type="button" href="/2019/05/11/a5/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/04/06/a13/" >FROM BIGTABLE TO DRUID</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-04-06  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>æœ€è¿‘åœ¨å­¦ä¹  <code>Druid</code>ï¼Œç´¢æ€§æ•´ç†äº†ä¸€ä¸‹ä» Google çš„ BigTable è®ºæ–‡è¡ç”Ÿå‡ºçš„è¿™ä¸€ç³»åˆ—æ•°æ®äº§å“æ¶æ„æ€è·¯ã€‚è¯¥æ–‡ç« ä¸­é€šè¿‡å¯¹ BigTable æ–‡ç« çš„ä»‹ç»åˆ° Hbase å†åˆ° Druidï¼Œè¯»è€…ä¼šå‘ç°è¿™ä¸‰è€…éå¸¸çš„ç›¸ä¼¼ï¼Œä½†æ˜¯åˆç”±äºä¸åŒçš„ä½¿ç”¨åœºæ™¯è€Œåšäº†å…¶ä»–çš„ä¼˜åŒ–ã€‚ç”±äºä½œè€…ä¹Ÿæ˜¯åˆå­¦è€…ï¼Œæ‰€ä»¥å¤šæ˜¯å¯¹ç½‘ä¸Šæ–‡ç« çš„æ•´ç†æ±‡æ€»ï¼Œä¹Ÿç®—åˆæœ‰è„‰ç»œï¼Œä½†æ˜¯æ€»çš„æ¥è¯´è¿˜æ˜¯ä¸€ç¯‡çº¸ä¸Šè°ˆå…µçš„æ–‡ç« ï¼Œä»…ä½œä¸ºå¯¹å­¦ä¹ çš„è®°å½•ã€‚ä¹‹ååº”è¯¥ä¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šæœ‰æ›´å¤šçš„å®æˆ˜æ–‡ç« ã€‚</p>
<h1 id="BigTable"><a href="#BigTable" class="headerlink" title="BigTable"></a>BigTable</h1><p><code>Bigtable</code> æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒè¢«è®¾è®¡ç”¨æ¥å¤„ç†æµ·é‡æ•°æ®ã€‚</p>
<p>è¿™æ˜¯è®ºæ–‡å¼€ç¯‡çš„æ¦‚æ‹¬ï¼Œä¹Ÿä½œä¸ºè¿™ç¯‡åšå®¢çš„å¼€å§‹å§ã€‚</p>
<h2 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(row: string, column: string, time: int64) -&gt; string</span><br></pre></td></tr></table></figure>

<p><img src="/images/a-13-1.png" alt="a-13-1"></p>
<p>æ•´ä¸ª <code>BigTable</code> çš„æ•°æ®æ¨¡å‹å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ˜ å°„ï¼Œåˆ†åˆ«æ˜¯ rowï¼Œcloumnï¼Œtime åˆ°ä¸€ä¸ªå…·ä½“æ•°æ®çš„æ˜ å°„ã€‚å¦‚ä¸Šå›¾æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¡Œåæ˜¯ä¸€ä¸ªåå‘ URLã€‚contents åˆ—æ—å­˜æ”¾çš„æ˜¯ç½‘é¡µçš„å†…å®¹ï¼Œanchor åˆ—æ—å­˜æ”¾å¼•ç”¨è¯¥ç½‘é¡µçš„é”šé“¾æ¥æ–‡æœ¬ã€‚ CNN çš„ä¸»é¡µè¢« Sports Illustrator å’Œ MY-look çš„ä¸»é¡µå¼•ç”¨ï¼Œå› æ­¤è¯¥è¡ŒåŒ…å«äº†åä¸º <code>anchor:cnnsi.com</code> å’Œ <code>anchhor:my.look.ca</code> çš„åˆ—ã€‚æ¯ä¸ªé”šé“¾æ¥åªæœ‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œè€Œ contents åˆ—åˆ™æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œåˆ†åˆ«ç”±æ—¶é—´æˆ³ t3ï¼Œt5 å’Œ t6 æ ‡è¯†ï¼Œæœ€æ–°çš„æ—¶é—´æˆ³ä¼šæ”¾åœ¨æœ€å‰é¢ã€‚</p>
<h2 id="æ¶æ„ç»„ä»¶"><a href="#æ¶æ„ç»„ä»¶" class="headerlink" title="æ¶æ„ç»„ä»¶"></a>æ¶æ„ç»„ä»¶</h2><p>è¿™æ•´ä¸ªç³»ç»Ÿå½“ä¸­ä¸»è¦æœ‰ä¸‰éƒ¨åˆ†çš„ç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ Master æœåŠ¡å™¨ï¼ŒTablet æœåŠ¡å™¨å’Œ Chubby æœåŠ¡å™¨æ„æˆã€‚åœ¨åé¢å¯¹å…¶ä»–æ¡†æ¶çš„ä»‹ç»å½“ä¸­ï¼Œä¼šå‘ç°åŸºç¡€æ¶æ„æœ‰å¾ˆé«˜çš„ç›¸ä¼¼æ€§ã€‚</p>
<h3 id="Master-æœåŠ¡å™¨ï¼ˆæ§åˆ¶è€…ï¼‰"><a href="#Master-æœåŠ¡å™¨ï¼ˆæ§åˆ¶è€…ï¼‰" class="headerlink" title="Master æœåŠ¡å™¨ï¼ˆæ§åˆ¶è€…ï¼‰"></a>Master æœåŠ¡å™¨ï¼ˆæ§åˆ¶è€…ï¼‰</h3><p>ä¸»è¦å·¥ä½œï¼š</p>
<ul>
<li>ä¸º Tablet æœåŠ¡å™¨åˆ†é… Tabletsã€‚</li>
<li>æ£€æµ‹æ–°åŠ å…¥çš„æˆ–è€…è¿‡æœŸå¤±æ•ˆçš„ Tablet æœåŠ¡å™¨ã€‚</li>
<li>å¯¹ Tablet æœåŠ¡å™¨è¿›è¡Œè´Ÿè½½å‡è¡¡ã€ä»¥åŠå¯¹ä¿å­˜åœ¨ GFS ä¸Šçš„æ–‡ä»¶è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜å¤„ç†å¯¹æ¨¡ å¼çš„ç›¸å…³ä¿®æ”¹æ“ä½œï¼Œä¾‹å¦‚å»ºç«‹è¡¨å’Œåˆ—æ—ã€‚</li>
</ul>
<h3 id="Tablet-æœåŠ¡å™¨ï¼ˆå·¥ä½œè€…ï¼‰"><a href="#Tablet-æœåŠ¡å™¨ï¼ˆå·¥ä½œè€…ï¼‰" class="headerlink" title="Tablet æœåŠ¡å™¨ï¼ˆå·¥ä½œè€…ï¼‰"></a>Tablet æœåŠ¡å™¨ï¼ˆå·¥ä½œè€…ï¼‰</h3><p>ä¸»è¦å·¥ä½œï¼šç®¡ç†ä¸€ä¸ª Tablet çš„é›†åˆï¼ˆé€šå¸¸æ¯ä¸ªæœåŠ¡å™¨æœ‰å¤§çº¦æ•°åä¸ªè‡³ä¸Šåƒä¸ª Tabletï¼‰ã€‚æ¯ä¸ª Tablet æœåŠ¡å™¨è´Ÿè´£å¤„ç†å®ƒæ‰€åŠ è½½çš„ Tablet çš„è¯»å†™æ“ä½œï¼Œä»¥åŠåœ¨ Tablets è¿‡å¤§æ—¶ï¼Œå¯¹å…¶è¿›è¡Œåˆ†å‰²ã€‚</p>
<h3 id="Chubbyï¼ˆåè°ƒè€…ï¼‰"><a href="#Chubbyï¼ˆåè°ƒè€…ï¼‰" class="headerlink" title="Chubbyï¼ˆåè°ƒè€…ï¼‰"></a>Chubbyï¼ˆåè°ƒè€…ï¼‰</h3><p>åœ¨è¯´ <code>Chubby</code> ä¹‹å‰æƒ³æ’å…¥ä¸€ä¸ªå°è¯é¢˜ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆæ˜¯ <code>åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜(Distributed consensus problem)</code> ã€‚å…¶å®åœ¨æ¥è§¦åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å§‹è¿™ä¸ªé—®é¢˜åŸºæœ¬ä¸Šåœ¨æ¯ä¸€ç¯‡åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ–‡ç« ä¸­éƒ½ä¼šè¢«æåŠï¼Œä½†æ˜¯åœ¨æ„Ÿæ€§çš„è®¤è¯†ä¸‹ï¼Œæˆ‘å‘ç°è‡ªå·±å¾ˆéš¾ç”¨ç®€æ´çš„è¯­è¨€è¿›è¡Œæ¦‚æ‹¬ï¼Œæ‰€ä»¥å»æŸ¥é˜…äº†ä¸€äº›æ–‡ç« ï¼Œæœ‰ä¸€æ®µæ˜¯æˆ‘å¾ˆè®¤åŒçš„ç®€ä»‹æè¿°ï¼š</p>
<p>åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæœ‰ä¸€ç»„çš„ Processï¼Œä»–ä»¬éœ€è¦ç¡®å®šä¸€ä¸ª Valueã€‚äºæ˜¯æ¯ä¸ª Process éƒ½æå‡ºä¸€ä¸ª Valueï¼Œ ä¸€è‡´æ€§å°±æ˜¯æŒ‡åªæœ‰å…¶ä¸­çš„ä¸€ä¸ª Value èƒ½å¤Ÿè¢«é€‰ä¸­ä½œä¸ºæœ€åç¡®å®šçš„å€¼ï¼Œå¹¶ä¸”å½“è¿™ä¸ªå€¼è¢«é€‰å‡ºæ¥åï¼Œæ‰€æœ‰çš„ Process éƒ½éœ€è¦è¢«é€šçŸ¥åˆ°ã€‚</p>
<p>è¡¨é¢ä¸Šçœ‹ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆå®¹æ˜“è§£å†³ã€‚æ¯”å¦‚è®¾ç½®ä¸€ä¸ªserverï¼Œæ‰€æœ‰çš„processéƒ½ å‘è¿™ä¸ªserveræäº¤ä¸€ä¸ªValueï¼Œè¿™ä¸ªserverå¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„è§„åˆ™æ¥æŒ‘é€‰å‡ºä¸€ä¸ªValueï¼ˆä¾‹å¦‚æœ€å…ˆåˆ°è¾¾çš„Valueè¢«é€‰ä¸­ï¼‰ï¼Œç„¶åç”±è¿™ä¸ª serveré€šçŸ¥æ‰€æœ‰çš„Processã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå°±ä¼šæœ‰å„ç§çš„é—®é¢˜å‘ç”Ÿï¼Œä¾‹å¦‚ï¼Œè¿™ä¸ªserverå´©æºƒäº†æ€ä¹ˆåŠï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½éœ€è¦æœ‰å‡ å° serverå…±åŒå†³å®šã€‚è¿˜æœ‰ï¼ŒProcessæäº¤Valueçš„æ—¶é—´éƒ½ä¸ä¸€æ ·ï¼Œç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ç”±äºå»¶è¿Ÿè¿™äº›Valueåˆ°è¾¾serverçš„é¡ºåºä¹Ÿéƒ½æ²¡æœ‰ä¿è¯ã€‚</p>
<p>æœ‰ä¸€ä¸ªå¾ˆå…·è±¡çš„ä¾‹å­ï¼š</p>
<p>åœ¨Google File System(GFS) ä¸­ï¼Œæœ‰å¾ˆå¤šçš„serverï¼Œè¿™äº›serveréœ€è¦é€‰ä¸¾å…¶ä¸­çš„ä¸€å°ä½œä¸ºmaster serverã€‚è¿™å…¶å®æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„consensusé—®é¢˜ï¼ŒValueå°±æ˜¯master serverçš„åœ°å€ã€‚GFSå°±æ˜¯ç”¨Chubbyæ¥è§£å†³çš„è¿™ä¸ªé—®é¢˜ï¼Œæ‰€æœ‰çš„serveré€šè¿‡Chubbyæä¾›çš„é€šä¿¡åè®®åˆ°Chubby serverä¸Šåˆ›å»ºåŒä¸€ä¸ªæ–‡ä»¶ï¼Œå½“ç„¶ï¼Œæœ€ç»ˆåªæœ‰ä¸€ä¸ªserverèƒ½å¤Ÿè·å‡†åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªserverå°±æˆä¸ºäº†masterï¼Œå®ƒä¼šåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å†™å…¥è‡ªå·± çš„åœ°å€ï¼Œè¿™æ ·å…¶å®ƒçš„serveré€šè¿‡è¯»å–è¿™ä¸ªæ–‡ä»¶å°±èƒ½çŸ¥é“è¢«é€‰å‡ºçš„masterçš„åœ°å€ã€‚</p>
<p>å¯¹åº”äº <code>Chubby</code> å°±ä¼šæœ‰ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„å¼€æºé¡¹ç›® <code>Zookeeper</code>ï¼Œä¸¤è€…ä»ä½œç”¨åˆ°æ¶æ„ä¸Šéƒ½éå¸¸çš„ç›¸ä¼¼ã€‚ä½†æ˜¯åˆå­˜åœ¨ä¸€äº›å·®åˆ«ï¼Œæ–‡ç« åé¢ä¼šç®€å•å™è¿°ä¸€ä¸‹ä¸¤è€…çš„ä¸åŒï¼Œä¸è¿‡å¯ä»¥ç±»æ¯” <code>Zookeeper</code> æ¥ç†è§£ <code>Chubby</code>ã€‚</p>
<p>å‰é¢è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ <code>Chubby</code> åˆ°åº•æ˜¯ä¸€ä¸ªä»€ä¹ˆæœåŠ¡ã€‚é¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥æä¾›æœºåˆ¶ä½¿å¾— client å¯ä»¥åœ¨ Chubby service ä¸Šåˆ›å»ºæ–‡ä»¶å’Œæ‰§è¡Œä¸€äº›æ–‡ä»¶çš„åŸºæœ¬æ“ä½œã€‚ä»æ›´é«˜ä¸€ç‚¹çš„è¯­ä¹‰å±‚é¢ä¸Šã€‚Chubby æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„é”ç³»ç»Ÿï¼Œâ€œé”â€ å°±æ˜¯æ–‡ä»¶ï¼ŒåŠ é”æ“ä½œå°±æ˜¯åˆ›å»ºæ–‡ä»¶æˆåŠŸçš„é‚£ä¸ª server æŠ¢å åˆ°äº† â€œé”â€ã€‚ç”¨æˆ·é€šè¿‡æ‰“å¼€ã€å…³é—­å’Œè¯»å–æ–‡ä»¶ï¼Œè·å–å…±äº«é”æˆ–è€…ç‹¬å é”ï¼›å¹¶ä¸”é€šè¿‡é€šä¿¡æœºåˆ¶ï¼Œå‘ç”¨æˆ·å‘é€æ›´æ–°ä¿¡æ¯ã€‚</p>
<h3 id="Tabletï¼ˆæ•°æ®èšåˆå•ä½ï¼‰"><a href="#Tabletï¼ˆæ•°æ®èšåˆå•ä½ï¼‰" class="headerlink" title="Tabletï¼ˆæ•°æ®èšåˆå•ä½ï¼‰"></a>Tabletï¼ˆæ•°æ®èšåˆå•ä½ï¼‰</h3><h4 id="INDEX"><a href="#INDEX" class="headerlink" title="INDEX"></a>INDEX</h4><p><img src="/images/a-13-2.png" alt="a-13-2"></p>
<p>Index æ˜¯ä¸€ä¸ªä¸‰å±‚çš„Bæ ‘ï¼Œç”±äº Root tablet ä¸ä¼šåˆ†è£‚ï¼Œæ‰€ä»¥æ°¸è¿œæ˜¯ä¸‰å±‚ã€‚çœŸæ­£çš„ Tablet ä½ç½®ä¿¡æ¯å­˜å‚¨åœ¨ç¬¬ä¸‰å±‚æ¯ä¸€ä¸ªè¡Œå…³é”®å­—ä¸‹ï¼Œè€Œç¬¬äºŒå±‚åªæ˜¯å¯¹ç¬¬ä¸‰å±‚çš„ç´¢å¼•ã€‚Root tablet å‚¨å­˜åœ¨ Chubby ä¸­ã€‚åœ¨å®¢æˆ·ç«¯ä¼šç¼“å­˜ Tablet çš„ä½ç½®ä¿¡æ¯ï¼Œå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰ç¼“å­˜æˆ–è€…å‘ç°å®ƒçš„ç¼“å­˜åœ°å€ä¸æ­£ç¡®ï¼Œå°±åœ¨æ ‘çŠ¶çš„å­˜å‚¨ç»“æ„ä¸­é€’å½’çš„æŸ¥è¯¢ Tablet ä½ç½®ä¿¡æ¯ã€‚å¦‚æœå®¢æˆ·ç«¯ç¼“å­˜æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆéœ€è¦ä¸‰æ¬¡å¯»å€ã€‚å¦‚æœæ˜¯è¿‡æœŸäº†åˆ™éœ€è¦6æ¬¡ï¼Œ3æ¬¡æ˜¯åœ¨ç¼“å­˜ä¸­å¯»æ‰¾ï¼Œ3æ¬¡æ˜¯æ›´æ–°ç¼“å­˜ã€‚</p>
<h4 id="åˆ†é…"><a href="#åˆ†é…" class="headerlink" title="åˆ†é…"></a>åˆ†é…</h4><p>åœ¨ä»»ä½•ä¸€ä¸ªæ—¶åˆ»ï¼Œä¸€ä¸ªTablet åªèƒ½åˆ†é…ç»™ä¸€ä¸ªTabletæœåŠ¡å™¨ã€‚MasteræœåŠ¡å™¨è®°å½•äº†å½“å‰æœ‰å“ªäº›æ´»è·ƒçš„ Tablet æœåŠ¡å™¨ã€å“ªäº› Tablet åˆ†é…ç»™äº†å“ªäº› Tablet æœåŠ¡å™¨ã€å“ªäº› Tablet è¿˜æ²¡æœ‰è¢«åˆ†é…ã€‚å½“ä¸€ä¸ª Tablet è¿˜æ²¡æœ‰è¢«åˆ†é…ã€ å¹¶ä¸”åˆšå¥½æœ‰ä¸€ä¸ª Tablet æœåŠ¡å™¨æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´è£…è½½è¯¥ Tablet æ—¶ï¼ŒMaster æœåŠ¡å™¨ä¼šç»™è¿™ä¸ª Tablet æœåŠ¡å™¨å‘é€ä¸€ä¸ªè£…è½½è¯·æ±‚ï¼ŒæŠŠ Tablet åˆ†é…ç»™è¿™ä¸ªæœåŠ¡å™¨ã€‚</p>
<p>BigTable ä½¿ç”¨ Chubby è·Ÿè¸ªè®°å½• Tablet æœåŠ¡å™¨çš„çŠ¶æ€ã€‚å½“ä¸€ä¸ª Tablet æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå®ƒåœ¨ Chubby çš„ä¸€ä¸ª æŒ‡å®šç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ªæœ‰å”¯ä¸€æ€§åå­—çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è·å–è¯¥æ–‡ä»¶çš„ç‹¬å é”ã€‚Master æœåŠ¡å™¨å®æ—¶ç›‘æ§ç€è¿™ä¸ªç›®å½•ï¼ˆæœåŠ¡å™¨ç›®å½•ï¼‰ï¼Œå› æ­¤ Master æœåŠ¡å™¨èƒ½å¤ŸçŸ¥é“æœ‰æ–°çš„ Tablet æœåŠ¡å™¨åŠ å…¥äº†ã€‚å¦‚æœ Tablet æœåŠ¡å™¨ä¸¢å¤±äº† Chubby ä¸Šçš„ç‹¬å é”ï¼Œæ¯”å¦‚ç”±äºç½‘ç»œæ–­å¼€å¯¼è‡´ Tablet æœåŠ¡å™¨å’Œ Chubby çš„ä¼šè¯ä¸¢å¤± â€” å®ƒå°±åœæ­¢å¯¹ Tablet æä¾›æœåŠ¡ã€‚ï¼ˆChubby æä¾›äº†ä¸€ç§é«˜æ•ˆçš„æœºåˆ¶ï¼Œåˆ©ç”¨è¿™ç§æœºåˆ¶ï¼ŒTablet æœåŠ¡å™¨èƒ½å¤Ÿåœ¨ä¸å¢åŠ ç½‘ç»œè´Ÿæ‹…çš„æƒ…å†µä¸‹çŸ¥é“å®ƒæ˜¯å¦ è¿˜æŒæœ‰é”ï¼‰ã€‚åªè¦æ–‡ä»¶è¿˜å­˜åœ¨ï¼ŒTablet æœåŠ¡å™¨å°±ä¼šè¯•å›¾é‡æ–°è·å¾—å¯¹è¯¥æ–‡ä»¶çš„ç‹¬å é”ï¼›å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨äº†ï¼Œé‚£ä¹ˆ Tablet æœåŠ¡å™¨å°±ä¸èƒ½å†æä¾›æœåŠ¡äº†ï¼Œå®ƒä¼šè‡ªè¡Œé€€å‡ºã€‚</p>
<h4 id="å†²å†™"><a href="#å†²å†™" class="headerlink" title="å†²å†™"></a>å†²å†™</h4><p>åœ¨ BigTable ä¸­ä¸€æ¬¡å†™æ“ä½œä¼šå…ˆè¢«è®°å½•åœ¨æ—¥å¿—æ–‡ä»¶å½“ä¸­ï¼Œç„¶åè¢«è®°å…¥ <code>memtable</code> ä¸­ã€‚è¿™é‡Œ <code>memtable</code> å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå†™ç¼“å­˜ï¼Œéšç€å†™æ“ä½œçš„æ‰§è¡Œï¼Œ<code>memtable</code> çš„å¤§å°ä¸æ–­å¢åŠ ã€‚å½“ <code>memtable</code> çš„å°ºå¯¸åˆ°è¾¾ä¸€ä¸ªé—¨é™å€¼çš„æ—¶å€™ï¼Œè¿™ä¸ª <code>memtable</code> å°±ä¼šè¢«å†»ç»“ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ <code>memtable</code>ï¼›è¢«å†»ç»“ä½ <code>memtable</code> ä¼šè¢«è½¬æ¢æˆ SSTableï¼Œç„¶åå†™å…¥ GFSã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º <code>Minor Compaction</code>ï¼Œ å®ƒæœ‰ä¸¤ä¸ªç›®çš„ï¼šæ”¶ç¼© Tablet æœåŠ¡å™¨ä½¿ç”¨çš„å†…å­˜ï¼Œä»¥åŠåœ¨æœåŠ¡å™¨ç¾éš¾æ¢å¤è¿‡ç¨‹ä¸­ï¼Œå‡å°‘å¿…é¡»ä» æäº¤æ—¥å¿—é‡Œè¯»å–çš„æ•°æ®é‡ã€‚åœ¨ Compaction è¿‡ç¨‹ä¸­ï¼Œæ­£åœ¨è¿›è¡Œçš„è¯»å†™æ“ä½œä»èƒ½ç»§ç»­ã€‚</p>
<p>è€Œæ¯ä¸€æ¬¡ Minor Compaction éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ SSTableã€‚å¦‚æœ Minor Compaction è¿‡ç¨‹ä¸åœæ»çš„æŒç»­è¿›è¡Œä¸‹å»ï¼Œè¯»æ“ä½œå¯èƒ½éœ€è¦åˆå¹¶æ¥è‡ªå¤šä¸ª SSTable çš„æ›´æ–°ã€‚é€šè¿‡å®šæœŸåœ¨åå°æ‰§è¡Œ Tablet çš„åˆå¹¶ï¼Œæ¥é™åˆ¶è¿™ç±»æ–‡ä»¶çš„æ•°é‡ï¼ŒåŠ é€Ÿå­˜å‚¨ä½¿ç”¨ç‡å’Œè¯»é€Ÿåº¦ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º <code>Merging Compaction</code>ã€‚</p>
<p>è¿™ä¸¤ä¸ªæ­¥éª¤åœ¨ BIGTABLE ç³»ç»Ÿä¸­éå¸¸çš„é‡è¦ï¼Œè¿™ä¹Ÿæ˜¯åœ¨è¯»å†™åˆ†ç¦»æ¶æ„ä¸­ï¼Œå¾—ä»¥ä¼˜åŒ–è¯»å†™æ•ˆç‡çš„æ ¹æœ¬ï¼Œåœ¨åé¢å…¶ä»–ç³»ç»Ÿçš„è®¾è®¡å½“ä¸­èƒ½ä¹Ÿèƒ½çœ‹åˆ°ç±»ä¼¼çš„ä¼˜åŒ–è®¾è®¡ã€‚</p>
<h4 id="å­˜å‚¨ç»“æ„"><a href="#å­˜å‚¨ç»“æ„" class="headerlink" title="å­˜å‚¨ç»“æ„"></a>å­˜å‚¨ç»“æ„</h4><p>Tablet æ˜¯é€»è¾‘å±‚é¢çš„å­˜å‚¨å•å…ƒï¼Œè€Œå®é™…çš„å­˜å‚¨å•å…ƒæ˜¯ SSTableï¼ŒSSTable æ˜¯ä¸€ä¸ªæŒä¹…åŒ–çš„ã€æ’åºçš„ã€ä¸å¯æ›´æ”¹çš„ Map ç»“æ„ï¼Œè€Œ Map æ˜¯ä¸€ä¸ª key-value æ˜ å°„çš„æ•°æ®ç»“æ„ï¼Œkey å’Œ value çš„å€¼éƒ½æ˜¯ä»»æ„çš„ Byte ä¸²ã€‚å¯ä»¥å¯¹ SSTable è¿›è¡Œå¦‚ä¸‹çš„æ“ä½œï¼šæŸ¥è¯¢ä¸ä¸€ä¸ª key å€¼ç›¸å…³çš„ valueï¼Œæˆ–è€…éå†æŸä¸ª key å€¼èŒƒå›´å†…çš„æ‰€æœ‰çš„ key-value å¯¹ã€‚ä»å†… éƒ¨çœ‹ï¼ŒSSTable æ˜¯ä¸€ç³»åˆ—çš„æ•°æ®å—ï¼ˆé€šå¸¸æ¯ä¸ªå—çš„å¤§å°æ˜¯ 64KBï¼Œè¿™ä¸ªå¤§å°æ˜¯å¯ä»¥é…ç½®çš„ï¼‰ã€‚SSTable ä½¿ç”¨å—ç´¢ å¼•ï¼ˆé€šå¸¸å­˜å‚¨åœ¨ SSTable çš„æœ€åï¼‰æ¥å®šä½æ•°æ®å—ï¼›åœ¨æ‰“å¼€ SSTable çš„æ—¶å€™ï¼Œç´¢å¼•è¢«åŠ è½½åˆ°å†…å­˜ï¼Œæ¥æé«˜æŸ¥è¯¢ã€è¯»å–æ•ˆç‡ã€‚</p>
<h1 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h1><h2 id="HMaster"><a href="#HMaster" class="headerlink" title="HMaster"></a>HMaster</h2><p>æ²¡æœ‰å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå¯åŠ¨å¤šä¸ª HMasterï¼Œé€šè¿‡ Zookeeper çš„ Master Election æœºåˆ¶ä¿è¯åŒæ—¶åªæœ‰ä¸€ä¸ª HMaster å¤„äº Activeï¼Œå…¶ä»–å¤„äºçƒ­å¤‡ä»½çš„çŠ¶æ€ï¼Œå®šæœŸä» Active çš„ Master åŒæ­¥å…¶æœ€æ–°çŠ¶æ€ã€‚</p>
<p>ä¸»è¦ä½œç”¨ï¼š</p>
<ul>
<li>ç®¡ç† HReigonServerï¼Œå®ç°å…¶è´Ÿè½½å‡è¡¡<ul>
<li>å¯åŠ¨æ—¶HRegionçš„åˆ†é…ï¼Œä»¥åŠè´Ÿè½½å‡è¡¡å’Œä¿®å¤æ—¶ HRegion çš„é‡æ–°åˆ†é…</li>
<li>ç›‘æ§é›†ç¾¤ä¸­æ‰€æœ‰ HRegionServer çš„çŠ¶æ€ï¼ˆé€šè¿‡ Heartbeat å’Œç›‘å¬ Zookeeper ä¸­çš„çŠ¶æ€ï¼‰</li>
</ul>
</li>
<li>ç®¡ç†å’Œåˆ†é… HRegion</li>
<li>å®ç° DDL æ“ä½œ (Data Defintion Language, namespace å’Œ table çš„å¢åˆ æ”¹ï¼Œcolumn familyçš„å¢åˆ æ”¹ç­‰)</li>
<li>ç®¡ç† namespace å’Œ table çš„å…ƒæ•°æ®</li>
<li>æƒé™æ§åˆ¶</li>
</ul>
<h2 id="HRegionServerï¼ˆå·¥ä½œè€…"><a href="#HRegionServerï¼ˆå·¥ä½œè€…" class="headerlink" title="HRegionServerï¼ˆå·¥ä½œè€…)"></a>HRegionServerï¼ˆå·¥ä½œè€…)</h2><p>HRegionServerä¸€èˆ¬å’ŒDataNodeåœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œå®ç°æ•°æ®çš„æœ¬åœ°æ€§ã€‚</p>
<p>å­˜æ”¾å’Œç®¡ç†æœ¬åœ°HRegionã€‚<br>è¯»å†™HDFSï¼Œç®¡ç†Tableä¸­çš„æ•°æ®ã€‚<br>Clientç›´æ¥é€šè¿‡HRegionServerè¯»å†™æ•°æ®<br>å¯ä»¥å‘ç° HRegionServer çš„ä½œç”¨ä¸ BigTable ä¸­ Tablet æœåŠ¡å™¨çš„ä½œç”¨å‡ ä¹ä¸€æ‘¸ä¸€æ ·ï¼Œä¸‹é¢ä»‹ç»æ›´å¤šå®ƒå†…éƒ¨çš„æœºåˆ¶ï¼š</p>
<h3 id="WALï¼ˆWRITE-AHEAD-LOGï¼‰"><a href="#WALï¼ˆWRITE-AHEAD-LOGï¼‰" class="headerlink" title="WALï¼ˆWRITE AHEAD LOGï¼‰"></a>WALï¼ˆWRITE AHEAD LOGï¼‰</h3><p>æ‰€æœ‰çš„å†™æ“ä½œéƒ½ä¼šä¿è¯å°†æ•°æ®å†™å…¥ LOG æ–‡ä»¶ä»¥åï¼Œæ‰ä¼šçœŸæ­£æ›´æ–° MemStoreï¼ˆå†™ç¼“å­˜ï¼‰ï¼Œæœ€åå†™å…¥ HFile ä¸­ã€‚é‡‡ç”¨è¿™ç§æ¨¡å¼ï¼Œå¯ä»¥ä¿è¯HRegionServerå®•æœºåï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ä»è¯¥Logæ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼ŒReplayæ‰€æœ‰çš„æ“ä½œï¼Œè€Œä¸è‡³äºæ•°æ®ä¸¢å¤±ã€‚è¿™ä¸ªLogæ–‡ä»¶ä¼šå®šæœŸRollå‡ºæ–°çš„æ–‡ä»¶è€Œåˆ é™¤æ—§çš„æ–‡ä»¶(é‚£äº›å·²æŒä¹…åŒ–åˆ°HFileä¸­çš„Logå¯ä»¥åˆ é™¤)ã€‚</p>
<h3 id="BLOCKCACHEï¼ˆè¯»ç¼“å­˜ï¼‰"><a href="#BLOCKCACHEï¼ˆè¯»ç¼“å­˜ï¼‰" class="headerlink" title="BLOCKCACHEï¼ˆè¯»ç¼“å­˜ï¼‰"></a>BLOCKCACHEï¼ˆè¯»ç¼“å­˜ï¼‰</h3><p>åŸºäºåˆ†ç©ºé—´å±€éƒ¨æ€§å’Œæ—¶é—´å±€éƒ¨æ€§åŸç†ï¼Œå°†æ•°æ®é¢„è¯»å–åˆ°å†…å­˜ä¸­ï¼Œä»¥æå‡è¯»æ€§èƒ½ã€‚HBase æä¾›äº†ä¸¤ç§ BlockCache çš„å®ç°ï¼Œé»˜è®¤æ˜¯ on-heap LRUBlockCache å’Œ BucketCache(off-heap)ã€‚é€šå¸¸BucketCacheçš„æ€§èƒ½è¦å·®äºLruBlockCacheï¼Œç„¶è€Œç”±äºGCçš„å½±å“ï¼ŒLruBlockCacheçš„å»¶è¿Ÿä¼šå˜çš„ä¸ç¨³å®šï¼Œè€ŒBucketCacheç”±äºæ˜¯è‡ªå·±ç®¡ç†BlockCacheï¼Œè€Œä¸éœ€è¦GCï¼Œå› è€Œå®ƒçš„å»¶è¿Ÿé€šå¸¸æ¯”è¾ƒç¨³å®šï¼Œè¿™ä¹Ÿæ˜¯æœ‰äº›æ—¶å€™éœ€è¦é€‰ç”¨BucketCacheçš„åŸå› ã€‚åœ¨ BlockCache 101 - Nick Dimiduk ä¸­æ›´åŠ è¯¦ç»†çš„å¯¹æ¯”ã€‚</p>
<h3 id="HSTOREï¼ˆæœ€å°å•ä½ï¼‰"><a href="#HSTOREï¼ˆæœ€å°å•ä½ï¼‰" class="headerlink" title="HSTOREï¼ˆæœ€å°å•ä½ï¼‰"></a>HSTOREï¼ˆæœ€å°å•ä½ï¼‰</h3><p><img src="/images/a-13-3.png" alt="a-13-3"></p>
<p>ä¸€ä¸ªTableå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªRegionï¼Œä»–ä»¬å¯ä»¥åœ¨ä¸€ä¸ªç›¸åŒçš„HRegionServerä¸Šï¼Œä¹Ÿå¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„HRegionServerä¸Šï¼Œä¸€ä¸ªHRegionServerå¯ä»¥æœ‰å¤šä¸ªHRegionï¼Œä»–ä»¬åˆ†åˆ«å±äºä¸åŒçš„Tableã€‚HRegionç”±å¤šä¸ªStore(HStore)æ„æˆï¼Œæ¯ä¸ªHStoreå¯¹åº”äº†ä¸€ä¸ªTableåœ¨è¿™ä¸ªHRegionä¸­çš„ä¸€ä¸ªColumn Familyï¼Œå³æ¯ä¸ªColumn Familyå°±æ˜¯ä¸€ä¸ªé›†ä¸­çš„å­˜å‚¨å•å…ƒï¼Œå› è€Œæœ€å¥½å°†å…·æœ‰ç›¸è¿‘IOç‰¹æ€§çš„Columnå­˜å‚¨åœ¨ä¸€ä¸ªColumn Familã€‚</p>
<h4 id="MEMSTOREï¼ˆå†™ç¼“å­˜ï¼‰"><a href="#MEMSTOREï¼ˆå†™ç¼“å­˜ï¼‰" class="headerlink" title="MEMSTOREï¼ˆå†™ç¼“å­˜ï¼‰"></a>MEMSTOREï¼ˆå†™ç¼“å­˜ï¼‰</h4><p>æ‰€æœ‰æ•°æ®çš„å†™åœ¨å®ŒæˆWALæ—¥å¿—å†™åï¼Œä¼š å†™å…¥MemStoreä¸­ï¼Œç”±MemStoreæ ¹æ®ä¸€å®šçš„ç®—æ³•å°†æ•°æ®Flushåˆ°åœ°å±‚HDFSæ–‡ä»¶ä¸­(HFile)ï¼Œé€šå¸¸æ¯ä¸ªHRegionä¸­çš„æ¯ä¸ª Column Familyæœ‰ä¸€ä¸ªè‡ªå·±çš„MemStoreã€‚</p>
<ul>
<li>æ¯ä¸€æ¬¡Put/Deleteè¯·æ±‚éƒ½æ˜¯å…ˆå†™å…¥åˆ°MemStoreä¸­ï¼Œå½“MemStoreæ»¡åä¼šFlushæˆä¸€ä¸ªæ–°çš„StoreFile(åº•å±‚å®ç°æ˜¯HFile)ï¼Œå³ä¸€ä¸ªHStore(Column Family)å¯ä»¥æœ‰0ä¸ªæˆ–å¤šä¸ªStoreFile(HFile)ã€‚æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µå¯ä»¥è§¦å‘MemStoreçš„FlushåŠ¨ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯MEMSTOREçš„æœ€å°FLUSHå•å…ƒæ˜¯HREGIONè€Œä¸æ˜¯å•ä¸ªMEMSTOREã€‚</li>
<li>å½“ä¸€ä¸ªHRegionä¸­çš„æ‰€æœ‰MemStoreçš„å¤§å°æ€»å’Œè¶…è¿‡äº†sizeã€‚å½“å‰ HRegion ä¸‹çš„æ‰€æœ‰ MemStore è¿›è¡Œ flushã€‚</li>
<li>å½“å…¨å±€MemStoreçš„å¤§å°æ€»å’Œè¶…è¿‡äº†sizeï¼Œå½“å‰ HRegionServer ä¸‹çš„æ‰€æœ‰ MemStore è¿›è¡Œ flush.</li>
<li>å½“å‰HRegionServerä¸­WALçš„å¤§å°è¶…è¿‡äº†sizeï¼Œå½“å‰ HRegionServer ä¸‹çš„æ‰€æœ‰ MemStore è¿›è¡Œ flushã€‚ä¾ç…§æ—¶é—´å…ˆåé¡ºåºï¼Œç›´åˆ° WAL å°‘äº sizeã€‚</li>
</ul>
<h3 id="HFILE"><a href="#HFILE" class="headerlink" title="HFILE"></a>HFILE</h3><p>ç”¨äºå­˜å‚¨HBaseçš„æ•°æ®ã€‚</p>
<h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h2><p>åœ¨äº§å“å®šä½ä¸Šï¼ŒZookeeper æ˜¯ä¸€ä¸ª <code>Distributed process coordinator</code> è€Œ Chubby æ˜¯ä¸€ä¸ª <code>Distributed lock service</code>ã€‚è€Œé«˜ä¸€è‡´æ€§ä¸å®ƒçš„ä½¿ç”¨åœºæ™¯å¯†åˆ‡ç›¸å…³ï¼Œç”±äº Chubby ä¸»è¦å¤„ç†å°‘é‡çš„å†™æ›´å¤šçš„è¯»æ“ä½œçš„åœºæ™¯ï¼Œæä¾›ç²—åŠ›åº¦çš„é”ï¼Œæ‰€ä»¥æ˜¯éœ€è¦ç¼“å­˜çš„ã€‚è€Œå¦‚æœéœ€è¦è¿›è¡Œä¸€æ¬¡æ•°æ®æ›´æ–°ï¼ŒChubby ä¼šå…ˆä¿è¯æ‰€æœ‰çš„ç¼“å­˜éƒ½è¿›è¡Œæ›´æ–°ä»¥åæ‰å®£å¸ƒè¿™æ¬¡æ›´æ–°å®Œæˆã€‚è€Œè¿™æ ·çš„ç¼“å­˜æœºåˆ¶åœ¨ Zookeeper ä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥å½“ä½ åœ¨ Zookeeper ä¸­è¿›è¡Œæ•°æ®æ›´æ–°ï¼Œæ›´æ–°ä½œç”¨åˆ° A å‰¯æœ¬ä¸Šï¼Œä½†æ˜¯æ²¡æ¥å¾—åŠåŒæ­¥åˆ° B å‰¯æœ¬ä¸Šæ˜¯ï¼Œå°±ä¼šå‡ºç° AB å‰¯æœ¬æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
<p>è€Œå¼€æºæœ‰å¼€æºçš„å¥½å¤„ï¼Œåœ¨ Zookeeper å®¢æˆ·ç«¯ä¸Šæœ‰ Apache é¡¹ç›® <code>Curator</code> è¿›è¡Œäº†é«˜åº¦çš„å°è£…ï¼Œæä¾›äº†è¿™æ ·çš„ç¼“å­˜æœºåˆ¶ï¼Œæå‡äº† Zookeeper çš„ä¸€è‡´æ€§ç­‰çº§ã€‚æ‰€ä»¥ä½¿ç”¨ Zookeeper åŠ ä¸Š Curator çš„è¯æ˜¯ç­‰äº Chubby çš„ã€‚</p>
<p>ä¸‹é¢å†ä»‹ç»ä¸€ä¸‹å®ƒæ˜¯å¦‚ä½•åœ¨ HBase ä¸­çš„ä½œç”¨ï¼š</p>
<ul>
<li>åœ¨HMasterå’ŒHRegionServerè¿æ¥åˆ°ZooKeeperååˆ›å»ºEphemeralèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨Heartbeatæœºåˆ¶ç»´æŒè¿™ä¸ªèŠ‚ç‚¹çš„å­˜æ´»çŠ¶æ€ï¼Œå¦‚æœæŸä¸ªEphemeralèŠ‚ç‚¹å®æ•ˆï¼Œåˆ™HMasterä¼šæ”¶åˆ°é€šçŸ¥ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†ã€‚<br>åè°ƒå¤šä¸ªçƒ­å¤‡ä»½çš„ HMaster èŠ‚ç‚¹ï¼Œé€šè¿‡ç›‘å¬ <code>/hbase/master</code> æ¥ç¡®è®¤ Active Master èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚æœèŠ‚ç‚¹æ¶ˆå¤±ï¼Œåˆ™å¾—åˆ°é€šçŸ¥ï¼Œå¹¶å°†è‡ªå·±è½¬ä¸º Activer HMasterã€‚</li>
<li>Hbase ä½¿ç”¨ RowKey å°†è¡¨æ°´å¹³åˆ‡å‰²æˆå¤šä¸ª HRegionï¼Œæ¯ä¸ª HRegion éƒ½è®°å½•äº†å®ƒçš„ StartKey å’Œ EndKeyï¼Œä¸”æœ‰åºã€‚HRegion ç”± HMaster åˆ†é…åˆ°ç›¸åº”çš„ HRegionServer ä¸­ï¼Œç„¶åç”± HRegionServer å¤æ‚ HRegion çš„å¯åŠ¨å’Œç®¡ç†ï¼Œå’Œ Client çš„é€šä¿¡ï¼Œè´Ÿè´£æ•°æ®çš„è¯»ï¼ˆä½¿ç”¨ HDFSï¼‰ã€‚æ¯ä¸ª HRegionServer å¯ä»¥åŒæ—¶ç®¡ç†1000ä¸ªå·¦å³çš„ HRegionã€‚ç°åœ¨å¾ˆå¤šçš„åˆ†å¸ƒå¼å­˜å‚¨éƒ½ä½¿ç”¨è¿™ç§æ¨ªå‘åˆ‡å‰²ï¼Œåˆ—å¼å­˜å‚¨çš„æ–¹å¼ã€‚</li>
</ul>
<h2 id="HRegionï¼ˆæ•°æ®èšåˆå•ä½"><a href="#HRegionï¼ˆæ•°æ®èšåˆå•ä½" class="headerlink" title="HRegionï¼ˆæ•°æ®èšåˆå•ä½)"></a>HRegionï¼ˆæ•°æ®èšåˆå•ä½)</h2><p>Hbase ä½¿ç”¨ RowKey å°†è¡¨æ°´å¹³åˆ‡å‰²æˆå¤šä¸ª HRegionï¼Œæ¯ä¸ª HRegion éƒ½è®°å½•äº†å®ƒçš„ StartKey å’Œ EndKeyï¼Œä¸”æœ‰åºã€‚HRegion ç”± HMaster åˆ†é…åˆ°ç›¸åº”çš„ HRegionServer ä¸­ï¼Œç„¶åç”± HRegionServer å¤æ‚ HRegion çš„å¯åŠ¨å’Œç®¡ç†ï¼Œå’Œ Client çš„é€šä¿¡ï¼Œè´Ÿè´£æ•°æ®çš„è¯»ï¼ˆä½¿ç”¨ HDFSï¼‰ã€‚æ¯ä¸ª HRegionServer å¯ä»¥åŒæ—¶ç®¡ç†1000ä¸ªå·¦å³çš„ HRegionã€‚ç°åœ¨å¾ˆå¤šçš„åˆ†å¸ƒå¼å­˜å‚¨éƒ½ä½¿ç”¨è¿™ç§æ¨ªå‘åˆ‡å‰²ï¼Œåˆ—å¼å­˜å‚¨çš„æ–¹å¼ã€‚</p>
<p>INDEX</p>
<p><img src="/images/a-13-4.jpg" alt="a-13-4"></p>
<p>å¯ä»¥å‘ç°è¿™å¼ å›¾å’Œ BigTable çš„ Tablet ç´¢å¼•å›¾å‡ ä¹ä¸€æ‘¸ä¸€æ ·ï¼Œä¸è¿‡æœ‰è¶£çš„æ˜¯åœ¨ 0.96 ä»¥åï¼ŒHBase è§‰å¾—è‡ªå·±ä¸éœ€è¦è¿™ä¹ˆå¤§çš„åœ°å€ç©ºé—´ï¼Œå¹¶ä»¥æ¯æ¬¡æŸ¥è¯¢å¤šä¸€æ¬¡å¯»å€çš„ä»£ä»·ã€‚æ‰€ä»¥æ”¹ä¸ºäº†ä¸¤å±‚ç»“æ„ï¼Œå¹¶ä¸”ä¹Ÿä¿è¯äº† <code>META Table</code> åƒä¹‹å‰çš„ Root table ä¸€æ ·æ˜¯ä¸å¯åˆ‡å‰²çš„ï¼Œä¿è¯è¿™æ£µ B æ ‘æ°¸è¿œåªæœ‰ä¸¤å±‚ç»“æ„ã€‚åŒæ ·æä¾›å®¢æˆ·ç«¯ç¼“å­˜ã€‚</p>
<h1 id="Druid"><a href="#Druid" class="headerlink" title="Druid"></a>Druid</h1><h2 id="åº•å±‚æ¨¡å‹çš„æ¼”è¿›"><a href="#åº•å±‚æ¨¡å‹çš„æ¼”è¿›" class="headerlink" title="åº•å±‚æ¨¡å‹çš„æ¼”è¿›"></a>åº•å±‚æ¨¡å‹çš„æ¼”è¿›</h2><p>åœ¨ä¸­æ’ä¸€ä¸ªå°è¯é¢˜ï¼Œè¯´è¯´æ•°æ®å­˜å‚¨ç³»ç»Ÿåº•å±‚æ¨¡å‹çš„ä¸€ä¸ªæ¼”è¿›ä¹‹è·¯ã€‚ä»æœ€å¼€å§‹çš„å¹³è¡¡æ ‘åˆ° B+ æ ‘å†åˆ° LSMæ ‘ï¼š</p>
<ul>
<li><p>å¹³è¡¡æ ‘ç¼ºç‚¹ï¼šæ ‘é«˜ä¸º log2(N)ï¼Œå¯¹äºç´¢å¼•æ ‘æ¥è¯´æ ‘é«˜è¶Šé«˜ï¼Œæ„å‘³ç€æŸ¥æ‰¾æ‰€è¦çš„èŠ±è´¹çš„è®¿é—®æ¬¡æ•°è¶Šå¤šï¼ŒæŸ¥è¯¢æ•ˆç‡è¶Šä½ã€‚ï¼ˆå¸¸æ•°ä»£ä»·é«˜ï¼‰å†µä¸”ä¸»å­˜ä»ç£ç›˜è¯»æ•°æ®ä¸€èˆ¬ä»¥é¡µä¸ºå•ä½ï¼Œæ¯æ¬¡è®¿é—®ç£ç›˜è¯»å–å¤šä¸ªæ‰‡åŒºçš„æ•°æ®ï¼ˆå¤§çº¦4kbï¼‰ï¼Œè¿œå¤§äºå•ä¸ªäºŒå‰æ ‘èŠ‚ç‚¹çš„å€¼ï¼Œé€ æˆäº†ä¸å¿…è¦çš„æŸ¥è¯¢æµªè´¹ã€‚</p>
</li>
<li><p>B+ tree ç¼ºç‚¹ï¼šå¶å­èŠ‚ç‚¹æ…¢æ…¢åˆ†è£‚ï¼Œå¯èƒ½å¯¼è‡´é€»è¾‘ä¸ŠåŸæœ¬è¿ç»­çš„æ•°æ®å®é™…ä¸Šå­˜æ”¾åœ¨ä¸åŒçš„ç‰©ç†ç£ç›˜å—ä½ç½®ä¸Šï¼Œåœ¨åšèŒƒå›´æŸ¥è¯¢çš„æ—¶å€™ä¼šå¯¼è‡´è¾ƒé«˜çš„ IOï¼Œå½±å“æ€§èƒ½ã€‚</p>
</li>
<li><p>LSM-tree ç‰¹ç‚¹ï¼šåœ¨ç£ç›˜çš„è®¿é—®ä¸­ï¼Œé¡ºåºè®¿é—®çš„é€Ÿåº¦æ˜¯è¿œå¤§äºéšæœºè®¿é—®çš„é€Ÿåº¦ã€‚è€Œ LSM-tree æ­£æ˜¯é¡ºåº”äº†è¿™ä¸ªç‰¹ç‚¹ï¼Œä¿è¯æ•°æ®çš„æœ‰åºæ€§ä»¥å°†ä¸€ä¸ªè¯·æ±‚è½¬åŒ–ä¸ºé¡ºåºçš„ç£ç›˜è®¿é—®ã€‚åœ¨ LSM-tree ä¸­åŒæ—¶ä½¿ç”¨ä¸¤éƒ¨åˆ†ç±»æ ‘çš„ç»“æ„æ¥å­˜å‚¨æ•°æ®ï¼Œå¹¶åŒæ—¶æä¾›æŸ¥è¯¢ã€‚å…¶ä¸­ä¸€éƒ¨åˆ†æ•°æ®å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œè´Ÿè´£æ¥å—æ–°çš„æ•°æ®æ’å…¥æ›´æ–°ä»¥åŠè¯»è¯·æ±‚ï¼Œå¹¶ç›´æ¥åœ¨å†…å­˜ä¸­å¯¹æ•°æ®è¿›è¡Œæ’åºã€‚å¦å¤–ä¸€éƒ¨åˆ†å­˜æ”¾åœ¨ç¡¬ç›˜ä¸Šï¼Œå®ƒä»¬æ˜¯ç”±å­˜æ”¾åœ¨å†…å­˜ä¸­çš„ c0 æ ‘å†²å†™åˆ°ç£ç›˜è€Œæˆï¼Œä¸»è¦æä¾›è¯»ï¼Œç‰¹ç‚¹æ˜¯æœ‰åºä¸”ä¸å¯åˆ«æ›´æ”¹ã€‚å†é€šè¿‡ WAL åŸåˆ™æ¥å®¹ç¾æ¢å¤ï¼Œä½¿ç”¨ bloom filter æ¥å¿«é€Ÿåˆ¤æ–­æ•°æ®çš„å­˜åœ¨æ€§ã€‚è€Œå…¶æ›´é€‚åˆæ’å…¥æ“ä½œè¿œå¤šäºæ•°æ®æ›´æ–°åˆ é™¤æ“ä½œä¸è¯»æ“ä½œçš„åœºæ™¯ã€‚</p>
</li>
</ul>
<p>Druid åœ¨æ¶æ„ä¸Šå€Ÿé‰´äº† LSM-tree çš„æ€æƒ³ï¼Œä½†æ˜¯ä¹Ÿå› ä¸ºä½¿ç”¨åœºæ™¯çš„å…³ç³»æœ‰ä¸€äº›å–èˆã€‚ç”±äºä¸æ”¯æŒæ•°æ®ä¿®æ”¹ï¼Œæ‰€ä»¥ç›´æ¥å»æ‰äº† WAL åŸåˆ™ã€‚æ•°æ®ç›´æ¥è¿›å…¥å†…å­˜çš„å †åŒºï¼Œåˆ°è¾¾æ¡ä»¶åå†²å†™åˆ°ç¡¬ç›˜ä¸Šå½¢æˆä¸€ä¸ªæ•°æ®å—ï¼ŒåŒæ—¶å®æ—¶èŠ‚ç‚¹åˆä¼šç«‹å³å°†æ–°ç”Ÿæˆçš„æ•°æ®å—åŠ è½½åˆ°éå †åŒºã€‚ä¼šå‘¨æœŸæ€§çš„å † Segment split è¿›è¡Œåˆå¹¶ï¼Œåˆå¹¶å¥½çš„ä¼šç«‹å³è¢«å®æ—¶èŠ‚ç‚¹ä¸Šä¼ åˆ°æ•°æ®æ–‡ä»¶å­˜å‚¨åº“ä¸­ï¼Œéšååè°ƒèŠ‚ç‚¹ä¼šæŒ‡å¯¼ä¸€ä¸ªå†å²èŠ‚ç‚¹å»æ–‡ä»¶å­˜å‚¨åº“ï¼Œå°†æ–°ç”Ÿæˆçš„ Segment ä¸‹è½½åˆ°å…¶æœ¬åœ°ç£ç›˜ä¸­ã€‚å½“å†å²èŠ‚ç‚¹æˆåŠŸåŠ è½½åˆ° Segment åï¼Œä¼šé€šè¿‡åè°ƒæœåŠ¡åœ¨é›†ç¾¤ä¸­å£°æ˜å…¶ä»æ­¤åˆ»å¼€å§‹è´Ÿè´£æä¾›è¯¥ Segment çš„æŸ¥è¯¢ã€‚å®æ—¶èŠ‚ç‚¹æ”¶åˆ°è¯¥å£°æ˜åå°±ä¸å†æä¾› Segment çš„æŸ¥è¯¢æœåŠ¡ã€‚</p>
<h2 id="ç³»ç»Ÿç»“æ„"><a href="#ç³»ç»Ÿç»“æ„" class="headerlink" title="ç³»ç»Ÿç»“æ„"></a>ç³»ç»Ÿç»“æ„</h2><h3 id="å®æ—¶èŠ‚ç‚¹ï¼ˆå·¥ä½œè€…-å†…å­˜è¯»å†™ï¼‰"><a href="#å®æ—¶èŠ‚ç‚¹ï¼ˆå·¥ä½œè€…-å†…å­˜è¯»å†™ï¼‰" class="headerlink" title="å®æ—¶èŠ‚ç‚¹ï¼ˆå·¥ä½œè€… å†…å­˜è¯»å†™ï¼‰"></a>å®æ—¶èŠ‚ç‚¹ï¼ˆå·¥ä½œè€… å†…å­˜è¯»å†™ï¼‰</h3><p>ä¸»è¦è´Ÿè´£å³æ—¶æ‘„å…¥å®æ—¶æ•°æ®ï¼Œä»¥åŠç”Ÿæˆ Segment æ•°æ®æ–‡ä»¶ã€‚å¦‚ Kafka çš„æ¶ˆè´¹ï¼Œå¯ä»¥å¼€å¤šä¸ªèŠ‚ç‚¹å¯¹å¤šä¸ª Partition è¿›è¡ŒåŒæ—¶æ¶ˆè´¹ï¼Œåœ¨ Zookeeper ä¸Šè®°å½• partition offsetï¼Œä¿è¯ at least oneã€‚</p>
<p><img src="/images/a-13-5.png" alt="a-13-5"></p>
<p>ä¸Šå›¾æ˜¯å®æ—¶èŠ‚ç‚¹çš„æ•°æ®æµå›¾ï¼Œå¯ä»¥çœ‹åˆ°å®æ—¶æ•°æ®ä¼šå…ˆè¢«å†™å…¥å †å†…å­˜å½“ä¸­ã€‚åœ¨å†™åˆ°ä¸€å®šæ•°é‡ä»¥åï¼Œä¼šå½¢æˆä¸€ä¸ª <code>Segement split</code> æŒä¹…åŒ–ä¿å­˜åˆ°ç¡¬ç›˜ä¸­ï¼Œä¸”å †å†…å­˜èƒ½ä¿è¯ <code>Segement split</code> å†…éƒ¨çš„æœ‰åºæ€§ã€‚è€Œä¸€ä¸ª <code>Segement split</code> é©¬ä¸Šä¼šè¢«ä»ç¡¬ç›˜é‡Œè¯»å–åˆ°éå †å†…å­˜ä¸­ï¼Œè€Œæ­¤æ—¶å †å†…å­˜ä¸­ç›¸åŒçš„æ•°æ®ä¼šè¢«æ¸…ç†æ‰ã€‚ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚ä¼šåŒæ—¶åˆ°å †å†…å­˜å’Œéå †å†…å­˜é‡ŒæŸ¥è¯¢æ•°æ®å†è¿›è¡Œæ‹¼æ¥ä»¥åè¿›è¡Œè¿”å›ã€‚</p>
<h3 id="åè°ƒèŠ‚ç‚¹ï¼ˆå†å²èŠ‚ç‚¹çš„æ§åˆ¶è€…ï¼‰"><a href="#åè°ƒèŠ‚ç‚¹ï¼ˆå†å²èŠ‚ç‚¹çš„æ§åˆ¶è€…ï¼‰" class="headerlink" title="åè°ƒèŠ‚ç‚¹ï¼ˆå†å²èŠ‚ç‚¹çš„æ§åˆ¶è€…ï¼‰"></a>åè°ƒèŠ‚ç‚¹ï¼ˆå†å²èŠ‚ç‚¹çš„æ§åˆ¶è€…ï¼‰</h3><p>è´Ÿè´£å†å²èŠ‚ç‚¹çš„æ•°æ®è´Ÿè½½å‡è¡¡ï¼Œä»¥åŠé€šè¿‡è§„åˆ™ç®¡ç†æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸã€‚Druid é€šè¿‡å¯¹æ¯ä¸ª DataSource è®¾ç½®çš„è§„åˆ™æ¥åŠ è½½æˆ–ä¸¢å¼ƒå…·ä½“çš„æ•°æ®æ–‡ä»¶ï¼Œä»¥ç®¡ç†æ•°æ®ç”Ÿå‘½å‘¨æœŸã€‚åœ¨å†å²èŠ‚ç‚¹æ¨å‡ºç³»ç»Ÿçš„æ—¶å€™ï¼Œåè°ƒèŠ‚ç‚¹è¿˜æ²¡æœ‰æŠŠå…¶èº«ä¸Šæºå¸¦çš„ Segment è´Ÿè½½åˆ°å…¶ä»–èŠ‚ç‚¹èº«ä¸Šçš„æ—¶å€™ï¼Œä¼šå‡ºç°çŸ­æš‚çš„æ•°æ®æ— æ³•è®¿é—®ã€‚è€ŒDruid å…è®¸é€šè¿‡ åˆ›å»º Segment çš„å‰¯æœ¬æ¥è§£å†³è¯¥é—®é¢˜ã€‚</p>
<h3 id="å†å²èŠ‚ç‚¹ï¼ˆå·¥ä½œè€…-è¯»ï¼‰"><a href="#å†å²èŠ‚ç‚¹ï¼ˆå·¥ä½œè€…-è¯»ï¼‰" class="headerlink" title="å†å²èŠ‚ç‚¹ï¼ˆå·¥ä½œè€… è¯»ï¼‰"></a>å†å²èŠ‚ç‚¹ï¼ˆå·¥ä½œè€… è¯»ï¼‰</h3><p>å†å²èŠ‚ç‚¹è´Ÿè´£åŠ è½½å·²ç»ç”Ÿæˆå¥½çš„æ•°æ®æ–‡ä»¶ä»¥æä¾›æŸ¥è¯¢ï¼Œå¹¶ä¸”ç”±åè°ƒèŠ‚ç‚¹æ¥è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å†å²èŠ‚ç‚¹åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œé¦–å…ˆæ£€æŸ¥è‡ªå·±çš„æœ¬åœ°ç¼“å­˜ä¸­å·²ç»å­˜åœ¨çš„ Segment æ•°æ®æ–‡ä»¶ï¼Œç„¶åä» DeepStorage ä¸­ä¸‹è½½å±äºè‡ªå·±ä½†ç›®å‰ä¸åœ¨è‡ªå·±æœ¬åœ°ç£ç›˜çš„ Segment æ•°æ®ã€‚æ— è®ºæ˜¯ä½•ç§æŸ¥è¯¢ï¼Œå†å²èŠ‚ç‚¹éƒ½ä¼šå°†ç›¸å…³çš„ Segment å…ˆåŠ å…¥åˆ°è‡ªå·±çš„å†…å­˜ä¸­ï¼Œç„¶åæä¾›æŸ¥è¯¢æœåŠ¡ã€‚</p>
<p>å†å²èŠ‚ç‚¹çš„æŸ¥è¯¢é€Ÿåº¦ä¸å…¶å†…å­˜ç©ºé—´å¤§å°å’Œæ‰€è´Ÿè´£çš„Segment æ•°æ®æ–‡ä»¶å¤§å°ä¹‹æ¯”æˆæ­£æ¯”ã€‚Druid å¯¹å†å²èŠ‚ç‚¹è¿›è¡Œåˆ†å±‚ï¼Œå¯ä»¥æ ¹æ®æ•°æ®æ¸©åº¦æ¥åè°ƒæ•°æ®çš„å­˜å‚¨ä½ç½®ã€‚</p>
<p>é€šè¿‡ Zookeeper æ¥åè°ƒé«˜å¯ç”¨å’Œé«˜æ‹“å±•æ€§ï¼Œæ–°çš„å†å²èŠ‚ç‚¹è¢«æ·»åŠ åï¼Œä¼šé€šè¿‡ Zookeeper è¢«åè°ƒèŠ‚ç‚¹å‘ç°ï¼Œç„¶ååè°ƒèŠ‚ç‚¹å°†ä¼šè‡ªåŠ¨åˆ†é…ç›¸å…³çš„ Segment ç»™å®ƒã€‚åŸæœ‰çš„å†å²èŠ‚ç‚¹è¢«ç§»é™¤çš„æ—¶å€™ï¼ŒåŒæ ·ä¼šè¢«åè°ƒèŠ‚ç‚¹å‘ç°ã€‚</p>
<h3 id="æŸ¥è¯¢èŠ‚ç‚¹ï¼ˆå·¥ä½œè€…ï¼‰"><a href="#æŸ¥è¯¢èŠ‚ç‚¹ï¼ˆå·¥ä½œè€…ï¼‰" class="headerlink" title="æŸ¥è¯¢èŠ‚ç‚¹ï¼ˆå·¥ä½œè€…ï¼‰"></a>æŸ¥è¯¢èŠ‚ç‚¹ï¼ˆå·¥ä½œè€…ï¼‰</h3><p>å¯¹å¤–æä¾›æŸ¥è¯¢æœåŠ¡ï¼Œä»å†å²èŠ‚ç‚¹å’Œäº‹å®èŠ‚ç‚¹æŸ¥è¯¢æ•°æ®ï¼Œåˆå¹¶åå›ä¼ ã€‚æä¾›ç¼“å­˜æœºåˆ¶ï¼Œä½¿ç”¨å¤šä¸ªæŸ¥è¯¢èŠ‚ç‚¹æ¥é˜²æ­¢å•ç‚¹æ•…éšœï¼Œä½¿ç”¨ Nginx æ¥åšè´Ÿè½½å‡è¡¡ã€‚ä¿è¯æ¯ä¸ªæŸ¥è¯¢èŠ‚ç‚¹åœ¨å¯¹åŒä¸€ä¸ªè¯·æ±‚ç›¸åº”çš„æ—¶å€™è¿”å›ç›¸åŒçš„ç»“æœã€‚</p>
<h3 id="Segmentï¼ˆæ•°æ®èšåˆå•ä½ï¼‰"><a href="#Segmentï¼ˆæ•°æ®èšåˆå•ä½ï¼‰" class="headerlink" title="Segmentï¼ˆæ•°æ®èšåˆå•ä½ï¼‰"></a>Segmentï¼ˆæ•°æ®èšåˆå•ä½ï¼‰</h3><p><img src="/images/a-13-6.jpeg" alt="a-13-6"></p>
<h3 id="æ€»è§ˆ"><a href="#æ€»è§ˆ" class="headerlink" title="æ€»è§ˆ"></a>æ€»è§ˆ</h3><p><img src="/images/a-13-7.png" alt="a-13-7"></p>
<p>å®çº¿æ˜¯æ•°æ®è¯·æ±‚çš„æµå‘ï¼Œè™šçº¿æ˜¯å®æ—¶æ•°æ®çš„æµå‘ã€‚</p>
<p>å®æ—¶æ•°æ®ä¼šå…ˆè¿›å…¥å®æ—¶èŠ‚ç‚¹çš„å †å†…å­˜ï¼Œåœ¨å †å†…å­˜çš„å¤§å°è¾¾åˆ°ä¸€å®šçš„æ•°é‡ä»¥åï¼Œä¼šå½¢æˆ <code>Segment split</code> å†²å†™åˆ°ç¡¬ç›˜é‡Œï¼ŒåŒæ—¶è¿™ä¸ª <code>Segement split</code> ä¼šè¢«åŠ è½½åˆ°éå †å†…å­˜ä¸­ä»¥ä¾›è®¿é—®ã€‚å¹¶ä¸”ä¼šæä¾›å‘¨æœŸæ€§çš„ <code>Merging Compaction</code>ï¼Œç”±å‡ ä¸ªå°çš„ <code>Segment split</code> åˆæˆä¸€ä¸ª Segementï¼Œå¹¶å­˜å…¥åˆ°å­˜å‚¨èŠ‚ç‚¹ä¸­ã€‚å­˜å‚¨å®Œæˆä»¥åä¼šå‘Šä¹‹åè°ƒèŠ‚ç‚¹ï¼Œç”±åè°ƒèŠ‚ç‚¹è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå†³å®šæŠŠè¿™ä¸ª Segement äº¤ç»™ä¸€ä¸ªå†å²èŠ‚ç‚¹ï¼Œä¹‹åè¿™ä¸ªå†å²èŠ‚ç‚¹ä¼šå£°æ˜å¯¹è¿™ä¸ª Segement çš„æŸ¥è¯¢æä¾›æœåŠ¡ï¼Œè€Œå®æ—¶èŠ‚ç‚¹æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯ä»¥åå°±ä¸å†å¯¹è¿™ä¸ª Segement çš„æŸ¥è¯¢æä¾›æœåŠ¡äº†ï¼Œå¹¶æ¸…ç†æ‰ç›¸å…³æ•°æ®ã€‚</p>
<p>ä¸€ä¸ªè¯·æ±‚è¿›å…¥ç³»ç»Ÿä»¥åä¼šå…ˆåˆ°æŸ¥è¯¢èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢èŠ‚ç‚¹å†é€šè¿‡ç°åœ¨å„èŠ‚ç‚¹å¯¹æ•°æ®çš„è´Ÿè´£æƒ…å†µï¼Œåˆ†åˆ«åˆ°å®æ—¶èŠ‚ç‚¹å’Œå†å²èŠ‚ç‚¹ä¸Šè¿›è¡ŒæŸ¥è¯¢ï¼Œæœ€åå°†ç»“æœåˆå¹¶è¿›è¡Œè¿”å›ã€‚å¹¶ä¸”åœ¨æŸ¥è¯¢èŠ‚ç‚¹ä¸Šä¼šæä¾›å„ç­‰çº§çš„ç¼“å­˜ï¼Œå†å²èŠ‚ç‚¹åˆ™æä¾› Block cacheã€‚</p>
<h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>ç›¸ä¿¡ä½ åœ¨é˜…è¯»ä»¥åèƒ½æ˜æ˜¾çš„æ„Ÿå—åˆ°ä¸‰ä¸ªç³»ç»Ÿçš„ç›¸ä¼¼ä¸åŒºåˆ«ï¼Œå¹¶å¯¹è¿™ç§åˆ†å¸ƒå¼æ¶æ„æœ‰ä¸ªå¤§ä½“ä¸Šçš„ç†è§£ã€‚æœ¬ç¯‡åšå®¢å¤§éƒ¨åˆ†å†…å®¹éƒ½æ˜¯å¯¹ç°æœ‰æ–‡ç« çš„æ•´ç†ï¼Œæ±‡æ€»ã€‚æ‰€ä»¥æœ€åæ„Ÿè°¢è¿™äº›æ–‡ç« åŠå…¶ä½œè€…ï¼š</p>
<ul>
<li><a href="http://blog.bizcloudsoft.com/wp-content/uploads/Google-Bigtable%E4%B8%AD%E6%96%87%E7%89%88_1.0.pdf" target="_blank" rel="noopener">BigTable ç¿»è¯‘ç‰ˆ</a> </li>
<li><a href="http://static.usenix.org/event/osdi06/tech/chang/chang.pdf" target="_blank" rel="noopener">BigTable åŸç‰ˆ</a> </li>
<li><a href="https://www.microsoft.com/en-us/research/uploads/prod/2016/12/paxos-simple-Copy.pdf" target="_blank" rel="noopener">Paxos Made Simple</a> </li>
<li><a href="https://blog.csdn.net/historyasamirror/article/details/3870168" target="_blank" rel="noopener">Googleåˆ©å™¨ä¹‹Chubby</a> </li>
<li><a href="http://www.blogjava.net/DLevin/archive/2015/08/22/426877.html?opt=admin" target="_blank" rel="noopener">æ·±å…¥HBaseæ¶æ„è§£æï¼ˆä¸€ï¼‰ - ä¸Šå–„è‹¥æ°´</a> </li>
</ul>
<ul>
<li><a href="http://www.n10k.com/blog/blockcache-101/" target="_blank" rel="noopener">BlockCache 101 - Nick Dimiduk</a> </li>
<li><a href="http://xudifsd.org/blog/2016/06/chubby-zookeeper-different-consistency-level/" target="_blank" rel="noopener">chubby &amp; zookeeper: different consistency level</a> </li>
<li><a href="http://www.cnblogs.com/yangecnu/p/Introduction-CQRS.html" target="_blank" rel="noopener">æµ…è°ˆå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»(CQRS)æ¨¡å¼ - yangecnu</a> </li>
</ul>

	
	</div>
  <a type="button" href="/2019/04/06/a13/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2019/03/17/a4/" >STORMä¸­OOMå¼•å‘çš„æ€è€ƒ</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2019-03-17  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="æè¿°"><a href="#æè¿°" class="headerlink" title="æè¿°"></a>æè¿°</h2><p>æœ€è¿‘ä¸€æ¬¡åœ¨å®ç°éœ€æ±‚çš„æ—¶å€™å‘ç° Storm ä¸­çš„ä¸€ä¸ª Bolt å‡ºç°äº† OOM å¯¼è‡´çš„é•¿æ—¶é—´ GC é—®é¢˜ã€‚æœ€åè™½ç„¶é€šè¿‡ review æ–°æ›´æ–°çš„ä»£ç æ‰¾åˆ°äº†é—®é¢˜ï¼Œä½†æ˜¯æ·±ç©¶å…¶ä¸­è¿˜æ˜¯æœ‰ä¸€äº›åˆ«çš„æ”¶è·ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œè¿›è¡Œè®°å½•ã€‚</p>
<p>åœ¨ review æ–°æ›´æ–°çš„ä»£ç ä¹‹åå‘ç°ï¼Œæˆ‘å°† <code>JedisPool</code> çš„å®ä¾‹åŒ–å†™åˆ°äº† <code>execute</code> ä¸­è€Œä¸æ˜¯ <code>prepare</code> ä¸­ï¼Œæ‰€ä»¥ Storm æ¯æ¬¡æ‰§è¡Œ <code>execute</code> çš„æ—¶å€™éƒ½ä¼šé‡æ–°å®ä¾‹åŒ– <code>JedisPool</code> å¹¶ä¸”ä¹Ÿæ²¡æœ‰æ˜¾å¼çš„è¿›è¡Œ <code>close</code>ã€‚</p>
<p>è™½ç„¶è¿™ä¸ªé—®é¢˜åªæ˜¯å› ä¸ºç–å¿½å¯¼è‡´çš„ï¼Œä½†æ˜¯ä¹Ÿè®©æˆ‘å¯¹ä¸¤ä¸ªå¤§é—®é¢˜è¿›è¡Œäº†æ€è€ƒã€‚ä¸€ä¸ªæ˜¯å¯¹äº Storm ä¸­èµ„æºå†²çªçš„é—®é¢˜åº”è¯¥å¦‚ä½•å»å‘ç°ã€å®šä½ã€å¤„ç†ï¼Œç¬¬äºŒä¸ªæ˜¯ Storm ä¸­ Component çš„ç”Ÿå‘½å‘¨æœŸã€‚ä¸‹é¢ä¼šè®¨è®ºè¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p>
<h2 id="Stormä¸­çš„èµ„æºå†²çª"><a href="#Stormä¸­çš„èµ„æºå†²çª" class="headerlink" title="Stormä¸­çš„èµ„æºå†²çª"></a>Stormä¸­çš„èµ„æºå†²çª</h2><p><img src="/images/a4-1.png" alt="a4-1"></p>
<p>è¦è§£å†³ Storm ä¸­çš„èµ„æºå†²çªï¼Œé‚£ä¹ˆéœ€è¦å…ˆäº†è§£ Storm ä¸­çš„èµ„æºåˆ†é…ã€‚ä¸€ä¸ªé›†ç¾¤ç”±ä¸€ä¸ª nimbus èŠ‚ç‚¹å’Œå¤šä¸ªå·¥ä½œèŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ç”±ä¸€ä¸ª <code>Supervisor</code> ç®¡ç†ç€å¤šä¸ª <code>Worker process</code>ï¼Œæ¯ä¸ª <code>Worker process</code> å¯¹åº”ç€ä¸€ä¸ª <code>JVM</code>ï¼Œåœ¨å…¶ä¸­æœ‰å¤šä¸ª <code>Executor thread</code>ã€‚æ¯ä¸ª <code>Executor thread</code> ä¸­å¯èƒ½å­˜åœ¨å¤šä¸ª <code>Task</code>ã€‚è€Œ <code>Task</code> åˆ™æ˜¯ä¸€ä¸ª bolt æˆ–è€… spout çš„å®ä¾‹ã€‚</p>
<p>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¯ä»¥æŠŠèµ„æºç«äº‰ä»æ‰€å±ç»“æ„ä»å°åˆ°å¤§åˆ’åˆ†ä¸ºï¼š</p>
<ul>
<li><code>Worker process</code> ä¸­çš„å†…å­˜å†²çª</li>
<li><code>Worker process</code> çš„å†²çª</li>
<li>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„å†…å­˜å†²çª</li>
<li>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ CPU å†²çª</li>
<li>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ç½‘ç»œ I/O å†²çª</li>
<li>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ç£ç›˜ I/O å†²çª</li>
</ul>
<h3 id="Worker-process-ä¸­çš„å†…å­˜å†²çª"><a href="#Worker-process-ä¸­çš„å†…å­˜å†²çª" class="headerlink" title="Worker process ä¸­çš„å†…å­˜å†²çª"></a>Worker process ä¸­çš„å†…å­˜å†²çª</h3><p>é¦–å…ˆè¿™ç±»å†²çªå®é™…ä¸Šæ˜¯ JVM ä¸­çš„å†…å­˜å ç”¨è¿‡å¤šï¼Œè¡¨ç°ä¸º <code>out-of-memory</code> æˆ–è€…è¿›å…¥é•¿æ—¶é—´çš„åƒåœ¾å›æ”¶ï¼Œå¹¶ä¸”è¿™ç±»å†²çªä¼šåœ¨ UI ä¸Šæš´éœ²å‡ºæ¥ã€‚è€Œè§£å†³åŠæ³•æ— éæ˜¯ï¼š</p>
<ul>
<li>å‡å°‘ä¸€ä¸ª <code>Worker process</code> ä¸­çš„ <code>Executor thread</code> ä¸ªæ•°<ul>
<li>ä¿è¯ <code>Executor thread</code> æ•°é‡ä¸å˜çš„æƒ…å†µä¸‹åŠ å¤§ <code>Worker process</code> æ•°é‡</li>
<li>ä¿è¯ <code>Worker process</code> æ•°é‡ä¸å˜çš„æƒ…å†µä¸‹å‡å°‘ <code>Executor thread</code> æ•°é‡</li>
</ul>
</li>
<li>æé«˜ç»™ JVM åˆ†é…çš„å†…å­˜ï¼šåœ¨ <code>storm.yaml</code> ä¸­ <code>worker.childopts</code> å±æ€§æ˜¯ JVM ç›¸å…³çš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡è®¾å®š <code>-Xms</code> å’Œ <code>-Xmx</code> æ¥è¿›è¡Œä¿®æ”¹ã€‚</li>
</ul>
<p>è€Œè§‚å¯Ÿä»»åŠ¡çš„ GC æ—¥å¿—æ˜¯æœ€ç›´æ¥ä¹Ÿæ˜¯æœ€é•¿ç”¨åˆ°æ¥è§£å†³é—®é¢˜çš„é€”å¾„ï¼Œåœ¨ <code>storm.yaml</code> çš„ <code>worker.childopts</code> ä¸­å¯ä»¥å¯¹ JVM çš„ GC æ—¥å¿—è¿›è¡Œé…ç½®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">worker.childopts: &quot;&quot;-XX +PrintGCTimeStamps  </span><br><span class="line">-XX: +PrintGCDetails</span><br><span class="line">-Xloggc: /opt/storm/worker-%ID%-jvm-gc.log</span><br><span class="line">-XX: +UseGCLogFileRotation</span><br><span class="line">-XX: NumberOfGCLogFiles=5</span><br><span class="line">-XX: GCLogFileSize=1M</span><br><span class="line">-XX: +PrintGCDateStamps</span><br><span class="line">-XX: +PrintGCApplicationStoppedTime</span><br><span class="line">-XX: +PrintGCApplicationConsurrentTime&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-XX +PrintGCTimeStamps</code>: æ‰“å°åƒåœ¾å›æ”¶çš„æ—¶é—´æˆ³</li>
<li><code>-XX: +PrintGCDetails</code>: æ‰“å°é¢å¤–çš„ GC ç»†èŠ‚</li>
<li><code>-Xloggc: /opt/storm/worker-%ID%-jvm-gc.log</code>: ä¸ºæ¯ä¸ªå·¥ä½œè¿›ç¨‹åˆ†åˆ«åˆ›å»ºæ—¥å¿—æ–‡ä»¶</li>
<li><code>-XX: +UseGCLogFileRotation</code>: å¯¹ GC æ—¥å¿—æ–‡ä»¶ä½¿ç”¨æ—¥å¿—è½¬å‚¨</li>
<li><code>-XX: NumberOfGCLogFiles=5</code>: è®¾ç½®æ—¥å¿—çš„åˆ†å‰²ä¸ªæ•°</li>
<li><code>-XX: GCLogFileSize=1M</code>: è®¾ç½®æ—¥å¿—çš„åˆ†å‰²å¤§å°</li>
<li><code>-XX: +PrintGCDateStamps</code>: æ‰“å°åƒåœ¾å›æ”¶çš„æ—¥æœŸå’Œæ—¶é—´ä¿¡æ¯</li>
<li><code>-XX: +PrintGCApplicationStoppedTime</code>: æ‰“å°åº”ç”¨ç¨‹åºåœæ­¢æ—¶ GC å¯åŠ¨æ—¶é—´ï¼ˆæ—¶é—´åœ¨å®‰å…¨ç‚¹å†…ï¼‰</li>
<li><code>-XX: +PrintGCApplicationConsurrentTime</code>: æ‰“å° GC æ‰§è¡ŒæœŸé—´ç¨‹åºå¯åŠ¨çš„æ—¶é—´ï¼ˆæ—¶é—´ä¸åœ¨å®‰å…¨ç‚¹å†…ï¼‰</li>
</ul>
<h3 id="Worker-process-çš„å†²çª"><a href="#Worker-process-çš„å†²çª" class="headerlink" title="Worker process çš„å†²çª"></a>Worker process çš„å†²çª</h3><p>è¿™æ˜¯ç”±äºéœ€è¦çš„ Worker process æ•°é‡è¶…è¿‡äº†é›†ç¾¤ä¸­çš„æ•°é‡ï¼Œå¯ä»¥é€šè¿‡æ‰©å±•é›†ç¾¤ï¼Œæˆ–è€…å¢åŠ æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹çš„ Worker process æ•°é‡æ¥è§£å†³ã€‚ä¹Ÿå¯ä»¥å¯¹å‡å°‘é›†ç¾¤é‡Œä¸€äº›ä»»åŠ¡çš„ Worker process å ç”¨æ¥è§£å†³ã€‚</p>
<p>åœ¨ <code>storm.yaml</code> çš„ <code>supervisor.slots.ports</code> é…ç½®é¡¹å¯ä»¥é…ç½®ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹çš„ Worker process æ•°é‡ï¼Œæ¯ä¸€ä¸ªç«¯å£å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ã€‚æ·»åŠ æ·»åŠ ã€åˆ é™¤ç«¯å£å°±èƒ½è¿›è¡Œæ§åˆ¶ã€‚</p>
<h3 id="å·¥ä½œèŠ‚ç‚¹ä¸Šçš„å†…å­˜å†²çª"><a href="#å·¥ä½œèŠ‚ç‚¹ä¸Šçš„å†…å­˜å†²çª" class="headerlink" title="å·¥ä½œèŠ‚ç‚¹ä¸Šçš„å†…å­˜å†²çª"></a>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„å†…å­˜å†²çª</h3><p>å› ä¸ºå·¥ä½œèŠ‚ç‚¹çš„å†…å­˜éœ€è¦æ”¯æ’‘ <code>Supervisor process</code>ï¼Œ æ“ä½œç³»ç»Ÿï¼Œå¤šä¸ª <code>Worker process</code> å’Œå…¶ä»–çš„ä¸€äº›è¿›ç¨‹ã€‚å¦‚æœå·¥ä½œèŠ‚ç‚¹åœ¨å†…å­˜ä¸Šå‘ç”Ÿäº†ä½¿ç”¨å†²çªï¼Œå·¥ä½œèŠ‚ç‚¹å°†å¼€å¯è¿›ç¨‹é—´çš„å†…å­˜è°ƒåº¦ï¼ˆswappingï¼‰ï¼Œä¼šé€ æˆæœ‰è¾ƒé«˜çš„å»¶æ—¶å‘ç”Ÿã€‚å¯ä»¥é€šè¿‡ <code>sar</code> å‘½ä»¤æ¥è¿›è¡Œç›‘æ§ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sar -S 1 3</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">è¡¨ç¤ºæ¯éš”1ç§’è¾“å‡º3æ¡å†…å­˜çš„æ´»åŠ¨ä¿¡æ¯ï¼Œä¸»è¦éœ€è¦å…³æ³¨ `kbswpused` å’Œ `%swpused` æ•°æ®ã€‚`kbswpused` æ˜¯ä½¿ç”¨ä¸­çš„äº¤æ¢ç©ºé—´å†…å­˜(KB) ï¼Œ`%swpused` æ˜¯ä½¿ç”¨ä¸­çš„äº¤æ¢ç©ºé—´å†…å­˜ç™¾åˆ†æ¯”ã€‚å¦‚æœè¿™ä¸¤ä¸ªå€¼å¤§äº0åˆ™è¯´æ˜ç³»ç»Ÿä¸­å­˜åœ¨å†…å­˜äº¤æ¢ã€‚</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>## å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ CPU å†²çª</span><br><span class="line">å’Œä¸Šä¸€ä¸ªæƒ…å†µç±»ä¼¼ï¼Œä¹Ÿæ˜¯å› ä¸ºå¯¹ CPU çš„ä½¿ç”¨è¶…è¿‡äº†èŠ‚ç‚¹æ‰€èƒ½æä¾›çš„è€Œé€ æˆçš„ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ `sar` å‘½ä»¤æ¥è¿›è¡Œç›‘æ§ï¼š</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line"><span class="meta">$</span> sar -u 1 3</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦éœ€è¦å…³æ³¨ <code>%idle</code>ï¼Œå³åœ¨ç³»ç»Ÿæ²¡æœ‰ä»»ä½•ç£ç›˜ I/O è¯·æ±‚ç©ºé—²CPUæ—¶é—´ç™¾åˆ†æ¯”ï¼Œå¦‚æœå€¼åä½ã€‚å†åˆ° <code>%user</code>ï¼Œ<code>%nice</code>ï¼Œ <code>%system</code> ä¸­å»æ‰¾äº‹åº”ç”¨å±‚é¢ä¸Šçš„é—®é¢˜è¿˜æ˜¯ç³»ç»Ÿå±‚é¢çš„é—®é¢˜ã€‚</p>
<h3 id="å·¥ä½œèŠ‚ç‚¹ä¸Šçš„-I-O-å†²çª"><a href="#å·¥ä½œèŠ‚ç‚¹ä¸Šçš„-I-O-å†²çª" class="headerlink" title="å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ I/O å†²çª"></a>å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ I/O å†²çª</h3><p>åŒæ ·å¯ä»¥ä½¿ç”¨ <code>sar</code> å‘½ä»¤æ¥è¿›è¡Œç›‘æ§ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sar -u 1 3</span><br></pre></td></tr></table></figure>

<p>åªæ˜¯ç°åœ¨éœ€è¦å…³æ³¨çš„å€¼æ˜¯ <code>%iowait</code>ï¼ŒCPU æ—¶é—´ç©ºé—²çš„ç™¾åˆ†æ¯”ï¼Œåœ¨æ­¤æœŸé—´ç³»ç»Ÿå°†æ‰§è¡Œ I/O è¯·æ±‚ã€‚å¦‚æœè¿™ä¸ªå€¼çº¦ä¸º 10.00ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡å‡ºç°å›  I/O å†²çªå¯¼è‡´çš„æ€§èƒ½é—®é¢˜ï¼Œå¦‚æœå¤§äº 25.00ï¼Œä¸€å®šé¢ä¸´æ¯”è¾ƒä¸¥é‡çš„ I/O å†²çªã€‚</p>
<p>ç„¶åè¦åšçš„å°±æ˜¯å®šä½é—®é¢˜æ˜¯åœ¨ç½‘ç»œ I/O è¿˜æ˜¯ç£ç›˜ I/Oï¼Œå¯ä»¥å…ˆé€šè¿‡ä¸‹é¢çš„æ–¹æ³•æ£€æŸ¥ç½‘ç»œ I/Oã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// è·å–è¿›ç¨‹id</span><br><span class="line"><span class="meta">$</span> ps aux | grep MY_TOPOLOGY_NAME</span><br><span class="line">stormuser 12345 .....</span><br><span class="line"></span><br><span class="line">// è·å–ç«¯å£</span><br><span class="line"><span class="meta">$</span> netstat -antup | grep "12345/"</span><br><span class="line">tcp6       0      0 xx.xx.xx.xx: 12345        xx.xx.xx.xx:42474       ESTABLISHED 4576/java</span><br><span class="line"></span><br><span class="line">// æŸ¥çœ‹é™åˆ¶</span><br><span class="line"><span class="meta">$</span> cat /proc/12345/limits</span><br><span class="line"></span><br><span class="line">// æŸ¥çœ‹è¯¥ç«¯å£çš„ç¨³å®šçš„è¿æ¥tcpè¿æ¥</span><br><span class="line"><span class="meta">$</span> netstat -na | grep "tcp6" | grep "4576" | grep "ESTABLISHED" | wc -l</span><br></pre></td></tr></table></figure>

<p>æ£€æŸ¥ <code>Max open files</code> ä¸€è¡Œï¼Œ soft limit å’Œ hard limit çš„å€¼ï¼Œå¦‚æœå·²ç»åˆ°è¾¾è®¾ç½®çš„æé™å€¼ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿç½‘ç»œ I/O å†²çªã€‚ç„¶åå¯ä»¥ä½¿ç”¨ iotop æ¥è§‚å¯Ÿæ˜¯å¦å‘ç”Ÿäº†ç£ç›˜ I/Oã€‚</p>
<p>ä¸»è¦è§‚å¯Ÿ USER ä¸º storm çš„è¿›ç¨‹ï¼Œ <code>DISK READ</code> ï¼Œ<code>DISK WRITE</code>ï¼Œ<code>IO&gt;</code> å³æ¯ç§’è¯¥è¿›ç¨‹è¯»å–çš„å­—èŠ‚æ•°ï¼Œæ¯ç§’è¯¥è¿›ç¨‹å†™å…¥çš„å­—èŠ‚æ•°ï¼Œæ¯ç§’ I/O è°ƒç”¨ç™¾åˆ†æ¯”ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªå€¼è¾ƒé«˜å°±è¯´æ˜ç›¸å…³çš„ä»»åŠ¡å‡ºç°äº†ç£ç›˜ I/O å†²çªã€‚</p>
<p><strong>è¯¥ç« èŠ‚ä¸»è¦å‚è€ƒã€ŠStormåº”ç”¨å®è·µã€‹</strong></p>
<h2 id="Component-ç”Ÿå‘½å‘¨æœŸ"><a href="#Component-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Component ç”Ÿå‘½å‘¨æœŸ"></a>Component ç”Ÿå‘½å‘¨æœŸ</h2><p>è¿™é‡Œå¯ä»¥å…ˆå‚è€ƒä¸€ä¸‹ Nathan on è‡ªå·±çš„å›ç­”ï¼š <a href="https://groups.google.com/forum/#!msg/storm-user/com4JfU9aJ4/zImseAoiH2IJ" target="_blank" rel="noopener">The lifecycle of a bolt or spout</a></p>
<p>å¯ä»¥çœ‹åˆ° <code>prepare</code> ä»…ä»…åªä¼šè¢« worker åœ¨å¼€å§‹çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯ <code>execute</code> ä¼šåœ¨æ¯æ¬¡æœ‰ tuple è¿›å…¥çš„æ—¶å€™éƒ½è¢«è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘æœ‰ä¸€ä¸ª Bolt å®šä¹‰äº†3ä¸ª workerï¼Œæ¯ä¸ª worker éƒ½æœ‰3ä¸ª executerã€‚é‚£ä¹ˆæ€»å…±æ˜¯æœ‰9ä¸ª taskï¼Œä¹Ÿå°±æ˜¯è¯´ <code>prepare</code> ä¼šè¢«è°ƒç”¨9æ¬¡ï¼Œè€Œ <code>execute</code> å°±ä¼šè¢«æ— é™è°ƒç”¨ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¸€äº›è¿æ¥å’Œé™æ€å˜é‡çš„åˆå§‹åŒ–å·¥ä½œæ”¾åˆ° <code>prepare</code> ä¸­å»å®Œæˆä¼šæ›´åŠ çš„å®æƒ ã€‚ä½†æ˜¯ç”±äºæ¯ä¸ª worker å¯¹åº”ä¸€ä¸ªå•ç‹¬çš„ JVM è¿›ç¨‹ï¼Œä¸€ä¸ª JVM è¿›ç¨‹ä¸­ä¼šæœ‰å¤šä¸ª executor çº¿ç¨‹ï¼Œæ‰€ä»¥å°±ä¼šæœ‰å¤šä¸ª task åŒæ—¶æ‰§è¡Œ <code>prepare</code> çš„æ“ä½œã€‚<br>é‚£ä¹ˆä¸€äº›è¿æ¥çš„åˆ›å»ºæ˜¯éœ€è¦çº¿ç¨‹å®‰å…¨çš„ç¯å¢ƒï¼Œçº¿ç¨‹å®‰å…¨çš„å•ä¾‹å†™æ³•è¿™é‡Œä¸èµ˜è¿°ã€‚</p>

	
	</div>
  <a type="button" href="/2019/03/17/a4/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2018/11/16/a3/" >åˆ†å¸ƒå¼è½®è¯¢ç³»ç»Ÿ</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2018-11-16  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>æœ€è¿‘éœ€è¦å®ç°çš„ä¸€ä¸ªåœºæ™¯æ˜¯å¯¹äºç¤¾åŒºé‡Œçš„æ¯æ¡åŠ¨æ€è¿›è¡Œå¤šæ¬¡çš„æ£€æµ‹å’Œè¯„ä¼°ï¼Œæš‚ä¸”ä¸è®ºæ£€æµ‹å’Œè¯„ä¼°çš„å…·ä½“åŠŸèƒ½ï¼Œç»Ÿç§°ä¸ºã€Œè®¡ç®—ã€ã€‚</p>
<p>è€Œè¿™äº›è®¡ç®—ç”±å…¶ä»–åŒäº‹æä¾›ç°æˆçš„æ¥å£ï¼Œä½†æ˜¯ç”±äºå…¶å…·ä½“åŠŸèƒ½çš„å·®å¼‚è¿™äº›è®¡ç®—æœ‰äº›ä¾èµ–äº†å¤–éƒ¨æ¥å£ï¼Œå¹¶ä¸”å¯èƒ½ä¾èµ–å¤–éƒ¨çš„é•¿å»¶æ—¶æ¥å£ï¼Œä¾‹å¦‚è§†é¢‘åˆ†æã€‚æ‰€ä»¥è¿™é‡Œä»è®¡ç®—çš„å®ç°ä¸Šå°†å…¶åˆ’åˆ†ä¸ºã€Œç¬æ—¶è®¡ç®—ã€å’Œã€Œé•¿æ—¶è®¡ç®—ã€ï¼Œè€Œå¯¹äºä¸Šå±‚ä½¿ç”¨æ–¹æ¥è¯´æ˜¯éœ€è¦æ„é€ å‡ºä¸€ç§ä½¿ç”¨åè®®æ¥åŒæ—¶å…¼å®¹ä¸¤ç§ç±»å‹ã€‚è€Œè¿™æ ·çš„ä¸‰å±‚ç»“æ„ä¸­æ˜¯æœ‰ä¸¤æ¬¡ç½‘ç»œä¼ è¾“è¿‡ç¨‹ï¼Œæ›´éœ€è¦ä¸€ç§è¶³å¤Ÿå¥å£®çš„é‡è¯•ç­–ç•¥ã€‚å¹¶ä¸”åœ¨åŠ¨æ€æµé‡åŸºæ•°è¾ƒå¤§ï¼Œå³°å€¼ä¸è°·å€¼å·®å¼‚è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œæ¨ªå‘æ‰©å®¹èƒ½åŠ›ä¹Ÿéå¸¸çš„é‡è¦ã€‚</p>
<h2 id="æ¨¡å‹"><a href="#æ¨¡å‹" class="headerlink" title="æ¨¡å‹"></a>æ¨¡å‹</h2><p>ç¬¬ä¸€æ¬¡è®¨è®ºçš„æ–¹æ¡ˆæ˜¯ ã€Œpushæ¨¡å‹ã€ï¼Œå¤šæ–¹ä½¿ç”¨æˆ‘æš´éœ²çš„æ¥å£ï¼Œåœ¨å®Œæˆæ•°æ®æ¶ˆè´¹è®¡ç®—ä¹‹åæ¨é€åˆ°æˆ‘çš„æœåŠ¡ä¸­è¿›è¡Œä¸‹æ¸¸é€»è¾‘ã€‚è¿™ç§æ–¹æ¡ˆæœ‰å‡ ä¸ªå¼Šç«¯ï¼Œç¬¬ä¸€æ˜¯å¤šæ–¹éœ€è¦å®ç°æ¶ˆè´¹ Kafka çš„é€»è¾‘å¹¶ä¸”éœ€è¦ç®¡ç† Kafka offsetï¼Œä¿è¯åœ¨äº‹æ•…ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ç¬¬äºŒæ˜¯ç½‘ç»œä¼ è¾“å¯¼è‡´çš„é‡è¯•é€»è¾‘å¤æ‚ï¼Œéœ€è¦æ¥å…¥ç¬¬äºŒä¸ªé‡è¯•é˜Ÿåˆ—ï¼Œæˆ–è€…æä¾›é‡è¯•æ¥å£ï¼Œè¿™æ ·æ•°æ®æµçš„æµå‘å°±ä»å•å‘å˜ä¸ºåŒå‘ï¼Œå¢åŠ äº†ä¹‹åçš„ç»´æŠ¤å’Œæ’æŸ¥æˆæœ¬ã€‚ä½†æ˜¯è¿™ç§æ–¹æ¡ˆè¿˜æ˜¯æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå› ä¸ºè®¡ç®—æ–¹æ˜¯æ¥è§¦æ•°æ®çš„ç¬¬ä¸€å±‚ï¼Œæ‰€ä»¥åœ¨è®¡ç®—æ–¹å†…éƒ¨å‡ºç°é”™è¯¯å¼•èµ·çš„é‡è¯•æˆ–è€…æŠ¥é”™æœºåˆ¶å®ç°å…¶ä»–éå¸¸ç®€å•ã€‚</p>
<p>åœ¨å¦å®šä»¥åè½¬æ¢ä¸º ã€Œpullæ¨¡å‹ã€ï¼Œå¤šæ–¹æš´éœ²æ¥å£è®©æˆ‘è¿›è¡Œç»Ÿä¸€çš„è°ƒç”¨ï¼Œä»…ç”±æˆ‘æ–¹æ¶ˆè´¹ Kafka å¹¶ç»Ÿä¸€ç»´æŠ¤çŠ¶æ€å’Œæä¾›é‡è¯•ç­–ç•¥ã€‚ä½†æ˜¯åœ¨å®ç°ç»†èŠ‚ä¸Šè¿˜æ˜¯æœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼Œä¸€ç§æ˜¯ä»¥ã€ŒåŠ¨æ€ä¸ºå•ä½ã€ï¼Œä¸€ç§æ˜¯ä»¥ã€Œè®¡ç®—ä¸ºå•ä½ã€ã€‚åŠ¨æ€ä¸ºå•ä½æ˜¯è¯´ï¼Œä¸»çº¿ç¨‹æ¶ˆè´¹ Kafkaï¼Œç„¶åäº¤ç”±ä¸‹æ¸¸å¼‚æ­¥æˆ–å¤šçº¿ç¨‹æ–¹å¼è°ƒç”¨å¤šä¸ªæ¥å£ï¼Œå…¨éƒ¨æˆåŠŸåç®—ä½œä¸€ä¸ªåŠ¨æ€è®¡ç®—å®Œæˆã€‚è®¡ç®—ä¸ºå•ä½æ˜¯è¯´ï¼Œå¤šä¸ªçº¿ç¨‹å„è‡ªä½¿ç”¨ç‹¬ç«‹çš„ group id æ¶ˆè´¹ Kafka å¹¶ç»´æŠ¤é‡è¯•é˜Ÿåˆ—ï¼Œç„¶ååœ¨çº¿ç¨‹å†…è¿›è¡Œæ¥å£è°ƒç”¨ã€‚ä¸¤ç§æ–¹å¼çš„åŒºåˆ«æ˜¯ä¸€ä¸ªè®¡ç®—å¤±è´¥ä¹‹åçš„ block ä»£ä»·ä¸åŒï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆä¼š block æ•´ä¸ªåŠ¨æ€ï¼Œç¬¬äºŒç§æ–¹æ¡ˆåªä¼š block åŠ¨æ€çš„ä¸€ä¸ªè®¡ç®—ã€‚å¹¶ä¸”ç”±äºè®¡ç®—ä¹‹é—´çš„æ•ˆç‡å·®ï¼Œç¬¬ä¸€ç§çš„æ•ˆç‡å–å†³äºæœ€æ…¢çš„ä¸€ä¸ªè®¡ç®—ï¼Œç¬¬äºŒç§åœ¨åŠ¨æ€ä¸ºå•ä½çš„è§’åº¦æ¥çœ‹ï¼Œä¹Ÿæ˜¯ä»¥æœ€æ…¢çš„ä¸€ä¸ªè®¡ç®—å†³å®šï¼Œä½†æ˜¯ç”±äºè®¡ç®—ä¹‹é—´ä¸ä¼šäº’ç›¸å½±å“ï¼Œæ‰€ä»¥ä¹‹åæƒ³å¯¹ã€Œæ…¢è®¡ç®—ã€è¿›è¡Œé™çº§çš„è¯èƒ½å¾ˆæ–¹ä¾¿çš„å®Œæˆã€‚</p>
<h2 id="ä¸‰ä¸ªé—®é¢˜"><a href="#ä¸‰ä¸ªé—®é¢˜" class="headerlink" title="ä¸‰ä¸ªé—®é¢˜"></a>ä¸‰ä¸ªé—®é¢˜</h2><p>åœ¨å†³å®šæ¨¡å‹ä»¥åï¼Œéœ€è¦è€ƒè™‘ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œã€Œæ„é€ å‡ºä¸€ä¸ªé€šç”¨çš„åè®®å…¼å®¹åŒæ­¥è®¡ç®—å’Œå¼‚æ­¥è®¡ç®—çš„è°ƒç”¨ã€ã€‚ä¸€ç§æ˜¯åŒæ­¥è½®è¯¢ï¼Œä¸€ç§æ˜¯å¼‚æ­¥è°ƒç”¨ã€‚ç”±äºåº•å±‚ä¾èµ–çš„å¤–éƒ¨é•¿æ—¶è®¡ç®—æœ‰è¯·æ±‚çš„æ¬¡æ•°é™åˆ¶ï¼Œæ‰€ä»¥åŒæ­¥è½®è¯¢éœ€è¦è®°å½•è¯·æ±‚æ—¶é—´æ¥æ§åˆ¶è½®è¯¢çš„æ—¶é—´é—´éš”ï¼Œä½†æ˜¯æ²¡æœ‰æ€§èƒ½é—®é¢˜çš„é£é™©ã€‚è€Œå¯¹äºå¼‚æ­¥è°ƒç”¨ï¼Œå¦‚æœä¸‹æ¸¸ç³»ç»Ÿè¢«æŸäº›åŸå›  block ä½çš„æ—¶å€™ä¼šæ— é™çš„å»ºç«‹è¿æ¥ï¼Œåœ¨è¶…è¿‡çº¿ç¨‹æ± çš„ä¸Šé™ä»¥åä¼š block ä½è°ƒç”¨æ–¹ã€‚æ‰€ä»¥æ¯”è¾ƒä¸‹æ¥è¿˜æ˜¯ä½¿ç”¨è½®è¯¢çš„æ–¹å¼ç®€å•å®ç”¨ï¼Œåªéœ€è¦ç»´æŠ¤ä¸€ä¸ªè°ƒç”¨é˜Ÿåˆ—ï¼Œæ¯ä¸ªè¯·æ±‚å¸¦ä¸Šã€Œä¸Šä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´æˆ³ã€å’Œã€Œé‡è¯•æ¬¡æ•°ã€ï¼Œå¦‚æœåœ¨æ¶ˆè´¹åˆ°ä¸€ä¸ªè¿˜æ²¡æœ‰è¶…è¿‡è°ƒç”¨é—´éš”çš„è¯·æ±‚ï¼Œä¸ç´¯åŠ é‡è¯•æ¬¡æ•°ï¼Œç›´æ¥æ”¾å…¥é˜Ÿåˆ—æœ«å°¾ï¼›å¦‚æœä¸€ä¸ªè¯·æ±‚å¤±è´¥åˆ™ç›´æ¥ä¿®æ”¹æ—¶é—´æˆ³ï¼Œç´¯åŠ é‡è¯•æ¬¡æ•°æ”¾å…¥é˜Ÿåˆ—æœ«å°¾ï¼›å¦‚æœè¶…è¿‡äº†é‡è¯•æ¬¡æ•°ï¼Œç›´æ¥æŠ›å‡ºç³»ç»Ÿè®°ä¸ºä¸€ä¸ª bad caseã€‚</p>
<p>åœ¨ç¡®å®šè½®è¯¢çš„æ–¹å¼ä»¥åï¼Œç¬¬äºŒä¸ªé‡è¯•é—®é¢˜ä¹Ÿè¿åˆƒè€Œè§£ï¼Œä»…ç”±é¡¶éƒ¨è°ƒç”¨æ–¹æ¥æ§åˆ¶è¯·æ±‚çŠ¶æ€ï¼Œå¹¶ä¸”æä¾›é‡è¯•ï¼Œè¿™æ ·å•å‘çš„æ•°æ®æµåœ¨åæœŸçš„é—®é¢˜æ’æŸ¥å’Œç»´æŠ¤è¿‡ç¨‹ä¸­æ˜¯éå¸¸é‡è¦çš„ã€‚è€Œç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œæ¨ªå‘æ‰©å±•èƒ½åŠ›ï¼Œç”±äºä½¿ç”¨äº†ã€Œä»¥è®¡ç®—ä¸ºå•ä½çš„pullæ¨¡å‹ã€ï¼Œæ‰©å±•æ–°çš„è®¡ç®—å¯è§æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œåªéœ€è¦æ·»åŠ ç‹¬ç«‹çš„çº¿ç¨‹ã€‚å¹¶ä¸”æ‰©å±•æ¯ä¸ªè®¡ç®—è°ƒç”¨ç³»ç»Ÿæœ¬èº«ä¹Ÿæ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œéœ€è¦å¯¹ã€Œåˆ†å‘ä»»åŠ¡é€»è¾‘ã€å’Œã€Œè°ƒç”¨é€»è¾‘ã€è¿›è¡Œè§£è€¦ï¼Œæ‰©å±•æ—¶åªæ‰©å±•ã€Œè°ƒç”¨é€»è¾‘ã€éƒ¨åˆ†ï¼Œä¸ç„¶çš„è¯è¿˜éœ€è¦ä¿è¯æ¯ä¸ªçº¿ç¨‹ä¹‹é—´åˆ†å‘ä»»åŠ¡çš„é˜Ÿåˆ—çš„ä¸€è‡´æ€§ï¼Œæ˜¯å¾ˆå†—ä½™çš„è®¾è®¡ã€‚é‚£ä¹ˆæ•´ä¸ªè½®è¯¢ç³»ç»Ÿå†…éƒ¨ä¹Ÿè¢«åˆ’åˆ†ä¸ºäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€ä¸ªéƒ¨åˆ†æ¶ˆè´¹ Kafkaï¼Œç»´æŠ¤è°ƒç”¨é˜Ÿåˆ—ï¼Œç¬¬äºŒä¸ªéƒ¨åˆ†æ¶ˆè´¹è°ƒç”¨é˜Ÿåˆ—è¿›è¡Œåº•å±‚æ¥å£è°ƒç”¨ï¼Œå¹¶ä¸”ä¼šåé¦ˆè°ƒç”¨ç»“æœç»™ç¬¬ä¸€ä¸ªéƒ¨åˆ†ï¼Œä½¿å…¶è¿›è¡Œè°ƒç”¨é˜Ÿåˆ—çš„çŠ¶æ€ç»´æŠ¤ã€‚</p>
<p><img src="/images/a3-1.png" alt="a3-1"></p>
<p>è€Œä¸Šé¢ä¹Ÿæåˆ°äº†å•å‘æ•°æ®æµçš„å¥½å¤„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†è§„é¿æ‰åŒå‘æ•°æ®æµï¼Œå°†è¯·æ±‚å®Œæˆåçš„é˜Ÿåˆ—ç»´æŠ¤å·¥ä½œä¹Ÿæ”¾åœ¨æ¥å£è°ƒç”¨éƒ¨åˆ†ã€‚æ‰€ä»¥å°±å˜æˆäº†ã€ŒçŠ¶æ€ç»´æŠ¤ã€éƒ¨åˆ†åªç®¡å¾€è°ƒç”¨é˜Ÿåˆ—é‡Œæ”¾è¯·æ±‚ï¼Œã€Œæ¥å£è°ƒç”¨ã€éƒ¨åˆ†è´Ÿè´£è°ƒç”¨æ¥å£å¹¶ä¸”ä½¿ç”¨ response æ¥ç»´æŠ¤è°ƒç”¨é˜Ÿåˆ—é‡Œçš„è¯·æ±‚çŠ¶æ€ï¼Œä¾‹å¦‚è¯·æ±‚æ¬¡æ•°åŠ ä¸€ä¹‹åæ”¾å…¥é˜Ÿåˆ—æœ«å°¾ã€‚</p>
<p><img src="/images/a3-2.png" alt="a3-2"></p>
<h2 id="å¤ç”¨Storm"><a href="#å¤ç”¨Storm" class="headerlink" title="å¤ç”¨Storm"></a>å¤ç”¨Storm</h2><p>ä¸Šé¢çš„ç»“æ„ä¸€çœ‹éå¸¸åƒ Storm çš„æµå¼ç»“æ„äº†ï¼Œå¹¶ä¸” Storm èƒ½ä¿è¯ä¸€æ¡ Kafka message åœ¨è½®è¯¢ç³»ç»Ÿä¸­ä¸€å®šä¼šè¢«æˆåŠŸæ¶ˆè´¹å¹¶ä¸”æ˜¯é¡ºåºæ¶ˆè´¹ï¼Œè¿˜èƒ½å¸®æˆ‘ä»¬ç®¡ç† Kafka offset çŠ¶æ€ï¼Œè¿˜ä¸éœ€è¦å†™å¤šçº¿ç¨‹ï¼Œæ‰©å®¹èµ·æ¥ä¹Ÿéå¸¸æ–¹ä¾¿ã€‚é‚£ä¹ˆä½•ä¹ä¸ºä¸ä¸ºå‘¢ï¼Ÿ</p>
<p><img src="/images/a3-3.png" alt="a3-3"></p>
<p>å°†è®¾è®¡å›¾ä¸€æ”¹ï¼Œç¬é—´è½¬å˜æˆä¸€ä¸ª Storm æ¶æ„ï¼Œå…¶å®ä¸Šé¢å•å‘æ•°æ®æµçš„è®¾è®¡ä¹Ÿè§„é¿äº† Storm ä¸­ä¸èƒ½ç”±ä¸‹æ¸¸ Bolt ç»™ä¸Šæ¸¸ Bolt ä¼ é€’æ¶ˆæ¯çš„æƒ…å†µã€‚è€Œ Storm æœ¬èº«ä¹Ÿæä¾›é‡è¯•æœºåˆ¶ï¼Œåœ¨è¯¥é‡è¯•æœºåˆ¶ä¸‹æˆ‘ä»¬å¯ä»¥é‡æ–°è€ƒè™‘ä¹‹å‰æ•°æ®ç»“æ„çš„è®¾è®¡ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬éœ€è¦è€ƒè™‘çš„æ˜¯ä¸¤ç±»é‡è¯•æƒ…å†µï¼Œä¸€ç§æ˜¯é€šè¿‡é‡è¯•èƒ½è§£å†³çš„ç½‘ç»œé—®é¢˜ï¼Œä¸€ç§æ˜¯é€šè¿‡é‡è¯•ä¸èƒ½è§£å†³çš„ç³»ç»Ÿé—®é¢˜ã€‚è€Œå½“æˆ‘ä»¬åœ¨é‡åˆ°è¶…è¿‡é‡è¯•æ¬¡æ•°æ²¡æœ‰è§£å†³çš„é—®é¢˜æ—¶ï¼Œä¹‹å‰çš„è§£å†³æ–¹æ¡ˆæ˜¯æŠ›å‡ºç³»ç»ŸæŒä¹…åŒ–åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œä¹‹åå†æƒ³åŠæ³•è§£å†³ï¼Œä½†æ˜¯è¿™æ ·åˆå¢æ·»äº†è¯¥ç³»ç»Ÿçš„å¤æ‚ç¨‹åº¦ï¼Œéœ€è¦é€šè¿‡è‡ªåŠ¨åŒ–çš„æ–¹æ¡ˆèƒ½åŒºåˆ†è¿™ä¸ª case åˆ°åº•æ˜¯ç½‘ç»œé—®é¢˜è¿˜æ˜¯ç³»ç»Ÿé—®é¢˜ï¼Œä¹‹åå†é€šè¿‡ä¸€å¥—æ–¹æ¡ˆå°†å®ƒè§£å†³æ‰å†å†™å…¥ç³»ç»Ÿã€‚</p>
<p>è¯•æƒ³æœ€ç®€å•çš„å¤„ç†æ–¹æ¡ˆæ˜¯é‡åˆ°ç½‘ç»œé—®é¢˜é€šè¿‡é‡è¯•è‡ªç„¶çš„è§£å†³å®ƒï¼Œè€Œé‡åˆ°ç³»ç»Ÿé—®é¢˜ç›´æ¥ block æ•´ä¸ªç³»ç»Ÿï¼Œç­‰å¾…è®¡ç®—æä¾›æ–¹è§£å†³é—®é¢˜åå†ç»§ç»­ã€‚è€Œ Storm çš„æœºåˆ¶åˆšå¥½æä¾›äº†è¿™ç§æ–¹æ¡ˆçš„è§£å†³ç­–ç•¥ï¼Œå¦‚æœé‡åˆ°é‡è¯•çš„è¯·æ±‚éƒ½è¿›è¡Œæ— é™æ¬¡çš„é‡è¯•ï¼Œå› ä¸ºçŸ­æš‚çš„é—®é¢˜è‚¯å®šæ˜¯ä¼šåœ¨æœ‰é™æ¬¡é‡è¯•çš„è¿‡ç¨‹ä¸­æ¢å¤ï¼Œè€Œç³»ç»Ÿé—®é¢˜æ˜¯æ— é™æ¬¡é‡è¯•éƒ½ä¸èƒ½è§£å†³çš„ï¼Œé‚£ä¹ˆé‡åˆ°å¾ˆå¤šçš„ç³»ç»Ÿé—®é¢˜ case ä¸æ˜¯ä¼šæµªè´¹IOï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰ block æ•´ä¸ªç³»ç»Ÿå—ï¼Ÿ</p>
<p>å…¶å®å¹¶ä¸ä¼šï¼ŒStorm å†…éƒ¨è®¾è®¡çš„æ—¶å€™ä¸€æ¬¡ä¼šä» Kafka ä¸­æ‹¿å‡ºå¤šä¸ª message å½¢æˆå¤šä¸ª tupleï¼Œåªæœ‰åœ¨è¿™äº› tuple å…¨éƒ¨ ack æ‰ä»¥åæ‰ä¼šç»§ç»­å‘åé¢æ‹¿æ•°æ®ã€‚æ‰€ä»¥å¦‚æœåœ¨ä¸€æ‰¹æ•°æ®ä¸­å‡ºç°äº†ä¸€äº›ç³»ç»Ÿé—®é¢˜çš„ caseï¼Œä»–ä»¬é€šè¿‡æ— é™çš„ fail é‡è¯•æ˜¯ä¼š block æ•´ä¸ª topology çš„ï¼Œå¹¶ä¸”ä»–ä»¬çš„ä¸ªæ•°ä¸ä¼šå¾ˆå¤šï¼Œæ‰€ä»¥ä¸ä¼šå¯¹ä¸‹æ¸¸é€ æˆ IO çš„å‹åŠ›ã€‚å¯¹ Kafka çš„ offset è¿›è¡Œæ£€æµ‹æ¥ä¸Šè­¦æŠ¥ä»¥åï¼Œå¾ˆå¿«æ¶ˆè´¹èƒ½åŠ›å°±è·Ÿä¸ä¸Šç”Ÿäº§èƒ½åŠ›ï¼Œå°±èƒ½çŸ¥é“å‡ºç°äº†è¿™æ ·çš„ç³»ç»Ÿé—®é¢˜ï¼Œåœ¨ä¸‹æ¸¸çš„æœåŠ¡ä¿®å¥½ä»¥åï¼Œå†æ¥ç€è¿›è¡Œæ¶ˆè´¹ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±æ•°æ®ã€‚</p>
<h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><p>ç³»ç»Ÿçš„è®¾è®¡ä¸­æ¯ä¸€éƒ¨åˆ†ä¸€å®šè¦ç®€å•çº¯ç²¹ï¼Œä¸è¦æƒ³è®©ä¸€ä¸ªéƒ¨åˆ†åšå¤šä»¶äº‹æƒ…ã€‚</p>

	
	</div>
  <a type="button" href="/2018/11/16/a3/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
           <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
        

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/2/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/druid/">druid<span>1</span></a></li>
		
			<li><a href="/tags/front-end/">front-end<span>1</span></a></li>
		
			<li><a href="/tags/database/">database<span>2</span></a></li>
		
			<li><a href="/tags/monogdb/">monogdb<span>1</span></a></li>
		
			<li><a href="/tags/hbase/">hbase<span>1</span></a></li>
		
			<li><a href="/tags/flink/">flink<span>1</span></a></li>
		
			<li><a href="/tags/react/">react<span>1</span></a></li>
		
			<li><a href="/tags/mongodb/">mongodb<span>2</span></a></li>
		
			<li><a href="/tags/spark/">spark<span>2</span></a></li>
		
			<li><a href="/tags/redux/">redux<span>1</span></a></li>
		
			<li><a href="/tags/elasticsearch/">elasticsearch<span>1</span></a></li>
		
			<li><a href="/tags/docker/">docker<span>1</span></a></li>
		
			<li><a href="/tags/kafka/">kafka<span>1</span></a></li>
		
			<li><a href="/tags/distributed-system/">distributed-system<span>7</span></a></li>
		
			<li><a href="/tags/java/">java<span>2</span></a></li>
		
			<li><a href="/tags/storm/">storm<span>2</span></a></li>
		
			<li><a href="/tags/typescript/">typescript<span>1</span></a></li>
		
			<li><a href="/tags/c/">c++<span>1</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2020/09/10/a18/" ><i class="fa fa-file-o"></i>Spark Memory Management</a>
      </li>
    
      <li>
        <a href="/2020/03/22/a17/" ><i class="fa fa-file-o"></i>Mongodb CDCé“¾è·¯ä¸­çš„æœ‰åºæ€§</a>
      </li>
    
      <li>
        <a href="/2020/01/20/a16/" ><i class="fa fa-file-o"></i>URLEncoder in JAVA</a>
      </li>
    
      <li>
        <a href="/2019/11/08/a15/" ><i class="fa fa-file-o"></i>KVåˆ†å¸ƒå¼äº‹åŠ¡</a>
      </li>
    
      <li>
        <a href="/2019/10/18/a14/" ><i class="fa fa-file-o"></i>é”</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/TalkWIthKeyboard" title="TalkWIthKeyboard's Github repository." target="_blank"]);">TalkWIthKeyboard</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2020 TalkWithKeyboard
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
