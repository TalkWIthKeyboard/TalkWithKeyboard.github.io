<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Mongodb CDCé“¾è·¯ä¸­çš„æœ‰åºæ€§ | GRYFFONDOR</title>
  <meta name="author" content="TalkWithKeyboard">
  
  <meta name="description" content="åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡å½“ä¸­æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œç”¨æˆ·æ¯æ”¶åˆ°ä¸€ç¬”è½¬è´¦ä»¥åï¼Œå°±ä¼šé€šè¿‡æ¨é€æœåŠ¡ç»™ç”¨æˆ·å‘é€ä¸€ä¸ªé€šçŸ¥ï¼Œè€Œè¿™äº›é€šçŸ¥ä¹‹é—´éœ€è¦ä¿è¯å…ˆåé¡ºåºï¼ˆå³å¸å•çš„äº§ç”Ÿæ—¶åºï¼‰ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•æ•°æ®ç»“æ„Billï¼š
1234567&amp;#123;	&#34;_id&#34;: ObjectId	&#34;fromUserId&#34;: String,	&#34;toUser">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Mongodb CDCé“¾è·¯ä¸­çš„æœ‰åºæ€§">
  <meta property="og:site_name" content="GRYFFONDOR">

  
    <meta property="og:image" content>
  

  
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

</head>
</html>
 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">GRYFFONDOR</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> Mongodb CDCé“¾è·¯ä¸­çš„æœ‰åºæ€§</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡å½“ä¸­æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œç”¨æˆ·æ¯æ”¶åˆ°ä¸€ç¬”è½¬è´¦ä»¥åï¼Œå°±ä¼šé€šè¿‡æ¨é€æœåŠ¡ç»™ç”¨æˆ·å‘é€ä¸€ä¸ªé€šçŸ¥ï¼Œè€Œè¿™äº›é€šçŸ¥ä¹‹é—´éœ€è¦ä¿è¯å…ˆåé¡ºåºï¼ˆå³å¸å•çš„äº§ç”Ÿæ—¶åºï¼‰ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•æ•°æ®ç»“æ„<code>Bill</code>ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"_id"</span>: ObjectId</span><br><span class="line">	<span class="string">"fromUserId"</span>: String,</span><br><span class="line">	<span class="attr">"toUserId"</span>: String,</span><br><span class="line">	<span class="attr">"amount"</span>: Double,</span><br><span class="line">	<span class="attr">"createdAt"</span>: Long</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>fromUserId</code>æ˜¯è½¬è´¦ç”¨æˆ·çš„idï¼Œ<code>toUserId</code>æ˜¯æ”¶æ¬¾ç”¨æˆ·çš„idï¼Œ<code>amount</code>æ˜¯è½¬è´¦é‡‘é¢ï¼Œ<code>createdAt</code>æ˜¯è®°å½•åˆ›å»ºçš„æ—¥æœŸã€‚</p>
<p>ç³»ç»Ÿä¸­ä½¿ç”¨å®‰è£…äº†<code>debezium connector for mongodb</code>æ’ä»¶çš„<code>kafka connect</code>æ¥å°†mongodb oplogæ”¶é›†åˆ°kafkaä¸­ï¼Œä¸‹æ¸¸ä½¿ç”¨<code>flink streaming task</code>æ¥è¿›è¡Œæ¶ˆè´¹å¹¶è§¦å‘æ¨é€æœåŠ¡ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­æ•°æ®ä¼šæµè¿‡å¤šä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¦‚ä½•ä¿è¯åœ¨æµç»è¿™äº›ç³»ç»Ÿä»¥åè¿˜èƒ½ä¿è¯è®°å½•çš„äº§ç”Ÿé¡ºåºå°±æ˜¯ä»Šå¤©è¦è®¨è®ºçš„é—®é¢˜ã€‚</p>
<h2 id="Kafka-connect-amp-amp-Kafka"><a href="#Kafka-connect-amp-amp-Kafka" class="headerlink" title="Kafka connect &amp;&amp; Kafka"></a>Kafka connect &amp;&amp; Kafka</h2><p>æ‰€æœ‰çš„<code>Bill oplog</code>éƒ½ä¼šè¢«å‘é€åˆ°åŒä¸€ä¸ª<code>Kafka topic</code>ä¸­ï¼Œæ‰€ä»¥åªéœ€è¦ä¿è¯åœ¨å‘å¾€Kafkaçš„è¿‡ç¨‹å½“ä¸­ä½¿ç”¨<code>toUserId</code>ä½œä¸º Partition Keyå³å¯ã€‚ä½†æ˜¯ç”±äºä½¿ç”¨äº†å¼€æºç»„ä»¶æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆäº†æ”¶é›†oplogçš„ä»»åŠ¡ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯<code>debezium connector for mongodb</code>èƒ½å¦‚æˆ‘ä»¬çš„æ„¿ã€‚</p>
<p>é¦–å…ˆéœ€è¦çŸ¥é“çš„æ˜¯<code>Kafka connect</code>é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„åˆ†åŒºç­–ç•¥æ˜¯<code>org.apache.kafka.clients.producer.DefaultPartitioner</code>ï¼Œå…¶ä¸­<code>partition</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Compute the partition for the given record.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> topic The topic name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key The key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keyBytes serialized key to partition on (or null if no key)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value The value to partition on or null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> valueBytes serialized value to partition on or null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cluster The current cluster metadata</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">    List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line">    <span class="keyword">int</span> numPartitions = partitions.size();</span><br><span class="line">    <span class="keyword">if</span> (keyBytes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextValue = nextValue(topic);</span><br><span class="line">        List&lt;PartitionInfo&gt; availablePartitions = cluster.availablePartitionsForTopic(topic);</span><br><span class="line">        <span class="keyword">if</span> (availablePartitions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> part = Utils.toPositive(nextValue) % availablePartitions.size();</span><br><span class="line">            <span class="keyword">return</span> availablePartitions.get(part).partition();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// no partitions are available, give a non-available partition</span></span><br><span class="line">            <span class="keyword">return</span> Utils.toPositive(nextValue) % numPartitions;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// hash the keyBytes to choose a partition</span></span><br><span class="line">        <span class="keyword">return</span> Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">nextValue</span><span class="params">(String topic)</span> </span>&#123;</span><br><span class="line">    AtomicInteger counter = topicCounterMap.get(topic);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == counter) &#123;</span><br><span class="line">        counter = <span class="keyword">new</span> AtomicInteger(ThreadLocalRandom.current().nextInt());</span><br><span class="line">        AtomicInteger currentCounter = topicCounterMap.putIfAbsent(topic, counter);</span><br><span class="line">        <span class="keyword">if</span> (currentCounter != <span class="keyword">null</span>) &#123;</span><br><span class="line">            counter = currentCounter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> counter.getAndIncrement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœkeyæ˜¯ç©ºçš„ï¼Œåˆ™ä»¥è½®è®­çš„æ–¹å¼æ¥åˆ†é…<code>partition</code>ï¼Œå¦åˆ™åˆ™ä½¿ç”¨ä¸€ç§<code>murmur2</code>çš„HASHç®—æ³•æ¥åˆ†é…<code>partition</code>ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†message keyè®¾ç½®ä¸º<code>toUserId</code>å³å¯è¾¾æˆæˆ‘ä»¬çš„ç›®çš„ã€‚ä½†æ˜¯ <a href="https://debezium.io/documentation/reference/1.0/connectors/mongodb.html#mongodb-change-events-key" target="_blank" rel="noopener">Debezium Connector for MongoDB :: Change eventâ€™s key</a> ä¸­å†™é“ï¼Œmessage keyåªèƒ½æ˜¯<code>_id</code>ï¼Œè€Œ<code>toUserId</code>ä¸å…·æœ‰å”¯ä¸€æ€§ï¼Œæ‰€ä»¥ä¸èƒ½ä½œä¸º<code>_id</code>ï¼›å¦‚æœåŠ ä¸Šæ—¶é—´æˆ³æˆ–è€…å…¶ä»–çš„å­—æ®µä¿è¯äº†å”¯ä¸€æ€§ï¼Œåˆå¤±å»äº†è¦å°†ç›¸åŒ<code>toUserId</code>æ”¾åœ¨ä¸€ä¸ªåˆ†åŒºçš„è¯­ä¹‰ï¼Œæ‰€ä»¥è¿™æ¡è·¯åŸºæœ¬æ˜¯èµ°ä¸é€šçš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The MongoDB connector does not make any explicit determination of the topic partitions for events. Instead, it allows Kafka to determine the partition based upon the key. You can change Kafkaâ€™s partitioning logic by defining in the Kafka Connect worker configuration the name of the Partitioner implementation.</span><br><span class="line">Be aware that Kafka only maintains total order for events written to a single topic partition. Partitioning the events by key does mean that all events with the same key will always go to the same partition, ensuring that all events for a specific document are always totally ordered.</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­å¯»æ‰¾å…¶ä»–çš„å˜é€šæ–¹æ³•ï¼Œ<a href="https://debezium.io/documentation/reference/1.0/connectors/mongodb.html#partitions" target="_blank" rel="noopener">Debezium Connector for MongoDB :: Partitions</a> æ–‡æ¡£ä¸­å†™åˆ°å¯ä»¥é€šè¿‡è®¾ç½® Kafka connect worker çš„<code>Partitioner</code>è®¾ç½®æ¥æŒ‡å®šåˆ†åŒºç­–ç•¥ã€‚ä¹Ÿå°±æ˜¯ <a href="http://kafka.apache.org/documentation.html#producerconfigs" target="_blank" rel="noopener">Apache Kafka</a> æ–‡æ¡£ä¸­æåˆ°çš„<code>partitioner.class</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">partitioner.class: Partitioner class that implements the org.apache.kafka.clients.producer.Partitioner interface.</span><br><span class="line">Type: classDefault: org.apache.kafka.clients.producer.internals.DefaultPartitioner</span><br></pre></td></tr></table></figure>

<p>å³éœ€è¦è‡ªå·±é€šè¿‡ç»§æ‰¿<code>Partitioner</code>æ¥å£æ¥å®ç°è‡ªå·±çš„åˆ†åŒºç­–ç•¥ï¼Œè¦å®ç°<code>partitionæ–¹æ³•</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°äº†ä¹‹åå°†åŒ…å«è¯¥ç±»çš„JARåŒ…æ”¾å…¥Kafka connectèƒ½æ‰«æçš„è·¯å¾„ä¸‹ï¼Œå†åœ¨<code>connect-standalone.properties</code>æˆ–è€…<code>connect-distributed.properties</code>é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œå…¨å±€çš„è®¾å®šã€‚å¯ä»¥å‚è§ä¸‹é¢ä¸¤ä¸ªé“¾æ¥ğŸ‘‡ï¼š</p>
<ul>
<li><a href="https://stackoverflow.com/questions/55188508/custom-partition-assignment-in-kafka-jdbc-connector" target="_blank" rel="noopener">java - Custom partition assignment in Kafka JDBC connector - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/questions/44810221/setting-partition-strategy-in-a-kafka-connector" target="_blank" rel="noopener">java - Setting Partition Strategy in a Kafka Connector - Stack Overflow</a></li>
</ul>
<p>é‚£ä¹ˆè¯•æƒ³ä¸€ä¸‹æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ä¸æ˜¯å°±å¯ä»¥å®ç°ä¸ºï¼Œå°†<code>toUserId</code>å’Œæ—¶é—´æˆ³æ‹¼æ¥ä¸ºå”¯ä¸€æ€§çš„<code>_id</code>ï¼Œåœ¨partitionå‡½æ•°ä¸­å°†<code>toUserId</code>æå–å‡ºæ¥å¹¶ä»¥æ­¤ä½œä¸ºpartition keyè¿›è¡Œåˆ†åŒºä»¥å®ç°åœ¨kafkaä¸­ä¿è¯é¡ºåºçš„ç›®çš„ã€‚ä½†æ˜¯è¿™æ ·çš„å®ç°æ–¹æ¡ˆä¹Ÿå­˜åœ¨é—®é¢˜ï¼Œæ¯”å¦‚è¿™ä¸ªKafka connect ä»…æ¥ä¸ºè¿™ä¸ªä»»åŠ¡æœåŠ¡ï¼Œå› ä¸ºè¿™ç§åˆ†åŒºç­–ç•¥å¹¶ä¸å…·æœ‰é€šç”¨æ€§ï¼Œå¦‚æœæœ‰å¤šä¸ªç±»ä¼¼çš„éœ€æ±‚åˆ™è¦éƒ¨ç½²å¤šä»½Kafka connectã€‚åŒæ—¶ä¹Ÿå­˜åœ¨ä¸€äº›å¥½å¤„ï¼Œä¾‹å¦‚æ‹¼æ¥çš„<code>_id</code>æ˜¯å¯ä»¥ç›´æ¥ä½œä¸ºMongodbçš„shard keyæ¥å¯¹è¯¥åœºæ™¯çš„ä¸Šæ¸¸è¿›è¡Œæ¨ªå‘æ‰©å±•çš„ã€‚å¯æƒœçš„æ˜¯debeziumçš„å®ç°å¹¶ä¸èƒ½ä¿è¯shard clusterä¼ å…¥kafkaæ—¶ä¿è¯äº‹ä»¶çš„å‘ç”Ÿé¡ºåºï¼Œè™½ç„¶èƒ½å°†æ‹¼æ¥çš„<code>_id</code>ä½œä¸ºshard keyï¼Œä½†æ˜¯ç”±äºè¿™ç§æ¶æ„å¹¶æ²¡æœ‰èƒ½åŠ›ä¿è¯é¡ºåºæ€§ï¼Œæ‰€ä»¥è¿™ç§æ‰©å±•ä¹Ÿæ˜¯æ— æ•ˆçš„ï¼Œå‚è§ğŸ‘‡ï¼š<br><a href="https://debezium.io/documentation/reference/1.0/connectors/mongodb.html#mongodb-sharded-cluster" target="_blank" rel="noopener">Debezium Connector for MongoDB :: MongoDB sharded cluster</a></p>
<p>ç»¼ä¸Šåœ¨è¯¥æ¶æ„ä¸­å¦‚æœæƒ³åœ¨Kafkaå±‚ä¿è¯äº‹ä»¶çš„æœ‰åºæ€§æ˜¯éå¸¸å›°éš¾ï¼Œå¹¶ä¸”å¾ˆä¸ç»æµå®æƒ ã€‚</p>
<h2 id="Flink-streaming"><a href="#Flink-streaming" class="headerlink" title="Flink streaming"></a>Flink streaming</h2><p>é€šè¿‡ä¸Šæ–‡çš„åˆ†æï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ¥å—ä¸€ä¸ªäº‹å®ï¼Œ<code>Flink</code>æ¶ˆè´¹åˆ°çš„æ˜¯ä¹±åºæ•°æ®ã€‚ä½†æ˜¯å› ä¸ºå…¶ç‰¹æ€§ï¼Œèƒ½è¾ƒä¸ºæ–¹ä¾¿çš„å¯¹ä¹±åºæ•°æ®è¿›è¡Œå¤„ç†ã€‚<br>åœ¨debeziumæ”¶é›†åˆ°çš„oplogä¸­ï¼ŒåŒ…å«ä¸¤ä¸ªæ—¶é—´æˆ³ï¼Œä¸€ä¸ªæ˜¯åœ¨Value payloadä¸­çš„<code>ts_ms</code>ï¼Œè¡¨ç¤ºçš„æ˜¯debeziumæ”¶é›†è¯¥oplogæ—¶çš„ç³»ç»Ÿæ—¶é—´ï¼›å¦å¤–ä¸€ä¸ªæ˜¯åœ¨Value payloadä¸­çš„<code>source.ts_ms</code>ï¼Œè¡¨ç¤ºçš„æ˜¯mongodbäº§ç”Ÿoplogçš„æ—¶é—´ã€‚è€Œæˆ‘ä»¬çš„å®ä½“ç±»ä¸­ä¹Ÿå†™å…¥äº†Create billçš„æ—¶é—´<code>createdAt</code>ï¼Œç”±äºåªå…³å¿ƒ<code>Insert</code>äº‹ä»¶ï¼Œæ‰€ä»¥åœ¨Value payloadçš„<code>after.createdAt</code>ä¸­èƒ½è·å–Billåˆ›å»ºçš„çœŸå®æ—¶é—´ã€‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸€èˆ¬ä»¥ç¬¬äºŒä¸ªæ—¶é—´æˆ–è€…ç¬¬ä¸‰ä¸ªæ—¶é—´ä¸ºå‡†ï¼Œåœ¨æ²¡æœ‰é‡‡ç”¨shard clusterçš„mongodbä¸­ï¼Œæˆ‘è®¤ä¸ºç¬¬äºŒä¸ªæ—¶é—´çš„å…ˆåæ¬¡åºåº”è¯¥ä¸ç¬¬ä¸‰ä¸ªæ—¶é—´çš„å…ˆåæ¬¡åºç›¸åŒï¼›é‡‡ç”¨äº†shard clusterçš„mongodbä¸­ï¼Œåº”è¯¥ä»¥ç¬¬ä¸‰ä¸ªæ—¶é—´ä¸ºå‡†ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">"payload": &#123;</span><br><span class="line">      "after": ...,</span><br><span class="line">      "patch": null,</span><br><span class="line">      "source": &#123;</span><br><span class="line">        "version": "1.0.3.Final",</span><br><span class="line">        "connector": "mongodb",</span><br><span class="line">        "name": "cdc_test",</span><br><span class="line">        "ts_ms": 1558965508000,</span><br><span class="line">        "snapshot": true,</span><br><span class="line">        "db": "inventory",</span><br><span class="line">        "rs": "rs0",</span><br><span class="line">        "collection": "bill",</span><br><span class="line">        "ord": 31,</span><br><span class="line">        "h": 1546547425148721999</span><br><span class="line">      &#125;,</span><br><span class="line">      "op": "r",</span><br><span class="line">      "ts_ms": 1558965515240</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨Flinkçš„æ—¶é—´æ¦‚å¿µä¸­ä¹Ÿæœ‰ä¸‰ç§æ—¶é—´ï¼š</p>
<ul>
<li>äº‹ä»¶æ—¶é—´ï¼šç‹¬ç«‹äº‹ä»¶åœ¨äº§ç”Ÿå®ƒçš„è®¾å¤‡ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œé€šå¸¸åœ¨è¿›å…¥Flinkä¹‹å‰å°±å·²ç»åµŒå…¥åˆ°äº‹ä»¶ä¸­ã€‚</li>
<li>æ¥å…¥æ—¶é—´ï¼šæ•°æ®è¿›å…¥Flinkçš„æ—¶é—´ï¼Œå–å†³äºSource Operatoræ‰€åœ¨ä¸»æœºçš„ç³»ç»Ÿæ—¶é’Ÿã€‚</li>
<li>å¤„ç†æ—¶é—´ï¼šæ•°æ®åœ¨æ“ä½œç®—å­è®¡ç®—è¿‡ç¨‹ä¸­è·å–åˆ°çš„æ‰€åœ¨ä¸»æœºæ—¶é—´ã€‚</li>
</ul>
<p>æ˜¾ç„¶åœ¨è¯¥åœºæ™¯ä¸‹åº”è¯¥é€‰æ‹©<code>Bill</code>çš„åˆ›å»ºæ—¶é—´ä½œä¸ºFlinkçš„äº‹ä»¶æ—¶é—´ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">env.addSource(<span class="type">Utils</span>.providesAvroKafkaConsumer(kafkaConfig))</span><br><span class="line">    .map(recordTuple =&gt; <span class="type">AvroMongoOplog</span>.newInstance(recordTuple._1.asInstanceOf[<span class="type">Record</span>], recordTuple._2.asInstanceOf[<span class="type">Record</span>]))</span><br><span class="line">    .filter(mongoOplog =&gt; mongoOplog.getOpType.eq(<span class="type">MongoOpType</span>.<span class="type">Insert</span>))</span><br><span class="line">    .assignAscendingTimestamps(mongoOplog =&gt; mongoOplog.getDocument.getLong(<span class="string">"createdAt"</span>))</span><br><span class="line">	  .keyBy(mongoOplog =&gt; mongoOplog.getDocument.get(<span class="string">"toUserId"</span>))</span><br><span class="line">    .window(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">    .process(...)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>è¿æ¥Kafkaï¼Œä½¿ç”¨å®ç°çš„<code>KeyedAvroDeserializationSchema</code>è¿›è¡Œååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.confluent.kafka.schemaregistry.client.CachedSchemaRegistryClient</span><br><span class="line"><span class="keyword">import</span> org.apache.avro.generic.GenericRecord</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.typeinfo.TypeInformation</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.formats.avro.registry.confluent.ConfluentRegistryAvroDeserializationSchema</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.KafkaDeserializationSchema</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord</span><br><span class="line"></span><br><span class="line"><span class="meta">@SerialVersionUID</span>(<span class="number">1584533572114L</span>)</span><br><span class="line">class KeyedAvroDeserializationSchema extends KafkaDeserializationSchema[(GenericRecord, GenericRecord)] &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> keyDeserializer: ConfluentRegistryAvroDeserializationSchema[GenericRecord] = _</span><br><span class="line">    <span class="keyword">var</span> valueDeserializer: ConfluentRegistryAvroDeserializationSchema[GenericRecord] = _</span><br><span class="line"></span><br><span class="line">    <span class="function">def <span class="title">this</span><span class="params">(topic: String, schemaRegistry: String)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>()</span><br><span class="line">        val keySubject = topic + <span class="string">"-key"</span></span><br><span class="line">        val valueSubject = topic + <span class="string">"-value"</span></span><br><span class="line">        val schemaRegistryClient = <span class="keyword">new</span> CachedSchemaRegistryClient(schemaRegistry, <span class="number">1000</span>)</span><br><span class="line">        val keySchema = schemaRegistryClient.getByID(schemaRegistryClient.getLatestSchemaMetadata(keySubject).getId)</span><br><span class="line">        val valueSchema = schemaRegistryClient.getByID(schemaRegistryClient.getLatestSchemaMetadata(valueSubject).getId)</span><br><span class="line">        keyDeserializer = ConfluentRegistryAvroDeserializationSchema.forGeneric(keySchema, schemaRegistry)</span><br><span class="line">        valueDeserializer = ConfluentRegistryAvroDeserializationSchema.forGeneric(valueSchema, schemaRegistry)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">override def <span class="title">isEndOfStream</span><span class="params">(t: (GenericRecord, GenericRecord)</span>): Boolean </span>= <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">    <span class="function">override def <span class="title">deserialize</span><span class="params">(consumerRecord: ConsumerRecord[Array[Byte], Array[Byte]])</span>: <span class="params">(GenericRecord, GenericRecord)</span></span></span><br><span class="line"><span class="function">    </span>= (keyDeserializer.deserialize(consumerRecord.key()), valueDeserializer.deserialize(consumerRecord.value()))</span><br><span class="line"></span><br><span class="line">    override def getProducedType: TypeInformation[(GenericRecord, GenericRecord)] = createTypeInformation[(GenericRecord, GenericRecord)]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ä¸€ä¸ªå·¥å…·ç±»å°†<code>(Record,Record)</code>è½¬åŒ–ä¸ºæ›´å¥½å¤„ç†çš„<code>MongoOplogEntry</code>ç±»å‹</p>
</li>
<li><p>è¿‡æ»¤å‡ºæ‰€æœ‰çš„<code>Insert</code>äº‹ä»¶</p>
</li>
<li><p>å°†<code>Bill</code>çš„åˆ›å»ºæ—¶é—´ä½œä¸ºFlinkçš„äº‹ä»¶æ—¶é—´</p>
</li>
<li><p>æŒ‰ç…§<code>toUserId</code>è¿›è¡Œåˆ†åŒº</p>
</li>
<li><p>è®¾ç½®10ç§’çš„æ—¶é—´çª—å£</p>
</li>
<li><p>åœ¨çª—å£å¤„ç†å‡½æ•°ä¸­å¯¹æ‰€æœ‰<code>MongoOplogEntry</code>å¯¹è±¡æŒ‰ç…§<code>createdAt</code>å†æ’åºåä¾æ¬¡è§¦å‘æ¨é€æœåŠ¡</p>
</li>
</ul>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ä»¥ä¸Šä»‹ç»äº†åœ¨Mongodb CDCè¿‡ç¨‹ä¸­ä¿è¯æ•°æ®æœ‰åºæ€§çš„ä¸¤ç§æ€è·¯ï¼Œä¸€ç§æ˜¯åœ¨Kafkaä¸­å°±ä¿è¯<code>toUserId</code>ç›¸åŒçš„æ•°æ®å‡æœ‰åºï¼Œè¿™æ ·åœ¨æ¶ˆè´¹è¿‡ç¨‹ä¸­ä¸éœ€è¦åšçª—å£è®¡ç®—ï¼Œåªè¦åœ¨éœ€è¦partitionçš„åœ°æ–¹ç»§ç»­ä½¿ç”¨<code>toUserId</code>è¿›è¡Œpartitionï¼Œå°±èƒ½ä¿è¯æ•°æ®æœ‰åºæ€§ã€‚è¿™ç§æ–¹æ¡ˆåœ¨Kafka connectä¾§éœ€è¦åšå¾ˆå¤šçš„å·¥ä½œï¼Œä½†æ˜¯èƒ½ä¸ºæµå¼ä»»åŠ¡å¸¦æ¥æ›´å¥½çš„æ¶ˆè´¹æ€§èƒ½ï¼Œä½†æ˜¯ç”±äºdebeziumçš„å±€é™æ€§ï¼Œåœ¨shard clusterçš„Mongodbä¸­ä¸èƒ½å‘æŒ¥ä½œç”¨ã€‚ç¬¬äºŒç§æ˜¯è®©Flinkæ¶ˆè´¹ä¹±åºæ•°æ®ï¼Œä½¿ç”¨å…¶æœ¬èº«çš„äº‹ä»¶æ—¶é—´çª—å£è®¡ç®—æ¥é‡æ–°çº æ­£æ•°æ®ã€‚è¿™ç§æ–¹æ¡ˆä¼šè®©Flinkçš„æ•ˆç‡å¤§æ‰“æŠ˜æ‰£ï¼Œå¹¶ä¸”éœ€è¦ä¿è¯çª—å£ç¼“å­˜æ•°æ®ä¸èƒ½è¶…è¿‡é™åˆ¶ï¼Œä½†æ˜¯æ¯”è¾ƒé€šç”¨ï¼Œä½¿ç”¨çš„æ—¶å€™ä¹Ÿéœ€è¦æ³¨æ„è¿Ÿåˆ°çš„æ•°æ®è¯¥å¦‚ä½•å¤„ç†ã€‚å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„åœºæ™¯æ¥æŒ‘é€‰æ–¹æ¡ˆï¼Œæˆ–è€…å¦‚æœæœ‰æ›´å¥½çš„æ–¹æ¡ˆæ¬¢è¿ä¸€èµ·äº¤æµã€‚</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a type="button" class="btn btn-default disabled"><i class="fa fa-arrow-circle-o-left"></i>Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2020/01/20/a16/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2020-03-22 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/monogdb/">monogdb<span>1</span></a></li> <li><a href="/tags/kafka/">kafka<span>1</span></a></li> <li><a href="/tags/flink/">flink<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Kafka-connect-amp-amp-Kafka"><span class="toc-article-text">Kafka connect &amp;&amp; Kafka</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Flink-streaming"><span class="toc-article-text">Flink streaming</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#æœ€å"><span class="toc-article-text">æœ€å</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2020 TalkWithKeyboard
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
