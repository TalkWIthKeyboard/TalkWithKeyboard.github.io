<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>URLEncoder in JAVA | GRYFFONDOR</title>
  <meta name="author" content="TalkWithKeyboard">
  
  <meta name="description" content="å‘ç°Webclientçš„URLEncoderçš„è¡¨ç°éå¸¸ä¸ç¨³å®šï¼Œæ‰€ä»¥æ‰¾äº†ä¸€ä¸‹æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªissue TestRestTemplate does the url encoding twice if I pass the URI as a string Â· Issue #8888 Â· spr">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="URLEncoder in JAVA">
  <meta property="og:site_name" content="GRYFFONDOR">

  
    <meta property="og:image" content>
  

  
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

</head>
</html>
 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">GRYFFONDOR</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> URLEncoder in JAVA</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>å‘ç°<code>Webclient</code>çš„<code>URLEncoder</code>çš„è¡¨ç°éå¸¸ä¸ç¨³å®šï¼Œæ‰€ä»¥æ‰¾äº†ä¸€ä¸‹æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªissue <a href="https://github.com/spring-projects/spring-boot/issues/8888" target="_blank" rel="noopener">TestRestTemplate does the url encoding twice if I pass the URI as a string Â· Issue #8888 Â· spring-projects/spring-boot Â· GitHub</a> ï¼Œä¸€ä¸ªè€å“¥å‘ç°å½“<code>exchange</code> é‡Œä¼ å…¥ <code>URI</code> ç±»çš„æ—¶å€™ï¼Œ<code>exchange</code>ä¸ä¼šæœ‰ä»»ä½•encodeè¡Œä¸ºï¼Œä½†æ˜¯åœ¨ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ä¼šè¢«encodeã€‚</p>
<p>ä¸‹é¢æœ‰<code>bclozel</code>çš„å›ç­”ğŸ‘‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Hi  [@georgmittendorfer](https://github.com/georgmittendorfer) ,</span><br><span class="line">I think this is the expected behavior in Spring Framework (see  [SPR-16202](https://jira.spring.io/browse/SPR-16202)  and  [SPR-14828](https://jira.spring.io/browse/SPR-14828)  for some background on this).</span><br><span class="line">As a general rule, providing a URI String to RestTemplate means that this String should be expanded (using optional method parameters) and then encoded. If you want to take full control over the encoding, you should then use the method variant taking a URI as a parameter.</span><br><span class="line">The Spring Framework team recently added  [some more documentation on the subject of URI encoding](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/web.html#web-uri-encoding) . Does that help?</span><br></pre></td></tr></table></figure>

<p>çœ‹æ¥Springè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ­£å¸¸çš„è¡Œä¸ºï¼Œå³<strong>ä¼ å…¥å­—ç¬¦ä¸²çš„æ—¶å€™æˆ‘å°±è¦å¯¹ä½ è¿›è¡Œencodeï¼Œä½ ä¼ URIå¯¹è±¡çš„æ—¶å€™æˆ‘ä¸ç®¡</strong>ã€‚ç»§ç»­ç‚¹è¿›å»çœ‹çœ‹å®˜æ–¹æ–‡æ¡£ <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/web.html#web-uri-encoding" target="_blank" rel="noopener">Web on Servlet Stack</a>ï¼š<br>1.5.3 ä¸­è¢«è¡¥ä¸Šäº†è¯¦ç»†çš„ä½¿ç”¨ç»†èŠ‚ï¼Œé¦–å…ˆå®ƒå°†<code>URI</code>çš„ç»„æˆåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªå«åš<code>URI template</code>ï¼Œä¸€ä¸ªå«åš<code>URI variables</code>ã€‚ç„¶åæä¾›äº†4ç§encodeçš„æ¨¡å¼ï¼š</p>
<ul>
<li><code>TEMPLATE_AND_VALUES</code>ï¼šä¼šå…ˆå¯¹templateè¿›è¡Œencodeï¼Œç„¶ååœ¨æ‰©å±•çš„æ—¶å€™å†å¯¹variablesè¿›è¡Œencodeã€‚</li>
<li><code>VALUES_ONLY</code>ï¼šä¸ä¼šå¯¹templateè¿›è¡Œencodeï¼Œåœ¨æ‰©å±•ä¹‹å‰å¯¹variablesè¿›è¡Œencodeã€‚</li>
<li><code>URI_COMPONENTS</code>ï¼šå’Œç¬¬äºŒç§ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯åœ¨æ‰©å±•ä¹‹åå¯¹valuesè¿›è¡Œencodeã€‚</li>
<li><code>NONE</code>ï¼šä¸åšä»»ä½•çš„encodeã€‚</li>
</ul>
<p>å†æ¥çœ‹çœ‹æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ï¼Œåœ¨æˆ‘ä»¬çš„ä¸€ä¸ªåº“ä¸­ï¼Œç”¨é”™è¯¯çš„å§¿åŠ¿ä½¿ç”¨çš„<code>URI</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> webClient</span><br><span class="line">    .get()</span><br><span class="line">    .uri(<span class="string">"/doItemHighCommissionPromotionLinkByAll?"</span> + Utils.pojo2UrlQuery(request))</span><br><span class="line">    .exchange();</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥ä¼ å…¥äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¼šå‘ç°è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBodySpec <span class="title">uri</span><span class="params">(String uriTemplate, Object... uriVariables)</span> </span>&#123;</span><br><span class="line">	attribute(URI_TEMPLATE_ATTRIBUTE, uriTemplate);</span><br><span class="line">	<span class="keyword">return</span> uri(uriBuilderFactory.expand(uriTemplate, uriVariables));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸæ¥æˆ‘ä»¬ä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å ä½ç¬¦çš„<code>uriTemplate</code>ï¼Œè€Œç°åœ¨ä¾èµ–çš„<code>WebClient</code>ç‰ˆæœ¬ä¸­é»˜è®¤çš„encodeæ¨¡å¼æ˜¯<code>EncodingMode.URI_COMPONENTS</code>ï¼Œä¹Ÿå°±æ˜¯æ ¹æœ¬ä¸ä¼šç®¡templateéƒ¨åˆ†ã€‚æ‰€ä»¥æˆ‘ä»¬å‘ç°ä¸ºä»€ä¹ˆä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™æ²¡æœ‰è¢«è‡ªåŠ¨encodeã€‚</p>
<p>é‚£ä¹ˆæ˜¯ä¸æ˜¯æŠŠencodeæ¨¡å¼æ”¹ä¸º<code>EncodingMode. TEMPLATE_AND_VALUES</code>ï¼Œè®©å®ƒä¼šencode templateå°±æ²¡é—®é¢˜äº†å‘¢ï¼Ÿä¹Ÿä¸æ˜¯ï¼Œæ¯”å¦‚<code>http://api.vephp.com/hcapi?detail=1&amp;vekey=V00003484Y95498091&amp;para=https://uland.taobao.com/coupon/edetail?activityId=8932eb9980234090851d448195fe363c&amp;itemId=578614572836</code><br>è¿™ä¸ªurlï¼Œparaä¼ å…¥çš„åˆæ˜¯ä¸€ä¸ªurlï¼Œè·Ÿäº†ä¸€ä¸‹è§£æä»£ç ï¼Œä¼šå‘ç°templateåœ¨è§£æçš„æ—¶å€™ä¼šæŠŠquery mapè§£æˆï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"detail"</span>: <span class="number">1</span>,</span><br><span class="line">	<span class="attr">"vekey"</span>: <span class="string">"V00003484Y95498091"</span>,</span><br><span class="line">	<span class="attr">"para"</span>: <span class="string">"https://uland.taobao.com/coupon/edetail?activityId=8932eb9980234090851d448195fe363c"</span>,</span><br><span class="line">	<span class="attr">"itemId"</span>: <span class="string">"578614572836"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå®ƒè§£æquery paramsçš„æ­£åˆ™é•¿è¿™æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"([^&amp;=]+)(=?)([^&amp;]+)?"</span></span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åæœæ˜¯<code>para</code>ä¼šè¢«encodeï¼ˆè€Œä¸”è¿˜æ˜¯é”™è¯¯çš„encodeï¼Œè¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹templateçš„encodeï¼Œä¸æ˜¯æ­£ç´§çš„urlEncodeï¼‰ï¼Œä½†æ˜¯<code>itemId</code>éƒ¨åˆ†ä¸ä¼šã€‚æ‰€ä»¥æœ€ç»ˆä¹Ÿåªæ˜¯å¾—åˆ°äº†ä¸€ä¸ªé”™è¯¯çš„encodeç»“æœã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li><p>ä¼ å…¥çš„è¿˜æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸è¿‡åœ¨æ„é€ çš„æ—¶å€™è‡ªå·±å»åšurlEncodeï¼Œç„¶ååœ¨WebClientçš„è®¾ç½®é‡Œå°†encodeæ¨¡å¼è®¾ä¸ºåä¸‰ç§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> WebClient</span><br><span class="line">    .builder()</span><br><span class="line">    .exchangeStrategies(strategies)</span><br><span class="line">    .baseUrl(endpoint)</span><br><span class="line">    .uriBuilderFactory(providesUriBuilderFactory(endpoint));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DefaultUriBuilderFactory <span class="title">providesUriBuilderFactory</span><span class="params">(String endpoint)</span> </span>&#123;</span><br><span class="line">    DefaultUriBuilderFactory factory = <span class="keyword">new</span> DefaultUriBuilderFactory(endpoint);</span><br><span class="line">    factory.setEncodingMode(EncodingMode.NONE);</span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¼ å…¥ä¸€ä¸ª<code>URI</code>å¯¹è±¡ï¼Œæ„é€ çš„æ—¶å€™è‡ªå·±å»åšurlEncodeï¼Œä¸ç”¨å…³å¿ƒWebClienté‡Œçš„è®¾ç½®ã€‚</p>
</li>
<li><p>æ­£ç¡®çš„ä½¿ç”¨<code>url template</code>å’Œ<code>url variables</code>è¿›è¡Œæ„é€ ï¼Œé‚£å°±ä¸ç”¨è‡ªå·±å»åšurlEncodeã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">URI uri = UriComponentsBuilder.fromPath(<span class="string">"/hotel list/&#123;city&#125;"</span>)</span><br><span class="line">        .queryParam(<span class="string">"q"</span>, <span class="string">"&#123;q&#125;"</span>)</span><br><span class="line">        .build(<span class="string">"New York"</span>, <span class="string">"foo+bar"</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>æœ€åä½ å¯èƒ½ä¼šå‘ç°è‡ªå·±åœ¨è¿›è¡ŒurlEncodeçš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šæœ‰é—®é¢˜ã€‚å¯ä»¥é˜…è¯»ä¸‹ <a href="https://stackoverflow.com/questions/14321873/java-url-encoding-urlencoder-vs-uri" target="_blank" rel="noopener">Java URL encoding: URLEncoder vs. URI - Stack Overflow</a> å’Œ  <a href="https://stackoverflow.com/questions/607176/java-equivalent-to-javascripts-encodeuricomponent-that-produces-identical-outpu" target="_blank" rel="noopener">Java equivalent to JavaScriptâ€™s encodeURIComponent that produces identical output? - Stack Overflow</a><br>ç®€å•ç‚¹è¯´å°±æ˜¯ <code>URLEncoder.encode()</code> æ–¹æ³•ä¸æ˜¯ä½ çœŸæ­£æƒ³ç”¨åˆ°çš„æ–¹æ³•ï¼Œä½ å¯ä»¥è¿™æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeURIComponent</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    String result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = URLEncoder.encode(s, <span class="string">"UTF-8"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\+"</span>, <span class="string">"%20"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%21"</span>, <span class="string">"!"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%27"</span>, <span class="string">"'"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%28"</span>, <span class="string">"("</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%29"</span>, <span class="string">")"</span>)</span><br><span class="line">                .replaceAll(<span class="string">"\\%7E"</span>, <span class="string">"~"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        result = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆå¥½å‚»å•Š</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2020/03/22/a17/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2019/11/08/a15/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2020-01-20 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/java/">java<span>2</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2020 TalkWithKeyboard
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>â¬†ï¸TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
